{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if item %}Хөрөнгийн баримт шинэчлэх{% else %}Хөрөнгийн баримт үүсгэх{% endif %} - Silicon4 Accounting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'js/shared-components.js' %}"></script>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-3">
        <div class="mb-3">
            <h1 class="text-base lg:text-lg xl:text-xl font-medium text-gray-900">{% if item %}Хөрөнгийн баримт шинэчлэх{% else %}Хөрөнгийн баримт үүсгэх{% endif %}</h1>
        </div>
        <p class="text-xs text-gray-600">{% if item %}Одоо байгаа хөрөнгийн баримт шинэчлэх{% else %}Шинэ хөрөнгийн баримт үүсгэх{% endif %}</p>
    </div>
    
    <!-- Form -->
    <div class="bg-white shadow rounded p-2 max-w-2xl">
        <form id="asset-document-form" method="post" action="{% if item %}{% url 'core:astdocument_update' item.DocumentId %}{% else %}{% url 'core:astdocument_create' %}{% endif %}">
            {% csrf_token %}
            
            <div class="border-gray-300 border">
                <!-- Document Date -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.DocumentDate.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            ОГНОО: <span class="text-red-500">*</span>
                    </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.DocumentDate }}
                        </div>
                        {% if form.DocumentDate.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.DocumentDate.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Document Type ID -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.DocumentTypeId.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            БАРИМТЫН ТӨРӨЛ: <span class="text-red-500">*</span>
                    </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                        {{ form.DocumentTypeId }}
                        </div>
                        {% if form.DocumentTypeId.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.DocumentTypeId.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Account ID -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="AccountIdDisplay" class="text-xs text-gray-700 font-normal uppercase">
                            ДАНС: <span class="text-red-500">*</span>
                    </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="relative w-full">
                            <input type="text" 
                                   id="AccountIdDisplay" 
                                   readonly
                                   value="{% if item and item.AccountId %}{{ item.AccountId.AccountCode }} - {{ item.AccountId.AccountName }}{% endif %}"
                                   class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer bg-gray-50"
                                   placeholder="Click to select account"
                                   onclick="handleAccountSelection(this)">
                            <input type="hidden" 
                                   name="AccountId" 
                                   id="AccountId" 
                                   value="{% if item and item.AccountId %}{{ item.AccountId.AccountId }}{% endif %}"
                                   required>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                        <div id="account-id-error" class="mt-1 text-xs text-red-600"></div>
                        {% if form.AccountId.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.AccountId.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Document Number -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.DocumentNo.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            БАРИМТЫН ДУГААР: <span class="text-red-500">*</span>
                    </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.DocumentNo }}
                        </div>
                        <div id="document-no-error" class="mt-1 text-xs text-red-600"></div>
                        {% if form.DocumentNo.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.DocumentNo.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Template Selection -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="TemplateId" class="text-xs text-gray-700 font-normal uppercase">
                            ГҮЙЛГЭЭНИЙ ЗАГВАР: 
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="relative w-full">
                            <select id="TemplateId" 
                                    name="TemplateId" 
                                    class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer bg-white appearance-none"
                                    onchange="handleTemplateSelection(this)">
                                <option value="">Template сонгоно уу?</option>
                                <!-- Templates will be populated dynamically -->
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                        <div id="template-id-error" class="mt-1 text-xs text-red-600"></div>
                    </div>
                </div>
                
                <!-- Client -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="ClientIdDisplay" class="text-xs text-gray-700 font-normal uppercase">
                            ХАРИЛЦАГЧ <span class="text-red-500">*</span>
                    </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="relative w-full">
                            <input type="text" 
                                   id="ClientIdDisplay" 
                                   readonly
                                   value="{% if item and item.ClientId %}{{ item.ClientId.ClientCode }} - {{ item.ClientId.ClientName }}{% endif %}"
                                   class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer bg-gray-50"
                                   placeholder="Click to select client"
                                   onclick="openClientPopup(this)">
                            <input type="hidden" 
                                   name="ClientId" 
                                   id="ClientId" 
                                   value="{% if item and item.ClientId %}{{ item.ClientId.ClientId }}{% endif %}"
                                   required>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                        {% if form.ClientId.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.ClientId.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Is VAT -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.IsVat.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            НӨОАТ (тай эсэх) :
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="flex items-center">
                            <!-- Hidden input to submit template-driven IsVat value -->
                            <input type="hidden"
                                   id="IsVatHidden"
                                   name="{{ form.IsVat.html_name }}"
                                   value="{% if form.IsVat.value %}true{% else %}false{% endif %}">
                            <input type="checkbox" 
                                   id="{{ form.IsVat.id_for_label }}" 
                                   value="true"
                                   {% if form.IsVat.value %}checked{% endif %}
                                   disabled
                                   title="Template-controlled"
                                   class="w-3 h-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 cursor-not-allowed">
                            <label for="{{ form.IsVat.id_for_label }}" class="ml-3 text-xs text-gray-700 cursor-pointer">НӨАТ идэвхжүүлэх</label>

                            <!-- VAT Percent inline next to checkbox -->
                            <div class="ml-6 flex items-center gap-2">
                                <label for="customVatPercent" class="text-xs text-gray-700 font-normal uppercase">НӨОАТ %:</label>
                                <input type="number" 
                                       id="customVatPercent" 
                                       name="VatPercent" 
                                       value="{{ VAT_RATE_PERCENT }}"
                                       readonly
                                       class="w-20 border border-gray-300 rounded-md px-2 py-1 text-xs bg-gray-100"
                                       step="0.01"
                                       min="0"
                                       max="100"
                                       placeholder="%">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- VAT Account ID -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="VatAccountIdDisplay" class="text-xs text-gray-700 font-normal uppercase">
                            НӨОАТ-ЫН ДАНС:
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="w-full">
                            <input type="text" 
                                   id="VatAccountIdDisplay" 
                                   readonly
                                   value="{% if item and item.VatAccountId %}{{ item.VatAccountId.AccountCode }}{% endif %}"
                                   class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs bg-gray-100"
                               placeholder="VAT account will be auto-selected based on document type">
                            <input type="hidden" 
                                   name="VatAccountId" 
                                   id="VatAccountId" 
                                   value="{% if item and item.VatAccountId %}{{ item.VatAccountId.AccountId }}{% endif %}">
                        </div>
                    </div>
                </div>
                
                <!-- Is Lock - Hidden -->
                <div style="display: none;">
                    {{ form.IsLock }}
                </div>
                
                <!-- Description -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.Description.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            ГҮЙЛГЭЭНИЙ УТГА: <span class="text-red-500">*</span>
                    </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="w-full">
                            <input type="text" 
                                   id="{{ form.Description.id_for_label }}" 
                                   name="{{ form.Description.html_name }}" 
                                   value="{{ form.Description.value|default:'' }}"
                                   class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Enter description"
                               maxlength="200"
                               required>
                            <div id="Description-validation" class="mt-1 text-xs hidden"></div>
                        {% if form.Description.errors %}
                            <div class="mt-1 text-xs text-red-600">
                            {% for error in form.Description.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex items-center gap-2 mt-4 pt-4 border-t">
                <div class="flex gap-2">
                    <a href="{% url 'core:astdocument_master_detail' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Цуцлах
                    </a>
                    <button type="submit" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    {% if item %}
                    <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                        Шинэчлэх
                    {% else %}
                    <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                        Үүсгэх
                    {% endif %}
                </button>
                </div>
            </div>
        </form>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Auto-fill current date if creating new document
    const dateField = document.getElementById('id_DocumentDate');
    if (dateField && !dateField.value) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        dateField.value = `${year}-${month}-${day}`;
    }
    
    // Form submission handling
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(event) {
            // Check HTML5 validation first
            if (!form.checkValidity()) {
                event.preventDefault();
                // Let HTML5 validation show its native messages
                return false;
            }
            
            // Validate modal-selected fields
            if (!validateModalFields()) {
                event.preventDefault();
                Silicon4Message.error('required-fields');
                return false;
            }
            
            // Additional validation for VAT account when VAT is enabled
            const vatCheckbox = document.getElementById('{{ form.IsVat.id_for_label }}');
            const vatAccountHidden = document.getElementById('VatAccountId');
            if (vatCheckbox && vatCheckbox.checked) {
                if (!vatAccountHidden || !vatAccountHidden.value) {
                    event.preventDefault();
                    Silicon4Message.error('vat-account-required');
                    // Show error message
                    const vatAccountDisplay = document.getElementById('VatAccountIdDisplay');
                    if (vatAccountDisplay) {
                        vatAccountDisplay.value = 'VAT account is required when VAT is enabled';
                        vatAccountDisplay.style.color = '#ef4444';
                    }
                    return false;
                }
            }
            
            // Additional validation for Description field
            const descriptionField = document.getElementById('id_Description');
            if (descriptionField) {
                const value = descriptionField.value.trim();
                if (!value) {
                    event.preventDefault();
                    descriptionField.focus();
                    descriptionField.classList.remove('border-gray-300', 'border-green-500', 'border-yellow-500');
                    descriptionField.classList.add('border-red-500');
                    return false;
                } else if (!validateDescriptionField(descriptionField)) {
                    event.preventDefault();
                    return false;
                }
            }
            
            const submitButton = document.querySelector('button[type="submit"]');
            if (submitButton) {
                Silicon4Form.showLoading(submitButton, 'Processing...');
            }
        });
    }
    
    // Helper function to validate modal-selected fields
    function validateModalFields() {
        const accountIdField = document.getElementById('AccountId');
        const clientIdField = document.getElementById('ClientId');
        
        // Clear previous error styling
        const accountDisplay = document.getElementById('AccountIdDisplay');
        const clientDisplay = document.getElementById('ClientIdDisplay');
        
        if (accountDisplay) accountDisplay.style.borderColor = '';
        if (clientDisplay) clientDisplay.style.borderColor = '';
        
        let isValid = true;
        
        // Check AccountId
        if (!accountIdField || !accountIdField.value) {
            if (accountDisplay) {
                accountDisplay.style.borderColor = '#ef4444';
            }
            isValid = false;
        }
        
        // Check ClientId
        if (!clientIdField || !clientIdField.value) {
            if (clientDisplay) {
                clientDisplay.style.borderColor = '#ef4444';
            }
            isValid = false;
        }
        
        return isValid;
    }
    
    // Initialize Document Number Generator for Asset Documents
    DocumentNumberGenerator.initDocumentTypeHandler('{{ form.DocumentTypeId.id_for_label }}', '{{ form.DocumentNo.id_for_label }}');
    
    // Document type change handler - update VAT account when document type changes
    const documentTypeSelect = document.getElementById('id_DocumentTypeId');
    const vatCheckbox = document.getElementById('{{ form.IsVat.id_for_label }}');
    // Make IsVat checkbox non-interactive; controlled by template selection
    if (vatCheckbox) {
        vatCheckbox.disabled = true;
        vatCheckbox.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        });
    }
    if (documentTypeSelect) {
        documentTypeSelect.addEventListener('change', function() {
            // Update VAT account when document type changes
            if (this.value) {
                setVatAccountForDocumentType(this.value);
            }
            // Update templates when document type changes
            updateTemplateDropdown();
        });
    }
    
    // Add click event to account display inputs
    const accountDisplayInput = document.getElementById('AccountIdDisplay');
    if (accountDisplayInput) {
        accountDisplayInput.addEventListener('click', function() {
            handleAccountSelection(document.getElementById('AccountIdDisplay'));
        });
        
        // Clear error styling when user clicks to select
        accountDisplayInput.addEventListener('focus', function() {
            this.style.borderColor = '';
        });
    }
    
    // Add focus event to client display input to clear error styling
    const clientDisplayInput = document.getElementById('ClientIdDisplay');
    if (clientDisplayInput) {
        clientDisplayInput.addEventListener('focus', function() {
            this.style.borderColor = '';
        });
    }
    
    // Listen for account selection changes to update templates
    const accountIdField = document.getElementById('AccountId');
    if (accountIdField) {
        // Use a MutationObserver to detect when the hidden AccountId field value changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                    updateTemplateDropdown();
                }
            });
        });
        observer.observe(accountIdField, { attributes: true, attributeFilter: ['value'] });
        
        // Also listen for direct value changes
        accountIdField.addEventListener('change', updateTemplateDropdown);
    }

    // If editing and both AccountId and DocumentTypeId are preset, populate and preselect template
    (function initializeTemplateOnEdit() {
        const acc = document.getElementById('AccountId');
        const docType = document.getElementById('id_DocumentTypeId');
        if (acc && acc.value && docType && docType.value) {
            updateTemplateDropdown();
        }
    })();
    
    // Auto-populate VAT account when VAT is enabled
    const vatAccountDisplay = document.getElementById('VatAccountIdDisplay');
    const vatAccountHidden = document.getElementById('VatAccountId');
    
    
    // VAT account mapping based on document type (using database constants)
    const vatAccountMapping = {
        // Document types 10 -> VAT_ACCOUNT_RECEIVABLE
        10: { id: '{{ VAT_ACCOUNT_RECEIVABLE }}', display: 'VAT Receivable Account' },
        
        // Document types 11 -> VAT_ACCOUNT_PAYABLE
        11: { id: '{{ VAT_ACCOUNT_PAYABLE }}', display: 'VAT Payable Account' },
    };
    
    // Flag to prevent redundant API calls
    let isUpdatingVatAccount = false;
    
    // Function to fetch account details and update display
    function updateVatAccountDisplay(accountId, displayText) {
        if (!vatAccountDisplay || !vatAccountHidden || isUpdatingVatAccount) return;
        
        // Prevent redundant calls
        isUpdatingVatAccount = true;
        
        // Fetch actual account details from API
        if (accountId) {
            fetch(`/core/api/accounts/${accountId}/details/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const account = data.account;
                        vatAccountDisplay.value = `${account.AccountCode} - ${account.AccountName}`;
                        vatAccountHidden.value = accountId;
                    } else {
                        // Fallback to provided display text
                        vatAccountDisplay.value = displayText;
                        vatAccountHidden.value = accountId;
                    }
                })
                .catch(error => {
                    console.error('Error fetching account details:', error);
                    // Fallback to provided display text
                    vatAccountDisplay.value = displayText;
                    vatAccountHidden.value = accountId;
                })
                .finally(() => {
                    // Reset flag after API call completes
                    isUpdatingVatAccount = false;
                });
        } else {
            // Clear fields
            vatAccountDisplay.value = '';
            vatAccountHidden.value = '';
            isUpdatingVatAccount = false;
        }
    }
    
    // Function to set VAT account based on document type
    function setVatAccountForDocumentType(documentTypeId) {
        if (!documentTypeId) return;
        
        const vatAccount = vatAccountMapping[parseInt(documentTypeId)];
        
        if (vatAccount) {
            updateVatAccountDisplay(vatAccount.id, vatAccount.display);
        } else {
            // Fallback to VAT_ACCOUNT_RECEIVABLE for unknown document types
            updateVatAccountDisplay('{{ VAT_ACCOUNT_RECEIVABLE }}', 'VAT Receivable Account (Default)');
        }
    }
    
    if (vatCheckbox && vatAccountDisplay && vatAccountHidden) {
        // Add a small delay to ensure DOM is fully loaded
        setTimeout(() => {
            // Initialize VAT account on page load
            const documentTypeSelect = document.getElementById('id_DocumentTypeId');
            if (documentTypeSelect && documentTypeSelect.value) {
                setVatAccountForDocumentType(documentTypeSelect.value);
            }
            
            // If VAT is not enabled, clear the VAT account
            if (!vatCheckbox.checked) {
                vatAccountDisplay.value = '';
                vatAccountHidden.value = '';
                const isVatHidden = document.getElementById('IsVatHidden');
                if (isVatHidden) isVatHidden.value = 'false';
            }
        }, 100);
        
        vatCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // Get current document type and set appropriate VAT account
                const documentTypeSelect = document.getElementById('id_DocumentTypeId');
                if (documentTypeSelect && documentTypeSelect.value) {
                    setVatAccountForDocumentType(documentTypeSelect.value);
                } else {
                    // Show message that document type must be selected first
                    updateVatAccountDisplay('', 'Please select document type first');
                }
                
                // VAT account will be set by the setVatAccountForDocumentType call above
            } else {
                // Clear VAT account when VAT is disabled
                updateVatAccountDisplay('', '');
            }
            // Mirror value to hidden field
            const isVatHidden = document.getElementById('IsVatHidden');
            if (isVatHidden) isVatHidden.value = this.checked ? 'true' : 'false';
        });
    }
    
    
    // Initialize hybrid validation for Description field
    try {
        // Get description field
        const descriptionField = document.getElementById('id_Description');
        
        if (descriptionField) {
            // Real-time validation on input
            descriptionField.addEventListener('input', function() {
                validateDescriptionField(this);
            });
            
            // Validation on blur
            descriptionField.addEventListener('blur', function() {
                validateDescriptionField(this);
            });
            
            // Validation on change
            descriptionField.addEventListener('change', function() {
                validateDescriptionField(this);
            });
            
            // Initial validation if there's a value
            if (descriptionField.value) {
                validateDescriptionField(descriptionField);
            }
            
            // Force trigger validation on page load only if field has content
            setTimeout(() => {
                if (descriptionField.value.trim()) {
                    validateDescriptionField(descriptionField);
                }
            }, 100);
        }
    } catch (error) {
        console.error('Error initializing Description validation:', error);
    }
});

// Period lock validation (generic) - align with inventory form
function getCSRFToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    if (token) return token.getAttribute('content');
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') return value;
    }
    const form = document.querySelector('form');
    if (form) {
        const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) return csrfInput.value;
    }
    return '';
}

function showMessageModal(message, type = 'error', title = null) {
    // Fallback to alert if shared modal not present
    const modal = document.getElementById('message-modal');
    if (!modal) { alert(message); return; }
}

function validatePeriodLock(dateValue, callback) {
    if (!dateValue) { callback(false, ''); return; }
    const timeoutId = setTimeout(() => callback(false, ''), 5000);
    fetch(`/core/api/check-period-lock/?date=${dateValue}`, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' }})
        .then(r => { clearTimeout(timeoutId); if (!r.ok) throw new Error(); return r.json(); })
        .then(d => callback(d.is_locked, d.message))
        .catch(() => { clearTimeout(timeoutId); callback(false, ''); });
}

function attachPeriodLockValidation(formSelector, dateInputSelector) {
    const form = document.querySelector(formSelector);
    const dateInput = document.querySelector(dateInputSelector);
    if (!form || !dateInput) return;
    let validationFlag = document.createElement('input');
    validationFlag.type = 'hidden';
    validationFlag.name = 'period_validation_passed';
    validationFlag.value = 'false';
    form.appendChild(validationFlag);
    let apiFailureCount = 0;
    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) { e.preventDefault(); return false; }
        if (validationFlag.value === 'true') return true;
        if (apiFailureCount >= 3) return true;
        e.preventDefault(); e.stopPropagation();
        const dateValue = dateInput.value;
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = submitBtn.innerHTML.replace('Processing...', 'Үүсгэх'); }
        validatePeriodLock(dateValue, function(isLocked, message) {
            if (isLocked) {
                if (typeof showMessageModal === 'function') showMessageModal(message, 'error', 'Тухайн сар цоожлогдсон байна.'); else alert(message);
                dateInput.focus();
                validationFlag.value = 'false';
            } else {
                validationFlag.value = 'true';
                const formData = new FormData(form);
                formData.append('csrfmiddlewaretoken', getCSRFToken());
                fetch(form.action || window.location.href, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' }})
                    .then(response => response.headers.get('content-type')?.includes('application/json') ? response.json() : (window.location.href = response.url || window.location.href, null))
                    .then(data => {
                        if (data) {
                            if (data.success === false && data.error) {
                                if (typeof showMessageModal === 'function') showMessageModal(data.error, 'error', 'Тухайн сар цоожлогдсон байна.'); else alert(data.error);
                                validationFlag.value = 'false';
                            } else if (data && (data.success === true || data.success)) {
                                window.location.href = data.redirect_url || '/core/astdocuments/';
                            } else if (data && data.redirect_url) {
                                window.location.href = data.redirect_url;
                            }
                        }
                    })
                    .catch(() => form.submit());
            }
        });
    });
    const originalValidatePeriodLock = validatePeriodLock;
    validatePeriodLock = function(dateValue, callback) {
        originalValidatePeriodLock(dateValue, function(isLocked, message) {
            if (message === '' && !isLocked) apiFailureCount++;
            callback(isLocked, message);
        });
    };
}

document.addEventListener('DOMContentLoaded', function() {
    try { attachPeriodLockValidation('form', '#id_DocumentDate'); } catch (e) { console.error('Error in attachPeriodLockValidation:', e); }
});

// Function to handle account selection with document type validation
function handleAccountSelection(accountDisplayInput) {
    // Check if document type is selected first
    const documentTypeSelect = document.getElementById('id_DocumentTypeId');
    if (!documentTypeSelect || !documentTypeSelect.value) {
        // Show error message
        Silicon4Message.error('document-type-required');
        
        // Highlight the document type field
        if (documentTypeSelect) {
            documentTypeSelect.focus();
            documentTypeSelect.style.borderColor = '#ef4444';
            setTimeout(() => {
                documentTypeSelect.style.borderColor = '';
            }, 3000);
        }
        
        // Show error in account field
        const accountErrorDiv = document.getElementById('account-id-error');
        if (accountErrorDiv) {
            accountErrorDiv.textContent = 'Please select document type first.';
            accountErrorDiv.style.color = '#ef4444';
        }
        
        return false;
    }
    
    // Clear any previous error messages
    const accountErrorDiv = document.getElementById('account-id-error');
    if (accountErrorDiv) {
        accountErrorDiv.textContent = '';
    }
    
    // If document type is selected, proceed with account selection
    const docTypeSelect = document.getElementById('id_DocumentTypeId');
    const selectedDocumentType = docTypeSelect ? docTypeSelect.value : null;
    
    // Build extra query parameters
    let extraQueryParams = `&document_type_id=${encodeURIComponent(selectedDocumentType)}`;
    
    // Check if we're creating a new record (not editing)
    // If AccountId field is empty or doesn't exist, we're creating new
    const accountIdField = document.getElementById('AccountId');
    const isNewRecord = !accountIdField || !accountIdField.value;
    
    // If creating new record, filter by account types for asset documents
    if (isNewRecord) {
        // Filter by AccountTypeId in (15, 18, 21, 24, 27, 30, 34)
        const assetAccountTypes = '15,18,21,24,27,30,34';
        extraQueryParams += `&account_type=${assetAccountTypes}`;
    }
    
    openAccountPopup(accountDisplayInput, null, { 
        extraQueryParams: extraQueryParams,
        modalTitle: 'Select Account', 
        modalSubtitle: 'Choose an account for asset transactions' 
    });
}

// Description field validation function
function validateDescriptionField(field) {
    const value = field.value.trim();
    const validationDiv = document.getElementById('Description-validation');
    
    // Clear previous validation
    if (validationDiv) {
        validationDiv.classList.add('hidden');
    }
    field.classList.remove('border-red-500', 'border-green-500', 'border-yellow-500');
    field.classList.add('border-gray-300');
    
    let isValid = true;
    let message = '';
    let type = 'success';
    
    // Validation rules
    if (!value) {
        isValid = false;
        message = 'Description is required';
        type = 'error';
    } else if (value.length < 3) {
        isValid = false;
        message = 'Description must be at least 3 characters long';
        type = 'error';
    } else if (value.length > 200) {
        // Auto-truncate if too long
        field.value = value.substring(0, 200);
        message = 'Description truncated to 200 characters';
        type = 'warning';
    } else if (value.length > 199) {
        message = `${value.length}/200 characters - Consider shortening`;
        type = 'warning';
    } else {
        message = `✓ Valid (${value.length}/200 characters)`;
        type = 'success';
    }
    
    // Apply visual feedback
    field.classList.add('border-' + (type === 'error' ? 'red' : type === 'warning' ? 'yellow' : 'green') + '-500');
    
    // Show validation message
    if (validationDiv) {
        validationDiv.textContent = message;
        validationDiv.classList.remove('hidden', 'text-red-600', 'text-yellow-600', 'text-green-600');
        validationDiv.classList.add('text-' + (type === 'error' ? 'red' : type === 'warning' ? 'yellow' : 'green') + '-600');
    }
    
    return isValid;
}

// Expose initial TemplateId for edit mode
const INITIAL_TEMPLATE_ID = {% if item and item.TemplateId %}{{ item.TemplateId.TemplateId }}{% else %}null{% endif %};

// Function to update template dropdown based on selected AccountId and DocumentTypeId
function updateTemplateDropdown() {
    const accountIdField = document.getElementById('AccountId');
    const documentTypeSelect = document.getElementById('id_DocumentTypeId');
    const templateSelect = document.getElementById('TemplateId');
    
    if (!templateSelect) return;
    
    // Clear existing options except the first one
    templateSelect.innerHTML = '<option value="">Template сонгоно уу?</option>';
    
    // Check if both AccountId and DocumentTypeId are selected
    if (!accountIdField || !accountIdField.value || !documentTypeSelect || !documentTypeSelect.value) {
        return;
    }
    
    // Fetch templates via AJAX
    fetch(`/core/api/templates/?account_id=${accountIdField.value}&document_type_id=${documentTypeSelect.value}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.templates) {
                data.templates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.TemplateId;
                    option.textContent = template.TemplateName + (template.IsVat ? ' (VAT)' : '');
                    option.setAttribute('data-isvat', template.IsVat);
                    templateSelect.appendChild(option);
                });

                // Preselect INITIAL_TEMPLATE_ID if present (edit mode)
                if (INITIAL_TEMPLATE_ID) {
                    const exists = Array.from(templateSelect.options).some(opt => String(opt.value) === String(INITIAL_TEMPLATE_ID));
                    if (exists) {
                        templateSelect.value = String(INITIAL_TEMPLATE_ID);
                        // Trigger template selection to sync VAT and related fields
                        handleTemplateSelection(templateSelect);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error loading templates:', error);
        });
}

// Function to handle template selection
function handleTemplateSelection(templateSelect) {
    if (!templateSelect.value) return;
    
    // Get the selected option to check if we have IsVat data
    const selectedOption = templateSelect.options[templateSelect.selectedIndex];
    const isVatFromDropdown = selectedOption.getAttribute('data-isvat');
    
    // If we have IsVat data from dropdown, use it immediately
    if (isVatFromDropdown !== null) {
        const vatCheckbox = document.getElementById('{{ form.IsVat.id_for_label }}');
        if (vatCheckbox) {
            vatCheckbox.checked = isVatFromDropdown === 'true';
                const isVatHidden = document.getElementById('IsVatHidden');
                if (isVatHidden) isVatHidden.value = (isVatFromDropdown === 'true') ? 'true' : 'false';
            // Trigger change event to update VAT-related fields
            vatCheckbox.dispatchEvent(new Event('change'));
        }
    }
    
    
    // Load template details for additional information
    loadTemplateDetails(templateSelect.value);
}

// Function to load template details and populate form fields
function loadTemplateDetails(templateId) {
    fetch(`/core/api/templates/${templateId}/details/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.template) {
                // Populate IsVat checkbox based on template's IsVat value
                const vatCheckbox = document.getElementById('{{ form.IsVat.id_for_label }}');
                if (vatCheckbox) {
                    vatCheckbox.checked = data.template.IsVat;
                        const isVatHidden = document.getElementById('IsVatHidden');
                        if (isVatHidden) isVatHidden.value = data.template.IsVat ? 'true' : 'false';
                    
                    // Trigger change event to update VAT-related fields
                    vatCheckbox.dispatchEvent(new Event('change'));
                }
                
            }
        })
        .catch(error => {
            console.error('Error loading template details:', error);
        });
}

// Global function to clear error styling when modal selections are made
window.clearModalFieldErrors = function() {
    const accountDisplay = document.getElementById('AccountIdDisplay');
    const clientDisplay = document.getElementById('ClientIdDisplay');
    
    if (accountDisplay) accountDisplay.style.borderColor = '';
    if (clientDisplay) clientDisplay.style.borderColor = '';
};
</script>

<!-- Include Client Selection Modal Component -->
{% include 'core/components/client_selection_modal.html' %}

<!-- Include Account Selection Modal Component -->
{% include 'core/components/account_selection_modal.html' %}

{% include 'core/components/message_modal.html' %}
</body>
</html>
