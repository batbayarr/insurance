{% extends 'base.html' %}
{% load static %}
<!-- FORCE NO CACHE -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="cache-bust" content="ASTREPORT-v1.0-2025-01-31">
{% load humanize %}

{% block title %}Asset Journal{% endblock %}

{% block content %}
<script src="{% static 'js/print-journal.js' %}"></script>
<div class="">
    <!-- Date Filter Section -->
    <div class="bg-white shadow rounded-lg p-1 mb-2">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center space-x-2">
                <label for="start-date" class="text-sm font-medium text-gray-700">Эхлэх огноо:</label>
                <input type="date" id="start-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-center space-x-2">
                <label for="end-date" class="text-sm font-medium text-gray-700">Дуусах огноо:</label>
                <input type="date" id="end-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="filter-button" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                СЭРГЭЭХ
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white shadow rounded-lg mb-4">
        <div class="border-b-2 border-gray-300">
            <nav class="flex space-x-2 px-6 p-3">
                <button id="tab-documents" onclick="switchToDocumentsView()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    НЭР ТӨРЛӨӨР
                </button>
                <button id="tab-detail" onclick="switchToDetailView()" class="border border-blue-500 text-blue-600 bg-blue-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ЖУРНАЛ
                </button>
                <button id="tab-balance" onclick="switchToBalanceView()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ДАНСНЫ ҮЛДЭГДЭЛ
                </button>
                <button id="tab-deleted" onclick="showDeletedDocuments()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    УСТГАСАН БАРИМТ
                </button>
                <button id="tab-trial-balance" onclick="switchToTrialBalanceView()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    БАЙГУУЛСАН ЭЛЭГДЭЛ
                </button>
                <button id="tab-depreciation" onclick="switchToDepreciationView()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ЭЛЭГДЛИЙН БИЧИЛТ
                </button>
            </nav>
        </div>
    </div>

    <!-- Asset Documents View (Hidden by default) -->
    <div id="ast-documents-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-24">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-20">Огноо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-20">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-12">БТ</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-40">Харилцагч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-20">Код</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-40">Актив карт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-20">Тоо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-20">Нэгж.өртөг</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-20">нэгж.үнэ</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-30">Нийт өртөг</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-30">Нийт үнэ</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-20">Хэрэглэгч</th>
                    </tr>
                    <!-- Filter Row -->
                    <tr class="bg-gray-100">
                        <td class="px-2 py-1 border-r border-gray-200 w-24">
                            <input type="text" id="filter-document-no" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-20">
                            <input type="text" id="filter-date" placeholder="Filter..."
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-20">
                            <input type="text" id="filter-account" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="9">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-12">
                            <input type="text" id="filter-document-type" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-40">
                            <input type="text" id="filter-client" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-20">
                            <input type="text" id="filter-asset-code" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-40">
                            <input type="text" id="filter-asset-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-20">
                            <input type="text" id="filter-quantity" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-20">
                            <input type="text" id="filter-unit-cost" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-20">
                            <input type="text" id="filter-unit-price" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-30">
                            <input type="text" id="filter-total-cost" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-30">
                            <input type="text" id="filter-total-price" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200 w-20">
                            <input type="text" id="filter-user" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                    </tr>
                </thead>
                <tbody id="documents-tbody" class="bg-white divide-y divide-gray-200">
                    <!-- Documents will be loaded here via AJAX -->
                    <tr>
                        <td colspan="13" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Ready to filter</h3>
                                <p class="text-sm text-gray-500">Select date range and click Filter to load documents.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr class="border-t border-gray-200">
                        <td class="px-2 py-1 text-xs border-r border-gray-200" colspan="7"></td>
                        <td id="ast-total-quantity" class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">0.000</td>
                        <td class="px-1 py-1 text-xs border-r border-gray-200"></td>
                        <td class="px-1 py-1 text-xs border-r border-gray-200"></td>
                        <td id="ast-total-cost" class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">0.00</td>
                        <td id="ast-total-price" class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">0.00</td>
                        <td class="px-1 py-1 text-xs"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info" class="text-sm text-gray-700">
                        Нийт <span id="total-count">0</span> бичлэгээс <span id="showing-start">0</span> - <span id="showing-end">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label for="page-size-select" class="text-sm font-medium text-gray-700">Хуудасны хэмжээ:</label>
                        <select id="page-size-select" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="40">40</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button id="prev-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Previous</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <span id="page-info" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                <!-- Dynamic page buttons will be generated here -->
                            </span>
                            <button id="next-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Next</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Journal Detail View (Hidden by default) -->
    <div id="ast-journal-detail-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
                
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Огноо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дансны нэр</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дебит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Кредит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                    </tr>
                    <!-- Filter Row -->
                    <tr class="bg-gray-100">
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-document-no" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-document-date" placeholder="Filter..."
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-account-code" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="9">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-account-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-client-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-description" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="70">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-debit-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-credit-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-user-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    <!-- Detail data will be loaded here via AJAX -->
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load journal details.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for ЖУРНАЛ tab -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page-detail" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page-detail" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info-detail" class="text-sm text-gray-700">
                        Нийт <span id="total-count-detail">0</span> бичлэгээс <span id="showing-start-detail">0</span> - <span id="showing-end-detail">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <button onclick="printDetailView()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                            ХЭВЛЭХ
                        </button>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page-desktop-detail" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span id="page-info-detail" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            <!-- Dynamic page buttons will be generated here -->
                        </span>
                    <button id="next-page-desktop-detail" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Account Balance View (Hidden by default) -->
    <div id="ast-balance-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Код</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Актив карт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Эх.үлдэгдэл</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Эх.өртөг</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Орлого</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ор.өртөг</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Зарлага</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Зар.өртөг</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Эц.үлдэгдэл</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Эц.өртөг</th>
                    </tr>
                    <!-- Filter Row -->
                    <tr class="bg-gray-100">
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-account" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="9">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-asset-code" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-asset-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-beginning-quantity" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-beginning-cost" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-in-quantity" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-in-cost" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-out-quantity" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-out-cost" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-ending-quantity" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-balance-ending-cost" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                    </tr>
                </thead>
                <tbody id="balance-tbody" class="bg-white">
                    <!-- Balance data will be loaded here via AJAX -->
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load account balance.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for ДАНСНЫ ҮЛДЭГДЭЛ tab -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page-balance" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page-balance" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info-balance" class="text-sm text-gray-700">
                        Нийт <span id="total-count-balance">0</span> бичлэгээс <span id="showing-start-balance">0</span> - <span id="showing-end-balance">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label for="page-size-select-balance" class="text-sm font-medium text-gray-700">Хуудасны хэмжээ:</label>
                        <select id="page-size-select-balance" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="40">40</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button id="prev-page-desktop-balance" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Previous</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <span id="page-info-balance" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                <!-- Dynamic page buttons will be generated here -->
                            </span>
                            <button id="next-page-desktop-balance" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Next</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- БАЙГУУЛСАН ЭЛЭГДЭЛ View (Hidden by default) -->
    <div id="ast-trial-balance-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хөрөнгө</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хон.элэг</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хоног</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Байгуулсан</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Үүсгэсэн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Зардал</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Элэгдэл</th>
                    </tr>
                </thead>
                <tbody id="trial-balance-tbody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="10" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load data.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for БАЙГУУЛСАН ЭЛЭГДЭЛ tab -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page-tb" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page-tb" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info-tb" class="text-sm text-gray-700">
                        Нийт <span id="total-count-tb">0</span> бичлэгээс <span id="showing-start-tb">0</span> - <span id="showing-end-tb">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label for="page-size-select-tb" class="text-sm font-medium text-gray-700">Хуудасны хэмжээ:</label>
                        <select id="page-size-select-tb" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="40">40</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button id="prev-page-desktop-tb" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Previous</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <span id="page-info-tb" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                <!-- Dynamic page buttons will be generated here -->
                            </span>
                            <button id="next-page-desktop-tb" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Next</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ЭЛЭГДЛИЙН БИЧИЛТ View (Hidden by default) -->
    <div id="ast-depreciation-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Огноо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дансны нэр</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валютын дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ханш</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дебит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Кредит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                    </tr>
                </thead>
                <tbody id="depreciation-tbody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load data.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for ЭЛЭГДЛИЙН БИЧИЛТ tab -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page-dep" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page-dep" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info-dep" class="text-sm text-gray-700">
                        Нийт <span id="total-count-dep">0</span> бичлэгээс <span id="showing-start-dep">0</span> - <span id="showing-end-dep">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page-desktop-dep" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span id="page-info-dep" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            <!-- Dynamic page buttons will be generated here -->
                        </span>
                        <button id="next-page-desktop-dep" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Asset Journal - Optimized Version
    
    // Global variables
    let documentsData = [];
    let detailsData = [];  // For ЖУРНАЛ tab
    let currentPage = 1;
    let pageSize = 20;
    let totalPages = 1;
    let isDeleteFilter = false;
    let isRendering = false;
    
    // Pagination variables for ЖУРНАЛ tab
    let currentPageDetail = 1;
    let pageSizeDetail = 20;
    let totalPagesDetail = 1;
    
    // Balance data and pagination variables for ДАНСНЫ ҮЛДЭГДЭЛ tab
    let balanceData = [];
    let currentPageBalance = 1;
    let pageSizeBalance = 20;
    let totalPagesBalance = 1;
    
    // Trial balance and depreciation data for new tabs
    let trialBalanceData = [];
    let currentPageTrialBalance = 1;
    let pageSizeTrialBalance = 20;
    let totalPagesTrialBalance = 1;
    
    let depreciationData = [];
    let currentPageDepreciation = 1;
    let pageSizeDepreciation = 20;
    let totalPagesDepreciation = 1;
    
    // API cache
    let apiCache = new Map();
    let currentCacheKey = '';
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        initializeAll();
    });
    
    function initializeAll() {
        initializeDateInputs();
        initializeFilters();
        initializePagination();
        loadInitialDocuments();
    }
    
    function initializeDateInputs() {
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const pageSizeSelect = document.getElementById('page-size-select');
        
        
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                const newPageSize = parseInt(this.value);
                pageSize = newPageSize;
                pageSizeDetail = newPageSize; // Also update detail page size
                currentPage = 1; // Reset to first page when changing page size
                currentPageDetail = 1; // Reset detail page too
                if (documentsData && documentsData.length > 0) {
                    applyFrontendFilter();
                }
                if (detailsData && detailsData.length > 0) {
                    renderDetailsTableWithPagination(detailsData);
                }
            });
        }
    }
    
    function initializeFilters() {
        // Initialize filters for НЭР ТӨРЛӨӨР tab
        const filterInputs = document.querySelectorAll('#ast-documents-view input[placeholder="Filter..."]');
        filterInputs.forEach((input, index) => {
            input.addEventListener('input', applyFilters);
        });
        
        // Initialize filters for ЖУРНАЛ tab
        const detailFilterInputs = document.querySelectorAll('#ast-journal-detail-view input[placeholder="Filter..."]');
        detailFilterInputs.forEach((input, index) => {
            input.addEventListener('input', applyDetailFiltersAndRender);
        });
        
        // Initialize filters for ДАНСНЫ ҮЛДЭГДЭЛ tab
        const balanceFilterInputs = document.querySelectorAll('#ast-balance-view input[placeholder="Filter..."]');
        balanceFilterInputs.forEach((input, index) => {
            input.addEventListener('input', applyBalanceFilters);
        });
    }
    
    function applyDetailFiltersAndRender() {
        // Debounce the filter application
        clearTimeout(window.detailFilterTimeout);
        window.detailFilterTimeout = setTimeout(() => {
            if (detailsData && detailsData.length > 0) {
                currentPageDetail = 1; // Reset to first page when filtering
                renderDetailsTableWithPagination(detailsData);
            }
        }, 300);
    }
    
    function initializePagination() {
        // БАРИМТ tab pagination
        const prevPage = document.getElementById('prev-page');
        const nextPage = document.getElementById('next-page');
        const prevPageDesktop = document.getElementById('prev-page-desktop');
        const nextPageDesktop = document.getElementById('next-page-desktop');
        
        if (prevPage) prevPage.addEventListener('click', () => changePage(currentPage - 1));
        if (nextPage) nextPage.addEventListener('click', () => changePage(currentPage + 1));
        if (prevPageDesktop) prevPageDesktop.addEventListener('click', () => changePage(currentPage - 1));
        if (nextPageDesktop) nextPageDesktop.addEventListener('click', () => changePage(currentPage + 1));
        
        // ЖУРНАЛ tab pagination
        const prevPageDetail = document.getElementById('prev-page-detail');
        const nextPageDetail = document.getElementById('next-page-detail');
        const prevPageDesktopDetail = document.getElementById('prev-page-desktop-detail');
        const nextPageDesktopDetail = document.getElementById('next-page-desktop-detail');
        
        if (prevPageDetail) prevPageDetail.addEventListener('click', () => changePageDetail(currentPageDetail - 1));
        if (nextPageDetail) nextPageDetail.addEventListener('click', () => changePageDetail(currentPageDetail + 1));
        if (prevPageDesktopDetail) prevPageDesktopDetail.addEventListener('click', () => changePageDetail(currentPageDetail - 1));
        if (nextPageDesktopDetail) nextPageDesktopDetail.addEventListener('click', () => changePageDetail(currentPageDetail + 1));
        
        // ДАНСНЫ ҮЛДЭГДЭЛ tab pagination
        const prevPageBalance = document.getElementById('prev-page-balance');
        const nextPageBalance = document.getElementById('next-page-balance');
        const prevPageDesktopBalance = document.getElementById('prev-page-desktop-balance');
        const nextPageDesktopBalance = document.getElementById('next-page-desktop-balance');
        const pageSizeSelectBalance = document.getElementById('page-size-select-balance');
        
        if (prevPageBalance) prevPageBalance.addEventListener('click', () => changePageBalance(currentPageBalance - 1));
        if (nextPageBalance) nextPageBalance.addEventListener('click', () => changePageBalance(currentPageBalance + 1));
        if (prevPageDesktopBalance) prevPageDesktopBalance.addEventListener('click', () => changePageBalance(currentPageBalance - 1));
        if (nextPageDesktopBalance) nextPageDesktopBalance.addEventListener('click', () => changePageBalance(currentPageBalance + 1));
        
        if (pageSizeSelectBalance) {
            pageSizeSelectBalance.addEventListener('change', function() {
                const newPageSize = parseInt(this.value);
                pageSizeBalance = newPageSize;
                currentPageBalance = 1; // Reset to first page when changing page size
                if (balanceData && balanceData.length > 0) {
                    applyBalanceFilter();
                }
            });
        }
        
        // БАЙГУУЛСАН ЭЛЭГДЭЛ tab pagination
        const prevPageTb = document.getElementById('prev-page-tb');
        const nextPageTb = document.getElementById('next-page-tb');
        const prevPageDesktopTb = document.getElementById('prev-page-desktop-tb');
        const nextPageDesktopTb = document.getElementById('next-page-desktop-tb');
        const pageSizeSelectTb = document.getElementById('page-size-select-tb');
        
        if (prevPageTb) prevPageTb.addEventListener('click', () => changePageTrialBalance(currentPageTrialBalance - 1));
        if (nextPageTb) nextPageTb.addEventListener('click', () => changePageTrialBalance(currentPageTrialBalance + 1));
        if (prevPageDesktopTb) prevPageDesktopTb.addEventListener('click', () => changePageTrialBalance(currentPageTrialBalance - 1));
        if (nextPageDesktopTb) nextPageDesktopTb.addEventListener('click', () => changePageTrialBalance(currentPageTrialBalance + 1));
        
        if (pageSizeSelectTb) {
            pageSizeSelectTb.addEventListener('change', function() {
                const newPageSize = parseInt(this.value);
                pageSizeTrialBalance = newPageSize;
                currentPageTrialBalance = 1;
                if (trialBalanceData && trialBalanceData.length > 0) {
                    renderTrialBalanceTable();
                }
            });
        }
        
        // ЭЛЭГДЛИЙН БИЧИЛТ tab pagination
        const prevPageDep = document.getElementById('prev-page-dep');
        const nextPageDep = document.getElementById('next-page-dep');
        const prevPageDesktopDep = document.getElementById('prev-page-desktop-dep');
        const nextPageDesktopDep = document.getElementById('next-page-desktop-dep');
        
        if (prevPageDep) prevPageDep.addEventListener('click', () => changePageDepreciation(currentPageDepreciation - 1));
        if (nextPageDep) nextPageDep.addEventListener('click', () => changePageDepreciation(currentPageDepreciation + 1));
        if (prevPageDesktopDep) prevPageDesktopDep.addEventListener('click', () => changePageDepreciation(currentPageDepreciation - 1));
        if (nextPageDesktopDep) nextPageDesktopDep.addEventListener('click', () => changePageDepreciation(currentPageDepreciation + 1));
    }
    
    function loadInitialDocuments() {
        setDefaultDateValues();
        
        // Set default active tab to ЖУРНАЛ (detail view)
        updateTabStyling('detail');
        
        // Ensure balance view and new views are hidden on initial load
        const balanceView = document.getElementById('ast-balance-view');
        if (balanceView) {
            balanceView.style.display = 'none';
        }
        const trialBalanceView = document.getElementById('ast-trial-balance-view');
        if (trialBalanceView) {
            trialBalanceView.style.display = 'none';
        }
        const depreciationView = document.getElementById('ast-depreciation-view');
        if (depreciationView) {
            depreciationView.style.display = 'none';
        }
        
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (startDate && endDate) {
            applyDateFilter();
        }
    }
    
    function setDefaultDateValues() {
        // Use user's local system date
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        // Format dates for HTML date input (YYYY-MM-DD)
        const formatDateForInput = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        
        if (startDateInput && !startDateInput.value) {
            startDateInput.value = formatDateForInput(firstDay);
        }
        if (endDateInput && !endDateInput.value) {
            endDateInput.value = formatDateForInput(lastDay);
        }
    }
    
    function applyDateFilter() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        // Clear cache before new API call
        apiCache.clear();
        currentCacheKey = '';
        isDeleteFilter = false;
        
        // Show loading state
        const filterButton = document.getElementById('filter-button');
        if (filterButton) {
            filterButton.textContent = 'Loading...';
            filterButton.disabled = true;
        }
        
        // Fetch ALL documents (both active and deleted) from server
        fetchAllDocumentsFromServer();
    }
    
    function fetchAllDocumentsFromServer() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // Fetch ALL data (documents + details) for all tabs in one call
        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate,
            page: '1',
            page_size: '2000'  // Large page size to get all records
        });
        
        const cacheKey = `${startDate}_${endDate}_comprehensive_data`;
        
        if (apiCache.has(cacheKey)) {
            const cachedData = apiCache.get(cacheKey);
            documentsData = cachedData.documents;
            detailsData = cachedData.details;
            
                    // Show documents view by default after loading from cache
                    const detailView = document.getElementById('ast-journal-detail-view');
                    const documentsView = document.getElementById('ast-documents-view');
                    const balanceView = document.getElementById('ast-balance-view');
                    const trialBalanceView = document.getElementById('ast-trial-balance-view');
                    const depreciationView = document.getElementById('ast-depreciation-view');
                    if (documentsView && detailView) {
                        documentsView.style.display = 'block';
                        detailView.style.display = 'none';
                        if (balanceView) {
                            balanceView.style.display = 'none';
                        }
                        if (trialBalanceView) {
                            trialBalanceView.style.display = 'none';
                        }
                        if (depreciationView) {
                            depreciationView.style.display = 'none';
                        }
                        updateTabStyling('documents');
                    } else {
                        // If views don't exist yet, just update tab styling
                        updateTabStyling('documents');
                    }
            
            applyFrontendFilter();
            return;
        }
        
        const url = `/core/api/ast-documents-filtered/?${params}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cache the response
                    apiCache.set(cacheKey, data);
                    currentCacheKey = cacheKey;
                    
                    // Store both documents and details data
                    documentsData = data.documents;
                    detailsData = data.details;
                    
                    // Show documents view by default after loading
                    const detailView = document.getElementById('ast-journal-detail-view');
                    const documentsView = document.getElementById('ast-documents-view');
                    const balanceView = document.getElementById('ast-balance-view');
                    const trialBalanceView = document.getElementById('ast-trial-balance-view');
                    const depreciationView = document.getElementById('ast-depreciation-view');
                    if (documentsView && detailView) {
                        documentsView.style.display = 'block';
                        detailView.style.display = 'none';
                        if (balanceView) {
                            balanceView.style.display = 'none';
                        }
                        if (trialBalanceView) {
                            trialBalanceView.style.display = 'none';
                        }
                        if (depreciationView) {
                            depreciationView.style.display = 'none';
                        }
                        updateTabStyling('documents');
                    } else {
                        // If views don't exist yet, just update tab styling
                        updateTabStyling('documents');
                    }
                    
                    applyFrontendFilter();
                    
                    // Also fetch trial balance and depreciation data
                    Promise.all([
                        fetchTrialBalanceData(startDate, endDate),
                        fetchDepreciationJournalData(startDate, endDate)
                    ]).catch(error => {
                        console.error('Error fetching additional data:', error);
                    });
                } else {
                    showDocumentsError(data.error || 'Failed to load comprehensive data');
                }
            })
            .catch(error => {
                showDocumentsError('Network error occurred');
            })
            .finally(() => {
                // Reset filter button
                const filterButton = document.getElementById('filter-button');
                if (filterButton) {
                    filterButton.textContent = 'СЭРГЭЭХ';
                    filterButton.disabled = false;
                }
            });
    }
    
    function applyFrontendFilter() {
        if (!documentsData || documentsData.length === 0) {
            return;
        }
        
        let filteredData = documentsData;
        
        // Apply delete filter based on current tab
        if (isDeleteFilter) {
            // Show only deleted documents
            filteredData = documentsData.filter(doc => doc.IsDelete === true);
        } else {
            // Show only active documents
            filteredData = documentsData.filter(doc => doc.IsDelete === false);
        }
        
        // Apply column filters if any
        const filterInputs = document.querySelectorAll('input[placeholder="Filter..."]');
        const filters = Array.from(filterInputs).map(input => input.value.toLowerCase().trim());
        
        if (filters.some(filter => filter.length > 0)) {
            filteredData = filteredData.filter(doc => {
                const values = [
                    String(doc.DocumentNo || '').toLowerCase(),
                    String(doc.DocumentDate || '').toLowerCase(),
                    String(doc.AccountCode || '').toLowerCase(),
                    String(doc.DocumentTypeCode || '').toLowerCase(),
                    String(doc.ClientName || '').toLowerCase(),
                    String(doc.AssetCardCode || '').toLowerCase(),
                    String(doc.AssetCardName || '').toLowerCase(),
                    String(doc.Quantity || '').toLowerCase(),
                    String(doc.UnitCost || '').toLowerCase(),
                    String(doc.UnitPrice || '').toLowerCase(),
                    String(doc.TotalCost || '').toLowerCase(),
                    String(doc.TotalPrice || '').toLowerCase(),
                    String(doc.UserName || doc.CreatedBy || '').toLowerCase()
                ];
                
                return filters.every((filter, index) => 
                    !filter || values[index].includes(filter)
                );
            });
        }
        
        // Calculate totals for ALL filtered data (not just current page)
        let totalQuantity = 0;
        let totalCost = 0;
        let totalPrice = 0;
        filteredData.forEach(doc => {
            totalQuantity += parseFloat(doc.Quantity || 0);
            totalCost += parseFloat(doc.TotalCost || 0);
            totalPrice += parseFloat(doc.TotalPrice || 0);
        });
        
        // Calculate pagination
        totalPages = Math.ceil(filteredData.length / pageSize);
        if (currentPage > totalPages) currentPage = 1;
        
        // Get paginated data
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const paginatedData = filteredData.slice(startIndex, endIndex);
        
        // Update pagination info
        updatePaginationInfo(filteredData.length, paginatedData.length, startIndex);
        
        // Use normal rendering with paginated data
        renderDocumentsTable(paginatedData);
        
        // Update summary totals with ALL filtered data totals
        updateSummaryTotals(totalQuantity, totalCost, totalPrice);
    }
    
    function renderDocumentsTable(documents) {
        if (isRendering) {
            return;
        }
        
        isRendering = true;
        
        const tbody = document.getElementById('documents-tbody');
        if (!tbody) {
            isRendering = false;
            return;
        }
        
        if (!documents || documents.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="13" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-sm font-medium text-gray-900 mb-1">No documents found</h3>
                            <p class="text-sm text-gray-500">No documents found in the selected date range.</p>
                        </div>
                    </td>
                </tr>
            `;
            isRendering = false;
            return;
        }
        
        // Use normal rendering
        renderNormalTable(documents);
        
        isRendering = false;
    }
    
    function renderNormalTable(documents) {
        const tbody = document.getElementById('documents-tbody');
        
        // Clear existing content
        tbody.innerHTML = '';
        
        // Use DocumentFragment for better performance
        const fragment = document.createDocumentFragment();
        
        documents.forEach((doc, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            // Pre-format data for better performance
            const documentNo = doc.DocumentNo || '';
            const documentDate = doc.DocumentDate || '';
            const accountCode = doc.AccountCode || '';
            const documentType = doc.DocumentTypeCode || '';
            const clientName = doc.ClientName || '';
            const assetCode = doc.AssetCardCode || '';
            const assetName = doc.AssetCardName || '';
            const quantity = formatNumber(doc.Quantity || 0, 3);
            const unitCost = formatNumber(doc.UnitCost || 0, 2);
            const unitPrice = formatNumber(doc.UnitPrice || 0, 2);
            const totalCost = formatNumber(doc.TotalCost || 0, 2);
            const totalPrice = formatNumber(doc.TotalPrice || 0, 2);
            const userName = doc.UserName || doc.CreatedBy || 'N/A';
            
            row.innerHTML = `
                <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${documentNo}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${documentDate}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${accountCode}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${documentType}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${clientName}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${assetCode}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${assetName}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${quantity}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${unitCost}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${unitPrice}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalCost}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalPrice}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${userName}</td>
            `;
            
            fragment.appendChild(row);
        });
        
        tbody.appendChild(fragment);
    }
    
    function updateSummaryTotals(totalQuantity, totalCost, totalPrice) {
        const totalQuantityEl = document.getElementById('ast-total-quantity');
        const totalCostEl = document.getElementById('ast-total-cost');
        const totalPriceEl = document.getElementById('ast-total-price');
        
        if (totalQuantityEl) {
            totalQuantityEl.textContent = formatNumber(totalQuantity, 3);
        }
        if (totalCostEl) {
            totalCostEl.textContent = formatNumber(totalCost, 2);
        }
        if (totalPriceEl) {
            totalPriceEl.textContent = formatNumber(totalPrice, 2);
        }
    }
    
    
    function updatePaginationInfo(totalRecords, currentRecords, startIndex) {
        const showingStart = document.getElementById('showing-start');
        const showingEnd = document.getElementById('showing-end');
        const totalCount = document.getElementById('total-count');
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        
        // Generate dynamic pagination
        generatePaginationButtons();
    }
    
    function generatePaginationButtons() {
        const pageInfo = document.getElementById('page-info');
        if (!pageInfo) return;
        
        // Clear existing buttons
        pageInfo.innerHTML = '';
        
        // Calculate pagination range
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // Generate page buttons
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPage 
                    ? 'bg-blue-400 text-white hover:bg-blue-500' 
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePage(i));
            pageInfo.appendChild(button);
        }
    }
    
    function changePage(newPage) {
        if (newPage < 1 || newPage > totalPages) return;
        
        currentPage = newPage;
        // Use frontend filtering instead of server call for better performance
        if (documentsData && documentsData.length > 0) {
            applyFrontendFilter();
        } else {
            fetchAllDocumentsFromServer();
        }
    }
    
    function changePageDetail(newPage) {
        if (newPage < 1 || newPage > totalPagesDetail) return;
        
        currentPageDetail = newPage;
        // Re-render details table with pagination
        if (detailsData && detailsData.length > 0) {
            renderDetailsTableWithPagination(detailsData);
        }
    }
    
    function applyFilters() {
        // Debounce the filter application
        clearTimeout(window.filterTimeout);
        window.filterTimeout = setTimeout(applyFiltersImmediate, 300);
    }
    
    function applyFiltersImmediate() {
        applyFrontendFilter();
    }
    
    function showDocumentsError(message) {
        const tbody = document.getElementById('documents-tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="13" class="px-4 py-8 text-center text-red-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="text-sm font-medium text-red-900 mb-1">Error loading documents</h3>
                            <p class="text-sm text-red-500">${message}</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    function switchToDetailView() {
        // Show the detail view
        document.getElementById('ast-journal-detail-view').style.display = 'block';
        
        // Hide the documents view
        document.getElementById('ast-documents-view').style.display = 'none';
        
        // Hide the balance view
        document.getElementById('ast-balance-view').style.display = 'none';
        
        // Hide the new views
        document.getElementById('ast-trial-balance-view').style.display = 'none';
        document.getElementById('ast-depreciation-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('detail');
        
        // Check if we have cached details data
        if (detailsData && detailsData.length > 0) {
            renderDetailsTable(detailsData);
        } else {
            const tbody = document.querySelector('#ast-journal-detail-view tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 012-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load journal details.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    function renderDetailsTable(details) {
        // Use the new paginated version
        renderDetailsTableWithPagination(details);
    }
    
    function renderDetailsTableWithPagination(details) {
        const tbody = document.querySelector('#ast-journal-detail-view tbody');
        if (!tbody) {
            return;
        }
        
        if (!details || details.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-sm font-medium text-gray-900 mb-1">No detail data found</h3>
                            <p class="text-sm text-gray-500">No document details found in the selected date range.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Apply filters first
        const filteredDetails = applyDetailFilters(details);
        
        // Calculate pagination on filtered data
        totalPagesDetail = Math.ceil(filteredDetails.length / pageSizeDetail);
        if (currentPageDetail > totalPagesDetail) currentPageDetail = 1;
        
        // Get paginated data from filtered results
        const startIndex = (currentPageDetail - 1) * pageSizeDetail;
        const endIndex = startIndex + pageSizeDetail;
        const paginatedDetails = filteredDetails.slice(startIndex, endIndex);
        
        // Update pagination info
        updatePaginationInfoDetail(filteredDetails.length, paginatedDetails.length, startIndex);
        
        // Group details by document (document_no + document_date)
        const groupedByDocument = {};
        paginatedDetails.forEach((item) => {
            const docKey = `${item.document_no}_${item.document_date}`;
            if (!groupedByDocument[docKey]) {
                groupedByDocument[docKey] = [];
            }
            groupedByDocument[docKey].push(item);
        });
        
        let htmlContent = '';
        let totalDebit = 0;
        let totalCredit = 0;
        
        // Render grouped by document with borders
        Object.keys(groupedByDocument).forEach((docKey, docIndex) => {
            const docItems = groupedByDocument[docKey];
            const isLastDocument = docIndex === Object.keys(groupedByDocument).length - 1;
            
            docItems.forEach((item, itemIndex) => {
                // Calculate totals
                totalDebit += parseFloat(item.debit_amount) || 0;
                totalCredit += parseFloat(item.credit_amount) || 0;
                
                const isLastItem = itemIndex === docItems.length - 1;
                // Add border only after the last row of each document batch (except the last document)
                // No borders between rows within the same document batch
                // Use same style as column borders (border-b border-gray-200)
                const rowBorderClass = isLastItem && !isLastDocument 
                    ? 'border-b border-gray-200' 
                    : '';
                
                htmlContent += `
                    <tr class="hover:bg-gray-50 ${rowBorderClass}">
                        <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_no || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_date || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_code || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_name || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.client_name || ''}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.description || ''}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.debit_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.credit_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.user_name || ''}</td>
                    </tr>
                `;
            });
        });
        
        // Add totals row
        htmlContent += `
            <tr class="bg-gray-100 border-t border-gray-200">
                <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200" colspan="6">НИЙТ:</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalDebit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalCredit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200"></td>
            </tr>
        `;
        
        tbody.innerHTML = htmlContent;
    }
    
    function applyDetailFilters(details) {
        if (!details || details.length === 0) {
            return [];
        }
        
        let filtered = details;
        
        // Get filter values
        const filters = {
            documentNo: document.getElementById('filter-detail-document-no')?.value.toLowerCase().trim() || '',
            documentDate: document.getElementById('filter-detail-document-date')?.value.toLowerCase().trim() || '',
            accountCode: document.getElementById('filter-detail-account-code')?.value.toLowerCase().trim() || '',
            accountName: document.getElementById('filter-detail-account-name')?.value.toLowerCase().trim() || '',
            clientName: document.getElementById('filter-detail-client-name')?.value.toLowerCase().trim() || '',
            description: document.getElementById('filter-detail-description')?.value.toLowerCase().trim() || '',
            debitAmount: document.getElementById('filter-detail-debit-amount')?.value.toLowerCase().trim() || '',
            creditAmount: document.getElementById('filter-detail-credit-amount')?.value.toLowerCase().trim() || '',
            userName: document.getElementById('filter-detail-user-name')?.value.toLowerCase().trim() || ''
        };
        
        // Apply filters
        if (Object.values(filters).some(f => f.length > 0)) {
            filtered = details.filter(item => {
                const values = {
                    documentNo: String(item.document_no || '').toLowerCase(),
                    documentDate: String(item.document_date || '').toLowerCase(),
                    accountCode: String(item.account_code || '').toLowerCase(),
                    accountName: String(item.account_name || '').toLowerCase(),
                    clientName: String(item.client_name || '').toLowerCase(),
                    description: String(item.description || '').toLowerCase(),
                    debitAmount: String(item.debit_amount || '').toLowerCase(),
                    creditAmount: String(item.credit_amount || '').toLowerCase(),
                    userName: String(item.user_name || '').toLowerCase()
                };
                
                return Object.keys(filters).every(key => {
                    const filterValue = filters[key];
                    if (!filterValue) return true;
                    
                    // Handle numeric filters
                    if (key.includes('Amount')) {
                        if (filterValue.startsWith('>=')) {
                            const num = parseFloat(filterValue.substring(2));
                            return !isNaN(num) && parseFloat(values[key]) >= num;
                        } else if (filterValue.startsWith('<=')) {
                            const num = parseFloat(filterValue.substring(2));
                            return !isNaN(num) && parseFloat(values[key]) <= num;
                        } else if (filterValue.startsWith('>')) {
                            const num = parseFloat(filterValue.substring(1));
                            return !isNaN(num) && parseFloat(values[key]) > num;
                        } else if (filterValue.startsWith('<')) {
                            const num = parseFloat(filterValue.substring(1));
                            return !isNaN(num) && parseFloat(values[key]) < num;
                        } else if (filterValue.startsWith('=')) {
                            const num = parseFloat(filterValue.substring(1));
                            return !isNaN(num) && parseFloat(values[key]) === num;
                        } else {
                            const num = parseFloat(filterValue);
                            if (!isNaN(num)) {
                                return parseFloat(values[key]) === num;
                            }
                        }
                    }
                    
                    // Text filters
                    return values[key].includes(filterValue);
                });
            });
        }
        
        return filtered;
    }
    
    function updatePaginationInfoDetail(totalRecords, currentRecords, startIndex) {
        const showingStart = document.getElementById('showing-start-detail');
        const showingEnd = document.getElementById('showing-end-detail');
        const totalCount = document.getElementById('total-count-detail');
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        
        // Generate dynamic pagination
        generatePaginationButtonsDetail();
    }
    
    function generatePaginationButtonsDetail() {
        const pageInfo = document.getElementById('page-info-detail');
        if (!pageInfo) return;
        
        // Clear existing buttons
        pageInfo.innerHTML = '';
        
        // Calculate pagination range
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPageDetail - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPagesDetail, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // Generate page buttons
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPageDetail 
                    ? 'bg-blue-400 text-white hover:bg-blue-500' 
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePageDetail(i));
            pageInfo.appendChild(button);
        }
    }
    
    function switchToDocumentsView() {
        // Show the documents view
        document.getElementById('ast-documents-view').style.display = 'block';
        
        // Hide the detail view
        document.getElementById('ast-journal-detail-view').style.display = 'none';
        
        // Hide the balance view
        document.getElementById('ast-balance-view').style.display = 'none';
        
        // Hide the new views
        document.getElementById('ast-trial-balance-view').style.display = 'none';
        document.getElementById('ast-depreciation-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('documents');
        
        // Set to active documents filter
        isDeleteFilter = false;
        
        // Check if we have data to display
        if (documentsData && documentsData.length > 0) {
            applyFrontendFilter();
        } else {
            const tbody = document.getElementById('documents-tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load documents.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    
    function showDeletedDocuments() {
        // Show the documents view
        document.getElementById('ast-documents-view').style.display = 'block';
        
        // Hide the detail view
        document.getElementById('ast-journal-detail-view').style.display = 'none';
        
        // Hide the balance view
        document.getElementById('ast-balance-view').style.display = 'none';
        
        // Hide the new views
        document.getElementById('ast-trial-balance-view').style.display = 'none';
        document.getElementById('ast-depreciation-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('deleted');
        
        // Set to deleted documents filter
        isDeleteFilter = true;
        
        // Check if we have data to display
        if (documentsData && documentsData.length > 0) {
            applyFrontendFilter();
        } else {
            const tbody = document.getElementById('documents-tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load deleted documents.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    
    function updateTabStyling(activeTab) {
        // Use IDs for more reliable tab selection
        const tabDocuments = document.getElementById('tab-documents');
        const tabDetail = document.getElementById('tab-detail');
        const tabBalance = document.getElementById('tab-balance');
        const tabDeleted = document.getElementById('tab-deleted');
        const tabTrialBalance = document.getElementById('tab-trial-balance');
        const tabDepreciation = document.getElementById('tab-depreciation');
        
        // Reset all tabs
        [tabDocuments, tabDetail, tabBalance, tabDeleted, tabTrialBalance, tabDepreciation].forEach(tab => {
            if (tab) {
                tab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
                tab.classList.add('border-gray-300', 'text-gray-500');
            }
        });
        
        // Set active tab
        if (activeTab === 'documents' && tabDocuments) {
            tabDocuments.classList.remove('border-gray-300', 'text-gray-500');
            tabDocuments.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        } else if (activeTab === 'detail' && tabDetail) {
            tabDetail.classList.remove('border-gray-300', 'text-gray-500');
            tabDetail.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        } else if (activeTab === 'balance' && tabBalance) {
            tabBalance.classList.remove('border-gray-300', 'text-gray-500');
            tabBalance.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        } else if (activeTab === 'deleted' && tabDeleted) {
            tabDeleted.classList.remove('border-gray-300', 'text-gray-500');
            tabDeleted.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        } else if (activeTab === 'trial-balance' && tabTrialBalance) {
            tabTrialBalance.classList.remove('border-gray-300', 'text-gray-500');
            tabTrialBalance.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        } else if (activeTab === 'depreciation' && tabDepreciation) {
            tabDepreciation.classList.remove('border-gray-300', 'text-gray-500');
            tabDepreciation.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        }
    }
    
    function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || isNaN(value)) return '0.00';
        return parseFloat(value).toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }
    
    // Print function for ЖУРНАЛ tab
    function printDetailView() {
        // Check if we have data to print
        if (!detailsData || detailsData.length === 0) {
            alert('No data to print. Please load data first.');
            return;
        }
        
        // Get date range from filter inputs
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // Calculate grand totals from ALL filtered data (not just current page)
        let totalDebit = 0;
        let totalCredit = 0;
        
        detailsData.forEach((item) => {
            totalDebit += parseFloat(item.debit_amount) || 0;
            totalCredit += parseFloat(item.credit_amount) || 0;
        });
        
        // Define column headers (excluding "Дансны нэр" and "Хэрэглэгч" columns)
        const columnHeaders = [
            'Баримт',
            'Огноо',
            'Данс',
            'Харилцагч',
            'Гүйлгээний утга',
            'Дебит дүн',
            'Кредит дүн'
        ];
        
        // Call the generic print function
        if (typeof window.printJournalTable === 'function') {
            window.printJournalTable({
                title: 'Asset Journal - ЖУРНАЛ',
                startDate: startDate,
                endDate: endDate,
                allData: detailsData, // All filtered rows, not just current page
                columnHeaders: columnHeaders,
                totals: {
                    debit: totalDebit,
                    credit: totalCredit
                }
            });
        } else {
            alert('Print system not loaded. Please refresh the page.');
        }
    }
    
    // Switch to balance view
    function switchToBalanceView() {
        // Show the balance view
        document.getElementById('ast-balance-view').style.display = 'block';
        
        // Hide other views
        document.getElementById('ast-documents-view').style.display = 'none';
        document.getElementById('ast-journal-detail-view').style.display = 'none';
        document.getElementById('ast-trial-balance-view').style.display = 'none';
        document.getElementById('ast-depreciation-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('balance');
        
        // Check if we have cached balance data
        if (balanceData && balanceData.length > 0) {
            applyBalanceFilter();
        } else {
            // Fetch balance data if not available
            fetchInventoryBalance();
        }
    }
    
    // Fetch inventory balance data from API
    function fetchInventoryBalance() {
        const startDate = document.getElementById('start-date')?.value;
        const endDate = document.getElementById('end-date')?.value;
        
        if (!startDate || !endDate) {
            balanceData = [];
            renderBalanceTable([], null);
            return;
        }
        
        // Show loading state
        const tbody = document.getElementById('balance-tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                       <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="animate-spin h-8 w-8 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="text-sm text-gray-500">Loading balance data...</p>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate
        });
        
        const url = `/core/api/ast-balance-data/?${params}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    balanceData = data.balance_data || [];
                    applyBalanceFilter();
                } else {
                    showBalanceError(data.error || 'Failed to load balance data');
                }
            })
            .catch(error => {
                showBalanceError('Network error occurred');
            });
    }
    
    // Apply balance filters
    function applyBalanceFilter() {
        if (!balanceData || balanceData.length === 0) {
            renderBalanceTable([], null);
            return;
        }
        
        let filteredData = balanceData;
        
        // Get filter values
        const accountFilter = document.getElementById('filter-balance-account')?.value.toLowerCase().trim() || '';
        const assetCodeFilter = document.getElementById('filter-balance-asset-code')?.value.toLowerCase().trim() || '';
        const assetNameFilter = document.getElementById('filter-balance-asset-name')?.value.toLowerCase().trim() || '';
        const beginningQuantityFilter = document.getElementById('filter-balance-beginning-quantity')?.value.toLowerCase().trim() || '';
        const beginningCostFilter = document.getElementById('filter-balance-beginning-cost')?.value.toLowerCase().trim() || '';
        const inQuantityFilter = document.getElementById('filter-balance-in-quantity')?.value.toLowerCase().trim() || '';
        const inCostFilter = document.getElementById('filter-balance-in-cost')?.value.toLowerCase().trim() || '';
        const outQuantityFilter = document.getElementById('filter-balance-out-quantity')?.value.toLowerCase().trim() || '';
        const outCostFilter = document.getElementById('filter-balance-out-cost')?.value.toLowerCase().trim() || '';
        const endingQuantityFilter = document.getElementById('filter-balance-ending-quantity')?.value.toLowerCase().trim() || '';
        const endingCostFilter = document.getElementById('filter-balance-ending-cost')?.value.toLowerCase().trim() || '';
        
        // Apply filters
        if (accountFilter || assetCodeFilter || assetNameFilter || 
            beginningQuantityFilter || beginningCostFilter || inQuantityFilter || inCostFilter ||
            outQuantityFilter || outCostFilter || endingQuantityFilter || endingCostFilter) {
            filteredData = filteredData.filter(balance => {
                const accountMatch = !accountFilter || String(balance.accountcode || '').toLowerCase().includes(accountFilter);
                const assetCodeMatch = !assetCodeFilter || String(balance.assetcardcode || '').toLowerCase().includes(assetCodeFilter);
                const assetNameMatch = !assetNameFilter || String(balance.assetcardname || '').toLowerCase().includes(assetNameFilter);
                const beginningQuantityMatch = !beginningQuantityFilter || String(balance.beginningquantity || '').toLowerCase().includes(beginningQuantityFilter);
                const beginningCostMatch = !beginningCostFilter || String(balance.beginningcost || '').toLowerCase().includes(beginningCostFilter);
                const inQuantityMatch = !inQuantityFilter || String(balance.inquantity || '').toLowerCase().includes(inQuantityFilter);
                const inCostMatch = !inCostFilter || String(balance.incost || '').toLowerCase().includes(inCostFilter);
                const outQuantityMatch = !outQuantityFilter || String(balance.outquantity || '').toLowerCase().includes(outQuantityFilter);
                const outCostMatch = !outCostFilter || String(balance.outcost || '').toLowerCase().includes(outCostFilter);
                const endingQuantityMatch = !endingQuantityFilter || String(balance.endingquantity || '').toLowerCase().includes(endingQuantityFilter);
                const endingCostMatch = !endingCostFilter || String(balance.endingcost || '').toLowerCase().includes(endingCostFilter);
                
                return accountMatch && assetCodeMatch && assetNameMatch &&
                       beginningQuantityMatch && beginningCostMatch && inQuantityMatch && inCostMatch &&
                       outQuantityMatch && outCostMatch && endingQuantityMatch && endingCostMatch;
            });
        }
        
        // Calculate summary totals from all filtered data (not just paginated)
        const summaryTotals = calculateBalanceTotals(filteredData);
        
        // Calculate pagination
        totalPagesBalance = Math.ceil(filteredData.length / pageSizeBalance);
        if (currentPageBalance > totalPagesBalance) currentPageBalance = 1;
        
        // Get paginated data
        const startIndex = (currentPageBalance - 1) * pageSizeBalance;
        const endIndex = startIndex + pageSizeBalance;
        const paginatedData = filteredData.slice(startIndex, endIndex);
        
        // Update pagination info
        updateBalancePaginationInfo(filteredData.length, paginatedData.length, startIndex);
        
        // Render table with summary
        renderBalanceTable(paginatedData, summaryTotals);
    }
    
    // Apply balance filters with debounce
    function applyBalanceFilters() {
        clearTimeout(window.balanceFilterTimeout);
        window.balanceFilterTimeout = setTimeout(applyBalanceFilter, 300);
    }
    
    // Calculate totals for summary row
    function calculateBalanceTotals(balances) {
        if (!balances || balances.length === 0) {
            return {
                beginningCost: 0,
                inCost: 0,
                outCost: 0,
                endingCost: 0
            };
        }
        
        const totals = balances.reduce((acc, balance) => {
            acc.beginningCost += parseFloat(balance.beginningcost || 0);
            acc.inCost += parseFloat(balance.incost || 0);
            acc.outCost += parseFloat(balance.outcost || 0);
            acc.endingCost += parseFloat(balance.endingcost || 0);
            return acc;
        }, {
            beginningCost: 0,
            inCost: 0,
            outCost: 0,
            endingCost: 0
        });
        
        return totals;
    }
    
    // Render balance table
    function renderBalanceTable(balances, summaryTotals) {
        const tbody = document.getElementById('balance-tbody');
        if (!tbody) return;
        
        if (!balances || balances.length === 0) {
            tbody.innerHTML = `
                <tr>
                       <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-sm font-medium text-gray-900 mb-1">No balance data found</h3>
                            <p class="text-sm text-gray-500">No data found in the selected date range.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = '';
        
        const fragment = document.createDocumentFragment();
        
        balances.forEach(balance => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 border-b border-gray-200';
            
            const accountCode = balance.accountcode || '';
            const assetCode = balance.assetcardcode || '';
            const assetName = balance.assetcardname || '';
            const beginningQuantity = formatNumber(balance.beginningquantity || 0, 3);
            const beginningCost = formatNumber(balance.beginningcost || 0, 2);
            const inQuantity = formatNumber(balance.inquantity || 0, 3);
            const inCost = formatNumber(balance.incost || 0, 2);
            const outQuantity = formatNumber(balance.outquantity || 0, 3);
            const outCost = formatNumber(balance.outcost || 0, 2);
            const endingQuantity = formatNumber(balance.endingquantity || 0, 3);
            const endingCost = formatNumber(balance.endingcost || 0, 2);
            
            row.innerHTML = `
                <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${accountCode}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${assetCode}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${assetName}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${beginningQuantity}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${beginningCost}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${inQuantity}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${inCost}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${outQuantity}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${outCost}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${endingQuantity}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${endingCost}</td>
            `;
            
            fragment.appendChild(row);
        });
        
        tbody.appendChild(fragment);
        
        // Add summary row if totals are provided
        if (summaryTotals) {
            const summaryRow = document.createElement('tr');
            summaryRow.className = 'bg-gray-100 border-t-2 border-gray-300';
            
            const totalBeginningCost = formatNumber(summaryTotals.beginningCost, 2);
            const totalInCost = formatNumber(summaryTotals.inCost, 2);
            const totalOutCost = formatNumber(summaryTotals.outCost, 2);
            const totalEndingCost = formatNumber(summaryTotals.endingCost, 2);
            
            summaryRow.innerHTML = `
                <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200" colspan="4">НИЙТЛЭГ:</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalBeginningCost}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200"></td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalInCost}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200"></td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalOutCost}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200"></td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalEndingCost}</td>
            `;
            
            tbody.appendChild(summaryRow);
        }
    }
    
    // Change balance page
    function changePageBalance(newPage) {
        if (newPage < 1 || newPage > totalPagesBalance) return;
        
        currentPageBalance = newPage;
        applyBalanceFilter();
    }
    
    // Update balance pagination info
    function updateBalancePaginationInfo(totalRecords, currentRecords, startIndex) {
        const showingStart = document.getElementById('showing-start-balance');
        const showingEnd = document.getElementById('showing-end-balance');
        const totalCount = document.getElementById('total-count-balance');
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        
        // Generate dynamic pagination
        generatePaginationButtonsBalance();
    }
    
    // Generate balance pagination buttons
    function generatePaginationButtonsBalance() {
        const pageInfo = document.getElementById('page-info-balance');
        if (!pageInfo) return;
        
        // Clear existing buttons
        pageInfo.innerHTML = '';
        
        // Calculate pagination range
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPageBalance - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPagesBalance, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // Generate page buttons
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPageBalance 
                    ? 'bg-blue-400 text-white hover:bg-blue-500' 
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePageBalance(i));
            pageInfo.appendChild(button);
        }
    }
    
    // Show balance error
    function showBalanceError(message) {
        const tbody = document.getElementById('balance-tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="px-4 py-8 text-center text-red-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="text-sm font-medium text-red-900 mb-1">Error loading balance</h3>
                            <p class="text-sm text-red-500">${message}</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    // Fetch trial balance data
    function fetchTrialBalanceData(startDate, endDate) {
        const cacheKey = `trial_balance_${startDate}_${endDate}`;
        if (apiCache.has(cacheKey)) {
            trialBalanceData = apiCache.get(cacheKey);
            return Promise.resolve();
        }
        
        const url = `/core/api/asset-depreciation-expenses/?start_date=${startDate}&end_date=${endDate}`;
        return fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    trialBalanceData = data.details || [];
                    apiCache.set(cacheKey, trialBalanceData);
                } else {
                    console.error('Failed to load trial balance data:', data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching trial balance:', error);
            });
    }
    
    // Fetch depreciation journal data
    function fetchDepreciationJournalData(startDate, endDate) {
        const cacheKey = `depreciation_${startDate}_${endDate}`;
        if (apiCache.has(cacheKey)) {
            depreciationData = apiCache.get(cacheKey);
            return Promise.resolve();
        }
        
        const url = `/core/api/cash-documents-filtered/?start_date=${startDate}&end_date=${endDate}&document_type_id=13`;
        return fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    depreciationData = data.details || [];
                    apiCache.set(cacheKey, depreciationData);
                } else {
                    console.error('Failed to load depreciation journal data:', data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching depreciation journal:', error);
            });
    }
    
    // Render trial balance table
    function renderTrialBalanceTable() {
        const tbody = document.getElementById('trial-balance-tbody');
        if (!tbody) return;
        
        if (!trialBalanceData || trialBalanceData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-sm font-medium text-gray-900 mb-1">No data found</h3>
                            <p class="text-sm text-gray-500">No data found in the selected date range.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Calculate pagination
        totalPagesTrialBalance = Math.ceil(trialBalanceData.length / pageSizeTrialBalance);
        if (currentPageTrialBalance > totalPagesTrialBalance) currentPageTrialBalance = 1;
        
        const startIndex = (currentPageTrialBalance - 1) * pageSizeTrialBalance;
        const endIndex = startIndex + pageSizeTrialBalance;
        const paginatedData = trialBalanceData.slice(startIndex, endIndex);
        
        // Update pagination info
        updateTrialBalancePaginationInfo(trialBalanceData.length, paginatedData.length, startIndex);
        
        // Render rows
        let htmlContent = '';
        paginatedData.forEach((item) => {
            htmlContent += `
                <tr class="hover:bg-gray-50">
                    <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_no || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_code || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.asset_card_name || ''}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.daily_expense, 6)}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.expense_day || ''}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.expense_amount, 2)}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.created_date || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.created_by || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.debit_account_code || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.credit_account_code || ''}</td>
                </tr>
            `;
        });
        
        tbody.innerHTML = htmlContent;
    }
    
    // Render depreciation table
    function renderDepreciationTable() {
        const tbody = document.getElementById('depreciation-tbody');
        if (!tbody) return;
        
        if (!depreciationData || depreciationData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-sm font-medium text-gray-900 mb-1">No data found</h3>
                            <p class="text-sm text-gray-500">No data found in the selected date range.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Calculate pagination
        totalPagesDepreciation = Math.ceil(depreciationData.length / pageSizeDepreciation);
        if (currentPageDepreciation > totalPagesDepreciation) currentPageDepreciation = 1;
        
        const startIndex = (currentPageDepreciation - 1) * pageSizeDepreciation;
        const endIndex = startIndex + pageSizeDepreciation;
        const paginatedData = depreciationData.slice(startIndex, endIndex);
        
        // Update pagination info
        updateDepreciationPaginationInfo(depreciationData.length, paginatedData.length, startIndex);
        
        // Render rows with totals
        let htmlContent = '';
        let totalDebit = 0;
        let totalCredit = 0;
        
        paginatedData.forEach((item) => {
            totalDebit += parseFloat(item.debit_amount) || 0;
            totalCredit += parseFloat(item.credit_amount) || 0;
            
            htmlContent += `
                <tr class="hover:bg-gray-50">
                    <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_no || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_date || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_code || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_name || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.client_name || ''}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.description || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.currency_name || ''}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.currency_amount, 2)}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.currency_exchange, 4)}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.debit_amount, 2)}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.credit_amount, 2)}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.user_name || ''}</td>
                </tr>
            `;
        });
        
        // Add totals row
        htmlContent += `
            <tr class="bg-gray-100 font-semibold">
                <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200" colspan="9">НИЙТ:</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(totalDebit, 2)}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(totalCredit, 2)}</td>
                <td class="px-1 py-1 text-xs text-gray-900"></td>
            </tr>
        `;
        
        tbody.innerHTML = htmlContent;
    }
    
    // Update trial balance pagination info
    function updateTrialBalancePaginationInfo(totalRecords, currentRecords, startIndex) {
        const showingStart = document.getElementById('showing-start-tb');
        const showingEnd = document.getElementById('showing-end-tb');
        const totalCount = document.getElementById('total-count-tb');
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        
        generateTrialBalancePaginationButtons();
    }
    
    // Generate trial balance pagination buttons
    function generateTrialBalancePaginationButtons() {
        const pageInfo = document.getElementById('page-info-tb');
        if (!pageInfo) return;
        
        pageInfo.innerHTML = '';
        
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPageTrialBalance - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPagesTrialBalance, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPageTrialBalance
                    ? 'bg-blue-400 text-white hover:bg-blue-500'
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePageTrialBalance(i));
            pageInfo.appendChild(button);
        }
    }
    
    // Change trial balance page
    function changePageTrialBalance(newPage) {
        if (newPage < 1 || newPage > totalPagesTrialBalance) return;
        currentPageTrialBalance = newPage;
        renderTrialBalanceTable();
    }
    
    // Update depreciation pagination info
    function updateDepreciationPaginationInfo(totalRecords, currentRecords, startIndex) {
        const showingStart = document.getElementById('showing-start-dep');
        const showingEnd = document.getElementById('showing-end-dep');
        const totalCount = document.getElementById('total-count-dep');
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        
        generateDepreciationPaginationButtons();
    }
    
    // Generate depreciation pagination buttons
    function generateDepreciationPaginationButtons() {
        const pageInfo = document.getElementById('page-info-dep');
        if (!pageInfo) return;
        
        pageInfo.innerHTML = '';
        
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPageDepreciation - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPagesDepreciation, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPageDepreciation
                    ? 'bg-blue-400 text-white hover:bg-blue-500'
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePageDepreciation(i));
            pageInfo.appendChild(button);
        }
    }
    
    // Change depreciation page
    function changePageDepreciation(newPage) {
        if (newPage < 1 || newPage > totalPagesDepreciation) return;
        currentPageDepreciation = newPage;
        renderDepreciationTable();
    }
    
    // Switch to trial balance view
    function switchToTrialBalanceView() {
        // Hide all views
        document.getElementById('ast-documents-view').style.display = 'none';
        document.getElementById('ast-journal-detail-view').style.display = 'none';
        document.getElementById('ast-balance-view').style.display = 'none';
        document.getElementById('ast-depreciation-view').style.display = 'none';
        
        // Show trial balance view
        document.getElementById('ast-trial-balance-view').style.display = 'block';
        
        // Update tab styling
        updateTabStyling('trial-balance');
        
        // Render if data exists
        if (trialBalanceData && trialBalanceData.length > 0) {
            renderTrialBalanceTable();
        }
    }
    
    // Switch to depreciation view
    function switchToDepreciationView() {
        // Hide all views
        document.getElementById('ast-documents-view').style.display = 'none';
        document.getElementById('ast-journal-detail-view').style.display = 'none';
        document.getElementById('ast-balance-view').style.display = 'none';
        document.getElementById('ast-trial-balance-view').style.display = 'none';
        
        // Show depreciation view
        document.getElementById('ast-depreciation-view').style.display = 'block';
        
        // Update tab styling
        updateTabStyling('depreciation');
        
        // Render if data exists
        if (depreciationData && depreciationData.length > 0) {
            renderDepreciationTable();
        }
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const filterButton = document.getElementById('filter-button');
        if (filterButton) {
            filterButton.addEventListener('click', applyDateFilter);
        }
    });
</script>
{% endblock %}

