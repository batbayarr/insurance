{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Cash Documents - Silicon-AI Accounting{% endblock %}

{% block content %}
{% csrf_token %}
<div class="space-y-0">
    <div class="flex justify-between items-center px-3 py-2 lg:px-6 bg-white border-b border-gray-200">
        <div>
            <h1 class="text-base lg:text-lg xl:text-xl font-medium text-gray-900">МӨНГӨН ХӨРӨНГИЙН МОДУЛЬ</h1>            
        </div>
        {% if perms.core.add_cash_document %}
        <a href="{% url 'core:cashdocument_create' %}" class="inline-flex items-center px-2 py-1 lg:px-3 lg:py-1.5 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg class="mr-1 lg:mr-1.5 h-3 w-3 lg:h-4 lg:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            <span class="text-xs">НЭМЭХ</span>
        </a>
        {% endif %}
    </div>

    <!-- Date Range Filter -->
    <div class="bg-white border-b border-gray-200 px-3 py-2 lg:px-6">
        <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center space-x-2">
                <label for="start-date" class="text-sm font-medium text-gray-700">Эхний огноо:</label>
                <input type="date" id="start-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-center space-x-2">
                <label for="end-date" class="text-sm font-medium text-gray-700">Эцсийн огноо:</label>
                <input type="date" id="end-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="apply-date-filter" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                СЭРГЭЭХ
            </button>
        </div>
    </div>

    <!-- Master Grid (Cash Documents) -->
    <div id="cash-document-container" 
         class="bg-white shadow overflow-hidden rounded-lg border border-gray-200 mx-0">        
        
        <!-- Table with horizontal scroll for large datasets -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 table-auto">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-24">Огноо</th>
                        <th class="px-4 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-24">Баримт</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 hidden">Б</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-28">Данс</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-8">НӨТ</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-60">Гүйлгээний утга</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-8">Вал</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют.дүн</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-28">Ханш</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дүн(₮)</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-10" >Хэрэглэгч</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-10">Загвар</th>
                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Үйлдэл</th>
                    </tr>
                    <!-- Filter Row -->
                    <tr class="bg-gray-100">
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-date" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-4 py-1 border-r border-gray-200" >
                            <input type="text" id="filter-document-no" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200 hidden">
                            <input type="text" id="filter-document-type" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-account" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-client" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200 w-8">
                            <input type="text" id="filter-is-vat" placeholder="Y/N" maxlength="1"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-description" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200 w-16">
                            <input type="text" id="filter-currency" placeholder="Filter..." maxlength="3"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-currency-amount" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-currency-exchange" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-mnt-amount" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-created-by" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-template-id" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1">
                            <button id="clear-filters" class="w-full px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 focus:ring-1 focus:ring-blue-500">
                                Clear
                            </button>
                        </td>
                    </tr>
                </thead>
                <tbody id="documents-tbody" class="bg-white divide-y divide-gray-200">
                    <!-- Documents will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
        
       <!-- Pagination -->
       <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
           <div class="flex-1 flex justify-between sm:hidden">
               <button id="prev-page-btn" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                   Өмнөх
               </button>
               <button id="next-page-btn" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                   Дараа
               </button>
           </div>
           <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
               <div>
                   <p id="pagination-info" class="text-sm text-gray-700">
                       Нийт <span id="total-count">0</span> бичлэгээс <span id="showing-start">0</span> - <span id="showing-end">0</span> бичлэг харагдаж байна
                   </p>
               </div>
               <div class="flex items-center space-x-4">
                   <div class="flex items-center space-x-2">
                       <label for="page-size-select" class="text-sm font-medium text-gray-700">Хуудасны хэмжээ:</label>
                       <select id="page-size-select" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                           <option value="10" selected>10</option>
                           <option value="15">15</option>
                       </select>
                   </div>
                   <div>
                       <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                           <button id="prev-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                               <span class="sr-only">Previous</span>
                               <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                   <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                               </svg>
                           </button>
                           <span id="page-info" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                               <!-- Dynamic page buttons will be generated here -->
                           </span>
                           <button id="next-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                               <span class="sr-only">Next</span>
                               <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                   <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                               </svg>
                           </button>
                       </nav>
                   </div>
               </div>
           </div>
       </div>
    </div>

    <!-- Detail Grid will be loaded here via AJAX -->
    <div id="detail-grid-container">
        <!-- Detail grid content will be dynamically loaded here -->
    </div>

</div>

<!-- Include Delete Modal -->
{% include 'core/components/delete_modal.html' %}

<!-- Include Document Print System -->
<script src="{% static 'js/print-cash-document.js' %}"></script>

<script>
// Prevent script re-execution
if (!window.cashDocumentScriptLoaded) {
    window.cashDocumentScriptLoaded = true;

// ===== API-Based Data Management =====
let allDocumentsData = [];
let filteredData = [];
let currentPage = 1;
let pageSize = 10;
let totalPages = 1;
let currentApiRequest = null; // For AbortController to cancel previous API requests
const currentUserId = {{ request.user.id }};
const hasChangePermission = {% if perms.core.change_cash_document %}true{% else %}false{% endif %};
const hasDeletePermission = {% if perms.core.delete_cash_document %}true{% else %}false{% endif %};
const hasViewDetailPermission = {% if perms.core.view_cash_documentdetail %}true{% else %}false{% endif %};
const hasAddDetailPermission = {% if perms.core.add_cash_documentdetail %}true{% else %}false{% endif %};
const hasChangeDetailPermission = {% if perms.core.change_cash_documentdetail %}true{% else %}false{% endif %};

// Helper function to save date range to localStorage
function saveDateRangeToLocalStorage(startDate, endDate) {
    try {
        localStorage.setItem('cashdocument_date_range', JSON.stringify({
            startDate: startDate,
            endDate: endDate
        }));
    } catch (e) {
        console.warn('Failed to save date range to localStorage:', e);
    }
}

// Helper function to load date range from localStorage
function loadDateRangeFromLocalStorage() {
    try {
        const saved = localStorage.getItem('cashdocument_date_range');
        if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed.startDate && parsed.endDate) {
                return {
                    startDate: parsed.startDate,
                    endDate: parsed.endDate
                };
            }
        }
    } catch (e) {
        console.warn('Failed to load date range from localStorage:', e);
    }
    return null;
}

// Helper function to save all filter states to localStorage
function saveAllFiltersToLocalStorage() {
    try {
        const filters = {
            documentNo: document.getElementById('filter-document-no')?.value || '',
            documentType: document.getElementById('filter-document-type')?.value || '',
            client: document.getElementById('filter-client')?.value || '',
            date: document.getElementById('filter-date')?.value || '',
            description: document.getElementById('filter-description')?.value || '',
            isVat: document.getElementById('filter-is-vat')?.value || '',
            account: document.getElementById('filter-account')?.value || '',
            currency: document.getElementById('filter-currency')?.value || '',
        currencyAmount: document.getElementById('filter-currency-amount')?.value || '',
        currencyExchange: document.getElementById('filter-currency-exchange')?.value || '',
        mntAmount: document.getElementById('filter-mnt-amount')?.value || '',
        createdBy: document.getElementById('filter-created-by')?.value || '',
        templateId: document.getElementById('filter-template-id')?.value || '',
        pageSize: pageSize,
        currentPage: currentPage
    };
        localStorage.setItem('cashdocument_all_filters', JSON.stringify(filters));
    } catch (e) {
        console.warn('Failed to save all filters to localStorage:', e);
    }
}

// Helper function to load all filter states from localStorage
function loadAllFiltersFromLocalStorage() {
    try {
        const saved = localStorage.getItem('cashdocument_all_filters');
        if (saved) {
            const parsed = JSON.parse(saved);
            return parsed;
        }
    } catch (e) {
        console.warn('Failed to load all filters from localStorage:', e);
    }
    return null;
}

// Helper function to clear all client-side filters (but preserve date range)
function clearAllClientSideFilters(preserveSelectedDocument = false) {
    const filterIds = [
        'filter-document-no', 'filter-document-type', 'filter-client',
        'filter-date', 'filter-description', 'filter-is-vat',
        'filter-account', 'filter-currency', 'filter-currency-amount',
        'filter-currency-exchange', 'filter-mnt-amount', 'filter-created-by'
    ];
    
    // Clear all filter input values
    filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });
    
    // Reset pagination
    currentPage = 1;
    
    // Remove selected_document from URL (unless we want to preserve it)
    if (!preserveSelectedDocument) {
        const currentUrl = new URL(window.location);
        if (currentUrl.searchParams.has('selected_document')) {
            currentUrl.searchParams.delete('selected_document');
            window.history.pushState({}, '', currentUrl.toString());
        }
    }
    
    // Clear filter localStorage (but keep date range localStorage)
    try {
        localStorage.removeItem('cashdocument_all_filters');
    } catch (e) {
        console.warn('Failed to clear filters from localStorage:', e);
    }
}

// Initialize date inputs with default values (current month)
function initializeDateInputs() {
    // Store the promise for external access when needed (declared at function scope)
    let searchPromise = null;
    
    // Format dates for HTML date input (YYYY-MM-DD)
    const formatDateForInput = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    // Check URL parameters for selected_document and date range
    const urlParams = new URLSearchParams(window.location.search);
    const selectedDocumentId = urlParams.get('selected_document');
    const beginDateParam = urlParams.get('begin_date');
    const endDateParam = urlParams.get('end_date');
    
    // If selected_document is present, clear filters and filter by documentId
    let useDocumentFilter = false;
    let usePassedDateRange = false;
    
    // Check if date range is passed from URL (from trial_balance.html or trial_edit_account_and_sub_ledger.html)
    if (beginDateParam && endDateParam) {
        usePassedDateRange = true;
    }
    
    if (selectedDocumentId) {
        // Clear filter localStorage first to prevent restoration
        try {
            localStorage.removeItem('cashdocument_all_filters');
        } catch (e) {
            console.warn('Failed to clear filters from localStorage:', e);
        }
        
        // Don't reset currentPage here - it will be calculated in applyFrontendFilter()
        // based on the document's position in the data
        useDocumentFilter = true;
    }
    
    // Use user's local system date
    const today = new Date();
    let firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    let lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
        // If date range is passed from URL, use it (ensures it matches trial_balance.html)
        // This takes priority over localStorage and default dates
        if (usePassedDateRange && beginDateParam && endDateParam) {
            // Use passed dates directly (already in YYYY-MM-DD format)
            firstDay = beginDateParam;
            lastDay = endDateParam;
        } else {
        // Check localStorage for saved date range values
        const savedDateRange = loadDateRangeFromLocalStorage();
        if (savedDateRange) {
            // Use saved date range values
            firstDay = new Date(savedDateRange.startDate);
            lastDay = new Date(savedDateRange.endDate);
        } else {
            // Check if selected_document is in URL and adjust date range if needed
            {% if selected_document %}
            if (selectedDocumentId) {
                // Get document date from server-side context
                const docDate = new Date('{{ selected_document.DocumentDate|date:"Y-m-d" }}');
                // If document date is outside current month, adjust date range to include it
                if (docDate < firstDay || docDate > lastDay) {
                    // Use document date ± 1 month, or use document date's month
                    const docYear = docDate.getFullYear();
                    const docMonth = docDate.getMonth();
                    firstDay = new Date(docYear, docMonth, 1);
                    lastDay = new Date(docYear, docMonth + 1, 0);
                    // Ensure we include at least the document date
                    if (docDate < firstDay) firstDay = new Date(docDate);
                    if (docDate > lastDay) lastDay = new Date(docDate);
                }
            }
            {% endif %}
        }
    }
    
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const pageSizeSelect = document.getElementById('page-size-select');
    const applyButton = document.getElementById('apply-date-filter');
    
    if (startDateInput && endDateInput) {
        // Set date input values - format Date objects
        if (useDocumentFilter) {
            // When filtering by documentId, clear all filter inputs
            // Use requestAnimationFrame to ensure DOM is fully rendered
            requestAnimationFrame(() => {
                const filterIds = [
                    'filter-document-no', 'filter-document-type', 'filter-client',
                    'filter-date', 'filter-description', 'filter-is-vat',
                    'filter-account', 'filter-currency', 'filter-currency-amount',
                    'filter-currency-exchange', 'filter-mnt-amount', 'filter-created-by',
                    'filter-template-id'
                ];
                
                filterIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = '';
                    }
                });
            });
        }
        
        // Set date inputs - use passed dates directly if available, otherwise format Date objects
        if (usePassedDateRange && beginDateParam && endDateParam) {
            // Use passed dates directly (already in YYYY-MM-DD format)
            startDateInput.value = beginDateParam;
            endDateInput.value = endDateParam;
        } else {
            // Format Date objects for input
            startDateInput.value = formatDateForInput(firstDay);
            endDateInput.value = formatDateForInput(lastDay);
        }
        // Save initial date range to localStorage
        saveDateRangeToLocalStorage(startDateInput.value, endDateInput.value);
        
        // Helper function to save and fetch documents
        const saveAndFetch = (startDate, endDate, skipLocalStorage = false) => {
            if (!skipLocalStorage) {
                saveDateRangeToLocalStorage(startDate, endDate);
            }
            return fetchDocuments(startDate, endDate);
        };
        
        // Flags for controlling button handler behavior
        let isProgrammaticClick = false;
        let skipFilterClear = false; // Flag to skip clearing filters if already cleared
        
        // Add event listeners
        applyButton.addEventListener('click', () => {
            // Skip if this is a programmatic click (we'll handle it separately)
            if (isProgrammaticClick) {
                isProgrammaticClick = false;
                // Still trigger the search, but don't clear filters
                searchPromise = saveAndFetch(startDateInput.value, endDateInput.value);
                return;
            }
            // Only clear filters if not already cleared
            if (!skipFilterClear) {
                clearAllClientSideFilters(); // Clear all filters before fetching
            }
            skipFilterClear = false; // Reset flag
            
            // Ensure selected_document is removed from URL before fetching
            const currentUrl = new URL(window.location);
            if (currentUrl.searchParams.has('selected_document')) {
                currentUrl.searchParams.delete('selected_document');
                window.history.replaceState({}, '', currentUrl.toString());
            }
            
            searchPromise = saveAndFetch(startDateInput.value, endDateInput.value);
        });
        
        // Save on date input change
        startDateInput.addEventListener('change', () => {
            saveDateRangeToLocalStorage(startDateInput.value, endDateInput.value);
        });
        endDateInput.addEventListener('change', () => {
            saveDateRangeToLocalStorage(startDateInput.value, endDateInput.value);
        });
        
        // Also trigger on Enter key
        startDateInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                clearAllClientSideFilters(); // Clear all filters before fetching
                saveAndFetch(startDateInput.value, endDateInput.value);
            }
        });
        endDateInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                clearAllClientSideFilters(); // Clear all filters before fetching
                saveAndFetch(startDateInput.value, endDateInput.value);
            }
        });
    }
    
    // Load all saved filter states (skip if filtering by documentId)
    if (!useDocumentFilter) {
        const savedFilters = loadAllFiltersFromLocalStorage();
        
        if (savedFilters) {
            // Restore page size
            if (savedFilters.pageSize) {
                pageSize = parseInt(savedFilters.pageSize);
                if (pageSizeSelect) {
                    pageSizeSelect.value = pageSize;
                }
            }
            
            // Restore current page (will be applied after data loads)
            if (savedFilters.currentPage) {
                currentPage = parseInt(savedFilters.currentPage);
            }
            
            // Restore inline filter values
            const filterIds = [
                'filter-document-no', 'filter-document-type', 'filter-client',
                'filter-date', 'filter-description', 'filter-is-vat',
                'filter-account', 'filter-currency', 'filter-currency-amount',
                'filter-currency-exchange', 'filter-mnt-amount', 'filter-created-by',
                'filter-template-id'
            ];
            
            const filterMap = {
                'filter-document-no': 'documentNo',
                'filter-document-type': 'documentType',
                'filter-client': 'client',
                'filter-date': 'date',
                'filter-description': 'description',
                'filter-is-vat': 'isVat',
                'filter-account': 'account',
                'filter-currency': 'currency',
                'filter-currency-amount': 'currencyAmount',
                'filter-currency-exchange': 'currencyExchange',
                'filter-mnt-amount': 'mntAmount',
                'filter-created-by': 'createdBy',
                'filter-template-id': 'templateId'
            };
            
            filterIds.forEach(filterId => {
                // Skip client filter if selected_document is in URL
                if (filterId === 'filter-client' && selectedDocumentId) {
                    return;
                }
                const element = document.getElementById(filterId);
                const savedKey = filterMap[filterId];
                if (element && savedFilters[savedKey] !== undefined) {
                    element.value = savedFilters[savedKey];
                }
            });
        }
    } else {
        // When filtering by documentId, ensure filters are cleared after DOM is ready
        // This happens after the above block, so filters won't be restored
        // Clear filters after a short delay to ensure DOM is ready
            setTimeout(() => {
                const filterIds = [
                    'filter-document-no', 'filter-document-type', 'filter-client',
                    'filter-date', 'filter-description', 'filter-is-vat',
                    'filter-account', 'filter-currency', 'filter-currency-amount',
                    'filter-currency-exchange', 'filter-mnt-amount', 'filter-created-by',
                    'filter-template-id'
                ];
            
            filterIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = '';
                }
            });
        }, 100);
    }
    
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', (e) => {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            saveAllFiltersToLocalStorage();
            applyFrontendFilter();
        });
    }
    
    // Load initial data
    if (useDocumentFilter) {
        if (applyButton) {
            setTimeout(() => {
                // Clear all filter inputs
                const clearFilters = () => {
                    const filterIds = [
                        'filter-document-no', 'filter-document-type', 'filter-client',
                        'filter-date', 'filter-description', 'filter-is-vat',
                        'filter-account', 'filter-currency', 'filter-currency-amount',
                        'filter-currency-exchange', 'filter-mnt-amount', 'filter-created-by',
                        'filter-template-id'
                    ];
                    filterIds.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) element.value = '';
                    });
                };
                
                clearFilters();
                setTimeout(clearFilters, 50);
                clearAllClientSideFilters(true);
                
                // Set flag to prevent fetchDocuments from applying filter immediately
                window.isInitialDocumentFilterLoad = true;
                
                // Set flags to control button handler behavior
                skipFilterClear = true;
                isProgrammaticClick = true;
                
                // Call fetchDocuments directly with selectedDocumentId parameter
                // Backend will filter and return only that document
                const promiseToUse = fetchDocuments(startDateInput.value, endDateInput.value, selectedDocumentId);
                
                promiseToUse.then((data) => {
                    window.isInitialDocumentFilterLoad = false;
                    setTimeout(() => {
                        applyFrontendFilter();
                    }, 150);
                }).catch(error => {
                    window.isInitialDocumentFilterLoad = false;
                    console.error('Error during search:', error);
                });
            }, 100);
        }
    } else {
        // Normal flow: page will be restored automatically via savedFilters.currentPage
        // The currentPage was already set above if savedFilters exists, and applyFrontendFilter()
        // in fetchDocuments will use it
        fetchDocuments(startDateInput.value, endDateInput.value);
    }
}

// Fetch documents from API
function fetchDocuments(startDate, endDate, selectedDocumentIdParam = null) {
    const tbody = document.getElementById('documents-tbody');
    if (!tbody) return Promise.resolve();
    
    // Cancel previous request if still in flight
    if (currentApiRequest) {
        currentApiRequest.abort();
        currentApiRequest = null;
    }
    
    // Show loading state
    tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-sm text-gray-600">Ачааллаж байна...</p></td></tr>';
    
    // Use passed parameter, or check URL as fallback
    let selectedDocumentId = selectedDocumentIdParam;
    if (!selectedDocumentId) {
        const urlParams = new URLSearchParams(window.location.search);
        selectedDocumentId = urlParams.get('selected_document');
    }
    
    let url = `/core/api/cash-documents-master/?start_date=${startDate}&end_date=${endDate}`;
    if (selectedDocumentId) {
        url += `&selected_document=${selectedDocumentId}`;
    }
    
    // Create new AbortController for this request
    currentApiRequest = new AbortController();
    
    // Add timeout to prevent hanging
    const timeoutId = setTimeout(() => {
        if (currentApiRequest) {
            currentApiRequest.abort();
            currentApiRequest = null;
            tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8 text-red-600">Холболт удаан байна. Дахин оролдоно уу.</td></tr>';
        }
    }, 30000); // 30 second timeout
    
    return fetch(url, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        signal: currentApiRequest.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        // Check if response is ok before parsing JSON
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Clear request reference on success
        currentApiRequest = null;
        
        if (data.success) {
            allDocumentsData = data.documents || [];
            
            // CRITICAL: If selected_document is in URL but no data returned (deleted or not found),
            // clear loading state and fetch all documents
            const urlParams = new URLSearchParams(window.location.search);
            const selectedDocId = urlParams.get('selected_document');
            if (selectedDocId && (!allDocumentsData || allDocumentsData.length === 0)) {
                // Document was deleted or not found - remove from URL and fetch all documents
                urlParams.delete('selected_document');
                const cleanUrl = urlParams.toString() 
                    ? `${window.location.pathname}?${urlParams.toString()}`
                    : window.location.pathname;
                window.history.replaceState({}, '', cleanUrl);
                
                // Fetch all documents without selected_document parameter
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                if (startDateInput && endDateInput) {
                    // Recursively call fetchDocuments without selected_document
                    return fetchDocuments(startDateInput.value, endDateInput.value, null);
                } else {
                    // Fallback: clear loading state
                    const tbody = document.getElementById('documents-tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8 text-gray-500">Баримт олдсонгүй</td></tr>';
                    }
                }
                return data; // Return early to prevent calling applyFrontendFilter with empty data
            }
            
            // If this is initial document filter load, don't call applyFrontendFilter here
            // The promise chain in initializeDateInputs() will handle it
            if (window.isInitialDocumentFilterLoad) {
                return data;
            }
            
            // Normal flow: apply filter after data is loaded
            setTimeout(() => {
                // CRITICAL: Ensure flags are cleared before calling applyFrontendFilter
                // This prevents applyFrontendFilter from being blocked
                window.skipFilterAfterDelete = false;
                if (window.Silicon4SoftDelete) {
                    window.Silicon4SoftDelete.isDeleting = false;
                }
                
                applyFrontendFilter();
            }, 10);
            
            return data;
        } else {
            currentApiRequest = null;
            tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8 text-red-600">Алдаа гарлаа: ' + (data.error || 'Unknown error') + '</td></tr>';
            throw new Error(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        // Clear request reference
        currentApiRequest = null;
        
        // Only show error if it's not an abort error (abort is intentional)
        if (error.name !== 'AbortError') {
            console.error('Error fetching documents:', error);
            console.error('Error details:', error.message, error.stack);
            console.error('Failed URL:', url);
            tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8 text-red-600">Сүлжээний алдаа гарлаа: ' + error.message + '</td></tr>';
        }
        // If AbortError, silently ignore (user triggered it by changing filters)
    });
}

// Apply frontend filters
function applyFrontendFilter() {
    // Skip filtering if we just deleted a record (prevents re-rendering after delete)
    if (window.skipFilterAfterDelete) {
        return;
    }
    
    // Also check if we're currently deleting (double safety)
    if (window.Silicon4SoftDelete && window.Silicon4SoftDelete.isDeleting) {
        return;
    }
    
    // Get filter values
    const filters = {
        documentNo: document.getElementById('filter-document-no')?.value.toLowerCase().trim() || '',
        documentType: document.getElementById('filter-document-type')?.value.toLowerCase().trim() || '',
        client: document.getElementById('filter-client')?.value.toLowerCase().trim() || '',
        date: document.getElementById('filter-date')?.value.toLowerCase().trim() || '',
        description: document.getElementById('filter-description')?.value.toLowerCase().trim() || '',
        isVat: document.getElementById('filter-is-vat')?.value.toLowerCase().trim() || '',
        account: document.getElementById('filter-account')?.value.toLowerCase().trim() || '',
        currency: document.getElementById('filter-currency')?.value.toLowerCase().trim() || '',
        currencyAmount: document.getElementById('filter-currency-amount')?.value.toLowerCase().trim() || '',
        currencyExchange: document.getElementById('filter-currency-exchange')?.value.toLowerCase().trim() || '',
        mntAmount: document.getElementById('filter-mnt-amount')?.value.toLowerCase().trim() || '',
        createdBy: document.getElementById('filter-created-by')?.value.toLowerCase().trim() || '',
        templateId: document.getElementById('filter-template-id')?.value.toLowerCase().trim() || ''
    };
    
    // Check for selected_document in URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    let selectedDocumentId = urlParams.get('selected_document');
    
    // If selected_document is in URL, backend already filtered the data
    // Check this first before any other filtering logic
    if (selectedDocumentId) {
        // Wait for data to be loaded if not ready yet
        if (!allDocumentsData || allDocumentsData.length === 0) {
            // Data not ready yet, return early and let fetchDocuments handle it
            return;
        }
        
        // CRITICAL: Check if the selected document is deleted - if so, remove from URL and skip loading details
        const selectedDoc = allDocumentsData.find(doc => doc.DocumentId == selectedDocumentId);
        
        if (selectedDoc && selectedDoc.IsDelete === true) {
            // Document is deleted - remove from URL and continue with normal filtering
            urlParams.delete('selected_document');
            const cleanUrl = urlParams.toString() 
                ? `${window.location.pathname}?${urlParams.toString()}`
                : window.location.pathname;
            window.history.replaceState({}, '', cleanUrl);
            // Fall through to normal filtering logic below
        } else if (selectedDoc && selectedDoc.IsDelete !== true) {
            // Document exists and is NOT deleted - proceed with loading details
            // Backend already filtered, so allDocumentsData should contain only the selected document
            if (allDocumentsData.length === 1) {
                // Set filter input value to make filtering explicit and visible to user
                const documentNoFilter = document.getElementById('filter-document-no');
                if (documentNoFilter && selectedDoc.DocumentNo) {
                    documentNoFilter.value = selectedDoc.DocumentNo;
                }
                
                // Just show this one document - backend already filtered it!
                filteredData = [selectedDoc];
                pageData = [selectedDoc];
                currentPage = 1;
                totalPages = 1;
                
                // Render immediately
                renderDocumentsTable(pageData);
                updatePaginationInfo(1, 1, 1);
                generatePaginationButtons();
                
                // Load details immediately (only if not deleted)
                setTimeout(() => {
                    // Double-check document is not deleted before loading details
                    const docCheck = allDocumentsData.find(d => d.DocumentId == selectedDocumentId);
                    if (docCheck && docCheck.IsDelete !== true) {
                        updateRowSelection(selectedDocumentId);
                        loadDocumentDetails(selectedDocumentId);
                    } else {
                        // Remove from URL if deleted
                        urlParams.delete('selected_document');
                        const cleanUrl = urlParams.toString() 
                            ? `${window.location.pathname}?${urlParams.toString()}`
                            : window.location.pathname;
                        window.history.replaceState({}, '', cleanUrl);
                    }
                }, 200);
                
                // Save filters to localStorage
                saveAllFiltersToLocalStorage();
                
                return; // Exit early
            } else {
                // Document not found - backend returned empty or multiple
                filteredData = [];
                pageData = [];
                currentPage = 1;
                totalPages = 1;
                renderDocumentsTable(pageData);
                updatePaginationInfo(0, 0, 0);
                generatePaginationButtons();
                return; // Exit early
            }
        } else {
            // Document not found in data - remove from URL and continue with normal filtering
            urlParams.delete('selected_document');
            const cleanUrl = urlParams.toString() 
                ? `${window.location.pathname}?${urlParams.toString()}`
                : window.location.pathname;
            window.history.replaceState({}, '', cleanUrl);
            // Fall through to normal filtering logic below
        }
    }
    
    // Normal filtering logic (when no selectedDocumentId)
    // Ensure allDocumentsData exists and is an array before filtering
    if (!allDocumentsData || !Array.isArray(allDocumentsData)) {
        // Data not loaded yet, fetch it first
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        if (startDateInput && endDateInput) {
            fetchDocuments(startDateInput.value, endDateInput.value).then(() => {
                // Retry applyFrontendFilter after data is loaded
                applyFrontendFilter();
            });
        }
        return;
    }
    
    filteredData = allDocumentsData.filter(doc => {
        // Apply all filters
        if (filters.documentNo && !(doc.DocumentNo || '').toLowerCase().includes(filters.documentNo)) return false;
        if (filters.documentType && !(doc.DocumentTypeCode || '').toLowerCase().includes(filters.documentType)) return false;
        if (filters.client && !(doc.ClientName || '').toLowerCase().includes(filters.client)) return false;
        if (filters.date && !(doc.DocumentDate || '').toLowerCase().includes(filters.date)) return false;
        if (filters.description && !(doc.Description || '').toLowerCase().includes(filters.description)) return false;
        if (filters.isVat) {
            const vatValue = doc.IsVat ? 'y' : 'n';
            if (!vatValue.includes(filters.isVat)) return false;
        }
        if (filters.account && !(doc.AccountCode || '').toLowerCase().includes(filters.account)) return false;
        if (filters.currency && !(doc.CurrencyName || '').toLowerCase().includes(filters.currency)) return false;
        if (filters.currencyAmount && !(doc.CurrencyAmount || 0).toString().includes(filters.currencyAmount)) return false;
        if (filters.currencyExchange && !(doc.CurrencyExchange || 0).toString().includes(filters.currencyExchange)) return false;
        if (filters.mntAmount && !(doc.CurrencyMNT || 0).toString().includes(filters.mntAmount)) return false;
        if (filters.createdBy && !(doc.CreatedByUsername || '').toLowerCase().includes(filters.createdBy)) return false;
        if (filters.templateId && !(doc.TemplateId || '').toString().includes(filters.templateId)) return false;
        return true;
    });
    
    // Calculate pagination for normal flow
    totalPages = Math.ceil(filteredData.length / pageSize);
    
    // Ensure currentPage is within valid range
    if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;
    
    // Slice data for current page
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredData.length);
    pageData = filteredData.slice(startIndex, endIndex);
    
    // Render table and update pagination
    renderDocumentsTable(pageData);
    updatePaginationInfo(startIndex + 1, endIndex, filteredData.length);
    generatePaginationButtons();
    
    // Save all filter states to localStorage (normal flow)
    saveAllFiltersToLocalStorage();
}

// Render documents table
function renderDocumentsTable(documents) {
    // Skip re-rendering if we just deleted a record (prevents filtering/re-rendering after delete)
    if (window.skipFilterAfterDelete) {
        return;
    }
    
    // Also check if we're currently deleting (double safety)
    if (window.Silicon4SoftDelete && window.Silicon4SoftDelete.isDeleting) {
        return;
    }
    
    const tbody = document.getElementById('documents-tbody');
    if (!tbody) return;
    
    if (documents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8 text-gray-500">Баримт олдсонгүй</td></tr>';
        return;
    }
    
    const fragment = document.createDocumentFragment();
    
    documents.forEach(doc => {
        const tr = document.createElement('tr');
        // Apply deleted styling if IsDelete is true
        if (doc.IsDelete) {
            tr.className = 'deleted-row';
            tr.style.cssText = 'opacity: 0.5; text-decoration: line-through; pointer-events: none; cursor: default;';
        } else {
            tr.className = 'hover:bg-gray-50 cursor-pointer';
        }
        tr.setAttribute('data-document-id', doc.DocumentId);
        tr.setAttribute('data-document-type-id', doc.DocumentTypeId || '');
        tr.setAttribute('data-document-type-name', doc.DocumentTypeName || '');
        tr.setAttribute('data-bank-account', doc.BankAccount || '');
        tr.setAttribute('data-bank-name', doc.BankName || '');
        tr.setAttribute('data-account-code', doc.AccountCode || '');
        tr.setAttribute('data-account-name', doc.AccountName || '');
        tr.setAttribute('data-template-id', doc.TemplateId || '');
        
        // Check permissions for action buttons (hide for deleted records)
        const isDeleted = doc.IsDelete === true;
        const canManageDetails = !isDeleted && (doc.CreatedById === currentUserId) && (hasViewDetailPermission || hasAddDetailPermission || hasChangeDetailPermission);
        const canEdit = !isDeleted && hasChangePermission && (doc.CreatedById === currentUserId);
        const canDelete = !isDeleted && hasDeletePermission && (doc.CreatedById === currentUserId);
        
        // Build action cell content
        let actionCellContent = '';
        if (isDeleted) {
            actionCellContent = '<span class="text-red-500 text-xs font-medium">(Устгагдсан)</span>';
        } else {
            actionCellContent = `
                <div class="flex items-center justify-end space-x-1 lg:space-x-2">
                    ${canManageDetails ? `
                    <button class="manage-details-btn text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50" 
                            data-document-id="${doc.DocumentId}"
                            data-document-date="${doc.DocumentDate}"
                            title="Manage Details">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                    </svg>
                                </button>
                    ` : ''}
                                <button class="print-document-btn" 
                            data-document-id="${doc.DocumentId}"
                                        class="inline-flex items-center p-1 lg:p-2 border border-transparent text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                                        title="Print Document">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                    </svg>
                                </button>
                    ${canEdit ? `
                    <button class="edit-document-btn text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50" 
                            data-document-id="${doc.DocumentId}"
                            data-document-date="${doc.DocumentDate}"
                            title="Edit Document">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                    ` : ''}
                    ${canDelete ? `
                                <button class="delete-document-btn text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50" 
                            data-delete-url="/core/cashdocuments/${doc.DocumentId}/delete/"
                            data-document-name="Document ${doc.DocumentNo}" 
                            data-soft-delete
                            data-item-id="${doc.DocumentId}"
                            data-item-name="${doc.DocumentNo}"
                            title="Delete Document">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                    ` : ''}
                            </div>
            `;
        }
        
        tr.innerHTML = `
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${doc.DocumentDate || ''}</td>
            <td class="px-4 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${doc.DocumentNo || ''}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200 hidden">${doc.DocumentTypeCode || '-'}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
                <span class="text-xs" title="${doc.AccountCode || ''} - ${doc.AccountName || ''}">${doc.AccountCode || '-'}</span>
            </td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${doc.ClientName || '-'}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200 w-8">${doc.IsVat ? 'Y' : 'N'}</td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">
                <span>${doc.Description || '-'}</span>
            </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 w-16">
                <span title="${doc.CurrencyName || ''}">${truncateText(doc.CurrencyName || '', 3)}</span>
                        </td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(doc.CurrencyAmount)}</td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(doc.CurrencyExchange)}</td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(doc.CurrencyMNT)}</td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">${doc.CreatedByUsername || '-'}</td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">${doc.TemplateId || '-'}</td>
            <td class="px-2 py-1 whitespace-nowrap text-right text-xs font-medium">
                ${actionCellContent}
            </td>
        `;
        
        fragment.appendChild(tr);
    });
    
    tbody.innerHTML = '';
    tbody.appendChild(fragment);
}

// Helper functions
function truncateText(text, maxLength) {
    if (!text) return '';
    return text.length > maxLength ? text.substring(0, maxLength - 3) + '...' : text;
}

function formatNumber(num) {
    if (num === null || num === undefined || num === 0) return '-';
    return parseFloat(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Update pagination info
function updatePaginationInfo(start, end, total) {
    const showingStart = document.getElementById('showing-start');
    const showingEnd = document.getElementById('showing-end');
    const totalCount = document.getElementById('total-count');
    
    if (showingStart) showingStart.textContent = total === 0 ? 0 : start;
    if (showingEnd) showingEnd.textContent = end;
    if (totalCount) totalCount.textContent = total;
    
    generatePaginationButtons();
}

// Generate pagination buttons
function generatePaginationButtons() {
    const pageInfo = document.getElementById('page-info');
    if (!pageInfo) return;
    
    // Clear existing buttons
    pageInfo.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Calculate pagination range
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust start page if we're near the end
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Generate page buttons
    for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.className = `px-2 py-1 text-sm rounded-md ${
            i === currentPage 
                ? 'bg-blue-400 text-white hover:bg-blue-500' 
                : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
        }`;
        button.addEventListener('click', () => changePage(i));
        pageInfo.appendChild(button);
    }
}

// Change page
function changePage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    
    // Remove selected_document from URL when user manually changes page
    // This allows normal pagination to work
    const currentUrl = new URL(window.location);
    if (currentUrl.searchParams.has('selected_document')) {
        currentUrl.searchParams.delete('selected_document');
        window.history.replaceState({}, '', currentUrl.toString());
    }
    
    applyFrontendFilter();
}

// Initialize pagination button listeners
function initializePaginationListeners() {
    // Mobile pagination buttons
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    
    if (prevBtn) prevBtn.onclick = () => changePage(currentPage - 1);
    if (nextBtn) nextBtn.onclick = () => changePage(currentPage + 1);
    
    // Desktop pagination buttons
    const prevDesktopBtn = document.getElementById('prev-page-desktop');
    const nextDesktopBtn = document.getElementById('next-page-desktop');
    
    if (prevDesktopBtn) prevDesktopBtn.onclick = () => changePage(currentPage - 1);
    if (nextDesktopBtn) nextDesktopBtn.onclick = () => changePage(currentPage + 1);
}

// Debounce utility
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
    };
}

// Initialize filter listeners
function initializeFilterListeners() {
    const filterIds = [
        'filter-document-no', 'filter-document-type', 'filter-client',
        'filter-date', 'filter-description', 'filter-is-vat',
        'filter-account', 'filter-currency', 'filter-currency-amount',
        'filter-currency-exchange', 'filter-mnt-amount', 'filter-created-by',
        'filter-template-id'
    ];
    
    const debouncedFilter = debounce(applyFrontendFilter, 300);
    
    filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', debouncedFilter);
        }
    });
    
    // Clear filters button
    const clearBtn = document.getElementById('clear-filters');
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            filterIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            currentPage = 1;
            
            // Remove selected_document from URL when filters are cleared
            const currentUrl = new URL(window.location);
            if (currentUrl.searchParams.has('selected_document')) {
                currentUrl.searchParams.delete('selected_document');
                window.history.pushState({}, '', currentUrl.toString());
            }
            
            applyFrontendFilter();
        });
    }
}

// ===== End API-Based Data Management =====

// Initialize event handlers using delegation pattern
function initializeEventHandlers() {
    // Use single event delegation for all table interactions
    const tableContainer = document.querySelector('#cash-document-container');
    if (!tableContainer) {
        return;
    }
    
    // Remove any existing event listener to prevent duplicates
    if (tableContainer.hasAttribute('data-event-listener-added')) {
        return; // Already initialized
    }
    
    tableContainer.addEventListener('click', function(e) {
        // Handle row clicks for document selection
        const row = e.target.closest('tr[data-document-id]');
        if (row && !e.target.closest('button') && !e.target.closest('a')) {
            // CRITICAL: Don't load details for deleted rows
            if (row.classList.contains('deleted-row') || row.style.pointerEvents === 'none') {
                return;
            }
            const documentId = row.getAttribute('data-document-id');
            if (documentId) {
                loadDocumentDetails(documentId);
            }
            return;
        }
    
    // Handle manage details buttons
        const manageDetailsBtn = e.target.closest('.manage-details-btn');
        if (manageDetailsBtn) {
            e.stopPropagation();
            
            const documentId = manageDetailsBtn.getAttribute('data-document-id');
            const documentDate = manageDetailsBtn.getAttribute('data-document-date');
            const row = manageDetailsBtn.closest('tr[data-document-id]');
            const templateId = row ? row.getAttribute('data-template-id') : null;
            
            // Check period lock before allowing manage details
            checkPeriodLockForManageDetails(documentId, documentDate, templateId);
            return;
        }
    
    // Handle edit document buttons
        const editBtn = e.target.closest('.edit-document-btn');
        if (editBtn) {
            e.stopPropagation();
            
            const documentId = editBtn.getAttribute('data-document-id');
            const documentDate = editBtn.getAttribute('data-document-date');
            const row = editBtn.closest('tr[data-document-id]');
            const templateId = row ? row.getAttribute('data-template-id') : null;
            
            // Check period lock before allowing edit
            checkPeriodLockForEdit(documentId, documentDate, templateId);
            return;
        }
    
    // Handle print document buttons
        const printBtn = e.target.closest('.print-document-btn');
        if (printBtn) {
                e.stopPropagation();
                
            // Get document ID from button
            const documentId = printBtn.getAttribute('data-document-id');
            
            // Find the table row to extract data from
            const row = printBtn.closest('tr[data-document-id]');
            if (!row) {
                console.error('Could not find table row for document:', documentId);
                return;
            }
            
            // Extract data from table cells and row data attributes
            const cells = row.querySelectorAll('td');
            const documentTypeId = parseInt(row.getAttribute('data-document-type-id')) || 1;
            const documentTypeName = row.getAttribute('data-document-type-name') || '';
            const bankAccount = row.getAttribute('data-bank-account') || '';
            const bankName = row.getAttribute('data-bank-name') || '';
            let accountName = row.getAttribute('data-account-name') || '';
            let accountCode = row.getAttribute('data-account-code') || '';
            
            if (!accountName || !accountCode) {
                const accountCell = cells[3]; // Account is now at index 3
                const accountTitle = accountCell?.querySelector('span')?.getAttribute('title') || '';
                
                if (accountTitle) {
                    // Title format: "AccountCode - AccountName"
                    const titleParts = accountTitle.split(' - ');
                    if (!accountCode) accountCode = titleParts[0]?.trim() || '';
                    if (!accountName) accountName = titleParts[1]?.trim() || '';
                }
                
                // Final fallback to cell text content for accountCode
                if (!accountCode) {
                    accountCode = cells[3]?.textContent?.trim() || '';
                }
            }
                const documentData = {
                documentId: documentId,
                documentNo: cells[1]?.textContent?.trim() || '', // Document is now at index 1
                documentDate: cells[0]?.textContent?.trim() || '', // Date is now at index 0
                description: cells[6]?.textContent?.trim() || '', // Description is now at index 6
                createdBy: cells[11]?.textContent?.trim() || '',
                documentTypeId: documentTypeId,
                documentTypeName: documentTypeName,
                bankAccount: bankAccount,
                bankName: bankName,
                accountName: accountName,//print changes
                accountCode: accountCode,//print changes
                clientName: cells[4]?.textContent?.trim() || '', // Client is now at index 4
                currencyName: cells[7]?.textContent?.trim() || '', // Currency is still at index 7
                currencyAmount: cells[8]?.textContent?.trim() || '', // Currency Amount is still at index 8
                currencyExchange: cells[9]?.textContent?.trim() || '', // Exchange is still at index 9
                currencyMNT: cells[10]?.textContent?.trim() || '', // MNT Amount is still at index 10
                isVat: cells[5]?.textContent?.trim() === 'Y', // VAT is still at index 5
                vatAmount: '' // Not available in table, would need to be fetched separately
                };
                
                // Call the print function from print-cash-document.js
                window.printDocument(
                    documentData.documentId,
                    documentData.documentNo,
                    documentData.documentDate,
                    documentData.description,
                    documentData.createdBy,
                    documentData.documentTypeId,
                    documentData
                );
            return;
        }
    
    // Handle delete document buttons
        const deleteBtn = e.target.closest('.delete-document-btn');
        if (deleteBtn) {
            e.stopPropagation();
            const deleteUrl = deleteBtn.getAttribute('data-delete-url');
            const row = deleteBtn.closest('tr[data-document-id]');
            const documentId = row ? row.getAttribute('data-document-id') : null;
            const documentDate = deleteBtn.getAttribute('data-document-date') || (row ? row.querySelector('td')?.textContent?.trim() : '');
            const documentName = deleteBtn.getAttribute('data-document-name') || (documentId ? Document  : 'Document');

            checkPeriodLockForDelete(documentId, documentDate, deleteUrl, documentName);
            return;
        }
    });
    
    // Mark as initialized to prevent duplicate listeners
    tableContainer.setAttribute('data-event-listener-added', 'true');
}

// Number formatting is now handled by shared-components.js

// Initialize everything when DOM is ready
function initializeAll() {
    initializeEventHandlers();
    initializeDateInputs();  // Initialize date range filter and load data
    initializeFilterListeners();  // Initialize inline filter listeners
    initializePaginationListeners();  // Initialize pagination button listeners
    
    // Initialize grid layout with desktop-focused responsive design
    if (typeof Silicon4Grid !== 'undefined') {
        Silicon4Grid.initializeGrid({
            tableSelector: 'table',
            autoAdjust: true,
            maxWidth: 600,  // Increased max width for desktop screens
            responsive: true,
            forceFilterWidths: {
                'filter-description': 300,       // Force description filter to be wider for desktop
                'filter-created-by': 120,        // Force admin field filter to be wider for desktop
                'filter-client': 200,            // Force client filter to be wider
                'filter-document-type': 100,     // Force document type filter width
                'filter-currency': 100,          // Force currency filter width
                'filter-account': 100            // Force account filter width
            }
        });
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAll);
} else {
    initializeAll();
}

// Global variables to track current AJAX request and cache for detail loading
let currentDetailRequest = null;
const detailCache = new Map();

// Cash Document Calculation Function (moved here to ensure it's always available)
function calculateCashDocumentTotals() {
    const tbody = document.getElementById('detail-tbody');
    if (!tbody) {
        console.warn('Cash document: No detail tbody found');
        return;
    }
    
    const rows = tbody.querySelectorAll('tr');
    let totalDebit = 0;
    let totalCredit = 0;
    
    // Read debit/credit amounts directly from the cells (which contain stored database values)
    // The database already has the correct calculated values, so we should use those directly
    rows.forEach((row) => {
        const debitCell = row.querySelector('td.debit-amount');
        const creditCell = row.querySelector('td.credit-amount');
        
        // Read the actual stored values from the database (displayed in cells)
        if (debitCell) {
            const debitValue = parseFloat(debitCell.textContent.replace(/,/g, '')) || 0;
            totalDebit += debitValue;
        }
        
        if (creditCell) {
            const creditValue = parseFloat(creditCell.textContent.replace(/,/g, '')) || 0;
            totalCredit += creditValue;
        }
    });
    
    const difference = totalDebit - totalCredit;
    const isBalanced = Math.abs(difference) < 0.01;
    
    // Update display elements
    const totalDebitElement = document.getElementById('display-total-debit');
    const totalCreditElement = document.getElementById('display-total-credit');
    const balanceStatusElement = document.getElementById('display-balance-status');
    
    if (totalDebitElement) {
        const formattedDebit = totalDebit.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        totalDebitElement.textContent = formattedDebit;
        // Set color: green if balanced, red if not balanced
        if (isBalanced) {
            totalDebitElement.className = 'font-medium text-green-600';
        } else {
            totalDebitElement.className = 'font-medium text-red-600';
        }
    }
    
    if (totalCreditElement) {
        const formattedCredit = totalCredit.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        totalCreditElement.textContent = formattedCredit;
        // Set color: green if balanced, green if not balanced (always green for credit)
        totalCreditElement.className = 'font-medium text-green-600';
    }
    
    if (balanceStatusElement) {
        if (isBalanced) {
            balanceStatusElement.textContent = 'гүйлгээ тэнцсэн ✓';
            balanceStatusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
        } else {
            balanceStatusElement.textContent = `гүйлгээ тэнцээгүй (${difference.toFixed(2)})`;
            balanceStatusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
        }
    }
}

// Make function globally available
window.calculateCashDocumentTotals = calculateCashDocumentTotals;

// Load document details via AJAX with caching
function loadDocumentDetails(documentId) {
    // CRITICAL: Don't load details for deleted documents
    // Check if the document is deleted by looking at the row
    const row = document.querySelector(`tr[data-document-id="${documentId}"]`);
    if (row && (row.classList.contains('deleted-row') || row.style.pointerEvents === 'none')) {
        return;
    }
    
    // Also check if document is deleted in allDocumentsData
    if (typeof allDocumentsData !== 'undefined' && Array.isArray(allDocumentsData)) {
        const doc = allDocumentsData.find(d => d.DocumentId == documentId);
        if (doc && doc.IsDelete === true) {
            return;
        }
    }
    
    // Check cache first
    if (detailCache.has(documentId)) {
        renderCachedDetails(documentId);
        return;
    }
    
    // Cancel any existing request
    if (currentDetailRequest) {
        currentDetailRequest.abort();
        currentDetailRequest = null;
    }
    
    // Update URL without page refresh
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('selected_document', documentId);
    window.history.pushState({}, '', currentUrl.toString());
    
    // Update row selection visual state
    updateRowSelection(documentId);
    
    // Show loading state
    showDetailLoadingState();
    
    // Create new AbortController for this request
    currentDetailRequest = new AbortController();
    
    // Make AJAX request to load details
    fetch(`?selected_document=${documentId}&ajax=1`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
        signal: currentDetailRequest.signal
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();
    })
    .then(html => {
        // Clear the current request reference since it completed successfully
        currentDetailRequest = null;
        
        // Cache the response
        detailCache.set(documentId, html);
        
        // Render the details
        renderDetailContent(html);
    })
    .catch(error => {
        // Clear the current request reference
        currentDetailRequest = null;
        
        // Only show error if it's not an abort error
        if (error.name !== 'AbortError') {
            console.error('Error loading document details:', error);
            hideDetailLoadingState();
            showDetailErrorState();
        }
    });
}

// Render cached details
function renderCachedDetails(documentId) {
    const html = detailCache.get(documentId);
    if (html) {
        // Update URL without page refresh
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('selected_document', documentId);
        window.history.pushState({}, '', currentUrl.toString());
        
        // Update row selection visual state
        updateRowSelection(documentId);
        
        // Render the cached content
        renderDetailContent(html);
    }
}

// Render detail content (shared between cached and fresh data)
function renderDetailContent(html) {
        // Find the detail grid container
        const detailContainer = document.getElementById('detail-grid-container');
        
        if (detailContainer) {
            // Replace the current detail grid with the new content
            detailContainer.innerHTML = html;
            
                    // Calculate and display totals after content is loaded
                    setTimeout(() => {
                        if (typeof window.calculateCashDocumentTotals === 'function') {
                            window.calculateCashDocumentTotals();
                        }
                    }, 100); // Small delay to ensure DOM is ready
        }
        
        // Re-initialize grid layout for the new detail grid
        if (typeof Silicon4Grid !== 'undefined') {
            Silicon4Grid.initializeGrid({
                tableSelector: '#detail-grid-container table',
                autoAdjust: true,
                maxWidth: 600,  // Increased max width for desktop screens
                responsive: true
            });
        }
}

// Update row selection visual state and scroll to row
function updateRowSelection(selectedDocumentId) {
    // Remove selection from all rows
    const allRows = document.querySelectorAll('tbody tr[data-document-id]');
    allRows.forEach(row => {
        row.classList.remove('bg-blue-50');
    });
    
    // Add selection to clicked row and scroll to it
    const selectedRow = document.querySelector(`tr[data-document-id="${selectedDocumentId}"]`);
    if (selectedRow) {
        selectedRow.classList.add('bg-blue-50');
        
        // Scroll to the selected row with smooth behavior
        selectedRow.scrollIntoView({
            behavior: 'smooth',
            block: 'center', // Center the row in the viewport
            inline: 'nearest'
        });
    }
}

// Show loading state for detail grid
function showDetailLoadingState() {
    const detailContainer = document.getElementById('detail-grid-container');
    if (detailContainer) {
        const loadingHtml = `
            <div class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <h3 class="mt-2 text-xs font-medium text-gray-900">Loading details...</h3>
                <p class="mt-1 text-xs text-gray-500">Please wait while we load the document details.</p>
            </div>
        `;
        detailContainer.innerHTML = loadingHtml;
    }
}

// Hide loading state
function hideDetailLoadingState() {
    // Loading state will be replaced by actual content
}

// Show error state for detail grid
function showDetailErrorState() {
    const detailContainer = document.getElementById('detail-grid-container');
    if (detailContainer) {
        const errorHtml = `
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="mt-2 text-xs font-medium text-gray-900">Error loading details</h3>
                <p class="mt-1 text-xs text-gray-500">There was an error loading the document details. Please try again.</p>
                <div class="mt-6">
                    <button onclick="location.reload()" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700">
                        Reload Page
                    </button>
                </div>
            </div>
        `;
        detailContainer.innerHTML = errorHtml;
    }
}

// Show confirmation modal with YES/NO buttons
function showConfirmationModal(message, title, onYesCallback, templateId = null) {
    const modal = document.getElementById('message-modal');
    if (!modal) {
        console.warn('Message modal not found, falling back to confirm');
        if (confirm(message)) {
            onYesCallback();
        }
        return;
    }
    
    // Get elements
    const iconContainer = document.getElementById('message-modal-icon-container');
    const titleElement = document.getElementById('message-modal-title');
    const textElement = document.getElementById('message-modal-text');
    const okButton = document.getElementById('message-modal-ok-btn');
    const yesNoButtons = document.getElementById('message-modal-yesno-buttons');
    const yesButton = document.getElementById('message-modal-yes-btn');
    const noButton = document.getElementById('message-modal-no-btn');
    
    // Hide all icons
    const icons = {
        error: document.getElementById('message-modal-icon-error'),
        success: document.getElementById('message-modal-icon-success'),
        warning: document.getElementById('message-modal-icon-warning'),
        info: document.getElementById('message-modal-icon-info')
    };
    
    Object.values(icons).forEach(icon => {
        if (icon) icon.classList.add('hidden');
    });
    
    // Use warning icon for confirmation
    if (iconContainer) {
        iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100';
    }
    if (icons.warning) {
        icons.warning.classList.remove('hidden');
    }
    
    // Update title
    if (titleElement) {
        titleElement.textContent = title || 'Баталгаажуулах';
    }
    
    // Update message - add TemplateId if provided
    if (textElement) {
        let messageText = message.replace(/\n/g, '<br>');
        if (templateId && templateId !== '' && templateId !== 'null' && templateId !== 'undefined') {
            messageText += `<br><br><strong>Таны гүйлгээ хийсэн загварын код: ${templateId}</strong>`;
        }
        textElement.innerHTML = messageText;
    }
    
    // Hide OK button, show YES/NO buttons
    if (okButton) {
        okButton.classList.add('hidden');
    }
    if (yesNoButtons) {
        yesNoButtons.classList.remove('hidden');
        yesNoButtons.classList.add('flex');
        yesNoButtons.style.display = 'flex';
    }
    
    // Remove existing event listeners and add new one for YES button
    const newYesButton = yesButton.cloneNode(true);
    yesButton.parentNode.replaceChild(newYesButton, yesButton);
    
    newYesButton.addEventListener('click', function() {
        modal.classList.add('hidden');
        if (onYesCallback) {
            onYesCallback();
        }
    });
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Focus on YES button for accessibility
    setTimeout(() => newYesButton.focus(), 100);
}

// Check period lock before allowing manage details
function checkPeriodLockForManageDetails(documentId, documentDate, templateId = null) {
    if (!documentDate) {
        // No date, proceed directly
        window.location.href = `/core/cashdocuments/${documentId}/bulk-manage-details/`;
        return;
    }
    
    // Check period lock via API
    fetch(`/core/api/check-period-lock/?date=${documentDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.is_locked) {
                // Show modal for locked period
                if (typeof showMessageModal === 'function') {
                    showMessageModal(data.message, 'error', 'Тухайн сар цоожлогдсон байна.');
                } else {
                    alert(data.message);
                }
            } else {
                // Not locked, proceed directly
                window.location.href = `/core/cashdocuments/${documentId}/bulk-manage-details/`;
            }
        })
        .catch(error => {
            console.error('Period lock check failed:', error);
            // On error, allow manage details (fail open)
            window.location.href = `/core/cashdocuments/${documentId}/bulk-manage-details/`;
        });
}

// Check period lock before allowing edit
function checkPeriodLockForEdit(documentId, documentDate, templateId = null) {
    if (!documentDate) {
        // No date, proceed directly
        window.location.href = `/core/cashdocuments/${documentId}/update/`;
        return;
    }
    
    // Check period lock via API
    fetch(`/core/api/check-period-lock/?date=${documentDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.is_locked) {
                // Show modal for locked period
                if (typeof showMessageModal === 'function') {
                    showMessageModal(data.message, 'error', 'Тухайн сар цоожлогдсон байна.');
                } else {
                    alert(data.message);
                }
            } else {
                // Not locked, proceed directly
                window.location.href = `/core/cashdocuments/${documentId}/update/`;
            }
        })
        .catch(error => {
            console.error('Period lock check failed:', error);
            // On error, allow edit (fail open)
            window.location.href = `/core/cashdocuments/${documentId}/update/`;
        });
}

// Check period lock before allowing delete
function checkPeriodLockForDelete(documentId, documentDate, deleteUrl, documentName) {
    if (!deleteUrl) {
        console.warn('Delete URL missing, aborting period lock check for delete action');
        return;
    }

    const proceedWithDelete = () => {
        if (typeof Silicon4Delete !== 'undefined' && Silicon4Delete.showModal) {
            Silicon4Delete.showModal(deleteUrl, documentName);
        } else {
            window.location.href = deleteUrl;
        }
    };

    if (!documentDate) {
        proceedWithDelete();
        return;
    }

    fetch(`/core/api/check-period-lock/?date=${documentDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.is_locked) {
                if (typeof showMessageModal === 'function') {
                    showMessageModal(data.message, 'error', 'Тухайн сар цоожлогдсон байна.');
                } else {
                    alert(data.message);
                }
            } else {
                proceedWithDelete();
            }
        })
        .catch(error => {
            console.error('Period lock check failed for delete:', error);
            proceedWithDelete();
        });
}


} // End of execution guard
</script>

<!-- Include Message Modal Component -->
{% include 'core/components/message_modal.html' %}

{% endblock %} 
