{% extends 'base.html' %}
{% load static %}
<!-- Trial Closing Entry - Depreciation and Closing Journal -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<parameter name="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% load humanize %}

{% block title %}Байгуулсан Элэгдэл Хаалт{% endblock %}

{% block content %}
<div class="">
    <!-- Date Filter Section -->
    <div class="bg-white shadow rounded-lg p-1 mb-2">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center space-x-2">
                <label for="start-date" class="text-sm font-medium text-gray-700">Эхлэх огноо:</label>
                <input type="date" id="start-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-center space-x-2">
                <label for="end-date" class="text-sm font-medium text-gray-700">Дуусах огноо:</label>
                <input type="date" id="end-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="filter-button" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ХААЛТ ХИЙХ
            </button>
            <button id="restore-button" onclick="restoreView()" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                СЭРГЭЭХ
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white shadow rounded-lg mb-4">
        <div class="border-b-2 border-gray-300">
            <nav class="flex space-x-2 px-6 p-3">
                <button id="tab-trial-balance" onclick="switchToTrialBalanceView()" class="tab-button border border-blue-500 text-blue-600 bg-blue-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    БАЙГУУЛСАН ЭЛЭГДЭЛ
                </button>
                <button id="tab-depreciation" onclick="switchToDepreciationView()" class="tab-button border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ЭЛЭГДЛИЙН БИЧИЛТ
                </button>
                <button id="tab-closing" onclick="switchToClosingView()" class="tab-button border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ХААЛТЫН БИЧИЛТ
                </button>
                <button onclick="printReport()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ХЭВЛЭХ
                </button>
                <button onclick="exportToExcel()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    EXCEL
                </button>
            </nav>
        </div>
    </div>

    <!-- Tab 1: БАЙГУУЛСАН ЭЛЭГДЭЛ (Trial Balance/Depreciation Summary) -->
    <div id="trial-balance-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: block;">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хөрөнгө</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хон.элэг</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хоног</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Байгуулсан</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Үүсгэсэн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Зардал</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Элэгдэл</th>
                    </tr>
                </thead>
                <tbody id="trial-balance-tbody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="10" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Огноогоо сонгоно уу</h3>
                                <p class="text-sm text-gray-500">Эхлэх ба дуусах огноо сонгоод Шүүх товчийг дарна уу.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page-tb" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page-tb" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info-tb" class="text-sm text-gray-700">
                        Нийт <span id="total-count-tb">0</span> бичлэгээс <span id="showing-start-tb">0</span> - <span id="showing-end-tb">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label for="page-size-select" class="text-sm font-medium text-gray-700">Хуудасны хэмжээ:</label>
                        <select id="page-size-select" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="40">40</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button id="prev-page-desktop-tb" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Previous</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <span id="page-info-tb" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                <!-- Dynamic page buttons will be generated here -->
                            </span>
                            <button id="next-page-desktop-tb" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Next</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 2: ЭЛЭГДЛИЙН БИЧИЛТ (Depreciation Journal) -->
    <div id="depreciation-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Огноо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дансны нэр</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валютын дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ханш</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дебит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Кредит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                    </tr>
                </thead>
                <tbody id="depreciation-tbody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Огноогоо сонгоно уу</h3>
                                <p class="text-sm text-gray-500">Эхлэх ба дуусах огноо сонгоод СЭРГЭЭХ товчийг дарна уу.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for Depreciation Tab -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page-dep" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page-dep" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info-dep" class="text-sm text-gray-700">
                        Нийт <span id="total-count-dep">0</span> бичлэгээс <span id="showing-start-dep">0</span> - <span id="showing-end-dep">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page-desktop-dep" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span id="page-info-dep" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            <!-- Dynamic page buttons will be generated here -->
                        </span>
                        <button id="next-page-desktop-dep" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 3: ХААЛТЫН БИЧИЛТ (Closing Journal) -->
    <div id="closing-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Огноо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дансны нэр</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валютын дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ханш</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дебит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Кредит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                    </tr>
                </thead>
                <tbody id="closing-tbody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Огноогоо сонгоно уу</h3>
                                <p class="text-sm text-gray-500">Эхлэх ба дуусах огноо сонгоод СЭРГЭЭХ товчийг дарна уу.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for Closing Tab -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page-clo" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page-clo" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info-clo" class="text-sm text-gray-700">
                        Нийт <span id="total-count-clo">0</span> бичлэгээс <span id="showing-start-clo">0</span> - <span id="showing-end-clo">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page-desktop-clo" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span id="page-info-clo" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            <!-- Dynamic page buttons will be generated here -->
                        </span>
                        <button id="next-page-desktop-clo" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let trialBalanceData = [];
    let depreciationData = [];
    let closingData = [];
    let currentTab = 'trial-balance';
    let currentPage = {
        'trial-balance': 1,
        'depreciation': 1,
        'closing': 1
    };
    let pageSize = 20;
    let totalPages = {
        'trial-balance': 1,
        'depreciation': 1,
        'closing': 1
    };
    let apiCache = new Map();
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initializeAll();
    });
    
    function initializeAll() {
        setDefaultDateValues();
        initializePagination();
        initializePageSizeSelector();
        // Initialize active tab styling
        updateTabStyling(0);
    }
    
    function setDefaultDateValues() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        const formatDateForInput = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        
        if (startDateInput && !startDateInput.value) {
            startDateInput.value = formatDateForInput(firstDay);
        }
        if (endDateInput && !endDateInput.value) {
            endDateInput.value = formatDateForInput(lastDay);
        }
    }
    
    function initializePagination() {
        // Trial Balance pagination
        const prevPageTb = document.getElementById('prev-page-tb');
        const nextPageTb = document.getElementById('next-page-tb');
        const prevPageDesktopTb = document.getElementById('prev-page-desktop-tb');
        const nextPageDesktopTb = document.getElementById('next-page-desktop-tb');
        
        if (prevPageTb) prevPageTb.addEventListener('click', () => changePage('trial-balance', currentPage['trial-balance'] - 1));
        if (nextPageTb) nextPageTb.addEventListener('click', () => changePage('trial-balance', currentPage['trial-balance'] + 1));
        if (prevPageDesktopTb) prevPageDesktopTb.addEventListener('click', () => changePage('trial-balance', currentPage['trial-balance'] - 1));
        if (nextPageDesktopTb) nextPageDesktopTb.addEventListener('click', () => changePage('trial-balance', currentPage['trial-balance'] + 1));
        
        // Depreciation pagination
        const prevPageDep = document.getElementById('prev-page-dep');
        const nextPageDep = document.getElementById('next-page-dep');
        const prevPageDesktopDep = document.getElementById('prev-page-desktop-dep');
        const nextPageDesktopDep = document.getElementById('next-page-desktop-dep');
        
        if (prevPageDep) prevPageDep.addEventListener('click', () => changePage('depreciation', currentPage['depreciation'] - 1));
        if (nextPageDep) nextPageDep.addEventListener('click', () => changePage('depreciation', currentPage['depreciation'] + 1));
        if (prevPageDesktopDep) prevPageDesktopDep.addEventListener('click', () => changePage('depreciation', currentPage['depreciation'] - 1));
        if (nextPageDesktopDep) nextPageDesktopDep.addEventListener('click', () => changePage('depreciation', currentPage['depreciation'] + 1));
        
        // Closing pagination
        const prevPageClo = document.getElementById('prev-page-clo');
        const nextPageClo = document.getElementById('next-page-clo');
        const prevPageDesktopClo = document.getElementById('prev-page-desktop-clo');
        const nextPageDesktopClo = document.getElementById('next-page-desktop-clo');
        
        if (prevPageClo) prevPageClo.addEventListener('click', () => changePage('closing', currentPage['closing'] - 1));
        if (nextPageClo) nextPageClo.addEventListener('click', () => changePage('closing', currentPage['closing'] + 1));
        if (prevPageDesktopClo) prevPageDesktopClo.addEventListener('click', () => changePage('closing', currentPage['closing'] - 1));
        if (nextPageDesktopClo) nextPageDesktopClo.addEventListener('click', () => changePage('closing', currentPage['closing'] + 1));
    }
    
    function initializePageSizeSelector() {
        const pageSizeSelect = document.getElementById('page-size-select');
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = {
                    'trial-balance': 1,
                    'depreciation': 1,
                    'closing': 1
                };
                renderCurrentTab();
            });
        }
    }
    
    async function applyDateFilter() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        apiCache.clear();
        
        const filterButton = document.getElementById('filter-button');
        if (filterButton) {
            filterButton.textContent = 'Тооцоолж байна...';
            filterButton.disabled = true;
        }
        
        let adjustedStartDate = startDate;
        let adjustedEndDate = endDate;
        
        try {
            // Call calculation functions first
            const [depreciationResult, closingResult] = await Promise.all([
                callCalculateDepreciation(startDate, endDate),
                callCalculateClosingRecord(startDate, endDate)
            ]);
            
            // Update dates if they were adjusted
            if (depreciationResult && depreciationResult.adjusted_dates) {
                adjustedStartDate = depreciationResult.adjusted_dates.start_date;
                adjustedEndDate = depreciationResult.adjusted_dates.end_date;
                
                // Update date inputs if dates were adjusted
                document.getElementById('start-date').value = adjustedStartDate;
                document.getElementById('end-date').value = adjustedEndDate;
            } else if (closingResult && closingResult.adjusted_dates) {
                adjustedStartDate = closingResult.adjusted_dates.start_date;
                adjustedEndDate = closingResult.adjusted_dates.end_date;
                
                // Update date inputs if dates were adjusted
                document.getElementById('start-date').value = adjustedStartDate;
                document.getElementById('end-date').value = adjustedEndDate;
            }
            
            // Show warnings if there were errors (but don't block)
            if (!depreciationResult || !depreciationResult.success) {
                console.warn('Depreciation calculation warning:', depreciationResult?.error || 'Unknown error');
            }
            if (!closingResult || !closingResult.success) {
                console.warn('Closing record calculation warning:', closingResult?.error || 'Unknown error');
            }
        } catch (error) {
            console.error('Error during calculations:', error);
            // Continue with data fetching even if calculations fail
        }
        
        // Update button text for data fetching
        if (filterButton) {
            filterButton.textContent = 'Ачаалж байна...';
        }
        
        // Fetch all data using adjusted dates
        try {
            await Promise.all([
                fetchTrialBalanceData(adjustedStartDate, adjustedEndDate),
                fetchDepreciationJournalData(adjustedStartDate, adjustedEndDate),
                fetchClosingJournalData(adjustedStartDate, adjustedEndDate)
            ]);
        } finally {
            if (filterButton) {
                filterButton.textContent = 'ХААЛТ ХИЙХ';
                filterButton.disabled = false;
            }
        }
    }
    
    async function callCalculateDepreciation(startDate, endDate) {
        try {
            const url = `/core/api/calculate-depreciation/?start_date=${startDate}&end_date=${endDate}`;
            const response = await fetch(url);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error calling calculate depreciation:', error);
            return {
                success: false,
                error: error.message || 'Network error occurred'
            };
        }
    }
    
    async function callCalculateClosingRecord(startDate, endDate) {
        try {
            const url = `/core/api/calculate-closing-record/?start_date=${startDate}&end_date=${endDate}`;
            const response = await fetch(url);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error calling calculate closing record:', error);
            return {
                success: false,
                error: error.message || 'Network error occurred'
            };
        }
    }
    
    function fetchTrialBalanceData(startDate, endDate) {
        const cacheKey = `trial_balance_${startDate}_${endDate}`;
        if (apiCache.has(cacheKey)) {
            trialBalanceData = apiCache.get(cacheKey);
            if (currentTab === 'trial-balance') {
                renderJournalTable(trialBalanceData, 'trial-balance');
            }
            return Promise.resolve();
        }
        
        const url = `/core/api/asset-depreciation-expenses/?start_date=${startDate}&end_date=${endDate}`;
        return fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    trialBalanceData = data.details || [];
                    apiCache.set(cacheKey, trialBalanceData);
                    if (currentTab === 'trial-balance') {
                        renderJournalTable(trialBalanceData, 'trial-balance');
                    }
                } else {
                    showError('trial-balance-tbody', data.error || 'Failed to load trial balance data');
                }
            })
            .catch(error => {
                console.error('Error fetching trial balance:', error);
                showError('trial-balance-tbody', 'Network error occurred');
            });
    }
    
    function fetchDepreciationJournalData(startDate, endDate) {
        const cacheKey = `depreciation_${startDate}_${endDate}`;
        if (apiCache.has(cacheKey)) {
            depreciationData = apiCache.get(cacheKey);
            if (currentTab === 'depreciation') {
                renderJournalTable(depreciationData, 'depreciation');
            }
            return Promise.resolve();
        }
        
        const url = `/core/api/cash-documents-filtered/?start_date=${startDate}&end_date=${endDate}&document_type_id=13`;
        return fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    depreciationData = data.details || [];
                    apiCache.set(cacheKey, depreciationData);
                    if (currentTab === 'depreciation') {
                        renderJournalTable(depreciationData, 'depreciation');
                    }
                } else {
                    showError('depreciation-tbody', data.error || 'Failed to load depreciation journal data');
                }
            })
            .catch(error => {
                console.error('Error fetching depreciation journal:', error);
                showError('depreciation-tbody', 'Network error occurred');
            });
    }
    
    function fetchClosingJournalData(startDate, endDate) {
        const cacheKey = `closing_${startDate}_${endDate}`;
        if (apiCache.has(cacheKey)) {
            closingData = apiCache.get(cacheKey);
            if (currentTab === 'closing') {
                renderJournalTable(closingData, 'closing');
            }
            return Promise.resolve();
        }
        
        const url = `/core/api/cash-documents-filtered/?start_date=${startDate}&end_date=${endDate}&document_type_id=14`;
        return fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closingData = data.details || [];
                    apiCache.set(cacheKey, closingData);
                    if (currentTab === 'closing') {
                        renderJournalTable(closingData, 'closing');
                    }
                } else {
                    showError('closing-tbody', data.error || 'Failed to load closing journal data');
                }
            })
            .catch(error => {
                console.error('Error fetching closing journal:', error);
                showError('closing-tbody', 'Network error occurred');
            });
    }
    
    function renderJournalTable(data, tabKey) {
        const tbodyId = `${tabKey}-tbody`;
        const tbody = document.getElementById(tbodyId);
        
        if (!tbody) {
            return;
        }
        
        if (!data || data.length === 0) {
            const colspan = tabKey === 'trial-balance' ? 10 : 12;
            tbody.innerHTML = `
                <tr>
                    <td colspan="${colspan}" class="px-4 py-8 text-center text-gray-500">
                        <h3 class="text-sm font-medium text-gray-900 mb-1">Мэдээлэл олдсонгүй</h3>
                        <p class="text-sm text-gray-500">Сонгосон хугацаанд мэдээлэл байхгүй байна.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Calculate pagination
        totalPages[tabKey] = Math.ceil(data.length / pageSize);
        if (currentPage[tabKey] > totalPages[tabKey]) currentPage[tabKey] = 1;
        
        const startIndex = (currentPage[tabKey] - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const paginatedData = data.slice(startIndex, endIndex);
        
        // Update pagination info
        updatePaginationInfo(tabKey, data.length, paginatedData.length, startIndex);
        
        // Render rows based on tab type
        let htmlContent = '';
        
        if (tabKey === 'trial-balance') {
            // Render asset depreciation expense data
            paginatedData.forEach((item) => {
                htmlContent += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_no || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_code || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.asset_card_name || ''}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.daily_expense, 6)}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.expense_day || ''}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.expense_amount, 2)}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.created_date || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.created_by || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.debit_account_code || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.credit_account_code || ''}</td>
                    </tr>
                `;
            });
        } else {
            // Render journal entry data for depreciation and closing tabs
            let totalDebit = 0;
            let totalCredit = 0;
            
            paginatedData.forEach((item) => {
                totalDebit += parseFloat(item.debit_amount) || 0;
                totalCredit += parseFloat(item.credit_amount) || 0;
                
                htmlContent += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_no || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_date || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_code || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_name || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.client_name || ''}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.description || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.currency_name || ''}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.currency_amount, 2)}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.currency_exchange, 4)}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.debit_amount, 2)}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.credit_amount, 2)}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.user_name || ''}</td>
                    </tr>
                `;
            });
            
            // Add totals row for journal tabs
            htmlContent += `
                <tr class="bg-gray-100 font-semibold">
                    <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200" colspan="9">НИЙТ:</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(totalDebit, 2)}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(totalCredit, 2)}</td>
                    <td class="px-1 py-1 text-xs text-gray-900"></td>
                </tr>
            `;
        }
        
        tbody.innerHTML = htmlContent;
    }
    
    function updatePaginationInfo(tabKey, totalRecords, currentRecords, startIndex) {
        const suffix = tabKey === 'trial-balance' ? '-tb' : (tabKey === 'depreciation' ? '-dep' : '-clo');
        
        const showingStart = document.getElementById(`showing-start${suffix}`);
        const showingEnd = document.getElementById(`showing-end${suffix}`);
        const totalCount = document.getElementById(`total-count${suffix}`);
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        
        generatePaginationButtons(tabKey);
    }
    
    function generatePaginationButtons(tabKey) {
        const suffix = tabKey === 'trial-balance' ? '-tb' : (tabKey === 'depreciation' ? '-dep' : '-clo');
        const pageInfo = document.getElementById(`page-info${suffix}`);
        if (!pageInfo) return;
        
        pageInfo.innerHTML = '';
        
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage[tabKey] - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages[tabKey], startPage + maxVisiblePages - 1);
        
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPage[tabKey]
                    ? 'bg-blue-400 text-white hover:bg-blue-500'
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePage(tabKey, i));
            pageInfo.appendChild(button);
        }
    }
    
    function changePage(tabKey, newPage) {
        if (newPage < 1 || newPage > totalPages[tabKey]) return;
        
        currentPage[tabKey] = newPage;
        renderCurrentTab();
    }
    
    function renderCurrentTab() {
        if (currentTab === 'trial-balance') {
            renderJournalTable(trialBalanceData, 'trial-balance');
        } else if (currentTab === 'depreciation') {
            renderJournalTable(depreciationData, 'depreciation');
        } else if (currentTab === 'closing') {
            renderJournalTable(closingData, 'closing');
        }
    }
    
    function switchToTrialBalanceView() {
        currentTab = 'trial-balance';
        document.getElementById('trial-balance-view').style.display = 'block';
        document.getElementById('depreciation-view').style.display = 'none';
        document.getElementById('closing-view').style.display = 'none';
        updateTabStyling(0);
        renderJournalTable(trialBalanceData, 'trial-balance');
    }
    
    function switchToDepreciationView() {
        currentTab = 'depreciation';
        document.getElementById('trial-balance-view').style.display = 'none';
        document.getElementById('depreciation-view').style.display = 'block';
        document.getElementById('closing-view').style.display = 'none';
        updateTabStyling(1);
        renderJournalTable(depreciationData, 'depreciation');
    }
    
    function switchToClosingView() {
        currentTab = 'closing';
        document.getElementById('trial-balance-view').style.display = 'none';
        document.getElementById('depreciation-view').style.display = 'none';
        document.getElementById('closing-view').style.display = 'block';
        updateTabStyling(2);
        renderJournalTable(closingData, 'closing');
    }
    
    function updateTabStyling(activeIndex) {
        // Get all tab buttons (first 3 are the main tabs)
        const tabTrialBalance = document.getElementById('tab-trial-balance');
        const tabDepreciation = document.getElementById('tab-depreciation');
        const tabClosing = document.getElementById('tab-closing');
        
        // Reset all tabs to inactive state
        [tabTrialBalance, tabDepreciation, tabClosing].forEach(tab => {
            if (tab) {
                tab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50', 'font-semibold');
                tab.classList.add('border-gray-300', 'text-gray-500', 'bg-white');
            }
        });
        
        // Set active tab styling
        let activeTab = null;
        if (activeIndex === 0) activeTab = tabTrialBalance;
        else if (activeIndex === 1) activeTab = tabDepreciation;
        else if (activeIndex === 2) activeTab = tabClosing;
        
        if (activeTab) {
            activeTab.classList.remove('border-gray-300', 'text-gray-500', 'bg-white');
            activeTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50', 'font-semibold');
        }
    }
    
    function showError(tbodyId, message) {
        const tbody = document.getElementById(tbodyId);
        if (tbody) {
            const colspan = tbodyId === 'trial-balance-tbody' ? 10 : 12;
            tbody.innerHTML = `
                <tr>
                    <td colspan="${colspan}" class="px-4 py-8 text-center text-red-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="text-sm font-medium text-red-900 mb-1">Алдаа гарлаа</h3>
                            <p class="text-sm text-red-500">${message}</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || isNaN(value)) return '0.00';
        return parseFloat(value).toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }
    
    function printReport() {
        window.print();
    }
    
    function exportToExcel() {
        let data = [];
        let filename = '';
        
        if (currentTab === 'trial-balance') {
            data = trialBalanceData;
            filename = 'trial_balance';
        } else if (currentTab === 'depreciation') {
            data = depreciationData;
            filename = 'depreciation_journal';
        } else if (currentTab === 'closing') {
            data = closingData;
            filename = 'closing_journal';
        }
        
        if (data.length === 0) {
            alert('No data to export');
            return;
        }
        
        // Create CSV content
        let csvContent = 'Баримт,Огноо,Данс,Дансны нэр,Харилцагч,Гүйлгээний утга,Валют,Валютын дүн,Ханш,Дебит дүн,Кредит дүн,Хэрэглэгч\n';
        
        data.forEach(item => {
            csvContent += `"${item.document_no || ''}","${item.document_date || ''}","${item.account_code || ''}","${item.account_name || ''}","${item.client_name || ''}","${item.description || ''}","${item.currency_name || ''}",${item.currency_amount || 0},${item.currency_exchange || 0},${item.debit_amount || 0},${item.credit_amount || 0},"${item.user_name || ''}"\n`;
        });
        
        // Create and download the file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('Excel exported successfully!');
    }
    
    async function restoreView() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // If no dates selected, reset to default
        if (!startDate || !endDate) {
            setDefaultDateValues();
            return;
        }
        
        // Clear cache to force fresh data fetch
        apiCache.clear();
        
        // Reset to first tab
        currentTab = 'trial-balance';
        currentPage = {
            'trial-balance': 1,
            'depreciation': 1,
            'closing': 1
        };
        
        // Show trial balance view
        document.getElementById('trial-balance-view').style.display = 'block';
        document.getElementById('depreciation-view').style.display = 'none';
        document.getElementById('closing-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling(0);
        
        // Show loading state
        const restoreButton = document.getElementById('restore-button');
        if (restoreButton) {
            restoreButton.textContent = 'Ачаалж байна...';
            restoreButton.disabled = true;
        }
        
        try {
            // Fetch data WITHOUT calling calculation functions
            await Promise.all([
                fetchTrialBalanceData(startDate, endDate),
                fetchDepreciationJournalData(startDate, endDate),
                fetchClosingJournalData(startDate, endDate)
            ]);
        } finally {
            if (restoreButton) {
                restoreButton.textContent = 'СЭРГЭЭХ';
                restoreButton.disabled = false;
            }
        }
    }
    
    // Event listeners
    document.getElementById('filter-button').addEventListener('click', applyDateFilter);
</script>
{% endblock %}

