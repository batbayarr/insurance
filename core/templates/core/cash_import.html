{% extends 'base.html' %}
{% load static %}
<!-- FORCE NO CACHE - New File -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% load humanize %}

{% block title %}Cash Import{% endblock %}

{% block content %}
<div class="">
    <!-- Instructions Section -->
    <div class="bg-white shadow rounded-lg p-4 mb-4">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-800 mb-2">Импорт</h2>
                <p class="text-sm text-gray-600">Excel-оос мэдээллийг хуулахдаа 6 баганатай мэдээлэл шаардлагатай: Огноо, Гүйлгээний утга, Дебит дүн, Кредит дүн, Данс, Харилцагч</p>
            </div>
            <div class="flex space-x-2">
                <button id="add-row-button" onclick="addNewRow()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                    МӨР НЭМЭХ
                </button>
                <button id="import-button" onclick="importCashDocuments()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ИМПОРТЛОХ
                </button>
                <button onclick="clearTable()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                    ЦЭВЭРЛЭХ
                </button>
            </div>
        </div>
    </div>

    <!-- Import Table -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200">
        <div class="overflow-x-auto">
            <table class="min-w-full border-collapse border border-gray-300" id="import-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-16">№</th>
                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-16">Устгах</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-32">Огноо</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-100">Гүйлгээний утга</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-32">Дебит дүн</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-32">Кредит дүн</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-16">Данс</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-32">Харилцагч</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-20">Загвар</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-60">Загварын нэр</th>
                    </tr>
                </thead>
                <tbody id="import-table-body" class="bg-white">
                    <tr id="empty-state">
                        <td colspan="10" class="px-2 py-2 text-center text-gray-500 border border-gray-300">
                            Excel-ээс мэдээллийг хуулж (Ctrl+C), энд дараад (Ctrl+V) дарна  уу?
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div id="pagination-container" class="bg-white shadow rounded-lg p-4 mt-4" style="display: none;">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
                Нийт: <span id="total-rows">0</span> мөр
            </div>
            <div class="flex items-center space-x-2">
                <button id="prev-page" onclick="goToPage(currentPage - 1)" class="px-3 py-1 text-sm border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Өмнөх
                </button>
                <span class="text-sm text-gray-700">
                    Хуудас <span id="current-page">1</span> / <span id="total-pages">1</span>
                </span>
                <button id="next-page" onclick="goToPage(currentPage + 1)" class="px-3 py-1 text-sm border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Дараах
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template Selection Modal -->
<div id="template-selection-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-4 border w-11/12 max-w-5xl min-w-[800px] shadow-xl rounded-lg bg-white">
        <!-- Modal Header -->
        <div class="flex justify-between items-center px-4 py-2 bg-white border-b border-gray-200">
            <div>
                <h3 class="text-lg font-medium text-gray-900">Загвар сонгох</h3>
                <p id="modal-account-info" class="text-sm text-gray-600"></p>
            </div>
            <button onclick="closeTemplateModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Search Filter -->
        <div class="px-4 py-3 border-b border-gray-200">
            <input type="text" id="template-search" placeholder="Загварын нэрээр хайх..." 
                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Template List Table -->
        <div class="overflow-x-auto max-h-96">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Загварын ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Загварын нэр</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Данс</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дансны нэр</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Баримтын төрөл</th>
                    </tr>
                </thead>
                <tbody id="template-list-body" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Ачааллаж байна...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Number formatting functions
    function normalizeNumericValue(value) {
        if (value === undefined || value === null) {
            return '';
        }
        return value.toString().replace(/,/g, '').trim();
    }

    function parseNumericValue(value, defaultValue = 0) {
        const normalized = normalizeNumericValue(value);
        if (normalized === '') {
            return defaultValue;
        }
        const parsed = parseFloat(normalized);
        return isNaN(parsed) ? defaultValue : parsed;
    }

    function formatNumericString(value) {
        if (value === undefined || value === null || value === '') {
            return '';
        }
        const normalized = normalizeNumericValue(value);
        if (normalized === '' || isNaN(normalized)) {
            return normalized;
        }
        const num = parseFloat(normalized);
        if (isNaN(num)) {
            return '';
        }
        // Format with 2 decimal places and thousand separators
        return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Message Modal Function
    function showMessageModal(message, type = 'error', title = null) {
        const modal = document.getElementById('message-modal');
        if (!modal) {
            console.warn('Message modal not found, falling back to alert');
            alert(message);
            return;
        }
        
        const iconContainer = document.getElementById('message-modal-icon-container');
        const titleElement = document.getElementById('message-modal-title');
        const textElement = document.getElementById('message-modal-text');
        const okButton = document.getElementById('message-modal-ok-btn');
        const yesNoButtons = document.getElementById('message-modal-yesno-buttons');
        
        // Hide YES/NO buttons, show OK button (for backward compatibility)
        if (yesNoButtons) {
            yesNoButtons.classList.add('hidden');
        }
        if (okButton) {
            okButton.classList.remove('hidden');
        }
        
        // Hide all icons
        const icons = {
            error: document.getElementById('message-modal-icon-error'),
            success: document.getElementById('message-modal-icon-success'),
            warning: document.getElementById('message-modal-icon-warning'),
            info: document.getElementById('message-modal-icon-info')
        };
        
        Object.values(icons).forEach(icon => {
            if (icon) icon.classList.add('hidden');
        });
        
        // Set styles based on type
        const typeConfig = {
            error: {
                bgClass: 'bg-red-100',
                btnClass: 'bg-red-500 hover:bg-red-600 focus:ring-red-300',
                defaultTitle: 'Алдаа'
            },
            success: {
                bgClass: 'bg-green-100',
                btnClass: 'bg-green-500 hover:bg-green-600 focus:ring-green-300',
                defaultTitle: 'Амжилттай'
            },
            warning: {
                bgClass: 'bg-yellow-100',
                btnClass: 'bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-300',
                defaultTitle: 'Анхааруулга'
            },
            info: {
                bgClass: 'bg-blue-100',
                btnClass: 'bg-blue-500 hover:bg-blue-600 focus:ring-blue-300',
                defaultTitle: 'Мэдээлэл'
            }
        };
        
        const config = typeConfig[type] || typeConfig.error;
        
        // Update icon container background
        if (iconContainer) {
            iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${config.bgClass}`;
        }
        
        // Show appropriate icon
        if (icons[type]) {
            icons[type].classList.remove('hidden');
        }
        
        // Update title
        if (titleElement) {
            titleElement.textContent = title || config.defaultTitle;
        }
        
        // Update message (preserve line breaks)
        if (textElement) {
            textElement.innerHTML = message.replace(/\n/g, '<br>');
        }
        
        // Update button style
        if (okButton) {
            okButton.className = `px-4 py-2 ${config.btnClass} text-white text-base font-medium rounded-md w-24 focus:outline-none focus:ring-2`;
        }
        
        // Show modal
        modal.classList.remove('hidden');
        
        // Focus on OK button for accessibility
        if (okButton) {
            setTimeout(() => okButton.focus(), 100);
        }
    }

    let importedData = [];
    let currentPage = 1;
    const rowsPerPage = 20;
    let currentRowIndex = null;
    let allTemplates = [];
    let filteredTemplates = [];
    let invalidRowIndices = []; // Track which rows have validation errors

    // Initialize paste handler
    document.addEventListener('DOMContentLoaded', function() {
        const tableContainer = document.getElementById('import-table');
        
        // Listen for paste events anywhere in the document
        document.addEventListener('paste', handlePaste);
        
        // Also handle paste on the table specifically
        if (tableContainer) {
            tableContainer.addEventListener('paste', handlePaste);
        }

        // Template search handler
        const templateSearch = document.getElementById('template-search');
        if (templateSearch) {
            templateSearch.addEventListener('input', function() {
                filterTemplates(this.value);
            });
        }
    });

    // Convert date to YYYY-MM-DD format
    function convertDateToYYYYMMDD(dateString) {
        if (!dateString) return '';
        
        // Handle various date formats
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            // Try parsing different formats
            const parts = dateString.split(/[-\/\.]/);
            if (parts.length === 3) {
                // Assume MM/DD/YYYY or DD/MM/YYYY
                let year, month, day;
                if (parts[0].length === 4) {
                    // YYYY-MM-DD or YYYY/MM/DD
                    year = parts[0];
                    month = parts[1].padStart(2, '0');
                    day = parts[2].padStart(2, '0');
                } else {
                    // Try MM/DD/YYYY first
                    const testDate1 = new Date(`${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`);
                    // Try DD/MM/YYYY
                    const testDate2 = new Date(`${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`);
                    
                    if (!isNaN(testDate1.getTime())) {
                        year = parts[2];
                        month = parts[0].padStart(2, '0');
                        day = parts[1].padStart(2, '0');
                    } else if (!isNaN(testDate2.getTime())) {
                        year = parts[2];
                        month = parts[1].padStart(2, '0');
                        day = parts[0].padStart(2, '0');
                    } else {
                        return dateString; // Return as-is if can't parse
                    }
                }
                return `${year}-${month}-${day}`;
            }
            return dateString; // Return as-is if can't parse
        }
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Handle paste event
    function handlePaste(e) {
        e.preventDefault();
        const pasteData = e.clipboardData.getData('text');
        parseAndRenderData(pasteData);
    }

    // Parse and render pasted data
    function parseAndRenderData(data) {
        if (!data || !data.trim()) {
            console.warn('No data to parse');
            return;
        }

        const rows = data.trim().split(/\r?\n/); // Handle both \n and \r\n
        const tbody = document.getElementById('import-table-body');
        const emptyState = document.getElementById('empty-state');
        
        // Remove empty state if it exists
        if (emptyState) {
            emptyState.remove();
        }

        // Reset data when pasting new data
        importedData = [];
        currentPage = 1;

        // Check if first row looks like headers (common header keywords)
        const headerKeywords = ['огноо', 'дата', 'date', 'гүйлгээний', 'description', 'дебит', 'дебет', 'debit', 'кредит', 'credit', 'дэнс', 'дэн', 'account', 'данс', 'харилцагч', 'client'];
        let startIndex = 0;
        if (rows.length > 0) {
            const firstRowCells = rows[0].split('\t').map(cell => cell.trim().toLowerCase());
            const looksLikeHeader = firstRowCells.some(cell => headerKeywords.some(keyword => cell.includes(keyword)));
            if (looksLikeHeader) {
                startIndex = 1; // Skip header row
                console.log('Skipping header row');
            }
        }

        rows.forEach((rowData, rowIndex) => {
            // Skip header row if detected
            if (rowIndex < startIndex) {
                return;
            }

            // Split by tab and trim each cell
            const cells = rowData.split('\t').map(cell => cell.trim());
            
            // Skip if row is empty or has no meaningful data
            if (cells.length === 0 || cells.every(cell => !cell || cell === '')) {
                return;
            }

            // Validate we have at least 6 columns, pad if needed
            while (cells.length < 6) {
                cells.push('');
            }

            // Convert date to YYYY-MM-DD format
            const dateString = convertDateToYYYYMMDD(cells[0]);

            // Store data - expecting 6 columns: Огноо, Гүйлгээний утга, Дебит дүн, Кредит дүн, Данс, Харилцагч
            // Note: Excel column 2 is Дебит дүн, column 3 is Кредит дүн (matching table order: Debit before Credit)
            // Append ":имп" to Description
            const description = (cells[1] || '').trim();
            const descriptionWithImport = description ? description + ':имп' : '';
            
            importedData.push({
                DocumentDate: dateString,
                Description: descriptionWithImport,
                DebitAmount: Math.abs(parseFloat(cells[2].replace(/,/g, '')) || 0), // Excel column 2 is Дебит дүн - use absolute value
                CreditAmount: Math.abs(parseFloat(cells[3].replace(/,/g, '')) || 0), // Excel column 3 is Кредит дүн - use absolute value
                AccountCode: cells[4] || '',
                AccountId: null, // Will be populated after lookup or modal selection
                ClientCode: cells[5] || '', // Excel column 5 is Харилцагч (ClientName)
                ClientId: null, // Will be populated after lookup
                ClientMatched: false, // Flag to track if client was matched
                DocumentTypeId: null, // Hidden field
                TemplateId: null, // Hidden field (will be populated when user selects template)
                TemplateName: '', // Hidden field (will be populated when user selects template)
                IsVat: false // Hidden boolean field (will be populated when user selects template)
            });
        });

        console.log(`Imported ${importedData.length} rows`);
        if (importedData.length > 0) {
            console.log('First row sample:', importedData[0]);
        }
        
        // Lookup clients for all rows
        lookupClientsForAllRows();
    }

    // Lookup clients for all imported rows
    async function lookupClientsForAllRows() {
        const lookupPromises = importedData.map(async (rowData, index) => {
            if (!rowData.ClientCode || rowData.ClientCode.trim() === '') {
                return; // Skip empty client codes
            }
            
            try {
                const response = await fetch(`/core/api/client-lookup-by-name/?client_name=${encodeURIComponent(rowData.ClientCode.trim())}`);
                const data = await response.json();
                
                if (data.success && data.found && data.client) {
                    importedData[index].ClientId = data.client.ClientId;
                    importedData[index].ClientMatched = true;
                    console.log(`Matched client: ${rowData.ClientCode} -> ClientId: ${data.client.ClientId}`);
                } else {
                    importedData[index].ClientId = null;
                    importedData[index].ClientMatched = false;
                    console.log(`No match found for client: ${rowData.ClientCode}`);
                }
            } catch (error) {
                console.error(`Error looking up client ${rowData.ClientCode}:`, error);
                importedData[index].ClientId = null;
                importedData[index].ClientMatched = false;
            }
        });
        
        // Wait for all lookups to complete
        await Promise.all(lookupPromises);
        
        // Render table after all lookups are done
        renderTable();
    }

    // Render table with pagination
    function renderTable() {
        const tbody = document.getElementById('import-table-body');
        
        if (!importedData || importedData.length === 0) {
            tbody.innerHTML = '<tr id="empty-state"><td colspan="10" class="px-2 py-2 text-center text-gray-500 border border-gray-300">Excel-оос мэдээллийг хуулж, энд дараад (Ctrl+V) тавина уу</td></tr>';
            document.getElementById('pagination-container').style.display = 'none';
            return;
        }

        // Calculate pagination
        const totalPages = Math.ceil(importedData.length / rowsPerPage);
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, importedData.length);
        const pageData = importedData.slice(startIndex, endIndex);

        // Clear and populate table
        tbody.innerHTML = '';

        pageData.forEach((rowData, index) => {
            const actualRowIndex = startIndex + index; // Use 0-based index for array
            const row = document.createElement('tr');
            
            // Mark row as invalid if it's in the invalidRowIndices array
            if (invalidRowIndices.includes(actualRowIndex)) {
                row.className = 'hover:bg-red-100 bg-red-50 border-red-300';
            } else {
                row.className = 'hover:bg-gray-50';
            }

            // Row number
            const rowNumCell = document.createElement('td');
            if (invalidRowIndices.includes(actualRowIndex)) {
                rowNumCell.className = 'px-2 py-1 whitespace-nowrap text-sm text-gray-900 border border-red-300 bg-red-50';
            } else {
                rowNumCell.className = 'px-2 py-1 whitespace-nowrap text-sm text-gray-900 border border-gray-300';
            }
            rowNumCell.textContent = actualRowIndex + 1;
            row.appendChild(rowNumCell);

            // Delete action cell
            const deleteCell = document.createElement('td');
            if (invalidRowIndices.includes(actualRowIndex)) {
                deleteCell.className = 'px-2 py-1 text-center border border-red-300 bg-red-50';
            } else {
                deleteCell.className = 'px-2 py-1 text-center border border-gray-300';
            }
            const deleteButton = document.createElement('button');
            deleteButton.className = 'text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50 transition-colors';
            deleteButton.title = 'Мөр устгах';
            deleteButton.onclick = (e) => {
                e.stopPropagation();
                removeImportedRow(actualRowIndex);
            };
            deleteButton.innerHTML = `
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            `;
            deleteCell.appendChild(deleteButton);
            row.appendChild(deleteCell);

            // DocumentDate - editable input
            const dateCell = document.createElement('td');
            if (invalidRowIndices.includes(actualRowIndex)) {
                dateCell.className = 'px-2 py-1 border border-red-300 bg-red-50';
            } else {
                dateCell.className = 'px-2 py-1 border border-gray-300';
            }
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.className = 'w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500';
            dateInput.value = rowData.DocumentDate || '';
            dateInput.onchange = () => {
                importedData[actualRowIndex].DocumentDate = dateInput.value;
                // Remove from invalid rows if it was marked
                if (invalidRowIndices.includes(actualRowIndex)) {
                    invalidRowIndices = invalidRowIndices.filter(idx => idx !== actualRowIndex);
                    renderTable(); // Re-render to remove red mark
                }
            };
            dateCell.appendChild(dateInput);
            row.appendChild(dateCell);

            // Description - editable input
            const descCell = document.createElement('td');
            if (invalidRowIndices.includes(actualRowIndex)) {
                descCell.className = 'px-2 py-1 border border-red-300 bg-red-50';
            } else {
                descCell.className = 'px-2 py-1 border border-gray-300';
            }
            const descInput = document.createElement('input');
            descInput.type = 'text';
            descInput.className = 'w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500';
            descInput.value = rowData.Description ? rowData.Description.replace(':имп', '') : '';
            descInput.onchange = () => {
                let desc = descInput.value.trim();
                if (desc && !desc.endsWith(':имп')) {
                    desc += ':имп';
                }
                importedData[actualRowIndex].Description = desc;
                // Remove from invalid rows if it was marked
                if (invalidRowIndices.includes(actualRowIndex)) {
                    invalidRowIndices = invalidRowIndices.filter(idx => idx !== actualRowIndex);
                    renderTable(); // Re-render to remove red mark
                }
            };
            descCell.appendChild(descInput);
            row.appendChild(descCell);

            // DebitAmount - editable input with formatting
            const debitCell = document.createElement('td');
            if (invalidRowIndices.includes(actualRowIndex)) {
                debitCell.className = 'px-2 py-1 border border-red-300 bg-red-50';
            } else {
                debitCell.className = 'px-2 py-1 border border-gray-300';
            }
            const debitInput = document.createElement('input');
            debitInput.type = 'text';
            debitInput.inputMode = 'decimal';
            debitInput.className = 'w-full px-2 py-1 text-xs text-right border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500';
            debitInput.value = formatNumericString(rowData.DebitAmount || 0);
            debitInput.onfocus = () => {
                // Show raw number when focused for easier editing
                const rawValue = parseNumericValue(debitInput.value, 0);
                debitInput.value = rawValue === 0 ? '' : rawValue.toString();
            };
            debitInput.onblur = () => {
                // Format on blur
                const parsed = parseNumericValue(debitInput.value, 0);
                importedData[actualRowIndex].DebitAmount = parsed;
                debitInput.value = formatNumericString(parsed);
                // Remove from invalid rows if it was marked
                if (invalidRowIndices.includes(actualRowIndex)) {
                    invalidRowIndices = invalidRowIndices.filter(idx => idx !== actualRowIndex);
                }
            };
            debitInput.onchange = () => {
                const parsed = parseNumericValue(debitInput.value, 0);
                importedData[actualRowIndex].DebitAmount = parsed;
                debitInput.value = formatNumericString(parsed);
                // Remove from invalid rows if it was marked
                if (invalidRowIndices.includes(actualRowIndex)) {
                    invalidRowIndices = invalidRowIndices.filter(idx => idx !== actualRowIndex);
                }
                renderTable(); // Re-render to update display
            };
            debitCell.appendChild(debitInput);
            row.appendChild(debitCell);

            // CreditAmount - editable input with formatting
            const creditCell = document.createElement('td');
            if (invalidRowIndices.includes(actualRowIndex)) {
                creditCell.className = 'px-2 py-1 border border-red-300 bg-red-50';
            } else {
                creditCell.className = 'px-2 py-1 border border-gray-300';
            }
            const creditInput = document.createElement('input');
            creditInput.type = 'text';
            creditInput.inputMode = 'decimal';
            creditInput.className = 'w-full px-2 py-1 text-xs text-right border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500';
            creditInput.value = formatNumericString(rowData.CreditAmount || 0);
            creditInput.onfocus = () => {
                // Show raw number when focused for easier editing
                const rawValue = parseNumericValue(creditInput.value, 0);
                creditInput.value = rawValue === 0 ? '' : rawValue.toString();
            };
            creditInput.onblur = () => {
                // Format on blur
                const parsed = parseNumericValue(creditInput.value, 0);
                importedData[actualRowIndex].CreditAmount = parsed;
                creditInput.value = formatNumericString(parsed);
                // Remove from invalid rows if it was marked
                if (invalidRowIndices.includes(actualRowIndex)) {
                    invalidRowIndices = invalidRowIndices.filter(idx => idx !== actualRowIndex);
                }
            };
            creditInput.onchange = () => {
                const parsed = parseNumericValue(creditInput.value, 0);
                importedData[actualRowIndex].CreditAmount = parsed;
                creditInput.value = formatNumericString(parsed);
                // Remove from invalid rows if it was marked
                if (invalidRowIndices.includes(actualRowIndex)) {
                    invalidRowIndices = invalidRowIndices.filter(idx => idx !== actualRowIndex);
                }
                renderTable(); // Re-render to update display
            };
            creditCell.appendChild(creditInput);
            row.appendChild(creditCell);

            // AccountCode (Данс) - readonly, clickable to open account selection modal
            const accountCell = document.createElement('td');
            if (invalidRowIndices.includes(actualRowIndex)) {
                accountCell.className = 'px-2 py-1 border border-red-300 bg-red-50';
            } else {
                accountCell.className = 'px-2 py-1 border border-gray-300';
            }
            const accountContainer = document.createElement('div');
            accountContainer.className = 'relative';
            const accountDisplayInput = document.createElement('input');
            accountDisplayInput.type = 'text';
            accountDisplayInput.readOnly = true;
            accountDisplayInput.className = 'w-full px-2 py-1 text-xs border border-gray-300 rounded bg-gray-50 cursor-pointer focus:outline-none focus:ring-1 focus:ring-blue-500';
            accountDisplayInput.value = rowData.AccountCode || '';
            accountDisplayInput.placeholder = 'Click to select account';
            accountDisplayInput.onclick = () => {
                openAccountPopupForImport(actualRowIndex, accountDisplayInput);
            };
            accountContainer.appendChild(accountDisplayInput);
            
            // Add dropdown icon
            const accountIcon = document.createElement('div');
            accountIcon.className = 'absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none';
            accountIcon.innerHTML = `
                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            `;
            accountContainer.appendChild(accountIcon);
            
            // Add hidden AccountId input
            const hiddenAccountId = document.createElement('input');
            hiddenAccountId.type = 'hidden';
            hiddenAccountId.className = 'account-id-input';
            hiddenAccountId.value = rowData.AccountId || '';
            accountContainer.appendChild(hiddenAccountId);
            
            accountCell.appendChild(accountContainer);
            row.appendChild(accountCell);

            // ClientCode (Харилцагч) - readonly, clickable to open client selection modal
            const clientCell = document.createElement('td');
            if (invalidRowIndices.includes(actualRowIndex)) {
                clientCell.className = 'px-2 py-1 whitespace-nowrap text-sm border border-red-300 bg-red-50';
            } else {
                clientCell.className = 'px-2 py-1 whitespace-nowrap text-sm border border-gray-300';
            }
            
            const clientContainer = document.createElement('div');
            clientContainer.className = 'relative';
            
            // Client display input - readonly and clickable
            const clientDisplayInput = document.createElement('input');
            clientDisplayInput.type = 'text';
            clientDisplayInput.readOnly = true;
            let clientDisplayValue = rowData.ClientCode || '';
            if (rowData.ClientCode && !rowData.ClientMatched) {
                clientDisplayInput.classList.add('text-red-600', 'font-semibold');
            } else {
                clientDisplayInput.classList.add('text-gray-900');
            }
            clientDisplayInput.className = 'w-full px-2 py-1 text-xs border border-gray-300 rounded bg-gray-50 cursor-pointer focus:outline-none focus:ring-1 focus:ring-blue-500 ' + (rowData.ClientCode && !rowData.ClientMatched ? 'text-red-600 font-semibold' : 'text-gray-900');
            clientDisplayInput.value = clientDisplayValue;
            clientDisplayInput.placeholder = 'Click to select client';
            clientDisplayInput.onclick = () => {
                openClientPopupForImport(actualRowIndex, clientCell);
            };
            clientContainer.appendChild(clientDisplayInput);
            
            // Add dropdown icon
            const clientIcon = document.createElement('div');
            clientIcon.className = 'absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none';
            clientIcon.innerHTML = `
                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            `;
            clientContainer.appendChild(clientIcon);
            
            // Add hidden ClientId input
            const hiddenClientId = document.createElement('input');
            hiddenClientId.type = 'hidden';
            hiddenClientId.className = 'client-id-input';
            hiddenClientId.value = rowData.ClientId || '';
            clientContainer.appendChild(hiddenClientId);
            
            clientCell.appendChild(clientContainer);
            row.appendChild(clientCell);

            // TemplateId (Загвар) - with Edit button
            const templateCell = document.createElement('td');
            if (invalidRowIndices.includes(actualRowIndex)) {
                templateCell.className = 'px-2 py-1 whitespace-nowrap text-sm text-gray-900 border border-red-300 bg-red-50';
            } else {
                templateCell.className = 'px-2 py-1 whitespace-nowrap text-sm text-gray-900 border border-gray-300';
            }
            
            const templateContainer = document.createElement('div');
            templateContainer.className = 'flex items-center space-x-2';
            
            const editButton = document.createElement('button');
            editButton.textContent = 'Сонгох';
            editButton.className = 'px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors';
            editButton.onclick = () => openTemplateModal(actualRowIndex, rowData.AccountCode, rowData.DebitAmount, rowData.CreditAmount);
            templateContainer.appendChild(editButton);
            
            if (rowData.TemplateId) {
                const templateIdSpan = document.createElement('span');
                templateIdSpan.textContent = rowData.TemplateId;
                templateIdSpan.className = 'text-gray-700';
                templateContainer.appendChild(templateIdSpan);
            }
            
            // Add hidden DocumentTypeId input
            const hiddenDocumentTypeId = document.createElement('input');
            hiddenDocumentTypeId.type = 'hidden';
            hiddenDocumentTypeId.className = 'document-type-id-input';
            hiddenDocumentTypeId.value = rowData.DocumentTypeId || '';
            templateContainer.appendChild(hiddenDocumentTypeId);
            
            // Add hidden TemplateId input
            const hiddenTemplateId = document.createElement('input');
            hiddenTemplateId.type = 'hidden';
            hiddenTemplateId.className = 'template-id-input';
            hiddenTemplateId.value = rowData.TemplateId || '';
            templateContainer.appendChild(hiddenTemplateId);
            
            // Add hidden IsVat input
            const hiddenIsVat = document.createElement('input');
            hiddenIsVat.type = 'hidden';
            hiddenIsVat.className = 'isvat-input';
            hiddenIsVat.value = rowData.IsVat ? 'true' : 'false';
            templateContainer.appendChild(hiddenIsVat);
            
            templateCell.appendChild(templateContainer);
            row.appendChild(templateCell);

            // TemplateName (Загварын нэр)
            const templateNameCell = document.createElement('td');
            if (invalidRowIndices.includes(actualRowIndex)) {
                templateNameCell.className = 'px-2 py-1 text-sm text-gray-900 border border-red-300 bg-red-50';
            } else {
                templateNameCell.className = 'px-2 py-1 text-sm text-gray-900 border border-gray-300';
            }
            templateNameCell.textContent = rowData.TemplateName || '';
            row.appendChild(templateNameCell);

            tbody.appendChild(row);
        });

        // Update pagination controls
        updatePagination(totalPages);
        updateImportButtonState();
    }

    // Update pagination controls
    function updatePagination(totalPages) {
        const paginationContainer = document.getElementById('pagination-container');
        const totalRowsEl = document.getElementById('total-rows');
        const currentPageEl = document.getElementById('current-page');
        const totalPagesEl = document.getElementById('total-pages');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');

        if (importedData.length === 0) {
            paginationContainer.style.display = 'none';
            return;
        }

        paginationContainer.style.display = 'block';
        
        if (totalRowsEl) totalRowsEl.textContent = importedData.length;
        if (currentPageEl) currentPageEl.textContent = currentPage;
        if (totalPagesEl) totalPagesEl.textContent = totalPages;

        // Enable/disable pagination buttons
        if (prevButton) {
            prevButton.disabled = currentPage <= 1;
        }
        if (nextButton) {
            nextButton.disabled = currentPage >= totalPages;
        }
    }

    // Go to specific page
    function goToPage(page) {
        const totalPages = Math.ceil(importedData.length / rowsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderTable();
        }
    }

    // Clear table function
    function clearTable() {
        importedData = [];
        invalidRowIndices = []; // Clear invalid row indices
        currentPage = 1;
        renderTable();
        updateImportButtonState();
    }

    // Add new empty row
    function addNewRow() {
        const today = new Date();
        const todayString = today.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        importedData.push({
            DocumentDate: todayString,
            Description: ':имп',
            DebitAmount: 0,
            CreditAmount: 0,
            AccountCode: '',
            AccountId: null,
            ClientCode: '',
            ClientId: null,
            ClientMatched: false,
            DocumentTypeId: null,
            TemplateId: null,
            TemplateName: '',
            IsVat: false
        });
        
        // Go to last page to show the new row
        const totalPages = Math.ceil(importedData.length / rowsPerPage);
        currentPage = totalPages;
        
        renderTable();
        updateImportButtonState();
    }

    // Remove a single imported row
    function removeImportedRow(rowIndex) {
        if (rowIndex === null || rowIndex < 0 || rowIndex >= importedData.length) {
            return;
        }
        importedData.splice(rowIndex, 1);
        
        const totalPages = Math.max(1, Math.ceil(Math.max(importedData.length, 1) / rowsPerPage));
        if (currentPage > totalPages) {
            currentPage = totalPages;
        }
        
        renderTable();
        updateImportButtonState();
    }

    // Open template selection modal
    function openTemplateModal(rowIndex, accountCode, debitAmount, creditAmount) {
        currentRowIndex = rowIndex;
        const modal = document.getElementById('template-selection-modal');
        const modalAccountInfo = document.getElementById('modal-account-info');
        
        if (modalAccountInfo) {
            if (accountCode) {
                modalAccountInfo.textContent = `Данс: ${accountCode}`;
            } else {
                modalAccountInfo.textContent = 'Бүх загвар';
            }
        }
        
        // Determine document type IDs based on debit/credit amounts
        let documentTypeIds = null;
        if (debitAmount > 0 && creditAmount === 0) {
            // Debit > 0 and Credit = 0: show templates with DocumentTypeId in (1, 3)
            documentTypeIds = [1, 3];
        } else if (creditAmount > 0 && debitAmount === 0) {
            // Credit > 0 and Debit = 0: show templates with DocumentTypeId in (2, 4)
            documentTypeIds = [2, 4];
        }
        
        // Fetch templates with document type filter
        fetchTemplates(accountCode, documentTypeIds);
        
        // Show modal
        if (modal) {
            modal.classList.remove('hidden');
        }
    }

    // Close template selection modal
    function closeTemplateModal() {
        const modal = document.getElementById('template-selection-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        currentRowIndex = null;
        
        // Clear search
        const searchInput = document.getElementById('template-search');
        if (searchInput) {
            searchInput.value = '';
        }
    }

    // Fetch templates from API
    function fetchTemplates(accountCode, documentTypeIds) {
        const tbody = document.getElementById('template-list-body');
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Ачааллаж байна...</td></tr>';
        
        let url = '/core/api/templates-by-account-code/';
        const params = [];
        if (accountCode) {
            params.push(`account_code=${encodeURIComponent(accountCode)}`);
        }
        if (documentTypeIds && documentTypeIds.length > 0) {
            params.push(`document_type_ids=${documentTypeIds.join(',')}`);
        }
        if (params.length > 0) {
            url += '?' + params.join('&');
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.templates) {
                    // Filter by document type IDs if provided
                    let templates = data.templates;
                    if (documentTypeIds && documentTypeIds.length > 0) {
                        templates = templates.filter(template => 
                            documentTypeIds.includes(template.DocumentTypeId)
                        );
                    }
                    allTemplates = templates;
                    filteredTemplates = [...allTemplates];
                    renderTemplateList();
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Загвар олдсонгүй</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error fetching templates:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-red-500">Алдаа гарлаа</td></tr>';
            });
    }

    // Filter templates by search term
    function filterTemplates(searchTerm) {
        if (!searchTerm || searchTerm.trim() === '') {
            filteredTemplates = [...allTemplates];
        } else {
            const searchLower = searchTerm.toLowerCase();
            filteredTemplates = allTemplates.filter(template => {
                return template.TemplateName.toLowerCase().includes(searchLower) ||
                       (template.AccountCode && template.AccountCode.toLowerCase().includes(searchLower)) ||
                       (template.AccountName && template.AccountName.toLowerCase().includes(searchLower)) ||
                       String(template.TemplateId).includes(searchLower);
            });
        }
        renderTemplateList();
    }

    // Render template list
    function renderTemplateList() {
        const tbody = document.getElementById('template-list-body');
        tbody.innerHTML = '';
        
        if (filteredTemplates.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Загвар олдсонгүй</td></tr>';
            return;
        }
        
        filteredTemplates.forEach(template => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-blue-50 cursor-pointer';
            row.onclick = () => selectTemplate(template.TemplateId, template.TemplateName, template.DocumentTypeId, template.IsVat);
            
            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${template.TemplateId}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${template.TemplateName}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${template.AccountCode || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${template.AccountName || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${template.DocumentTypeName || '-'}</td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // Select template and update row
    function selectTemplate(templateId, templateName, documentTypeId, isVat) {
        if (currentRowIndex === null || currentRowIndex < 0 || currentRowIndex >= importedData.length) {
            console.error('Invalid row index');
            return;
        }
        
        // Update importedData
        importedData[currentRowIndex].TemplateId = templateId;
        importedData[currentRowIndex].TemplateName = templateName;
        if (documentTypeId) {
            importedData[currentRowIndex].DocumentTypeId = documentTypeId;
        }
        importedData[currentRowIndex].IsVat = isVat || false; // Populate IsVat from template
        
        // Remove from invalid rows if it was marked
        if (invalidRowIndices.includes(currentRowIndex)) {
            invalidRowIndices = invalidRowIndices.filter(idx => idx !== currentRowIndex);
        }
        
        // Re-render table to show updated values
        renderTable();
        updateImportButtonState();
        
        // Close modal
        closeTemplateModal();
    }

    // Store current row index being edited for client selection
    let currentClientRowIndex = null;
    
    // Store current row index being edited for account selection
    let currentAccountRowIndex = null;

    // Open client popup for import (when clicking client field)
    function openClientPopupForImport(rowIndex, cellElement) {
        currentClientRowIndex = rowIndex;
        
        // Find the input element within the cell
        const inputElement = cellElement.querySelector('input[type="text"]') || cellElement;
        
        // Store reference to cell element for later use
        window.currentClientInput = inputElement;
        window.currentClientRowId = `import-row-${rowIndex}`;
        
        // Use existing openClientPopup function from modal
        if (typeof window.openClientPopup === 'function') {
            window.openClientPopup(inputElement, `import-row-${rowIndex}`, {});
        } else {
            // Fallback: open modal directly
            const modal = document.getElementById('client-selection-modal');
            if (modal) {
                modal.classList.remove('hidden');
                if (typeof window.loadClientList === 'function') {
                    window.loadClientList({});
                }
            }
        }
    }
    
    // Open account popup for import (when clicking account field)
    function openAccountPopupForImport(rowIndex, inputElement) {
        currentAccountRowIndex = rowIndex;
        
        // Store reference to input element for later use
        window.currentAccountInput = inputElement;
        window.currentAccountRowId = `import-row-${rowIndex}`;
        
        // Use existing openAccountPopup function from modal
        if (typeof window.openAccountPopup === 'function') {
            window.openAccountPopup(inputElement, `import-row-${rowIndex}`, {
                modalTitle: 'Select Account',
                modalSubtitle: 'Choose an account for cash transactions'
            });
        } else {
            // Fallback: open modal directly
            const modal = document.getElementById('account-selection-modal');
            if (modal) {
                modal.classList.remove('hidden');
                if (typeof window.loadAccountList === 'function') {
                    window.loadAccountList({});
                }
            }
        }
    }

    // Override selectClient to handle our import case
    // This will run after the modal component is loaded
    let clientSelectionOverrideSetup = false;
    function setupClientSelectionOverride() {
        if (clientSelectionOverrideSetup) return; // Already setup
        
        if (typeof window.selectClient === 'function') {
            clientSelectionOverrideSetup = true;
            const originalSelectClient = window.selectClient;
            window.selectClient = function(clientId, clientCode, clientName) {
                // Check if we're in import mode (currentClientRowIndex is set)
                if (currentClientRowIndex !== null && currentClientRowIndex >= 0 && currentClientRowIndex < importedData.length) {
                    // Update importedData
                    importedData[currentClientRowIndex].ClientId = clientId;
                    importedData[currentClientRowIndex].ClientCode = `${clientCode} - ${clientName}`; // Update to show code and name
                    importedData[currentClientRowIndex].ClientCodeOriginal = clientCode; // Store original code for validation
                    importedData[currentClientRowIndex].ClientName = clientName; // Store client name
                    importedData[currentClientRowIndex].ClientMatched = true;
                    
                    // Remove from invalid rows if it was marked
                    if (invalidRowIndices.includes(currentClientRowIndex)) {
                        invalidRowIndices = invalidRowIndices.filter(idx => idx !== currentClientRowIndex);
                    }
                    
                    // Clear the stored reference
                    currentClientRowIndex = null;
                    window.currentClientInput = null;
                    window.currentClientRowId = null;
                    
                    // Re-render table to show updated values
                    renderTable();
                    
                    // Close modal
                    if (typeof window.closeClientPopup === 'function') {
                        window.closeClientPopup();
                    }
                    
                    return; // Don't call original function
                }
                
                // Call original function for other cases
                return originalSelectClient(clientId, clientCode, clientName);
            };
        } else {
            // If selectClient not yet defined, try again after a short delay
            setTimeout(setupClientSelectionOverride, 100);
        }
    }
    
    // Override selectAccount to handle our import case
    // This will run after the modal component is loaded
    let accountSelectionOverrideSetup = false;
    function setupAccountSelectionOverride() {
        if (accountSelectionOverrideSetup) return; // Already setup
        
        if (typeof window.selectAccount === 'function') {
            accountSelectionOverrideSetup = true;
            const originalSelectAccount = window.selectAccount;
            window.selectAccount = function(accountId, accountCode, accountName, currencyId, currencyName, currencyDefaultValue) {
                // Check if we're in import mode (currentAccountRowIndex is set)
                if (currentAccountRowIndex !== null && currentAccountRowIndex >= 0 && currentAccountRowIndex < importedData.length) {
                    // Update importedData
                    importedData[currentAccountRowIndex].AccountId = accountId;
                    importedData[currentAccountRowIndex].AccountCode = accountCode;
                    
                    // Remove from invalid rows if it was marked
                    if (invalidRowIndices.includes(currentAccountRowIndex)) {
                        invalidRowIndices = invalidRowIndices.filter(idx => idx !== currentAccountRowIndex);
                    }
                    
                    // Clear the stored reference
                    currentAccountRowIndex = null;
                    window.currentAccountInput = null;
                    window.currentAccountRowId = null;
                    
                    // Re-render table to show updated values
                    renderTable();
                    
                    // Close modal
                    if (typeof window.closeAccountPopup === 'function') {
                        window.closeAccountPopup();
                    }
                    
                    return; // Don't call original function
                }
                
                // Call original function for other cases
                return originalSelectAccount(accountId, accountCode, accountName, currencyId, currencyName, currencyDefaultValue);
            };
        } else {
            // If selectAccount not yet defined, try again after a short delay
            setTimeout(setupAccountSelectionOverride, 100);
        }
    }
    
    // Setup override when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        setupClientSelectionOverride();
        setupAccountSelectionOverride();
        updateImportButtonState();
    });

    // Update import button state based on data availability
    function updateImportButtonState() {
        const importButton = document.getElementById('import-button');
        if (importButton) {
            importButton.disabled = importedData.length === 0;
        }
    }

    // Validate period lock for a date
    async function checkPeriodLock(dateValue) {
        if (!dateValue) {
            return { isLocked: false, message: '' };
        }
        
        try {
            const response = await fetch(`/core/api/check-period-lock/?date=${dateValue}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                return { isLocked: false, message: '' };
            }
            
            const data = await response.json();
            return { isLocked: data.is_locked || false, message: data.message || '' };
        } catch (error) {
            console.error('Period lock check error:', error);
            return { isLocked: false, message: '' };
        }
    }
    
    // Validate all records before import
    async function validateAllRecords() {
        const validationErrors = [];
        const validRecords = [];
        const invalidRowIndices = []; // Track which row indices have errors
        
        for (let i = 0; i < importedData.length; i++) {
            const row = importedData[i];
            const rowNum = i + 1;
            let rowValid = true;
            
            // Validate required fields
            if (!row.DocumentDate) {
                validationErrors.push(`Мөр ${rowNum}: Огноо заавал шаардлагатай`);
                rowValid = false;
            }
            
            if (!row.Description || row.Description.trim() === '' || row.Description.trim() === ':имп') {
                validationErrors.push(`Мөр ${rowNum}: Гүйлгээний утга заавал шаардлагатай`);
                rowValid = false;
            }
            
            if (!row.AccountCode || row.AccountCode.trim() === '') {
                validationErrors.push(`Мөр ${rowNum}: Данс заавал шаардлагатай`);
                rowValid = false;
            }
            
            if (!row.ClientId) {
                validationErrors.push(`Мөр ${rowNum}: Харилцагч сонгоогүй байна`);
                rowValid = false;
            }
            
            if (!row.DocumentTypeId) {
                validationErrors.push(`Мөр ${rowNum}: Загвар сонгоогүй байна`);
                rowValid = false;
            }
            
            // Validate amounts - use as-is from Excel, no calculation
            const debitAmount = parseFloat(row.DebitAmount) || 0;
            const creditAmount = parseFloat(row.CreditAmount) || 0;
            
            // Check if at least one amount is non-zero
            if (debitAmount === 0 && creditAmount === 0) {
                validationErrors.push(`Мөр ${rowNum}: Дебит эсвэл Кредит дүн заавал шаардлагатай`);
                rowValid = false;
            }
            
            // Either debit OR credit must have value, but not both
            if (debitAmount !== 0 && creditAmount !== 0) {
                validationErrors.push(`Мөр ${rowNum}: Дебит болон Кредит дүн нэгэн зэрэг байж болохгүй`);
                rowValid = false;
            }
            
            // Check period lock
            if (row.DocumentDate && rowValid) {
                const periodCheck = await checkPeriodLock(row.DocumentDate);
                if (periodCheck.isLocked) {
                    validationErrors.push(`Мөр ${rowNum}: ${periodCheck.message || 'Тухайн сар цоожлогдсон байна'}`);
                    rowValid = false;
                }
            }
            
            // Validate AccountId exists (if set) or lookup AccountCode
            if (row.AccountCode && row.AccountCode.trim() && rowValid) {
                try {
                    let accountId = row.AccountId;
                    if (!accountId) {
                        // Lookup by AccountCode
                        const response = await fetch(`/core/api/account-lookup-by-code/?account_code=${encodeURIComponent(row.AccountCode.trim())}`);
                        const data = await response.json();
                        if (data.success && data.account) {
                            accountId = data.account.AccountId;
                            row.AccountId = accountId;
                        } else {
                            validationErrors.push(`Мөр ${rowNum}: Данс "${row.AccountCode}" олдсонгүй`);
                            rowValid = false;
                        }
                    } else {
                        // Validate AccountId exists
                        const response = await fetch(`/core/api/account-lookup-by-code/?account_code=${encodeURIComponent(row.AccountCode.trim())}`);
                        const data = await response.json();
                        if (!data.success || !data.account || data.account.AccountId != accountId) {
                            validationErrors.push(`Мөр ${rowNum}: Данс "${row.AccountCode}" ID тохирохгүй байна`);
                            rowValid = false;
                        }
                    }
                } catch (error) {
                    validationErrors.push(`Мөр ${rowNum}: Данс шалгахад алдаа гарлаа: ${error.message}`);
                    rowValid = false;
                }
            }
            
            // Validate ClientId exists
            if (row.ClientId && rowValid) {
                try {
                    // Use stored client name if available, otherwise extract from combined string
                    let clientNameForLookup = row.ClientName;
                    
                    // If ClientName is not stored, try to extract from ClientCode (format: "CODE - NAME")
                    if (!clientNameForLookup && row.ClientCode && row.ClientCode.includes(' - ')) {
                        const parts = row.ClientCode.split(' - ');
                        if (parts.length > 1) {
                            clientNameForLookup = parts.slice(1).join(' - ').trim();
                        }
                    }
                    
                    // If still no name, use ClientCode as fallback (for cases where it's just the name)
                    if (!clientNameForLookup) {
                        clientNameForLookup = row.ClientCode || '';
                    }
                    
                    if (!clientNameForLookup) {
                        validationErrors.push(`Мөр ${rowNum}: Харилцагч мэдээлэл дутуу байна`);
                        rowValid = false;
                    } else {
                        const response = await fetch(`/core/api/client-lookup-by-name/?client_name=${encodeURIComponent(clientNameForLookup)}`);
                        const data = await response.json();
                        if (!data.success || !data.found || data.client.ClientId != row.ClientId) {
                            validationErrors.push(`Мөр ${rowNum}: Харилцагч ID тохирохгүй байна`);
                            rowValid = false;
                        }
                    }
                } catch (error) {
                    validationErrors.push(`Мөр ${rowNum}: Харилцагч шалгахад алдаа гарлаа: ${error.message}`);
                    rowValid = false;
                }
            }
            
            // Validate TemplateId exists (if provided)
            if (row.TemplateId && rowValid) {
                try {
                    const response = await fetch(`/core/api/templates/${row.TemplateId}/details/`);
                    const data = await response.json();
                    if (!data.success || !data.template) {
                        validationErrors.push(`Мөр ${rowNum}: Загвар ID ${row.TemplateId} олдсонгүй`);
                        rowValid = false;
                    }
                } catch (error) {
                    validationErrors.push(`Мөр ${rowNum}: Загвар шалгахад алдаа гарлаа: ${error.message}`);
                    rowValid = false;
                }
            }
            
            // Validate DocumentTypeId exists
            if (row.DocumentTypeId && rowValid) {
                // DocumentTypeId validation will be done server-side, but we can check if it's a valid cash document type
                const validCashDocTypes = [1, 2, 3, 4, 15, 16, 17, 18];
                if (!validCashDocTypes.includes(parseInt(row.DocumentTypeId))) {
                    validationErrors.push(`Мөр ${rowNum}: Баримтын төрөл буруу байна`);
                    rowValid = false;
                }
            }
            
            if (rowValid) {
                validRecords.push({
                    rowIndex: i,
                    rowData: row
                });
            } else {
                invalidRowIndices.push(i);
            }
        }
        
        return {
            valid: validationErrors.length === 0,
            errors: validationErrors,
            validRecords: validRecords,
            invalidRowIndices: invalidRowIndices
        };
    }
    
        // Mark invalid rows with red background in the table
        function markInvalidRows(validationResult) {
            // Store invalid row indices globally
            invalidRowIndices = validationResult.invalidRowIndices || [];
            
            // Re-render table to show red marks on invalid rows
            renderTable();
        }

    // Import cash documents
    async function importCashDocuments() {
        if (importedData.length === 0) {
            if (typeof showMessageModal === 'function') {
                showMessageModal('Импортлох мэдээлэл байхгүй байна', 'error', 'Алдаа');
            } else {
                alert('Импортлох мэдээлэл байхгүй байна');
            }
            return;
        }

        // Disable button during validation
        const importButton = document.getElementById('import-button');
        if (importButton) {
            importButton.disabled = true;
            importButton.textContent = 'Шалгаж байна...';
        }

        // Validate all records
        const validationResult = await validateAllRecords();
        
        // Mark invalid rows in the table with red background
        markInvalidRows(validationResult);
        
        // If there are ANY errors, reject import completely
        if (validationResult.errors.length > 0) {
            // Show error modal - all records must be correct
            const errorMessage = 'Бүх гүйлгээ алдаагүй байх ёстой тул, улаан өнгөтэй гүйлгээнүүдийг засна уу?';
            showMessageModal(errorMessage, 'error', 'Алдаа');
            
            // Stop import - user must fix all errors first
            if (importButton) {
                importButton.disabled = false;
                importButton.textContent = 'ИМПОРТЛОХ';
                updateImportButtonState();
            }
            return;
        }
        
        // If no valid records, show error and stop
        if (validationResult.validRecords.length === 0) {
            const errorMessage = 'Бүх гүйлгээ алдаагүй байх ёстой тул, улаан өнгөтэй гүйлгээнүүдийг засна уу?';
            showMessageModal(errorMessage, 'error', 'Алдаа');
            
            if (importButton) {
                importButton.disabled = false;
                importButton.textContent = 'ИМПОРТЛОХ';
                updateImportButtonState();
            }
            return;
        }

        // Prepare validated rows for import
        const rowsToImport = validationResult.validRecords.map(item => {
            const row = item.rowData;
            return {
                DocumentTypeId: row.DocumentTypeId,
                DocumentDate: row.DocumentDate,
                Description: row.Description.trim(),
                ClientId: row.ClientId,
                AccountId: row.AccountId,
                AccountCode: row.AccountCode.trim(),
                TemplateId: row.TemplateId || null,
                IsVat: row.IsVat || false,
                DebitAmount: parseFloat(row.DebitAmount) || 0,
                CreditAmount: parseFloat(row.CreditAmount) || 0
            };
        });
        
        // Update button text
        if (importButton) {
            importButton.textContent = 'ИМПОРТЛОЖ БАЙНА...';
        }

        try {
            const response = await fetch('/core/api/cash-import-bulk/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ rows: rowsToImport })
            });

            const result = await response.json();

            if (result.success) {
                const successMessage = `Амжилттай! ${result.count} бичиг импортлогдлоо.\n\nБичигүүдийн дугаар:\n${result.document_numbers.join('\n')}`;
                showMessageModal(successMessage, 'success', 'Амжилттай');
                // Optionally clear table after successful import
                // clearTable();
            } else {
                let errorMessage = result.message || 'Импорт хийхэд алдаа гарлаа';
                if (result.errors && result.errors.length > 0) {
                    errorMessage += '\n\n' + result.errors.join('\n');
                }
                showMessageModal(errorMessage, 'error', 'Алдаа');
            }
        } catch (error) {
            showMessageModal(`Импорт хийхэд алдаа гарлаа: ${error.message}`, 'error', 'Алдаа');
        } finally {
            // Re-enable button
            if (importButton) {
                importButton.disabled = false;
                importButton.textContent = 'ИМПОРТЛОХ';
                updateImportButtonState();
            }
        }
    }

    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<!-- Include Client Selection Modal Component -->
{% include 'core/components/client_selection_modal.html' %}

<!-- Include Account Selection Modal Component -->
{% include 'core/components/account_selection_modal.html' %}

<!-- Include Message Modal Component -->
{% include 'core/components/message_modal.html' %}

{% endblock %}
