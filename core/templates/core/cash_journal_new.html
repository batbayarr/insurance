{% extends 'base.html' %}
{% load static %}
<!-- FORCE NO CACHE - New File -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="cache-bust" content="NEW-FILE-v3.7-2025-01-31-16:15">
{% load humanize %}

{% block title %}Cash Journal{% endblock %}

{% block content %}
<div class="">
    <!-- Date Filter Section -->
    <div class="bg-white shadow rounded-lg p-1 mb-2">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center space-x-2">
                <label for="start-date" class="text-sm font-medium text-gray-700">Эхлэх огноо:</label>
                <input type="date" id="start-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-center space-x-2">
                <label for="end-date" class="text-sm font-medium text-gray-700">Дуусах огноо:</label>
                <input type="date" id="end-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="filter-button" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                Шүүх
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white shadow rounded-lg mb-4">
        <div class="border-b-2 border-gray-300">
            <nav class="flex space-x-2 px-6 p-3">
                <button onclick="switchToDocumentsView()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    БАРИМТ
                </button>
                <button onclick="switchToDetailView()" class="border border-blue-500 text-blue-600 bg-blue-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ЖУРНАЛ
                </button>
                <button onclick="showDeletedDocuments()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    УСТГАСАН БАРИМТ
                </button>
                <button onclick="printCashJournal()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ХЭВЛЭХ
                </button>
                <button onclick="exportToExcel()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    EXCEL
                </button>
            </nav>
        </div>
    </div>

    <!-- Cash Documents View (Hidden by default) -->
    <div id="cash-documents-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Огноо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Төрөл</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">НӨТ</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют.дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ханш</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дүн(₮)</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                    </tr>
                    <!-- Filter Row -->
                    <tr class="bg-gray-100">
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-document-no" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="date" id="filter-date" placeholder="Filter..."
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-account" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="9">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-document-type" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-client" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-description" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="70">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-is-vat" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-currency" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="3">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-currency-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-currency-exchange" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-mnt-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-user" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                    </tr>
                </thead>
                <tbody id="documents-tbody" class="bg-white divide-y divide-gray-200">
                    <!-- Documents will be loaded here via AJAX -->
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Ready to filter</h3>
                                <p class="text-sm text-gray-500">Select date range and click Filter to load documents.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info" class="text-sm text-gray-700">
                        Нийт <span id="total-count">0</span> бичлэгээс <span id="showing-start">0</span> - <span id="showing-end">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label for="page-size-select" class="text-sm font-medium text-gray-700">Хуудасны хэмжээ:</label>
                        <select id="page-size-select" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="40">40</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button id="prev-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Previous</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <span id="page-info" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                <!-- Dynamic page buttons will be generated here -->
                            </span>
                            <button id="next-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Next</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash Journal Detail View (Hidden by default) -->
    <div id="cash-journal-detail-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
                
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Огноо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дансны нэр</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валютын дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ханш</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дебит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Кредит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <!-- Detail data will be loaded here via AJAX -->
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load journal details.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for ЖУРНАЛ tab -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page-detail" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page-detail" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info-detail" class="text-sm text-gray-700">
                        Нийт <span id="total-count-detail">0</span> бичлэгээс <span id="showing-start-detail">0</span> - <span id="showing-end-detail">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page-desktop-detail" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span id="page-info-detail" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            <!-- Dynamic page buttons will be generated here -->
                        </span>
                    <button id="next-page-desktop-detail" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Cash Journal - Optimized Version
    
    // Global variables
    let documentsData = [];
    let detailsData = [];  // For ЖУРНАЛ tab
    let currentPage = 1;
    let pageSize = 20;
    let totalPages = 1;
    let isDeleteFilter = false;
    let isRendering = false;
    
    // Pagination variables for ЖУРНАЛ tab
    let currentPageDetail = 1;
    let pageSizeDetail = 20;
    let totalPagesDetail = 1;
    
    // API cache
    let apiCache = new Map();
    let currentCacheKey = '';
    
    
    // Define filter inputs array (corrected column order) - Updated 2024
    const FILTER_INPUTS = [
        'DocumentNo', 'DocumentDate', 'AccountCode', 'DocumentType', 'ClientName', 
        'Description', 'VAT', 'CurrencyCode', 'CurrencyAmount', 'CurrencyExchange', 'Amount', 'UserName'
    ];
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        initializeAll();
    });
    
    function initializeAll() {
        initializeDateInputs();
        initializeFilters();
        initializePagination();
        loadInitialDocuments();
    }
    
    function initializeDateInputs() {
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const pageSizeSelect = document.getElementById('page-size-select');
        
        if (startDateInput) {
            startDateInput.addEventListener('change', function() {
                // Date change handler
            });
        }
        
        if (endDateInput) {
            endDateInput.addEventListener('change', function() {
                // Date change handler
            });
        }
        
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                const newPageSize = parseInt(this.value);
                pageSize = newPageSize;
                pageSizeDetail = newPageSize; // Also update detail page size
                currentPage = 1; // Reset to first page when changing page size
                currentPageDetail = 1; // Reset detail page too
                if (documentsData && documentsData.length > 0) {
                    applyFrontendFilter();
                }
                if (detailsData && detailsData.length > 0) {
                    renderDetailsTableWithPagination(detailsData);
                }
            });
        }
    }
    
    function initializeFilters() {
        const filterInputs = document.querySelectorAll('input[placeholder="Filter..."]');
        filterInputs.forEach((input, index) => {
            input.addEventListener('input', applyFilters);
        });
    }
    
    function initializePagination() {
        // БАРИМТ tab pagination
        const prevPage = document.getElementById('prev-page');
        const nextPage = document.getElementById('next-page');
        const prevPageDesktop = document.getElementById('prev-page-desktop');
        const nextPageDesktop = document.getElementById('next-page-desktop');
        
        if (prevPage) prevPage.addEventListener('click', () => changePage(currentPage - 1));
        if (nextPage) nextPage.addEventListener('click', () => changePage(currentPage + 1));
        if (prevPageDesktop) prevPageDesktop.addEventListener('click', () => changePage(currentPage - 1));
        if (nextPageDesktop) nextPageDesktop.addEventListener('click', () => changePage(currentPage + 1));
        
        // ЖУРНАЛ tab pagination
        const prevPageDetail = document.getElementById('prev-page-detail');
        const nextPageDetail = document.getElementById('next-page-detail');
        const prevPageDesktopDetail = document.getElementById('prev-page-desktop-detail');
        const nextPageDesktopDetail = document.getElementById('next-page-desktop-detail');
        
        if (prevPageDetail) prevPageDetail.addEventListener('click', () => changePageDetail(currentPageDetail - 1));
        if (nextPageDetail) nextPageDetail.addEventListener('click', () => changePageDetail(currentPageDetail + 1));
        if (prevPageDesktopDetail) prevPageDesktopDetail.addEventListener('click', () => changePageDetail(currentPageDetail - 1));
        if (nextPageDesktopDetail) nextPageDesktopDetail.addEventListener('click', () => changePageDetail(currentPageDetail + 1));
    }
    
    function loadInitialDocuments() {
        setDefaultDateValues();
        
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (startDate && endDate) {
            applyDateFilter();
        }
    }
    
    function setDefaultDateValues() {
        // Use user's local system date
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        // Format dates for HTML date input (YYYY-MM-DD)
        const formatDateForInput = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        
        if (startDateInput && !startDateInput.value) {
            startDateInput.value = formatDateForInput(firstDay);
        }
        if (endDateInput && !endDateInput.value) {
            endDateInput.value = formatDateForInput(lastDay);
        }
    }
    
    function applyDateFilter() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        // Clear cache before new API call
        apiCache.clear();
        currentCacheKey = '';
        isDeleteFilter = false;
        
        // Show loading state
        const filterButton = document.getElementById('filter-button');
        if (filterButton) {
            filterButton.textContent = 'Loading...';
            filterButton.disabled = true;
        }
        
        // Fetch ALL documents (both active and deleted) from server
        fetchAllDocumentsFromServer();
    }
    
    function fetchAllDocumentsFromServer() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // Fetch ALL data (documents + details) for all tabs in one call
        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate,
            page: '1',
            page_size: '2000'  // Large page size to get all records
        });
        
        const cacheKey = `${startDate}_${endDate}_comprehensive_data`;
        
        if (apiCache.has(cacheKey)) {
            const cachedData = apiCache.get(cacheKey);
            documentsData = cachedData.documents;
            detailsData = cachedData.details;
            applyFrontendFilter();
            return;
        }
        
        const url = `/core/api/cash-documents-filtered/?${params}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cache the response
                    apiCache.set(cacheKey, data);
                    currentCacheKey = cacheKey;
                    
                    // Store both documents and details data
                    documentsData = data.documents;
                    detailsData = data.details;
                    
                    applyFrontendFilter();
                } else {
                    showDocumentsError(data.error || 'Failed to load comprehensive data');
                }
            })
            .catch(error => {
                showDocumentsError('Network error occurred');
            })
            .finally(() => {
                // Reset filter button
                const filterButton = document.getElementById('filter-button');
                if (filterButton) {
                    filterButton.textContent = 'Filter';
                    filterButton.disabled = false;
                }
            });
    }
    
    function applyFrontendFilter() {
        if (!documentsData || documentsData.length === 0) {
            return;
        }
        
        let filteredData = documentsData;
        
        // Apply delete filter based on current tab
        if (isDeleteFilter) {
            // Show only deleted documents
            filteredData = documentsData.filter(doc => doc.IsDelete === true);
        } else {
            // Show only active documents
            filteredData = documentsData.filter(doc => doc.IsDelete === false);
        }
        
        // Apply column filters if any
        const filterInputs = document.querySelectorAll('input[placeholder="Filter..."]');
        const filters = Array.from(filterInputs).map(input => input.value.toLowerCase().trim());
        
        if (filters.some(filter => filter.length > 0)) {
            filteredData = filteredData.filter(doc => {
                const values = [
                    String(doc.DocumentNo || '').toLowerCase(),
                    String(doc.DocumentDate || '').toLowerCase(),
                    String(doc.AccountCode || '').toLowerCase(),
                    String(doc.DocumentTypeCode || '').toLowerCase(),
                    String(doc.ClientName || '').toLowerCase(),
                    String(doc.Description || '').toLowerCase(),
                    doc.IsVat ? 'y' : 'n',
                    String(doc.CurrencyName || '').toLowerCase(),
                    String(doc.CurrencyAmount || '').toLowerCase(),
                    String(doc.CurrencyExchange || '').toLowerCase(),
                    String(doc.CurrencyMNT || '').toLowerCase(),
                    String(doc.UserName || doc.CreatedBy || '').toLowerCase()
                ];
                
                return filters.every((filter, index) => 
                    !filter || values[index].includes(filter)
                );
            });
        }
        
        // Calculate pagination
        totalPages = Math.ceil(filteredData.length / pageSize);
        if (currentPage > totalPages) currentPage = 1;
        
        // Get paginated data
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const paginatedData = filteredData.slice(startIndex, endIndex);
        
        // Update pagination info
        updatePaginationInfo(filteredData.length, paginatedData.length, startIndex);
        
        // Use normal rendering with paginated data
        renderDocumentsTable(paginatedData);
        
        updateFilterCount(filteredData.length);
    }
    
    function renderDocumentsTable(documents) {
        if (isRendering) {
            return;
        }
        
        isRendering = true;
        
        const tbody = document.getElementById('documents-tbody');
        if (!tbody) {
            isRendering = false;
            return;
        }
        
        if (!documents || documents.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-sm font-medium text-gray-900 mb-1">No documents found</h3>
                            <p class="text-sm text-gray-500">No documents found in the selected date range.</p>
                        </div>
                    </td>
                </tr>
            `;
            isRendering = false;
            return;
        }
        
        // Use normal rendering
        renderNormalTable(documents);
        
        isRendering = false;
    }
    
    function renderNormalTable(documents) {
        const tbody = document.getElementById('documents-tbody');
        
        // Clear existing content
        tbody.innerHTML = '';
        
        // Use DocumentFragment for better performance
        const fragment = document.createDocumentFragment();
        
        documents.forEach((doc, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            // Pre-format data for better performance
            const documentNo = doc.DocumentNo || '';
            const documentDate = doc.DocumentDate || '';
            const accountCode = doc.AccountCode || '';
            const documentType = doc.DocumentTypeCode || '';
            const clientName = doc.ClientName || '';
            const description = truncateText(doc.Description || '', 50);
            const vat = doc.IsVat ? 'Y' : 'N';
            const currencyName = doc.CurrencyName || '';
            const currencyAmount = formatNumber(doc.CurrencyAmount || 0, 2);
            const currencyExchange = formatNumber(doc.CurrencyExchange || 0, 4);
            const amount = formatNumber(doc.CurrencyMNT || 0, 2);
            const userName = doc.UserName || doc.CreatedBy || 'N/A';
            
            row.innerHTML = `
                <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${documentNo}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${documentDate}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${accountCode}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${documentType}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${clientName}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${description}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${vat}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${currencyName}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${currencyAmount}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${currencyExchange}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${amount}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${userName}</td>
            `;
            
            fragment.appendChild(row);
        });
        
        tbody.appendChild(fragment);
    }
    
    
    function updatePaginationInfo(totalRecords, currentRecords, startIndex) {
        const showingStart = document.getElementById('showing-start');
        const showingEnd = document.getElementById('showing-end');
        const totalCount = document.getElementById('total-count');
        const currentPageSpan = document.getElementById('current-page');
        const totalPagesSpan = document.getElementById('total-pages');
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        if (currentPageSpan) currentPageSpan.textContent = currentPage;
        if (totalPagesSpan) totalPagesSpan.textContent = totalPages;
        
        // Generate dynamic pagination
        generatePaginationButtons();
    }
    
    function updateDocumentsPaginationInfo(data) {
        const showingStart = document.getElementById('showing-start');
        const showingEnd = document.getElementById('showing-end');
        const totalCount = document.getElementById('total-count');
        const currentPageSpan = document.getElementById('current-page');
        const totalPagesSpan = document.getElementById('total-pages');
        
        if (showingStart) showingStart.textContent = ((data.page - 1) * data.page_size) + 1;
        if (showingEnd) showingEnd.textContent = Math.min(data.page * data.page_size, data.total);
        if (totalCount) totalCount.textContent = data.total;
        if (currentPageSpan) currentPageSpan.textContent = data.page;
        if (totalPagesSpan) totalPagesSpan.textContent = data.total_pages;
        
        currentPage = data.page;
        totalPages = data.total_pages;
        
        // Generate dynamic pagination
        generatePaginationButtons();
    }
    
    function generatePaginationButtons() {
        const pageInfo = document.getElementById('page-info');
        if (!pageInfo) return;
        
        // Clear existing buttons
        pageInfo.innerHTML = '';
        
        // Calculate pagination range
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // Generate page buttons
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPage 
                    ? 'bg-blue-400 text-white hover:bg-blue-500' 
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePage(i));
            pageInfo.appendChild(button);
        }
    }
    
    function changePage(newPage) {
        if (newPage < 1 || newPage > totalPages) return;
        
        currentPage = newPage;
        // Use frontend filtering instead of server call for better performance
        if (documentsData && documentsData.length > 0) {
            applyFrontendFilter();
        } else {
            fetchDocumentsFromServer();
        }
    }
    
    function changePageDetail(newPage) {
        if (newPage < 1 || newPage > totalPagesDetail) return;
        
        currentPageDetail = newPage;
        // Re-render details table with pagination
        if (detailsData && detailsData.length > 0) {
            renderDetailsTableWithPagination(detailsData);
        }
    }
    
    function applyFilters() {
        // Debounce the filter application
        clearTimeout(window.filterTimeout);
        window.filterTimeout = setTimeout(applyFiltersImmediate, 300);
    }
    
    function applyFiltersImmediate() {
        applyFrontendFilter();
    }
    
    function updateFilterCount(count) {
        // Filter count updated
    }
    
    function showDocumentsError(message) {
        const tbody = document.getElementById('documents-tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="px-4 py-8 text-center text-red-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="text-sm font-medium text-red-900 mb-1">Error loading documents</h3>
                            <p class="text-sm text-red-500">${message}</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    function switchToDetailView() {
        // Show the detail view
        document.getElementById('cash-journal-detail-view').style.display = 'block';
        
        // Hide the documents view
        document.getElementById('cash-documents-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('detail');
        
        // Check if we have cached details data
        if (detailsData && detailsData.length > 0) {
            renderDetailsTable(detailsData);
        } else {
            const tbody = document.querySelector('#cash-journal-detail-view tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 012-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load journal details.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    function renderDetailsTable(details) {
        // Use the new paginated version
        renderDetailsTableWithPagination(details);
    }
    
    function renderDetailsTableWithPagination(details) {
        const tbody = document.querySelector('#cash-journal-detail-view tbody');
        if (!tbody) {
            return;
        }
        
        if (!details || details.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-sm font-medium text-gray-900 mb-1">No detail data found</h3>
                            <p class="text-sm text-gray-500">No document details found in the selected date range.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Calculate pagination
        totalPagesDetail = Math.ceil(details.length / pageSizeDetail);
        if (currentPageDetail > totalPagesDetail) currentPageDetail = 1;
        
        // Get paginated data
        const startIndex = (currentPageDetail - 1) * pageSizeDetail;
        const endIndex = startIndex + pageSizeDetail;
        const paginatedDetails = details.slice(startIndex, endIndex);
        
        // Update pagination info
        updatePaginationInfoDetail(details.length, paginatedDetails.length, startIndex);
        
        let htmlContent = '';
        let totalDebit = 0;
        let totalCredit = 0;
        
        paginatedDetails.forEach((item, index) => {
            // Calculate totals
            totalDebit += parseFloat(item.debit_amount) || 0;
            totalCredit += parseFloat(item.credit_amount) || 0;
            
            htmlContent += `
                <tr class="hover:bg-gray-50">
                    <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_no || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_date || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_code || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_name || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.client_name || ''}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.description || ''}</td>
                    <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.currency_name || ''}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.currency_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.currency_exchange.toLocaleString('en-US', {minimumFractionDigits: 4, maximumFractionDigits: 4})}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.debit_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.credit_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.user_name || ''}</td>
                </tr>
            `;
        });
        
        // Add totals row
        htmlContent += `
            <tr class="bg-gray-100 font-semibold">
                <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200" colspan="9">НИЙТ:</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalDebit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalCredit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td class="px-1 py-1 text-xs text-gray-900"></td>
            </tr>
        `;
        
        tbody.innerHTML = htmlContent;
    }
    
    function updatePaginationInfoDetail(totalRecords, currentRecords, startIndex) {
        const showingStart = document.getElementById('showing-start-detail');
        const showingEnd = document.getElementById('showing-end-detail');
        const totalCount = document.getElementById('total-count-detail');
        const currentPageSpan = document.getElementById('current-page-detail');
        const totalPagesSpan = document.getElementById('total-pages-detail');
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        if (currentPageSpan) currentPageSpan.textContent = currentPageDetail;
        if (totalPagesSpan) totalPagesSpan.textContent = totalPagesDetail;
        
        // Generate dynamic pagination
        generatePaginationButtonsDetail();
    }
    
    function generatePaginationButtonsDetail() {
        const pageInfo = document.getElementById('page-info-detail');
        if (!pageInfo) return;
        
        // Clear existing buttons
        pageInfo.innerHTML = '';
        
        // Calculate pagination range
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPageDetail - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPagesDetail, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // Generate page buttons
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPageDetail 
                    ? 'bg-blue-400 text-white hover:bg-blue-500' 
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePageDetail(i));
            pageInfo.appendChild(button);
        }
    }
    
    function switchToDocumentsView() {
        // Show the documents view
        document.getElementById('cash-documents-view').style.display = 'block';
        
        // Hide the detail view
        document.getElementById('cash-journal-detail-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('documents');
        
        // Set to active documents filter
        isDeleteFilter = false;
        
        // Check if we have data to display
        if (documentsData && documentsData.length > 0) {
            applyFrontendFilter();
        } else {
            const tbody = document.getElementById('documents-tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load documents.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    
    function showDeletedDocuments() {
        // Show the documents view
        document.getElementById('cash-documents-view').style.display = 'block';
        
        // Hide the detail view
        document.getElementById('cash-journal-detail-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('deleted');
        
        // Set to deleted documents filter
        isDeleteFilter = true;
        
        // Check if we have data to display
        if (documentsData && documentsData.length > 0) {
            applyFrontendFilter();
        } else {
            const tbody = document.getElementById('documents-tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load deleted documents.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    
    function updateTabStyling(activeTab) {
        const tabs = document.querySelectorAll('nav button');
        tabs.forEach(tab => {
            tab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
            tab.classList.add('border-gray-300', 'text-gray-500');
        });
        
        if (activeTab === 'documents') {
            tabs[0].classList.remove('border-gray-300', 'text-gray-500');
            tabs[0].classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        } else if (activeTab === 'detail') {
            tabs[1].classList.remove('border-gray-300', 'text-gray-500');
            tabs[1].classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        } else if (activeTab === 'deleted') {
            tabs[2].classList.remove('border-gray-300', 'text-gray-500');
            tabs[2].classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        }
    }
    
    function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || isNaN(value)) return '0.00';
        return parseFloat(value).toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }
    
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }
    
    function printCashJournal() {
        window.print();
    }
    
    function exportToExcel() {
        
        // Create CSV content from the table
        const table = document.querySelector('table');
        if (!table) {
            alert('No data to export');
            return;
        }
        
        let csvContent = '';
        const rows = table.querySelectorAll('tr');
        
        rows.forEach(function(row) {
            const cells = row.querySelectorAll('th, td');
            const rowData = [];
            
            cells.forEach(function(cell) {
                let cellText = cell.textContent.trim();
                // Clean up the text and handle commas
                cellText = cellText.replace(/,/g, '');
                rowData.push('"' + cellText + '"');
            });
            
            csvContent += rowData.join(',') + '\n';
        });
        
        // Create and download the file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'cash_journal_' + new Date().toISOString().split('T')[0] + '.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success message
        alert('Cash journal exported to Excel successfully!');
    }
    
    // Event listeners
    document.getElementById('filter-button').addEventListener('click', applyDateFilter);
</script>
{% endblock %}
