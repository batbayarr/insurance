{% extends 'base.html' %}
{% load static %}

{% block title %}Шинэ гэрээ оруулах - Silicon-Insurance{% endblock %}

{% block content %}
{% csrf_token %}
<div class="h-screen w-full bg-gray-50">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 px-3 py-2 lg:px-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="#" class="text-gray-600 hover:text-gray-900">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                <div>
                    <h1 class="text-lg font-semibold text-gray-900">Шинэ гэрээ нэмэх</h1>
                    <p class="text-sm text-gray-600">Гэрээний мэдээллийг бөглөж шинэ гэрээ үүсгэнэ үү.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="mx-auto">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="flex">
                <!-- Left Sidebar - Steps -->
                <div class="w-64 border-r border-gray-200 px-3 py-2">
                    <div class="space-y-6">
                        <!-- Step 1 -->
                        <div class="step-item" data-step="1">
                            <div class="flex items-start space-x-3">
                                <div class="step-number flex-shrink-0 w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-semibold">
                                    1
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-gray-900">Ерөнхий мэдээлэл</div>                                    
                                </div>
                            </div>
                        </div>

                        <!-- Step 2 -->
                        <div class="step-item" data-step="2">
                            <div class="flex items-start space-x-3">
                                <div class="step-number flex-shrink-0 w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-semibold">
                                    2
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-gray-700">Даатгалын мэдээлэл</div>                                    
                                </div>
                            </div>
                        </div>

                        <!-- Step 3 -->
                        <div class="step-item" data-step="3">
                            <div class="flex items-start space-x-3">
                                <div class="step-number flex-shrink-0 w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-semibold">
                                    3
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-gray-700">Төлбөрийн хуваарь</div>                                    
                                </div>
                            </div>
                        </div>

                        <!-- Step 4 -->
                        <div class="step-item" data-step="4">
                            <div class="flex items-start space-x-3">
                                <div class="step-number flex-shrink-0 w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-semibold">
                                    4
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-gray-700">Хавсралт</div>                                    
                                </div>
                            </div>
                        </div>

                        <!-- Step 5 -->
                        <div class="step-item" data-step="5">
                            <div class="flex items-start space-x-3">
                                <div class="step-number flex-shrink-0 w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-semibold">
                                    5
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-gray-700">Хянах</div>                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side - Form Content -->
                <div class="flex-1 px-3 py-2">
                    <form id="policy-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="current-step" name="current_step" value="1">
                        <input type="hidden" id="policy-id" name="policy_id" value="">

                        <!-- Step 1: General Information -->
                        <div id="step-1" class="step-content">
                            <div class="mb-6">
                                <h2 class="text-lg font-semibold text-gray-900">Ерөнхий мэдээлэл</h2>
                                <p class="text-sm text-gray-600">Гэрээний үндсэн мэдээлэл</p>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300">
                                    <tbody class="bg-white">
                                        <!-- Row 1: Policy Number | Client -->
                                        <tr>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50 w-1/3">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Гэрээний дугаар <span class="text-red-500">*</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <input type="text" name="policy_no" id="policy_no" required
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                       placeholder="Гэрээний дугаар оруулна уу">
                                            </td>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50 w-1/3">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Харилцагч <span class="text-red-500">*</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <div class="flex space-x-2">
                                                    <div class="relative flex-1">
                                                        <input type="text" 
                                                               id="client_id_display" 
                                                               readonly
                                                               placeholder="Харилцагч хайж сонгоно уу"
                                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 cursor-pointer bg-gray-50"
                                                               onclick="openClientSelectionModal()">
                                                        <input type="hidden" name="client_id" id="client_id" required>
                                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                                            </svg>
                                                        </div>
                                                    </div>
                                                    <button type="button" onclick="openClientSelectionModal()" 
                                                            class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>

                                        <!-- Row 2: Agent | Policy Template -->
                                        <tr>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Гэрээний менежер <span class="text-red-500">*</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <select name="agent_id" id="agent_id" required
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                                    <option value="">Гэрээний менежер хайж сонгоно уу</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Гэрээний загварын дугаар <span class="text-red-500">*</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <div class="flex space-x-2">
                                                    <input type="text" id="policy_template_id_display" readonly
                                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50 cursor-pointer"
                                                           placeholder="Гэрээний загварын дугаар оруулна уу"
                                                           onclick="openTemplateSelectionModal()">
                                                    <input type="hidden" name="policy_template_id" id="policy_template_id" required>
                                                    <button type="button" onclick="openTemplateSelectionModal()" 
                                                            class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>

                                        <!-- Row 3: Begin Date | End Date -->
                                        <tr>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Эхлэх огноо <span class="text-red-500">*</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <input type="date" name="begin_date" id="begin_date" required
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                            </td>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Дуусах огноо <span class="text-red-500">*</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <input type="date" name="end_date" id="end_date" required
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                            </td>
                                        </tr>

                                        <!-- Row 4: Currency | Currency Exchange -->
                                        <tr>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Валютын дугаар <span class="text-red-500">*</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <select name="currency_id" id="currency_id" required
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                                    <option value="">Валют сонгоно уу</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Валютын ханш <span class="text-red-500">*</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <input type="number" name="currency_exchange" id="currency_exchange" step="0.0001"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                       placeholder="0" value="0">
                                            </td>
                                        </tr>

                                        <!-- Row 5: Branch | Channel -->
                                        <tr>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Салбарын дугаар <span class="text-red-500">*</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <select name="agent_branch_id" id="agent_branch_id" required
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                                    <option value="">Салбарын дугаар оруулна уу</option>
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Сувгийн дугаар <span class="text-red-500">*</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <select name="agent_channel_id" id="agent_channel_id" required
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                                    <option value="">Сувгийн дугаар оруулна уу</option>
                                                </select>
                                            </td>
                                        </tr>

                                        <!-- Row 6: Director Name | Description -->
                                        <tr>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Захиралын нэр
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <input type="text" name="director_name" id="director_name" maxlength="15"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                       placeholder="Захиралын нэр оруулна уу">
                                            </td>
                                            <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Тайлбар
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-b border-gray-300">
                                                <input type="text" name="description" id="description" maxlength="60"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                                       placeholder="Тайлбар оруулна уу">
                                            </td>
                                        </tr>

                                        <!-- Row 7: Is Active | Has Coinsurance -->
                                        <tr>
                                            <td class="px-4 py-3 border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Идэвхтэй эсэх
                                                </label>
                                            </td>
                                            <td class="px-4 py-3">
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="is_active" id="is_active" checked
                                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                    <span class="ml-2 text-sm text-gray-700">Идэвхтэй</span>
                                                </label>
                                            </td>
                                            <td class="px-4 py-3 border-r border-gray-300 bg-gray-50">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    Хамтран даатгуулагчтай
                                                </label>
                                            </td>
                                            <td class="px-4 py-3">
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="has_coinsurance" id="has_coinsurance"
                                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                    <span class="ml-2 text-sm text-gray-700">Хамтран даатгуулагчтай</span>
                                                </label>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Coinsurance Section (Hidden by default) -->
                            <div id="coinsurance-section" class="hidden border-t pt-4 mt-4">
                                <h3 class="text-md font-semibold text-gray-900 mb-4">Хамтран даатгуулагч</h3>
                                <div id="coinsurance-list" class="space-y-3">
                                    <!-- Coinsurance items will be added here dynamically -->
                                </div>
                                <button type="button" id="add-coinsurance" class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm">
                                    + Хамтран даатгуулагч нэмэх
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Insurance Information -->
                        <div id="step-2" class="step-content hidden">
                            <div class="mb-6">
                                <h2 class="text-lg font-semibold text-gray-900">Даатгалын мэдээлэл</h2>
                                <p class="text-sm text-gray-600">Бүтээгдэхүүн, Даатгалын зүйл, Эрсдэл</p>
                            </div>

                            <div id="template-data-container" class="space-y-4">
                                <div id="template-loading" class="text-center py-4 text-gray-500 hidden">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                    <p class="mt-2 text-sm">Уншиж байна...</p>
                                </div>
                                <div id="template-data-empty" class="text-center py-4 text-gray-500">
                                    <p class="text-sm">Гэрээний загварыг сонгоно уу</p>
                                </div>
                                <div id="template-products-list" class="space-y-4">
                                    <!-- Template products will be displayed here -->
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Payment Schedule -->
                        <div id="step-3" class="step-content hidden">
                            <div class="mb-6">
                                <h2 class="text-lg font-semibold text-gray-900">Төлбөрийн хуваарь</h2>
                                <p class="text-sm text-gray-600">Төлбөрийн дүн, Төлбөрийн хуваарь</p>
                            </div>

                            <div class="space-y-4">
                                <div class="overflow-x-auto border border-gray-200 rounded-md">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Төлбөрийн огноо</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дүн</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Үйлдэл</th>
                                            </tr>
                                        </thead>
                                        <tbody id="payment-schedule-list" class="bg-white divide-y divide-gray-200">
                                            <!-- Payment schedules will be added here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <button type="button" id="add-payment-schedule" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm">
                                    + Төлбөрийн хуваарь нэмэх
                                </button>
                            </div>
                        </div>

                        <!-- Step 4: Attachments -->
                        <div id="step-4" class="step-content hidden">
                            <div class="mb-6">
                                <h2 class="text-lg font-semibold text-gray-900">Хавсралт</h2>
                                
                            </div>

                            <div class="space-y-4">
                                <div class="overflow-x-auto border border-gray-200 rounded-md">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Файлын нэр</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Файлын зам</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Үйлдэл</th>
                                            </tr>
                                        </thead>
                                        <tbody id="files-list" class="bg-white divide-y divide-gray-200">
                                            <!-- Files will be added here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <button type="button" id="add-file" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm">
                                    + Хавсралт нэмэх
                                </button>
                            </div>
                        </div>

                        <!-- Step 5: Review -->
                        <div id="step-5" class="step-content hidden">
                            <div class="mb-6">
                                <h2 class="text-lg font-semibold text-gray-900">Гэрээний мэдээллийг шалгах</h2>
                                <p class="text-sm text-gray-600">Бүх мэдээллийг шалгаад хадгалах</p>
                            </div>

                            <div class="space-y-6" id="step-5-review-content">
                                <!-- Content will be populated dynamically -->
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200">
                            <button type="button" id="prev-btn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 hidden">
                                Өмнөх
                            </button>
                            <div class="flex-1"></div>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-gray-600">Алхам <span id="step-indicator">1</span> / 5</span>
                                <button type="button" id="next-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Дараах
                                </button>
                                <button type="submit" id="submit-btn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 hidden">
                                    Хадгалах
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 5;
    let coinsuranceData = [];
    let policyDetailsData = [];
    let paymentScheduleData = [];
    let filesData = [];
    let lastLoadedTemplateId = null; // Track which template was last loaded
    
    // Get username from template context
    const currentUsername = '{{ user.username|escapejs }}';

    // Sync data from DOM to data structures before leaving a step
    function syncStepData(step) {
        if (step === 2) {
            // Sync policy products data from DOM inputs
            updatePolicyProductsData();
        } else if (step === 3) {
            // Sync payment schedule data from DOM
            syncPaymentScheduleData();
        } else if (step === 4) {
            // Sync files data from DOM
            updateFilesData();
        }
        // Step 1 and 5 don't need syncing (Step 1 is form fields, Step 5 is read-only)
    }
    
    // Restore data when entering a step
    function restoreStepData(step) {
        // Check if we're in edit mode - if so, don't restore, let loadPolicyDataForEdit handle it
        const urlParams = new URLSearchParams(window.location.search);
        const editPolicyId = urlParams.get('edit');
        const isEditMode = editPolicyId || window.editingPolicyId;
        
        if (step === 2) {
            // In edit mode, don't restore - data will be loaded by loadPolicyDataForEdit
            if (isEditMode && !window.policyDataLoaded) {
                // Wait for policy data to be loaded
                return;
            }
            
            // Check if we already have data and template hasn't changed
            const templateId = document.getElementById('policy_template_id')?.value;
            if (policyProductsData.length > 0 && templateId === lastLoadedTemplateId) {
                // Restore from existing data instead of loading from template
                restoreTemplateDataFromExisting();
            } else {
                // First time or template changed, load from API
                loadTemplateData();
            }
        } else if (step === 3) {
            // Restore payment schedules from data
            restorePaymentScheduleData();
        } else if (step === 4) {
            // Restore files from data
            restoreFilesData();
        }
    }
    
    // Step navigation
    function showStep(step) {
        // Sync current step data before leaving
        if (currentStep !== step) {
            syncStepData(currentStep);
        }
        
        // Hide all steps
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`step-${step}`).classList.remove('hidden');

        // Update step indicators
        document.querySelectorAll('.step-item').forEach((item, index) => {
            const stepNum = index + 1;
            const numberEl = item.querySelector('.step-number');
            if (stepNum < step) {
                numberEl.classList.remove('bg-gray-300', 'text-gray-600');
                numberEl.classList.add('bg-green-500', 'text-white');
            } else if (stepNum === step) {
                numberEl.classList.remove('bg-gray-300', 'text-gray-600', 'bg-green-500');
                numberEl.classList.add('bg-blue-600', 'text-white');
            } else {
                numberEl.classList.remove('bg-blue-600', 'text-white', 'bg-green-500');
                numberEl.classList.add('bg-gray-300', 'text-gray-600');
            }
        });

        // Update buttons
        document.getElementById('prev-btn').classList.toggle('hidden', step === 1);
        document.getElementById('next-btn').classList.toggle('hidden', step === totalSteps);
        document.getElementById('submit-btn').classList.toggle('hidden', step !== totalSteps);
        document.getElementById('step-indicator').textContent = step;
        document.getElementById('current-step').value = step;
        
        // Update currentStep variable
        currentStep = step;
        
        // Restore data when entering a step
        restoreStepData(step);
        
        // Populate review data when navigating to step 5
        if (step === 5) {
            populateStep5Review();
        }
    }

    // Next button
    document.getElementById('next-btn').addEventListener('click', function() {
        if (validateStep(currentStep)) {
            // Sync current step data before moving forward
            syncStepData(currentStep);
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }
    });

    // Previous button
    document.getElementById('prev-btn').addEventListener('click', function() {
        // Sync current step data before moving backward
        syncStepData(currentStep);
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    });

    // Validate step
    function validateStep(step) {
        if (step === 1) {
            const required = ['policy_no', 'client_id', 'agent_id', 'policy_template_id', 
                             'begin_date', 'end_date', 'currency_id', 'agent_branch_id', 'agent_channel_id'];
            for (let field of required) {
                const fieldElement = document.getElementById(field);
                if (!fieldElement || !fieldElement.value) {
                    alert('Бүх шаардлагатай талбаруудыг бөглөнө үү');
                    if (fieldElement) {
                        fieldElement.focus();
                    }
                    return false;
                }
            }
        }
        if (step === 2) {
            // Validate that template data is loaded
            if (policyProductsData.length === 0) {
                const templateId = document.getElementById('policy_template_id')?.value;
                if (templateId) {
                    // Try to load data first
                    loadTemplateData();
                    // Wait a moment and check again
                    setTimeout(() => {
                        if (policyProductsData.length === 0) {
                            alert('Гэрээний загварын мэдээлэл ачааллаагүй байна. Гэрээний загварыг сонгоно уу.');
                        }
                    }, 1000);
                    return false;
                } else {
                    alert('Гэрээний загварыг сонгоно уу.');
                    return false;
                }
            }
        }
        // Steps 3 and 4 are optional - no validation needed
        return true;
    }
    
    // Load template data
    function loadTemplateData() {
        const templateId = document.getElementById('policy_template_id')?.value;
        if (!templateId) {
            document.getElementById('template-data-empty').classList.remove('hidden');
            document.getElementById('template-products-list').innerHTML = '';
            lastLoadedTemplateId = null;
            return;
        }
        
        // Check if we're in edit mode and data is already loaded from policy
        const urlParams = new URLSearchParams(window.location.search);
        const editPolicyId = urlParams.get('edit');
        const isEditMode = editPolicyId || window.editingPolicyId;
        
        // In edit mode, if policy data is already loaded, don't overwrite it
        if (isEditMode && window.policyDataLoaded && policyProductsData.length > 0) {
            // Policy data is already loaded, just restore it
            restoreTemplateDataFromExisting();
            return;
        }
        
        // Track the template ID we're loading
        lastLoadedTemplateId = templateId;
        
        document.getElementById('template-loading').classList.remove('hidden');
        document.getElementById('template-data-empty').classList.add('hidden');
        document.getElementById('template-products-list').innerHTML = '';
        
        fetch(`/core/api/policy-template/${templateId}/full-data/`, {
            credentials: 'include',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('template-loading').classList.add('hidden');
            
            if (data.success && data.products && data.products.length > 0) {
                displayTemplateData(data.products);
            } else {
                document.getElementById('template-data-empty').classList.remove('hidden');
                document.getElementById('template-data-empty').textContent = 'Гэрээний загварт мэдээлэл олдсонгүй';
            }
        })
        .catch(error => {
            console.error('Error loading template data:', error);
            document.getElementById('template-loading').classList.add('hidden');
            document.getElementById('template-data-empty').classList.remove('hidden');
            document.getElementById('template-data-empty').textContent = 'Алдаа гарлаа: ' + error.message;
        });
    }
    
    // Restore template data from existing policyProductsData (without fetching from API)
    function restoreTemplateDataFromExisting() {
        if (policyProductsData.length === 0) {
            // No data to restore, load from template
            loadTemplateData();
            return;
        }
        
        // Hide loading/empty messages
        document.getElementById('template-loading').classList.add('hidden');
        document.getElementById('template-data-empty').classList.add('hidden');
        
        // Preserve templateProductsData if it exists (needed for "Add Item" functionality)
        const preservedTemplateData = templateProductsData.length > 0 ? templateProductsData : null;
        
        // Rebuild the display from existing data
        // We need to reconstruct the products structure for displayTemplateData
        // First, we need to get product names and codes from templateProductsData if available
        const productsForDisplay = policyProductsData.map(product => {
            // Try to find product info from templateProductsData
            const templateProduct = preservedTemplateData ? preservedTemplateData.find(tp => tp.productId === product.productId) : null;
            return {
                productId: product.productId,
                productName: templateProduct ? templateProduct.productName : (product.productName || ''),
                productCode: templateProduct ? templateProduct.productCode : (product.productCode || ''),
                items: product.items.map(item => ({
                    itemId: item.itemId,
                    itemName: item.itemName,
                    itemCode: item.itemCode,
                    beginDate: item.beginDate || '',
                    endDate: item.endDate || '',
                    valuation: item.valuation || '',
                    commPercent: item.commPercent || '',
                    commAmount: item.commAmount || '',
                    // Map risks to match displayTemplateData expected format
                    risks: (item.risks || []).map(r => ({
                        riskId: r.riskId,
                        riskName: r.riskName || '',
                        riskCode: r.riskCode || '',
                        commPercent: r.commPercent !== null && r.commPercent !== undefined ? r.commPercent : (r.riskPercent !== null && r.riskPercent !== undefined ? r.riskPercent : null),
                        isCoreRisk: r.isCoreRisk !== null && r.isCoreRisk !== undefined ? r.isCoreRisk : true,
                        isSelected: r.isSelected !== undefined ? r.isSelected : (r.isCoreRisk === false ? false : true)
                    })),
                    questions: item.questions || []
                }))
            };
        });
        
        // Use displayTemplateData to render, but restore templateProductsData afterwards if it was preserved
        displayTemplateData(productsForDisplay);
        
        // Restore templateProductsData if it was preserved (needed for "Add Item" functionality)
        if (preservedTemplateData) {
            templateProductsData = preservedTemplateData;
        }
    }
    
    // Display template data in table format
    function displayTemplateData(products) {
        const container = document.getElementById('template-products-list');
        container.innerHTML = '';
        policyProductsData = [];
        templateProductsData = products; // Store template data for later use
        
        // Build flat list of all items from all products
        const allItems = [];
        products.forEach((product, productIndex) => {
            const productData = {
                productId: product.productId,
                items: []
            };
            
            product.items.forEach((item, itemIndex) => {
                const itemKey = `${productIndex}-${itemIndex}`;
                const itemData = {
                    itemId: item.itemId,
                    itemName: item.itemName,
                    itemCode: item.itemCode,
                    productId: product.productId,
                    productName: product.productName,
                    productCode: product.productCode,
                    // Use actual values if provided (for edit mode), otherwise use empty (for new policy from template)
                    // IMPORTANT: These values will be used in the template string, so they must be preserved
                    // Don't filter out empty strings - preserve the actual value from the API
                    beginDate: item.beginDate !== null && item.beginDate !== undefined ? item.beginDate : '',
                    endDate: item.endDate !== null && item.endDate !== undefined ? item.endDate : '',
                    valuation: item.valuation !== null && item.valuation !== undefined ? item.valuation : '',
                    commPercent: item.commPercent !== null && item.commPercent !== undefined ? item.commPercent : '',
                    commAmount: item.commAmount !== null && item.commAmount !== undefined ? item.commAmount : '',
                    isFromTemplate: !item.beginDate && !item.valuation, // Only true if no actual data (template mode)
                    risks: (item.risks || []).map(r => ({
                        riskId: r.riskId,
                        riskName: r.riskName || '',
                        riskCode: r.riskCode || '',
                        riskPercent: r.commPercent !== null && r.commPercent !== undefined ? r.commPercent : '',
                        commPercent: r.commPercent || null,
                        isCoreRisk: r.isCoreRisk !== null && r.isCoreRisk !== undefined ? r.isCoreRisk : true,
                        isSelected: r.isCoreRisk === false ? (r.isSelected !== undefined ? r.isSelected : false) : true // Additional risks track selection, core risks always selected
                    })),
                    questions: (item.questions || []).map(q => ({
                        itemQuestionId: q.itemQuestionId,
                        itemQuestionName: q.itemQuestionName || '',
                        answer: q.answer || ''  // Use actual answer if provided (for edit mode)
                    }))
                };
                
                productData.items.push(itemData);
                allItems.push({
                    ...itemData,
                    itemKey: itemKey,
                    productIndex: productIndex,
                    itemIndex: itemIndex
                });
            });
            
            policyProductsData.push(productData);
        });
        
        // Create table structure
        if (allItems.length === 0) {
            container.innerHTML = `
                <div class="mb-4 flex justify-end">
                    <button type="button" 
                            onclick="openAddItemModal()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-medium">
                        НЭМЭХ
                    </button>
                </div>
                <div class="text-center py-8 text-gray-500">
                    <p class="text-sm">Гэрээний загварт зүйл олдсонгүй</p>
                    <p class="text-xs text-gray-400 mt-2">Дээрх "НЭМЭХ" товч дараад зүйл нэмнэ үү</p>
                </div>
            `;
            return;
        }
        
        const tableHTML = `
            <div class="mb-4 flex justify-end">
                <button type="button" 
                        onclick="openAddItemModal()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-medium">
                    НЭМЭХ
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Бүтээгдэхүүн</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Зүйл</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Эхлэх огноо</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Дуусах огноо</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Үнэлгээ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300" style="width: 8%;">Хураамж(%)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300" style="width: 15%;">Хураамж</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Эрсдэл</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Асуулт</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${allItems.map((item, rowIndex) => `
                            <tr class="hover:bg-gray-50" data-item-key="${item.itemKey}">
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <div class="text-gray-900">${item.productName}</div>
                                    <div class="text-xs text-gray-500">${item.productCode}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <div class="text-gray-900">${item.itemName}</div>
                                    <div class="text-xs text-gray-500">${item.itemCode}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <input type="date" 
                                           class="item-begin-date w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" 
                                           data-item-key="${item.itemKey}"
                                           value="${item.beginDate || ''}"
                                           placeholder="YYYY-MM-DD">
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <input type="date" 
                                           class="item-end-date w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" 
                                           data-item-key="${item.itemKey}"
                                           value="${item.endDate || ''}"
                                           placeholder="YYYY-MM-DD">
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <input type="number" 
                                           class="item-valuation w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" 
                                           step="0.000001"
                                           data-item-key="${item.itemKey}"
                                           value="${item.valuation || ''}"
                                           placeholder="0.000000">
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap" style="width: 8%;">
                                    <input type="number" 
                                           class="item-commission w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" 
                                           step="0.001" 
                                           data-item-key="${item.itemKey}"
                                           value="${item.commPercent || ''}"
                                           placeholder="0.000">
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap" style="width: 15%;">
                                    <div class="px-2 py-1 text-sm text-gray-900 text-right item-comm-amount-display" data-item-key="${item.itemKey}">${formatNumber(item.commAmount || 0)}</div>
                                    <input type="hidden" 
                                           class="item-comm-amount" 
                                           data-item-key="${item.itemKey}"
                                           value="${item.commAmount || ''}">
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                                    <span class="text-gray-600">${item.risks.length}</span>
                                    ${item.risks.length > 0 ? `
                                        <button type="button" 
                                                onclick="openRisksModal('${item.itemKey}')" 
                                                class="ml-2 text-blue-600 hover:text-blue-800 text-xs">
                                            Харах
                                        </button>
                                    ` : ''}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                                    <span class="text-gray-600">${item.questions.length}</span>
                                    ${item.questions.length > 0 ? `
                                        <button type="button" 
                                                onclick="openQuestionsModal('${item.itemKey}')" 
                                                class="ml-2 text-blue-600 hover:text-blue-800 text-xs">
                                            Харах
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot class="bg-gray-100">
                        <tr class="font-semibold" id="comm-amount-summary-row">
                            <td class="px-4 py-3 text-sm text-gray-900" colspan="6">Нийт:</td>
                            <td class="px-4 py-3 text-sm text-gray-900 text-right" id="comm-amount-total">0.00</td>
                            <td class="px-4 py-3 text-sm text-gray-900" colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        `;
        
        container.innerHTML = tableHTML;
        
        // Add event listeners for all input fields
        document.querySelectorAll('.item-commission').forEach(input => {
            input.addEventListener('input', function() {
                const itemKey = this.getAttribute('data-item-key');
                calculateCommAmountForItem(itemKey);
                updatePolicyProductsData();
                updateCommAmountTotal();
            });
            input.addEventListener('change', function() {
                const itemKey = this.getAttribute('data-item-key');
                calculateCommAmountForItem(itemKey);
                updatePolicyProductsData();
                updateCommAmountTotal();
            });
        });
        
        document.querySelectorAll('.item-valuation').forEach(input => {
            input.addEventListener('input', function() {
                const itemKey = this.getAttribute('data-item-key');
                calculateCommAmountForItem(itemKey);
                updatePolicyProductsData();
                updateCommAmountTotal();
            });
            input.addEventListener('change', function() {
                const itemKey = this.getAttribute('data-item-key');
                calculateCommAmountForItem(itemKey);
                updatePolicyProductsData();
                updateCommAmountTotal();
            });
        });
        
        // Comm amount is read-only, no input listeners needed
        
        document.querySelectorAll('.item-begin-date, .item-end-date').forEach(input => {
            input.addEventListener('input', updatePolicyProductsData);
            input.addEventListener('change', updatePolicyProductsData);
        });
        
        // Calculate and set initial commPercent values from risks
        allItems.forEach(item => {
            const calculatedSum = calculateRisksCommPercentSum(item.itemKey);
            const commInput = document.querySelector(`.item-commission[data-item-key="${item.itemKey}"]`);
            if (commInput) {
                commInput.value = calculatedSum.toFixed(3);
                // Update data structure
                const parts = item.itemKey.split('-');
                if (parts.length >= 2) {
                    const productIndex = parseInt(parts[0]);
                    const itemIndex = parseInt(parts[1]);
                    if (policyProductsData[productIndex] && policyProductsData[productIndex].items[itemIndex]) {
                        policyProductsData[productIndex].items[itemIndex].commPercent = calculatedSum.toFixed(3);
                    }
                }
            }
            // Calculate initial commAmount
            calculateCommAmountForItem(item.itemKey);
        });
        
        // Update total after initial calculations
        updateCommAmountTotal();
    }
    
    // Calculate sum of commPercent from risks for an item
    function calculateRisksCommPercentSum(itemKey) {
        const parts = itemKey.split('-');
        if (parts.length < 2) return 0;
        
        const productIndex = parseInt(parts[0]);
        const itemIndex = parseInt(parts[1]);
        const productData = policyProductsData[productIndex];
        
        if (!productData || !productData.items[itemIndex]) return 0;
        
        const item = productData.items[itemIndex];
        if (!item.risks || !Array.isArray(item.risks)) return 0;
        
        let total = 0;
        item.risks.forEach(risk => {
            // Always include core risks
            if (risk.isCoreRisk !== false) {
                const commPercent = risk.commPercent !== null && risk.commPercent !== undefined ? parseFloat(risk.commPercent) : 0;
                total += commPercent;
            } else {
                // Include additional risks only if selected
                if (risk.isSelected === true) {
                    const commPercent = risk.commPercent !== null && risk.commPercent !== undefined ? parseFloat(risk.commPercent) : 0;
                    total += commPercent;
                }
            }
        });
        
        return total;
    }
    
    // Calculate commAmount for a specific item: commAmount = valuation * (commPercent / 100)
    function calculateCommAmountForItem(itemKey) {
        const valuationInput = document.querySelector(`.item-valuation[data-item-key="${itemKey}"]`);
        const commPercentInput = document.querySelector(`.item-commission[data-item-key="${itemKey}"]`);
        const commAmountInput = document.querySelector(`.item-comm-amount[data-item-key="${itemKey}"]`);
        const commAmountDisplay = document.querySelector(`.item-comm-amount-display[data-item-key="${itemKey}"]`);
        
        if (!valuationInput || !commPercentInput) return;
        
        const valuation = parseFloat(valuationInput.value) || 0;
        const commPercent = parseFloat(commPercentInput.value) || 0;
        const commAmount = valuation * (commPercent / 100);
        
        // Update hidden input for form submission
        if (commAmountInput) {
            commAmountInput.value = commAmount.toFixed(6);
        }
        
        // Update read-only display
        if (commAmountDisplay) {
            commAmountDisplay.textContent = formatNumber(commAmount);
        }
        
        // Update data structure
        const parts = itemKey.split('-');
        if (parts.length >= 2) {
            const productIndex = parseInt(parts[0]);
            const itemIndex = parseInt(parts[1]);
            if (policyProductsData[productIndex] && policyProductsData[productIndex].items[itemIndex]) {
                policyProductsData[productIndex].items[itemIndex].commAmount = commAmount.toFixed(6);
            }
        }
    }
    
    // Format number with thousand separator and 2 decimal places
    function formatNumber(num) {
        if (num === null || num === undefined || num === '') return '0.00';
        const numValue = parseFloat(num);
        if (isNaN(numValue)) return '0.00';
        return numValue.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Format number with thousand separator and 2 decimal places (for percentage)
    function formatPercent(num) {
        if (num === null || num === undefined || num === '') return '0.00';
        const numValue = parseFloat(num);
        if (isNaN(numValue)) return '0.00';
        return numValue.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    
    // Calculate and update total commAmount in summary row
    function updateCommAmountTotal() {
        const totalCell = document.getElementById('comm-amount-total');
        if (!totalCell) return;
        
        let total = 0;
        // Sum from hidden inputs or display values
        document.querySelectorAll('.item-comm-amount').forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        
        totalCell.textContent = formatNumber(total);
    }
    
    // Open risks modal for an item
    window.openRisksModal = function(itemKey) {
        const parts = itemKey.split('-');
        if (parts.length < 2) return;
        
        const productIndex = parseInt(parts[0]);
        const itemIndex = parseInt(parts[1]);
        const productData = policyProductsData[productIndex];
        
        if (!productData || !productData.items[itemIndex]) return;
        
        const item = productData.items[itemIndex];
        
        // Function to calculate summary (core risks + selected additional risks)
        function calculateSummary() {
            let total = 0;
            item.risks.forEach(risk => {
                // Always include core risks
                if (risk.isCoreRisk !== false) {
                    const commPercent = risk.commPercent !== null && risk.commPercent !== undefined ? parseFloat(risk.commPercent) : 0;
                    total += commPercent;
                } else {
                    // Include additional risks only if checkbox is checked
                    const checkbox = document.querySelector(`.risk-is-core-risk[data-item-key="${itemKey}"][data-risk-id="${risk.riskId}"]`);
                    if (checkbox && checkbox.checked) {
                        const commPercent = risk.commPercent !== null && risk.commPercent !== undefined ? parseFloat(risk.commPercent) : 0;
                        total += commPercent;
                    }
                }
            });
            return total;
        }
        
        // Build table rows for risks
        const risksTableRows = item.risks.length > 0 ? item.risks.map((risk, riskIndex) => {
            // Initialize isSelected for additional risks (default to false, will be updated from checkbox state)
            if (risk.isCoreRisk === false) {
                risk.isSelected = risk.isSelected !== undefined ? risk.isSelected : false;
            }
            
            return `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-900">
                    ${risk.riskName || ''}
                    ${risk.riskCode ? `<span class="text-xs text-gray-500 ml-1">(${risk.riskCode})</span>` : ''}
                </td>
                <td class="px-4 py-3 text-center">
                    ${risk.isCoreRisk !== false ? `
                        <span class="text-xs text-gray-700">Үндсэн эрсдэл</span>
                    ` : `
                        <label class="flex items-center justify-center">
                            <input type="checkbox" 
                                   class="risk-is-core-risk rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                                   data-item-key="${itemKey}"
                                   data-risk-id="${risk.riskId}"
                                   ${risk.isSelected ? 'checked' : ''}
                                   onchange="updateRisksModalSummary('${itemKey}')">
                            <span class="ml-2 text-xs text-gray-700">Нэмэлт эрсдэл</span>
                        </label>
                    `}
                </td>
                <td class="px-4 py-3 text-sm text-gray-700 text-center">
                    ${risk.riskPercent !== null && risk.riskPercent !== undefined && risk.riskPercent !== '' ? risk.riskPercent : '0.000'}
                </td>
            </tr>
        `;
        }).join('') : `
            <tr>
                <td colspan="3" class="px-4 py-8 text-center text-sm text-gray-500">Эрсдэл байхгүй</td>
            </tr>
        `;
        
        // Calculate initial summary
        let initialTotal = 0;
        item.risks.forEach(risk => {
            if (risk.isCoreRisk !== false) {
                const commPercent = risk.commPercent !== null && risk.commPercent !== undefined ? parseFloat(risk.commPercent) : 0;
                initialTotal += commPercent;
            } else if (risk.isSelected) {
                const commPercent = risk.commPercent !== null && risk.commPercent !== undefined ? parseFloat(risk.commPercent) : 0;
                initialTotal += commPercent;
            }
        });
        
        // Add summary row if there are risks
        const summaryRow = item.risks.length > 0 ? `
            <tr class="bg-gray-100 font-semibold" id="risks-summary-row-${itemKey}">
                <td class="px-4 py-3 text-sm text-gray-900" colspan="2">Нийт:</td>
                <td class="px-4 py-3 text-sm text-gray-900 text-center">${initialTotal.toFixed(3)}</td>
            </tr>
        ` : '';
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.id = 'risks-modal';
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Эрсдэл - ${item.itemName}</h3>
                        <button type="button" onclick="closeRisksModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-md">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Эрсдэлийн нэр</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ангилал</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Эрсдэлийн хувь</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${risksTableRows}
                                ${summaryRow}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button type="button" 
                                onclick="closeRisksModal()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Хаах
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    };
    
    // Update summary row when checkbox changes
    window.updateRisksModalSummary = function(itemKey) {
        // Find the item data
        const parts = itemKey.split('-');
        if (parts.length < 2) return;
        
        const productIndex = parseInt(parts[0]);
        const itemIndex = parseInt(parts[1]);
        const productData = policyProductsData[productIndex];
        
        if (!productData || !productData.items[itemIndex]) return;
        
        const item = productData.items[itemIndex];
        
        // Update isSelected for additional risks based on checkbox state
        item.risks.forEach(risk => {
            if (risk.isCoreRisk === false) {
                const checkbox = document.querySelector(`.risk-is-core-risk[data-item-key="${itemKey}"][data-risk-id="${risk.riskId}"]`);
                if (checkbox) {
                    risk.isSelected = checkbox.checked;
                }
            }
        });
        
        // Calculate new total
        let total = 0;
        item.risks.forEach(risk => {
            if (risk.isCoreRisk !== false) {
                // Always include core risks
                const commPercent = risk.commPercent !== null && risk.commPercent !== undefined ? parseFloat(risk.commPercent) : 0;
                total += commPercent;
            } else {
                // Include additional risks only if selected
                if (risk.isSelected) {
                    const commPercent = risk.commPercent !== null && risk.commPercent !== undefined ? parseFloat(risk.commPercent) : 0;
                    total += commPercent;
                }
            }
        });
        
        // Update summary row
        const summaryRow = document.getElementById(`risks-summary-row-${itemKey}`);
        if (summaryRow) {
            const totalCell = summaryRow.querySelector('td:last-child');
            if (totalCell) {
                totalCell.textContent = total.toFixed(3);
            }
        }
        
        // Update commPercent input field in the main table
        const commInput = document.querySelector(`.item-commission[data-item-key="${itemKey}"]`);
        if (commInput) {
            commInput.value = total.toFixed(3);
        }
        
        // Update item.commPercent in the data structure
        item.commPercent = total.toFixed(3);
        
        // Recalculate commAmount since commPercent changed
        calculateCommAmountForItem(itemKey);
        
        // Update total
        updateCommAmountTotal();
        
        // Also update the data structure
        updatePolicyProductsData();
    };
    
    window.closeRisksModal = function() {
        // Before closing, filter risks to keep only core risks and selected additional risks
        const modal = document.getElementById('risks-modal');
        if (!modal) return;
        
        // Find all checkboxes in the modal to get itemKey
        const checkboxes = modal.querySelectorAll('.risk-is-core-risk');
        if (checkboxes.length > 0) {
            const firstCheckbox = checkboxes[0];
            const itemKey = firstCheckbox.getAttribute('data-item-key');
            
            if (itemKey) {
                const parts = itemKey.split('-');
                if (parts.length >= 2) {
                    const productIndex = parseInt(parts[0]);
                    const itemIndex = parseInt(parts[1]);
                    const productData = policyProductsData[productIndex];
                    
                    if (productData && productData.items[itemIndex]) {
                        const item = productData.items[itemIndex];
                        
                        // Update isSelected for all additional risks based on checkbox state
                        item.risks.forEach(risk => {
                            if (risk.isCoreRisk === false) {
                                const checkbox = document.querySelector(`.risk-is-core-risk[data-item-key="${itemKey}"][data-risk-id="${risk.riskId}"]`);
                                if (checkbox) {
                                    risk.isSelected = checkbox.checked;
                                }
                            }
                        });
                        
                        // Filter risks: keep core risks and selected additional risks
                        item.risks = item.risks.filter(risk => {
                            // Always keep core risks
                            if (risk.isCoreRisk !== false) {
                                return true;
                            }
                            // Keep additional risks only if selected
                            return risk.isSelected === true;
                        });
                        
                        // Calculate and update commPercent from risks sum
                        const calculatedSum = calculateRisksCommPercentSum(itemKey);
                        const commInput = document.querySelector(`.item-commission[data-item-key="${itemKey}"]`);
                        if (commInput) {
                            commInput.value = calculatedSum.toFixed(3);
                        }
                        item.commPercent = calculatedSum.toFixed(3);
                        
                        // Recalculate commAmount since commPercent changed
                        calculateCommAmountForItem(itemKey);
                        
                        // Update total
                        updateCommAmountTotal();
                        
                        // Update the data structure
                        updatePolicyProductsData();
                    }
                }
            }
        }
        
        modal.remove();
    };
    
    // Open questions modal for an item
    window.openQuestionsModal = function(itemKey) {
        const parts = itemKey.split('-');
        if (parts.length < 2) return;
        
        const productIndex = parseInt(parts[0]);
        const itemIndex = parseInt(parts[1]);
        const productData = policyProductsData[productIndex];
        
        if (!productData || !productData.items[itemIndex]) return;
        
        const item = productData.items[itemIndex];
        const questionsHTML = item.questions.map((question) => `
            <div class="border border-gray-200 rounded p-3 mb-3 bg-gray-50">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    ${question.itemQuestionName}
                </label>
                <textarea 
                    class="item-question-answer w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                    rows="2"
                    data-item-key="${itemKey}"
                    data-question-id="${question.itemQuestionId}"
                    placeholder="Хариулт оруулна уу"
                    maxlength="300"
                    oninput="updatePolicyProductsData()">${question.answer || ''}</textarea>
            </div>
        `).join('');
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.id = 'questions-modal';
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Асуултууд - ${item.itemName}</h3>
                        <button type="button" onclick="closeQuestionsModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        ${questionsHTML || '<p class="text-sm text-gray-500">Асуулт байхгүй</p>'}
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button type="button" 
                                onclick="closeQuestionsModal()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Хаах
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    };
    
    window.closeQuestionsModal = function() {
        // Update policy products data before closing to ensure question answers are saved
        updatePolicyProductsData();
        const modal = document.getElementById('questions-modal');
        if (modal) modal.remove();
    };
    
    // Edit item details (opens a modal with all details)
    window.editItemDetails = function(itemKey) {
        const parts = itemKey.split('-');
        if (parts.length < 2) return;
        
        const productIndex = parseInt(parts[0]);
        const itemIndex = parseInt(parts[1]);
        const productData = policyProductsData[productIndex];
        
        if (!productData || !productData.items[itemIndex]) return;
        
        const item = productData.items[itemIndex];
        
        // Get current values from inputs
        const beginDateInput = document.querySelector(`.item-begin-date[data-item-key="${itemKey}"]`);
        const endDateInput = document.querySelector(`.item-end-date[data-item-key="${itemKey}"]`);
        const valuationInput = document.querySelector(`.item-valuation[data-item-key="${itemKey}"]`);
        const commPercentInput = document.querySelector(`.item-commission[data-item-key="${itemKey}"]`);
        const commAmountInput = document.querySelector(`.item-comm-amount[data-item-key="${itemKey}"]`);
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.id = 'item-details-modal';
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Зүйлийн дэлгэрэнгүй - ${item.itemName}</h3>
                        <button type="button" onclick="closeItemDetailsModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Эхлэх огноо</label>
                                <input type="date" 
                                       class="item-begin-date-modal w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                                       value="${beginDateInput ? (beginDateInput.value.includes('T') ? beginDateInput.value.split('T')[0] : beginDateInput.value) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Дуусах огноо</label>
                                <input type="date" 
                                       class="item-end-date-modal w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                                       value="${endDateInput ? (endDateInput.value.includes('T') ? endDateInput.value.split('T')[0] : endDateInput.value) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Үнэлгээ</label>
                                <input type="number" 
                                       class="item-valuation-modal w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                                       step="0.000001"
                                       value="${valuationInput ? valuationInput.value : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Хураамж (%)</label>
                                <input type="number" 
                                       class="item-commission-modal w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                                       step="0.001"
                                       value="${commPercentInput ? commPercentInput.value : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Хураамжийн дүн</label>
                                <input type="number" 
                                       class="item-comm-amount-modal w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                                       step="0.000001"
                                       value="${commAmountInput ? commAmountInput.value : ''}">
                            </div>
                        </div>
                        <div class="pt-4 border-t">
                            <button type="button" 
                                    onclick="openRisksModal('${itemKey}')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                Эрсдэл засах (${item.risks.length})
                            </button>
                            <button type="button" 
                                    onclick="openQuestionsModal('${itemKey}')" 
                                    class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                Асуулт засах (${item.questions.length})
                            </button>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-3">
                        <button type="button" 
                                onclick="saveItemDetails('${itemKey}')" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            Хадгалах
                        </button>
                        <button type="button" 
                                onclick="closeItemDetailsModal()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Цуцлах
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    };
    
    window.saveItemDetails = function(itemKey) {
        const beginDateInput = document.querySelector(`#item-details-modal .item-begin-date-modal`);
        const endDateInput = document.querySelector(`#item-details-modal .item-end-date-modal`);
        const valuationInput = document.querySelector(`#item-details-modal .item-valuation-modal`);
        const commPercentInput = document.querySelector(`#item-details-modal .item-commission-modal`);
        const commAmountInput = document.querySelector(`#item-details-modal .item-comm-amount-modal`);
        
        // Update table inputs
        const tableBeginDate = document.querySelector(`.item-begin-date[data-item-key="${itemKey}"]`);
        const tableEndDate = document.querySelector(`.item-end-date[data-item-key="${itemKey}"]`);
        const tableValuation = document.querySelector(`.item-valuation[data-item-key="${itemKey}"]`);
        const tableCommPercent = document.querySelector(`.item-commission[data-item-key="${itemKey}"]`);
        const tableCommAmount = document.querySelector(`.item-comm-amount[data-item-key="${itemKey}"]`);
        
        if (beginDateInput && tableBeginDate) tableBeginDate.value = beginDateInput.value;
        if (endDateInput && tableEndDate) tableEndDate.value = endDateInput.value;
        if (valuationInput && tableValuation) tableValuation.value = valuationInput.value;
        if (commPercentInput && tableCommPercent) tableCommPercent.value = commPercentInput.value;
        if (commAmountInput && tableCommAmount) tableCommAmount.value = commAmountInput.value;
        
        // Recalculate commAmount if valuation or commPercent changed
        calculateCommAmountForItem(itemKey);
        
        // Update total
        updateCommAmountTotal();
        
        updatePolicyProductsData();
        closeItemDetailsModal();
    };
    
    window.closeItemDetailsModal = function() {
        const modal = document.getElementById('item-details-modal');
        if (modal) modal.remove();
    };
    
    // Global variable to track which product we're adding items to
    let currentProductIndexForItemSelection = null;
    let availableItemsList = [];
    let templateProductsData = []; // Store original template data
    
    // Open add item modal - allows selecting product first
    window.openAddItemModal = function() {
        if (!templateProductsData || templateProductsData.length === 0) {
            alert('Гэрээний загварын мэдээлэл олдсонгүй');
            return;
        }
        
        if (templateProductsData.length === 1) {
            // Only one product, directly open item selection
            addItemFromTemplate(0);
            return;
        }
        
        // Multiple products - show product selection modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.id = 'product-selection-modal';
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Бүтээгдэхүүн сонгох</h3>
                        <button type="button" onclick="closeProductSelectionModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${templateProductsData.map((product, index) => `
                            <button type="button" 
                                    onclick="selectProductForAddItem(${index})" 
                                    class="w-full text-left px-4 py-3 border border-gray-200 rounded-md hover:bg-gray-50 hover:border-blue-500 transition-colors">
                                <div class="font-medium text-gray-900">${product.productName}</div>
                                <div class="text-sm text-gray-500">${product.productCode}</div>
                            </button>
                        `).join('')}
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button type="button" 
                                onclick="closeProductSelectionModal()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Цуцлах
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    };
    
    window.selectProductForAddItem = function(productIndex) {
        closeProductSelectionModal();
        addItemFromTemplate(productIndex);
    };
    
    window.closeProductSelectionModal = function() {
        const modal = document.getElementById('product-selection-modal');
        if (modal) modal.remove();
    };
    
    // Add item by showing modal with template items
    window.addItemFromTemplate = function(productIndex) {
        const productData = policyProductsData[productIndex];
        if (!productData) {
            alert('Эхлээд гэрээний загварыг сонгоно уу');
            return;
        }
        
        // Check if template data is available
        if (!templateProductsData || templateProductsData.length === 0) {
            alert('Гэрээний загварын мэдээлэл олдсонгүй');
            return;
        }
        
        // Find the product in template data
        const templateProduct = templateProductsData.find(p => p.productId === productData.productId);
        if (!templateProduct || !templateProduct.items || templateProduct.items.length === 0) {
            alert('Энэ бүтээгдэхүүнд загварын зүйл олдсонгүй');
            return;
        }
        
        // Open modal with template items
        currentProductIndexForItemSelection = productIndex;
        document.getElementById('item-selection-modal').classList.remove('hidden');
        loadTemplateItemsForProduct(templateProduct.items);
    };
    
    // Open item selection modal (kept for backward compatibility if needed)
    window.openItemSelectionModal = function(productIndex) {
        currentProductIndexForItemSelection = productIndex;
        document.getElementById('item-selection-modal').classList.remove('hidden');
        loadAvailableItems();
    };
    
    // Close item selection modal
    window.closeItemSelectionModal = function() {
        document.getElementById('item-selection-modal').classList.add('hidden');
        currentProductIndexForItemSelection = null;
        const searchInput = document.getElementById('item-search-input');
        if (searchInput) searchInput.value = '';
    };
    
    // Load template items for the current product
    function loadTemplateItemsForProduct(templateItems) {
        const container = document.getElementById('items-list-container');
        
        if (!templateItems || templateItems.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">Энэ бүтээгдэхүүнд зүйл олдсонгүй</div>';
            return;
        }
        
        // Store template items for search
        availableItemsList = templateItems;
        renderTemplateItemsList(templateItems);
        
        // Setup search
        const searchInput = document.getElementById('item-search-input');
        if (searchInput) {
            // Remove existing listeners by cloning
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            
            newSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filtered = templateItems.filter(item => 
                    (item.itemCode && item.itemCode.toLowerCase().includes(searchTerm)) ||
                    (item.itemName && item.itemName.toLowerCase().includes(searchTerm))
                );
                renderTemplateItemsList(filtered);
            });
        }
    }
    
    // Load available items from API
    function loadAvailableItems() {
        const container = document.getElementById('items-list-container');
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-sm">Уншиж байна...</p>
            </div>
        `;
        
        fetch('/core/api/items/?is_active=true&page_size=1000', {
            credentials: 'include',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.results) {
                availableItemsList = data.results;
                renderItemsList(availableItemsList);
                
                // Setup search
                const searchInput = document.getElementById('item-search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        const filtered = availableItemsList.filter(item => 
                            (item.ItemCode && item.ItemCode.toLowerCase().includes(searchTerm)) ||
                            (item.ItemName && item.ItemName.toLowerCase().includes(searchTerm))
                        );
                        renderItemsList(filtered);
                    });
                }
            } else {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">Мэдээлэл олдсонгүй</div>';
            }
        })
        .catch(error => {
            console.error('Error loading items:', error);
            container.innerHTML = `<div class="text-center py-8 text-red-500">Алдаа: ${error.message}</div>`;
        });
    }
    
    // Render template items list with risks and questions info
    function renderTemplateItemsList(items) {
        const container = document.getElementById('items-list-container');
        if (items.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">Мэдээлэл олдсонгүй</div>';
            return;
        }
        
        container.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Код</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Нэр</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Эрсдэл</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Асуулт</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Үйлдэл</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${items.map(item => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-sm text-gray-900">${item.itemCode || ''}</td>
                            <td class="px-4 py-2 text-sm text-gray-900">${item.itemName || ''}</td>
                            <td class="px-4 py-2 text-sm text-gray-600">${item.risks ? item.risks.length : 0}</td>
                            <td class="px-4 py-2 text-sm text-gray-600">${item.questions ? item.questions.length : 0}</td>
                            <td class="px-4 py-2 text-sm">
                                <button type="button" 
                                        onclick="selectTemplateItem(${item.itemId}, '${(item.itemName || '').replace(/'/g, "\\'")}', '${(item.itemCode || '').replace(/'/g, "\\'")}')" 
                                        class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">
                                    Сонгох
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    // Render items list
    function renderItemsList(items) {
        const container = document.getElementById('items-list-container');
        if (items.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">Мэдээлэл олдсонгүй</div>';
            return;
        }
        
        container.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Код</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Нэр</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Төрөл</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Үйлдэл</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${items.map(item => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-sm text-gray-900">${item.ItemCode || ''}</td>
                            <td class="px-4 py-2 text-sm text-gray-900">${item.ItemName || ''}</td>
                            <td class="px-4 py-2 text-sm text-gray-600">${item.ItemTypeName || ''}</td>
                            <td class="px-4 py-2 text-sm">
                                <button type="button" 
                                        onclick="selectItem(${item.ItemId}, '${(item.ItemName || '').replace(/'/g, "\\'")}', '${(item.ItemCode || '').replace(/'/g, "\\'")}')" 
                                        class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">
                                    Сонгох
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    // Select template item and add to product with all risks and questions
    window.selectTemplateItem = function(itemId, itemName, itemCode) {
        if (currentProductIndexForItemSelection === null) return;
        
        // Find the template item data
        const productData = policyProductsData[currentProductIndexForItemSelection];
        const templateProduct = templateProductsData.find(p => p.productId === productData.productId);
        if (!templateProduct) return;
        
        const templateItem = templateProduct.items.find(item => item.itemId === itemId);
        if (!templateItem) return;
        
        const newItemIndex = productData.items.length;
        const itemKey = `${currentProductIndexForItemSelection}-${newItemIndex}`;
        
        // Create new item from template with all risks and questions
        const newItem = {
            itemId: templateItem.itemId,
            itemName: templateItem.itemName,
            itemCode: templateItem.itemCode,
            commPercent: '',
            beginDate: '',
            endDate: '',
            valuation: '',
            commAmount: '',
            isFromTemplate: false, // Mark as manually added
            // Copy risks from template
            risks: (templateItem.risks || []).map(risk => ({
                riskId: risk.riskId,
                riskName: risk.riskName || '',
                riskCode: risk.riskCode || '',
                riskPercent: risk.commPercent !== null && risk.commPercent !== undefined ? risk.commPercent : '',
                commPercent: risk.commPercent || null,
                isCoreRisk: risk.isCoreRisk !== null && risk.isCoreRisk !== undefined ? risk.isCoreRisk : true,
                isSelected: risk.isCoreRisk === false ? false : true // Additional risks default to not selected, core risks are always selected
            })),
            // Copy questions from template
            questions: (templateItem.questions || []).map(q => ({
                itemQuestionId: q.itemQuestionId,
                itemQuestionName: q.itemQuestionName || '',
                answer: ''
            }))
        };
        
        // Add to data structure
        productData.items.push(newItem);
        
        // Render the new item in the UI
        renderNewItem(currentProductIndexForItemSelection, newItemIndex, newItem);
        
        // Close modal
        closeItemSelectionModal();
    };
    
    // Select item and add to product
    window.selectItem = function(itemId, itemName, itemCode) {
        if (currentProductIndexForItemSelection === null) return;
        
        // Get item questions from API (risks will be empty for manually added items)
        fetch(`/core/api/item-questions/?item_id=${itemId}`, {
            credentials: 'include',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return { success: true, results: [] };
            }
            return response.json();
        })
        .then(data => {
            const productData = policyProductsData[currentProductIndexForItemSelection];
            const newItemIndex = productData.items.length;
            const itemKey = `${currentProductIndexForItemSelection}-${newItemIndex}`;
            
            // Add to data structure
            const newItem = {
                itemId: itemId,
                itemName: itemName,
                itemCode: itemCode,
                commPercent: '',
                beginDate: '',
                endDate: '',
                valuation: '',
                commAmount: '',
                isFromTemplate: false,
                risks: [], // Manually added items don't have risks from template
                questions: (data.results || []).map(q => ({
                    itemQuestionId: q.ItemQuestionId || q.itemQuestionId,
                    itemQuestionName: q.ItemQuestionName || q.itemQuestionName || 'Асуулт',
                    answer: ''
                }))
            };
            
            productData.items.push(newItem);
            
            // Render the new item in the UI
            renderNewItem(currentProductIndexForItemSelection, newItemIndex, newItem);
            
            // Close modal
            closeItemSelectionModal();
        })
        .catch(error => {
            console.error('Error loading item questions:', error);
            // Add item anyway with empty questions
            const productData = policyProductsData[currentProductIndexForItemSelection];
            const newItemIndex = productData.items.length;
            
            const newItem = {
                itemId: itemId,
                itemName: itemName,
                itemCode: itemCode,
                commPercent: '',
                beginDate: '',
                endDate: '',
                valuation: '',
                commAmount: '',
                isFromTemplate: false,
                risks: [],
                questions: []
            };
            
            productData.items.push(newItem);
            renderNewItem(currentProductIndexForItemSelection, newItemIndex, newItem);
            closeItemSelectionModal();
        });
    };
    
    // Render new item in the UI (adds row to table)
    function renderNewItem(productIndex, itemIndex, item) {
        const container = document.getElementById('template-products-list');
        if (!container) return;
        
        const table = container.querySelector('table tbody');
        if (!table) {
            // If table doesn't exist, recreate it with the new item
            displayTemplateData(templateProductsData);
            return;
        }
        
        const productData = policyProductsData[productIndex];
        if (!productData) return;
        
        // Get product info from template data
        const templateProduct = templateProductsData.find(p => p.productId === productData.productId);
        const productName = templateProduct ? templateProduct.productName : 'Бүтээгдэхүүн';
        const productCode = templateProduct ? templateProduct.productCode : '';
        
        const itemKey = `${productIndex}-${itemIndex}`;
        
        // Create table row HTML
        const rowHTML = `
            <tr class="hover:bg-gray-50" data-item-key="${itemKey}">
                <td class="px-4 py-3 whitespace-nowrap text-sm">
                    <div class="font-medium text-gray-900">${productName}</div>
                    <div class="text-xs text-gray-500">${productCode}</div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">
                    <div class="font-medium text-gray-900">${item.itemName}</div>
                    <div class="text-xs text-gray-500">${item.itemCode}</div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="date" 
                           class="item-begin-date w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" 
                           data-item-key="${itemKey}"
                           placeholder="YYYY-MM-DD">
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="date" 
                           class="item-end-date w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" 
                           data-item-key="${itemKey}"
                           placeholder="YYYY-MM-DD">
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="number" 
                           class="item-valuation w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" 
                           step="0.000001"
                           data-item-key="${itemKey}"
                           placeholder="0.000000">
                </td>
                <td class="px-4 py-3 whitespace-nowrap" style="width: 8%;">
                    <input type="number" 
                           class="item-commission w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" 
                           step="0.001" 
                           data-item-key="${itemKey}"
                           placeholder="0.000">
                </td>
                <td class="px-4 py-3 whitespace-nowrap" style="width: 15%;">
                    <div class="px-2 py-1 text-sm text-gray-900 text-right item-comm-amount-display" data-item-key="${itemKey}">0.00</div>
                    <input type="hidden" 
                           class="item-comm-amount" 
                           data-item-key="${itemKey}"
                           value="">
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <span class="text-gray-600">${item.risks ? item.risks.length : 0}</span>
                    ${item.risks && item.risks.length > 0 ? `
                        <button type="button" 
                                onclick="openRisksModal('${itemKey}')" 
                                class="ml-2 text-blue-600 hover:text-blue-800 text-xs">
                            Харах
                        </button>
                    ` : ''}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <span class="text-gray-600">${item.questions ? item.questions.length : 0}</span>
                    ${item.questions && item.questions.length > 0 ? `
                        <button type="button" 
                                onclick="openQuestionsModal('${itemKey}')" 
                                class="ml-2 text-blue-600 hover:text-blue-800 text-xs">
                            Харах
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
        
        // Create row element and append to table
        const row = document.createElement('tr');
        row.innerHTML = rowHTML;
        row.className = 'hover:bg-gray-50';
        row.setAttribute('data-item-key', itemKey);
        table.appendChild(row);
        
        // Calculate and set initial commPercent value from risks
        const calculatedSum = calculateRisksCommPercentSum(itemKey);
        const commInput = document.querySelector(`.item-commission[data-item-key="${itemKey}"]`);
        if (commInput) {
            commInput.value = calculatedSum.toFixed(3);
        }
        item.commPercent = calculatedSum.toFixed(3);
        
        // Calculate initial commAmount
        calculateCommAmountForItem(itemKey);
        
        // Update total
        updateCommAmountTotal();
        
        // Attach event listeners
        attachItemEventListeners(itemKey);
    }
    
    // Create item HTML
    function createItemHTML(itemKey, item) {
        return `
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-medium text-gray-900">${item.itemName} (${item.itemCode})</h4>
                ${!item.isFromTemplate ? `
                    <button type="button" 
                            onclick="removeItem('${itemKey}')" 
                            class="text-red-600 hover:text-red-800 text-sm">
                        Устгах
                    </button>
                ` : ''}
            </div>
            
            <!-- Risks -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Эрсдэл:</label>
                <div class="space-y-2" id="risks-container-${itemKey}">
                    ${item.risks && item.risks.length > 0 ? item.risks.map((risk, riskIndex) => `
                        <div class="border border-gray-200 rounded p-3 bg-gray-50 risk-item" data-risk-id="${risk.riskId}">
                            <div class="flex items-center justify-between mb-2">
                                <div>
                                    <span class="text-sm font-medium text-gray-900">${risk.riskName || 'Эрсдэл'} (${risk.riskCode || ''})</span>
                                    ${risk.commPercent !== null && risk.commPercent !== undefined ? `<span class="text-xs text-gray-500 ml-2">Комисс: ${risk.commPercent}%</span>` : ''}
                                </div>
                                ${!item.isFromTemplate ? `
                                    <button type="button" 
                                            onclick="removeRisk('${itemKey}', ${risk.riskId})" 
                                            class="text-red-600 hover:text-red-800 text-xs">
                                        Устгах
                                    </button>
                                ` : ''}
                            </div>
                            <div class="mb-2">
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           class="risk-is-core-risk rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                                           data-item-key="${itemKey}"
                                           data-risk-id="${risk.riskId}"
                                           ${risk.isCoreRisk !== false ? 'checked' : ''}>
                                    <span class="ml-2 text-xs text-gray-700">Ангилал</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Эрсдэлийн хувь</label>
                                <div class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700">
                                    ${risk.riskPercent !== null && risk.riskPercent !== undefined && risk.riskPercent !== '' ? risk.riskPercent : '0.000'}
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-sm text-gray-500">Эрсдэл байхгүй</p>'}
                </div>
                ${!item.isFromTemplate ? `
                    <button type="button" 
                            onclick="openRiskSelectionModal('${itemKey}')" 
                            class="mt-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">
                        + Эрсдэл нэмэх
                    </button>
                ` : ''}
            </div>
            
            <!-- Commission -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Хураамж (%)<span class="text-red-500">*</span>
                </label>
                <input type="number" 
                       class="item-commission w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                       step="0.001" 
                       data-item-key="${itemKey}"
                       placeholder="0.000">
            </div>
            
            <!-- Item Details Section -->
            <div class="mb-4 border-t pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-3">Зүйлийн мэдээлэл:</label>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Эхлэх огноо</label>
                        <input type="date" 
                               class="item-begin-date w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                               data-item-key="${itemKey}"
                               placeholder="YYYY-MM-DD">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Дуусах огноо</label>
                        <input type="date" 
                               class="item-end-date w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                               data-item-key="${itemKey}"
                               placeholder="YYYY-MM-DD">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Үнэлгээ</label>
                        <input type="number" 
                               class="item-valuation w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                               step="0.000001"
                               data-item-key="${itemKey}"
                               placeholder="0.000000">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Хураамж</label>
                        <input type="number" 
                               class="item-comm-amount w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                               step="0.000001"
                               data-item-key="${itemKey}"
                               placeholder="0.000000">
                    </div>
                </div>
            </div>
            
            <!-- Questions -->
            ${item.questions && item.questions.length > 0 ? `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Асуултууд:</label>
                    <div class="space-y-3">
                        ${item.questions.map((question, qIndex) => `
                            <div class="border border-gray-200 rounded p-3 bg-gray-50">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    ${question.itemQuestionName || 'Асуулт'}
                                </label>
                                <textarea 
                                    class="item-question-answer w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                                    rows="2"
                                    data-item-key="${itemKey}"
                                    data-question-id="${question.itemQuestionId}"
                                    placeholder="Хариулт оруулна уу"
                                    maxlength="300"
                                    oninput="updatePolicyProductsData()">${question.answer || ''}</textarea>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '<p class="text-sm text-gray-500">Асуулт байхгүй</p>'}
        `;
    }
    
    // Attach event listeners for item fields
    function attachItemEventListeners(itemKey) {
        // Commission - calculate commAmount when changed
        const commInput = document.querySelector(`.item-commission[data-item-key="${itemKey}"]`);
        if (commInput) {
            commInput.addEventListener('input', function() {
                calculateCommAmountForItem(itemKey);
                updatePolicyProductsData();
                updateCommAmountTotal();
            });
            commInput.addEventListener('change', function() {
                calculateCommAmountForItem(itemKey);
                updatePolicyProductsData();
                updateCommAmountTotal();
            });
        }
        
        // Valuation - calculate commAmount when changed
        const valuationInput = document.querySelector(`.item-valuation[data-item-key="${itemKey}"]`);
        if (valuationInput) {
            valuationInput.addEventListener('input', function() {
                calculateCommAmountForItem(itemKey);
                updatePolicyProductsData();
                updateCommAmountTotal();
            });
            valuationInput.addEventListener('change', function() {
                calculateCommAmountForItem(itemKey);
                updatePolicyProductsData();
                updateCommAmountTotal();
            });
        }
        
        // Comm amount is read-only, no input listeners needed
        
        // Other item fields
        document.querySelectorAll(`.item-begin-date[data-item-key="${itemKey}"], .item-end-date[data-item-key="${itemKey}"]`).forEach(input => {
            input.addEventListener('input', function() {
                updatePolicyProductsData();
            });
            input.addEventListener('change', function() {
                updatePolicyProductsData();
            });
        });
        
        // Risk percent - no longer editable, so no event listener needed
        
        // IsCoreRisk checkbox
        document.querySelectorAll(`.risk-is-core-risk[data-item-key="${itemKey}"]`).forEach(checkbox => {
            checkbox.addEventListener('change', updatePolicyProductsData);
        });
        
        // Questions
        document.querySelectorAll(`.item-question-answer[data-item-key="${itemKey}"]`).forEach(textarea => {
            textarea.addEventListener('input', updatePolicyProductsData);
        });
    }
    
    // Remove item
    window.removeItem = function(itemKey) {
        const parts = itemKey.split('-');
        if (parts.length < 2) return;
        
        const productIndex = parseInt(parts[0]);
        const itemIndex = parseInt(parts[1]);
        const productData = policyProductsData[productIndex];
        
        if (productData && productData.items[itemIndex]) {
            // Remove from data structure
            productData.items.splice(itemIndex, 1);
            
            // Remove from UI (table row)
            const rowElement = document.querySelector(`tr[data-item-key="${itemKey}"]`);
            if (rowElement) {
                rowElement.remove();
            }
            
            // Update total after removal
            updateCommAmountTotal();
            
            // Re-render table to update keys
            displayTemplateData(templateProductsData);
        }
    };
    
    // Remove risk from item
    window.removeRisk = function(itemKey, riskId) {
        const parts = itemKey.split('-');
        if (parts.length < 2) return;
        
        const productIndex = parseInt(parts[0]);
        const itemIndex = parseInt(parts[1]);
        const productData = policyProductsData[productIndex];
        
        if (productData && productData.items[itemIndex]) {
            const item = productData.items[itemIndex];
            
            // Remove from data structure
            if (item.risks) {
                item.risks = item.risks.filter(r => r.riskId !== riskId);
            }
            
            // Remove from UI
            const riskElement = document.querySelector(`#risks-container-${itemKey} .risk-item[data-risk-id="${riskId}"]`);
            if (riskElement) {
                riskElement.remove();
            }
            
            // Show "no risks" message if no risks left
            const risksContainer = document.getElementById(`risks-container-${itemKey}`);
            if (risksContainer && risksContainer.querySelectorAll('.risk-item').length === 0) {
                risksContainer.innerHTML = '<p class="text-sm text-gray-500">Эрсдэл байхгүй</p>';
            }
            
            // Update data structure
            updatePolicyProductsData();
        }
    };
    
    // Open risk selection modal (stub - can be implemented later if needed)
    window.openRiskSelectionModal = function(itemKey) {
        // For now, just show an alert that this feature can be added later
        alert('Эрсдэл нэмэх функцийг дараа нь нэмнэ. Одоогоор зүйл нэмэхдээ эрсдэл автоматаар нэмэгдэнэ.');
    };
    
    // Reindex items after removal (re-render table)
    function reindexProductItems(productIndex) {
        // Re-render the entire table to update all keys
        displayTemplateData(templateProductsData);
    }
    
    // Attach remove item listeners
    function attachRemoveItemListeners() {
        // Handled via onclick attribute, no additional listeners needed
    }
    
    // Update policy products data structure
    function updatePolicyProductsData() {
        policyProductsData.forEach((product, productIndex) => {
            product.items.forEach((item, itemIndex) => {
                const itemKey = `${productIndex}-${itemIndex}`;
                
                // Update commission
                const commInput = document.querySelector(`.item-commission[data-item-key="${itemKey}"]`);
                if (commInput) {
                    item.commPercent = commInput.value || '';
                }
                
                // Update item fields
                const beginDateInput = document.querySelector(`.item-begin-date[data-item-key="${itemKey}"]`);
                if (beginDateInput) {
                    item.beginDate = beginDateInput.value || '';
                }
                
                const endDateInput = document.querySelector(`.item-end-date[data-item-key="${itemKey}"]`);
                if (endDateInput) {
                    item.endDate = endDateInput.value || '';
                }
                
                const valuationInput = document.querySelector(`.item-valuation[data-item-key="${itemKey}"]`);
                if (valuationInput) {
                    item.valuation = valuationInput.value || '';
                }
                
                const commAmountInput = document.querySelector(`.item-comm-amount[data-item-key="${itemKey}"]`);
                if (commAmountInput) {
                    item.commAmount = commAmountInput.value || '';
                }
                
                // Update isSelected for additional risks (isCoreRisk is read-only from template)
                if (item.risks && Array.isArray(item.risks)) {
                    item.risks.forEach((risk) => {
                        // Risk percent is read-only, so we don't update it from input
                        // risk.riskPercent remains as set from template
                        // isCoreRisk comes from template and is not editable
                        
                        // For additional risks, update isSelected based on checkbox
                        if (risk.isCoreRisk === false) {
                            const isSelectedCheckbox = document.querySelector(`.risk-is-core-risk[data-item-key="${itemKey}"][data-risk-id="${risk.riskId}"]`);
                            if (isSelectedCheckbox) {
                                risk.isSelected = isSelectedCheckbox.checked;
                            }
                        }
                    });
                }
                
                // Update question answers
                item.questions.forEach(question => {
                    const answerInput = document.querySelector(`.item-question-answer[data-item-key="${itemKey}"][data-question-id="${question.itemQuestionId}"]`);
                    if (answerInput) {
                        question.answer = answerInput.value || '';
                    }
                });
            });
        });
    }

    // Coinsurance toggle
    document.getElementById('has_coinsurance').addEventListener('change', function() {
        const section = document.getElementById('coinsurance-section');
        if (this.checked) {
            section.classList.remove('hidden');
        } else {
            section.classList.add('hidden');
        }
    });

    // Add coinsurance
    document.getElementById('add-coinsurance').addEventListener('click', function() {
        const index = coinsuranceData.length;
        const html = `
            <div class="border rounded p-3 coinsurance-item" data-index="${index}">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Харилцагч</label>
                        <select class="coinsurance-client w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Сонгох</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Тайлбар</label>
                        <input type="text" class="coinsurance-description w-full px-3 py-2 border border-gray-300 rounded-md" maxlength="30">
                    </div>
                </div>
                <button type="button" class="remove-coinsurance mt-2 text-red-600 text-sm">Устгах</button>
            </div>
        `;
        document.getElementById('coinsurance-list').insertAdjacentHTML('beforeend', html);
        
        // Add remove functionality
        const newItem = document.getElementById('coinsurance-list').lastElementChild;
        newItem.querySelector('.remove-coinsurance').addEventListener('click', function() {
            newItem.remove();
            updateCoinsuranceData();
        });
        
        updateCoinsuranceData();
    });

    function updateCoinsuranceData() {
        coinsuranceData = [];
        document.querySelectorAll('.coinsurance-item').forEach((item, idx) => {
            const clientSelect = item.querySelector('.coinsurance-client');
            const descInput = item.querySelector('.coinsurance-description');
            coinsuranceData.push({
                client_id: clientSelect.value,
                description: descInput.value
            });
        });
    }

    // Policy products data structure
    let policyProductsData = [];

    // Add payment schedule (Step 3)
    document.getElementById('add-payment-schedule').addEventListener('click', function() {
        const index = paymentScheduleData.length;
        const tbody = document.getElementById('payment-schedule-list');
        
        // Create table row
        const row = document.createElement('tr');
        row.className = 'schedule-item hover:bg-gray-50';
        row.setAttribute('data-index', index);
        row.innerHTML = `
            <td class="px-4 py-3">
                <input type="date" 
                       class="schedule-date w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                       data-index="${index}">
            </td>
            <td class="px-4 py-3">
                <input type="number" 
                       class="schedule-amount w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                       step="0.000001"
                       data-index="${index}">
            </td>
            <td class="px-4 py-3 text-center">
                <button type="button" 
                        class="remove-schedule text-red-600 hover:text-red-800 text-sm"
                        data-index="${index}">
                    Устгах
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        
        // Add remove functionality
        const removeBtn = row.querySelector('.remove-schedule');
        removeBtn.addEventListener('click', function() {
            const rowIndex = parseInt(this.getAttribute('data-index'));
            // Remove from data array
            paymentScheduleData.splice(rowIndex, 1);
            // Remove from UI
            row.remove();
            // Re-index remaining rows
            reindexPaymentScheduleRows();
        });
        
        // Add to data array
        paymentScheduleData.push({
            date: '',
            amount: ''
        });
        
        // Add event listeners for inputs
        const dateInput = row.querySelector('.schedule-date');
        const amountInput = row.querySelector('.schedule-amount');
        
        dateInput.addEventListener('change', function() {
            const idx = parseInt(this.getAttribute('data-index'));
            if (paymentScheduleData[idx]) {
                paymentScheduleData[idx].date = this.value;
            }
        });
        
        amountInput.addEventListener('input', function() {
            const idx = parseInt(this.getAttribute('data-index'));
            if (paymentScheduleData[idx]) {
                paymentScheduleData[idx].amount = this.value;
            }
        });
    });
    
    // Re-index payment schedule rows after removal
    function reindexPaymentScheduleRows() {
        const rows = document.querySelectorAll('#payment-schedule-list .schedule-item');
        rows.forEach((row, newIndex) => {
            row.setAttribute('data-index', newIndex);
            const dateInput = row.querySelector('.schedule-date');
            const amountInput = row.querySelector('.schedule-amount');
            const removeBtn = row.querySelector('.remove-schedule');
            
            if (dateInput) dateInput.setAttribute('data-index', newIndex);
            if (amountInput) amountInput.setAttribute('data-index', newIndex);
            if (removeBtn) removeBtn.setAttribute('data-index', newIndex);
        });
    }
    
    // Sync payment schedule data from DOM to paymentScheduleData array
    function syncPaymentScheduleData() {
        paymentScheduleData = [];
        const rows = document.querySelectorAll('#payment-schedule-list .schedule-item');
        rows.forEach((row) => {
            const dateInput = row.querySelector('.schedule-date');
            const amountInput = row.querySelector('.schedule-amount');
            paymentScheduleData.push({
                date: dateInput ? dateInput.value : '',
                amount: amountInput ? amountInput.value : ''
            });
        });
    }
    
    // Restore payment schedules from paymentScheduleData array
    function restorePaymentScheduleData() {
        const tbody = document.getElementById('payment-schedule-list');
        if (!tbody) return;
        
        // Clear existing rows
        tbody.innerHTML = '';
        
        // Restore from data array
        paymentScheduleData.forEach((schedule, index) => {
            const row = document.createElement('tr');
            row.className = 'schedule-item hover:bg-gray-50';
            row.setAttribute('data-index', index);
            row.innerHTML = `
                <td class="px-4 py-3">
                    <input type="date" 
                           class="schedule-date w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                           data-index="${index}"
                           value="${schedule.date || ''}">
                </td>
                <td class="px-4 py-3">
                    <input type="number" 
                           class="schedule-amount w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                           step="0.000001"
                           data-index="${index}"
                           value="${schedule.amount || ''}">
                </td>
                <td class="px-4 py-3 text-center">
                    <button type="button" 
                            class="remove-schedule text-red-600 hover:text-red-800 text-sm"
                            data-index="${index}">
                        Устгах
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            
            // Add remove functionality
            const removeBtn = row.querySelector('.remove-schedule');
            removeBtn.addEventListener('click', function() {
                const rowIndex = parseInt(this.getAttribute('data-index'));
                // Remove from data array
                paymentScheduleData.splice(rowIndex, 1);
                // Remove from UI
                row.remove();
                // Re-index remaining rows
                reindexPaymentScheduleRows();
            });
            
            // Add event listeners for inputs
            const dateInput = row.querySelector('.schedule-date');
            const amountInput = row.querySelector('.schedule-amount');
            
            dateInput.addEventListener('change', function() {
                const idx = parseInt(this.getAttribute('data-index'));
                if (paymentScheduleData[idx]) {
                    paymentScheduleData[idx].date = this.value;
                }
            });
            
            amountInput.addEventListener('input', function() {
                const idx = parseInt(this.getAttribute('data-index'));
                if (paymentScheduleData[idx]) {
                    paymentScheduleData[idx].amount = this.value;
                }
            });
        });
    }

    // Add file (Step 4)
    const addFileBtn = document.getElementById('add-file');
    if (addFileBtn) {
        addFileBtn.addEventListener('click', function() {
            const index = filesData.length;
            const row = document.createElement('tr');
            row.className = 'file-item hover:bg-gray-50';
            row.setAttribute('data-index', index);
            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="file" class="file-name w-full px-3 py-2 border border-gray-300 rounded-md" data-index="${index}">
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="text" class="file-path w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" maxlength="100" readonly>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-center">
                    <button type="button" class="remove-file text-red-600 hover:text-red-800 text-sm" data-index="${index}">
                        Устгах
                    </button>
                </td>
            `;
            const filesList = document.getElementById('files-list');
            if (filesList) {
                filesList.appendChild(row);
                
                const removeBtn = row.querySelector('.remove-file');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        const rowIndex = parseInt(this.getAttribute('data-index'));
                        filesData.splice(rowIndex, 1);
                        row.remove();
                        updateFilesData();
                        reindexFileItems();
                    });
                }
                
                // Initialize data entry
                filesData.push({
                    fileName: '',
                    filePath: ''
                });
                
                // Add file selection listener to update filesData
                const fileNameInput = row.querySelector('.file-name');
                const filePathInput = row.querySelector('.file-path');
                
                if (fileNameInput) {
                    fileNameInput.addEventListener('change', function() {
                        const file = this.files[0];
                        if (file) {
                            const fileName = file.name;
                            const filePath = file.name; // Use file name as path, or could use file.path if available
                            
                            // Update the readonly path field
                            if (filePathInput) {
                                filePathInput.value = filePath;
                            }
                            
                            // Update filesData
                            if (filesData[index]) {
                                filesData[index].fileName = fileName;
                                filesData[index].filePath = filePath;
                            }
                        }
                    });
                }
            }
        });
    }
    
    // Update files data
    function updateFilesData() {
        filesData = [];
        document.querySelectorAll('#files-list .file-item').forEach((item, idx) => {
            const fileNameInput = item.querySelector('.file-name');
            const filePathInput = item.querySelector('.file-path');
            
            // For file inputs, get the file name from the selected file or the readonly path field
            let fileName = '';
            if (fileNameInput && fileNameInput.files && fileNameInput.files.length > 0) {
                fileName = fileNameInput.files[0].name;
            } else if (filePathInput) {
                // Fallback to path field if file input doesn't have a file selected
                fileName = filePathInput.value;
            }
            
            filesData.push({
                fileName: fileName,
                filePath: filePathInput ? filePathInput.value : ''
            });
        });
    }
    
    // Re-index file items after removal
    function reindexFileItems() {
        const fileItems = document.querySelectorAll('#files-list .file-item');
        fileItems.forEach((item, newIndex) => {
            item.setAttribute('data-index', newIndex);
            const fileNameInput = item.querySelector('.file-name');
            const filePathInput = item.querySelector('.file-path');
            const removeBtn = item.querySelector('.remove-file');
            if (fileNameInput) fileNameInput.setAttribute('data-index', newIndex);
            if (removeBtn) removeBtn.setAttribute('data-index', newIndex);
        });
    }
    
    // Restore files from filesData array
    function restoreFilesData() {
        const filesList = document.getElementById('files-list');
        if (!filesList) return;
        
        // Clear existing items
        filesList.innerHTML = '';
        
        // Restore from data array
        filesData.forEach((file, index) => {
            const row = document.createElement('tr');
            row.className = 'file-item hover:bg-gray-50';
            row.setAttribute('data-index', index);
            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="file" class="file-name w-full px-3 py-2 border border-gray-300 rounded-md" data-index="${index}">
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="text" class="file-path w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" maxlength="100" value="${escapeHtml(file.filePath)}" readonly>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-center">
                    <button type="button" class="remove-file text-red-600 hover:text-red-800 text-sm" data-index="${index}">
                        Устгах
                    </button>
                </td>
            `;
            filesList.appendChild(row);
            
            const removeBtn = row.querySelector('.remove-file');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    const rowIndex = parseInt(this.getAttribute('data-index'));
                    filesData.splice(rowIndex, 1);
                    row.remove();
                    updateFilesData();
                    reindexFileItems();
                });
            }
            
            // Add file selection listener to update filesData
            const fileNameInput = row.querySelector('.file-name');
            const filePathInput = row.querySelector('.file-path');
            
            if (fileNameInput) {
                fileNameInput.addEventListener('change', function() {
                    const file = this.files[0];
                    if (file) {
                        const fileName = file.name;
                        const filePath = file.name; // Use file name as path, or could use file.path if available
                        
                        // Update the readonly path field
                        if (filePathInput) {
                            filePathInput.value = filePath;
                        }
                        
                        // Update filesData
                        if (filesData[index]) {
                            filesData[index].fileName = fileName;
                            filesData[index].filePath = filePath;
                        }
                    }
                });
            }
        });
    }

    // Load branch users for agent dropdown (AgentId is FK to User, not RefClient)
    function loadBranchUsersForAgent() {
        return fetch('/core/api/branch-users/', {
            credentials: 'include',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.users) {
                const agentSelect = document.getElementById('agent_id');
                if (agentSelect) {
                    // Clear existing options except the first placeholder
                    while (agentSelect.options.length > 1) {
                        agentSelect.remove(1);
                    }
                    
                    // Add all users from Ref_Branch_User
                    // AgentId is FK to User, so store UserId directly
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.UserId;  // Store UserId (AgentId is FK to User)
                        const displayName = user.first_name || user.last_name 
                            ? `${user.username} (${user.first_name} ${user.last_name})`.trim()
                            : user.username;
                        option.textContent = displayName;
                        agentSelect.appendChild(option);
                    });
                }
            }
            return data;
        })
        .catch(error => {
            console.error('Error loading branch users for agent dropdown:', error);
            return null;
        });
    }

    // Load user's branch and channel on page load
    function loadUserBranchChannel() {
        fetch('/core/api/user-branch-channel/', {
            credentials: 'include',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.branch && data.channel) {
                // Set branch value
                const branchSelect = document.getElementById('agent_branch_id');
                if (branchSelect) {
                    // Create option if it doesn't exist
                    let branchOption = branchSelect.querySelector(`option[value="${data.branch.BranchId}"]`);
                    if (!branchOption) {
                        branchOption = document.createElement('option');
                        branchOption.value = data.branch.BranchId;
                        branchOption.textContent = `${data.branch.BranchCode} - ${data.branch.BranchName}`;
                        branchSelect.appendChild(branchOption);
                    }
                    branchSelect.value = data.branch.BranchId;
                }
                
                // Set channel value
                const channelSelect = document.getElementById('agent_channel_id');
                if (channelSelect) {
                    // Create option if it doesn't exist
                    let channelOption = channelSelect.querySelector(`option[value="${data.channel.ChannelId}"]`);
                    if (!channelOption) {
                        channelOption = document.createElement('option');
                        channelOption.value = data.channel.ChannelId;
                        channelOption.textContent = data.channel.ChannelName;
                        channelSelect.appendChild(channelOption);
                    }
                    channelSelect.value = data.channel.ChannelId;
                }
                
                // Set agent value - default to logged-in user's UserId (from Ref_Branch_User)
                // AgentId is FK to User, so store UserId directly
                const agentSelect = document.getElementById('agent_id');
                if (agentSelect) {
                    if (data.agent && data.user_id) {
                        // Find the option that matches the logged-in user's UserId
                        const loggedInUserOption = agentSelect.querySelector(`option[value="${data.user_id}"]`);
                        
                        if (loggedInUserOption) {
                            // Option exists in dropdown, set it as default
                            agentSelect.value = data.user_id;  // Store UserId (AgentId is FK to User)
                        } else {
                            // Option doesn't exist yet (shouldn't happen if loadBranchUsersForAgent ran first)
                            // Create it and select it as fallback
                            const option = document.createElement('option');
                            option.value = data.user_id;  // Store UserId (AgentId is FK to User)
                            option.textContent = data.username;
                            agentSelect.appendChild(option);
                            agentSelect.value = data.user_id;
                        }
                    }
                    // Ensure the select field is always editable (not disabled/readonly)
                    agentSelect.disabled = false;
                    agentSelect.readOnly = false;
                }
            } else {
                console.warn('User branch and channel not found');
            }
        })
        .catch(error => {
            console.error('Error loading user branch and channel:', error);
        });
    }

    // Load currencies from API
    function loadCurrencies() {
        return fetch('/core/api/currencies/', {
            credentials: 'include',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.currencies) {
                const currencySelect = document.getElementById('currency_id');
                if (currencySelect) {
                    // Clear existing options except the first one
                    while (currencySelect.options.length > 1) {
                        currencySelect.remove(1);
                    }
                    
                    // Add currency options
                    data.currencies.forEach(currency => {
                        const option = document.createElement('option');
                        option.value = currency.CurrencyId;
                        option.textContent = `${currency.CurrencyName}`;
                        option.setAttribute('data-default-value', currency.DefaultValue);
                        currencySelect.appendChild(option);
                    });
                    
                    // Set default currency exchange rate when currency is selected
                    currencySelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        const defaultValue = selectedOption.getAttribute('data-default-value');
                        const exchangeInput = document.getElementById('currency_exchange');
                        if (exchangeInput && defaultValue) {
                            exchangeInput.value = defaultValue;
                        }
                    });
                }
            } else {
                console.warn('Currencies not found');
            }
            return data;
        })
        .catch(error => {
            console.error('Error loading currencies:', error);
            return null;
        });
    }

    // Listen for template selection changes
    const templateDisplayInput = document.getElementById('policy_template_id_display');
    const templateHiddenInput = document.getElementById('policy_template_id');
    
    if (templateDisplayInput && templateHiddenInput) {
        // Listen for change events on the hidden input (triggered by modal)
        templateHiddenInput.addEventListener('change', function() {
            // Check if we're in edit mode - don't reset data in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const editPolicyId = urlParams.get('edit');
            const isEditMode = editPolicyId || window.editingPolicyId;
            
            // In edit mode, don't reset data when template changes (template is already set from policy)
            if (isEditMode && window.policyDataLoaded) {
                return;
            }
            
            const newTemplateId = this.value;
            // If template changed, reset the data
            if (newTemplateId !== lastLoadedTemplateId) {
                // Clear existing data if template changed
                if (newTemplateId && lastLoadedTemplateId !== null) {
                    policyProductsData = [];
                    lastLoadedTemplateId = null;
                }
                // If on step 2, load new template data
                if (newTemplateId && currentStep === 2) {
                    loadTemplateData();
                }
            }
        });
        
        // Also check periodically if template was selected (for modal integration)
        setInterval(function() {
            // Check if we're in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const editPolicyId = urlParams.get('edit');
            const isEditMode = editPolicyId || window.editingPolicyId;
            
            // In edit mode, don't auto-load template (data is loaded from policy)
            if (isEditMode && window.policyDataLoaded) {
                return;
            }
            
            const templateId = templateHiddenInput.value;
            if (templateId && currentStep === 2) {
                // Only load if we don't have data or template changed
                if (policyProductsData.length === 0 || templateId !== lastLoadedTemplateId) {
                    loadTemplateData();
                }
            }
        }, 500);
    }
    
    // Serialize policy products data for form submission
    function serializePolicyProductsData() {
        const serialized = JSON.stringify(policyProductsData);
        // Store in hidden input for form submission
        let hiddenInput = document.getElementById('policy_products_data');
        if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = 'policy_products_data';
            hiddenInput.name = 'policy_products_data';
            document.getElementById('policy-form').appendChild(hiddenInput);
        }
        hiddenInput.value = serialized;
        return serialized;
    }
    
    // Update form submission to include policy products data and files data
    const policyForm = document.getElementById('policy-form');
    if (policyForm) {
        policyForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission
            
            // Update policy products data to ensure all changes (including question answers) are captured
            updatePolicyProductsData();
            
            // Serialize data before submission
            serializePolicyProductsData();
            
            // Serialize payment schedule data
            let scheduleInput = document.getElementById('payment_schedule_data');
            if (!scheduleInput) {
                scheduleInput = document.createElement('input');
                scheduleInput.type = 'hidden';
                scheduleInput.id = 'payment_schedule_data';
                scheduleInput.name = 'payment_schedule_data';
                policyForm.appendChild(scheduleInput);
            }
            scheduleInput.value = JSON.stringify(paymentScheduleData);
            
            // Serialize files data
            updateFilesData();
            let filesInput = document.getElementById('files_data');
            if (!filesInput) {
                filesInput = document.createElement('input');
                filesInput.type = 'hidden';
                filesInput.id = 'files_data';
                filesInput.name = 'files_data';
                policyForm.appendChild(filesInput);
            }
            filesInput.value = JSON.stringify(filesData);
            
            // Submit via AJAX
            const formData = new FormData(policyForm);
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Хадгалж байна...';
            }
            
            fetch(policyForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Алдаа гарлаа');
                    });
                }
            })
            .then(data => {
                if (data.success) {
                    // Show success message with print button
                    const policyId = data.policy_id || window.editingPolicyId;
                    if (policyId) {
                        showPolicySuccessModal(policyId);
                    } else {
                        alert('Амжилттай хадгалагдлаа');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Хадгалах';
                        }
                    }
                } else {
                    alert(data.error || 'Алдаа гарлаа');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Хадгалах';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Алдаа гарлаа: ' + error.message);
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Хадгалах';
                }
            });
        });
    }
    
    // Show success modal with print button
    function showPolicySuccessModal(policyId) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.id = 'policy-success-modal';
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                        <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mt-5">Амжилттай</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">Гэрээ амжилттай үүсгэгдлээ.</p>
                    </div>
                    <div class="flex items-center justify-center space-x-4 px-4 py-3">
                        <button onclick="window.location.reload()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-400">
                            ХАДГАЛАХ
                        </button>
                        <button onclick="generatePolicyWord(${policyId})" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                            ГЭРЭЭ ХЭВЛЭХ
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Merge template risks with policy risks
    // Template risks provide the base set of available risks
    // Policy risks override template values where they exist
    function mergeTemplateAndPolicyRisks(templateRisks, policyRisks) {
        // Create map of policy risks by riskId for quick lookup
        const policyRisksMap = new Map();
        (policyRisks || []).forEach(pr => {
            policyRisksMap.set(pr.riskId, pr);
        });
        
        // Start with template risks
        const mergedRisks = (templateRisks || []).map(tr => {
            const policyRisk = policyRisksMap.get(tr.riskId);
            if (policyRisk) {
                // Policy risk exists - merge with policy values taking precedence
                return {
                    riskId: tr.riskId,
                    riskName: tr.riskName || policyRisk.riskName || '',
                    riskCode: tr.riskCode || policyRisk.riskCode || '',
                    riskPercent: policyRisk.riskPercent !== null && policyRisk.riskPercent !== undefined 
                        ? policyRisk.riskPercent 
                        : (tr.commPercent !== null && tr.commPercent !== undefined ? tr.commPercent : null),
                    commPercent: policyRisk.riskPercent !== null && policyRisk.riskPercent !== undefined 
                        ? policyRisk.riskPercent 
                        : (tr.commPercent !== null && tr.commPercent !== undefined ? tr.commPercent : null),
                    isCoreRisk: tr.isCoreRisk !== null && tr.isCoreRisk !== undefined ? tr.isCoreRisk : true,
                    isSelected: policyRisk.isSelected !== undefined ? policyRisk.isSelected : (tr.isCoreRisk === false ? false : true)
                };
            } else {
                // Template-only risk - use template defaults
                return {
                    riskId: tr.riskId,
                    riskName: tr.riskName || '',
                    riskCode: tr.riskCode || '',
                    riskPercent: tr.commPercent !== null && tr.commPercent !== undefined ? tr.commPercent : null,
                    commPercent: tr.commPercent !== null && tr.commPercent !== undefined ? tr.commPercent : null,
                    isCoreRisk: tr.isCoreRisk !== null && tr.isCoreRisk !== undefined ? tr.isCoreRisk : true,
                    isSelected: tr.isCoreRisk === false ? false : true // Additional risks default to not selected
                };
            }
        });
        
        // Add policy-only risks (risks in policy but not in template)
        (policyRisks || []).forEach(pr => {
            if (!(templateRisks || []).find(tr => tr.riskId === pr.riskId)) {
                mergedRisks.push({
                    riskId: pr.riskId,
                    riskName: pr.riskName || '',
                    riskCode: pr.riskCode || '',
                    riskPercent: pr.riskPercent !== null && pr.riskPercent !== undefined ? pr.riskPercent : null,
                    commPercent: pr.riskPercent !== null && pr.riskPercent !== undefined ? pr.riskPercent : null,
                    isCoreRisk: pr.isCoreRisk !== undefined ? pr.isCoreRisk : true,
                    isSelected: pr.isSelected !== undefined ? pr.isSelected : true
                });
            }
        });
        
        return mergedRisks;
    }
    
    // Load policy data for editing
    function loadPolicyDataForEdit(policyId) {
        fetch(`/core/api/policy/${policyId}/edit-data/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mark that policy data is loaded (for edit mode detection)
                window.policyDataLoaded = true;
                
                const policy = data.policy;
                // Store policy ID for edit mode detection (set early so template change listener can use it)
                window.editingPolicyId = policy.policyId;
                
                const products = data.products || [];
                const schedules = data.schedules || [];
                const files = data.files || [];
                
                // Debug: Log the products data to see what we're receiving
                console.log('Policy edit data received:', {
                    policy: policy,
                    products: products,
                    firstItemDates: products[0]?.items[0] ? {
                        beginDate: products[0].items[0].beginDate,
                        endDate: products[0].items[0].endDate,
                        valuation: products[0].items[0].valuation
                    } : 'No items'
                });
                
                // Populate Step 1: Basic policy fields
                if (policy.policyNo) document.getElementById('policy_no').value = policy.policyNo;
                if (policy.clientId) {
                    const clientIdInput = document.getElementById('client_id');
                    const clientDisplayInput = document.getElementById('client_id_display');
                    if (clientIdInput) {
                        clientIdInput.value = policy.clientId;
                    }
                    if (clientDisplayInput && policy.clientDisplay) {
                        clientDisplayInput.value = policy.clientDisplay;
                    }
                }
                if (policy.agentId) document.getElementById('agent_id').value = policy.agentId;
                if (policy.policyTemplateId) {
                    const templateIdInput = document.getElementById('policy_template_id');
                    const templateDisplayInput = document.getElementById('policy_template_id_display');
                    if (templateIdInput) {
                        templateIdInput.value = policy.policyTemplateId;
                        // Trigger change event to load template data for step 2
                        setTimeout(() => {
                            const event = new Event('change', { bubbles: true });
                            templateIdInput.dispatchEvent(event);
                        }, 100);
                    }
                    if (templateDisplayInput && policy.policyTemplateDisplay) {
                        templateDisplayInput.value = policy.policyTemplateDisplay;
                    }
                }
                if (policy.beginDate) document.getElementById('begin_date').value = policy.beginDate;
                if (policy.endDate) document.getElementById('end_date').value = policy.endDate;
                if (policy.currencyId) {
                    const currencySelect = document.getElementById('currency_id');
                    if (currencySelect) {
                        currencySelect.value = policy.currencyId;
                        // Set exchange rate after a short delay to allow currency options to load
                        setTimeout(() => {
                            if (policy.currencyExchange) {
                                document.getElementById('currency_exchange').value = policy.currencyExchange;
                            } else {
                                // Trigger currency change to set default exchange rate if not provided
                                const event = new Event('change', { bubbles: true });
                                currencySelect.dispatchEvent(event);
                            }
                        }, 200);
                    }
                }
                if (policy.currencyAmount) document.getElementById('currency_amount').value = policy.currencyAmount;
                if (policy.agentBranchId) document.getElementById('agent_branch_id').value = policy.agentBranchId;
                if (policy.agentChannelId) document.getElementById('agent_channel_id').value = policy.agentChannelId;
                if (policy.directorName) document.getElementById('director_name').value = policy.directorName;
                if (policy.description) document.getElementById('description').value = policy.description;
                if (policy.isActive) document.getElementById('is_active').checked = policy.isActive;
                if (policy.hasCoinsurance) document.getElementById('has_coinsurance').checked = policy.hasCoinsurance;
                
                // Populate Step 2: Products, items, risks, questions
                // When editing, first load template risks, then merge with policy risks
                const processProductsWithTemplateRisks = (templateData) => {
                    // Create a map of template items by itemId for quick lookup
                    const templateItemsMap = new Map();
                    if (templateData && templateData.products) {
                        templateData.products.forEach(templateProduct => {
                            (templateProduct.items || []).forEach(templateItem => {
                                templateItemsMap.set(templateItem.itemId, templateItem);
                            });
                        });
                    }
                    
                    // Transform products data to match displayTemplateData format
                    // Merge template risks with policy risks for each item
                    const transformedProducts = products.map(product => ({
                        productId: product.productId,
                        productName: product.productName,
                        productCode: product.productCode || '',
                        items: product.items.map(item => {
                            // Get template risks for this item
                            const templateItem = templateItemsMap.get(item.itemId);
                            const templateRisks = templateItem ? (templateItem.risks || []) : [];
                            
                            // Get policy risks for this item
                            const policyRisks = (item.risks || []).map(r => ({
                                riskId: r.riskId,
                                riskName: r.riskName || '',
                                riskCode: r.riskCode || '',
                                riskPercent: r.riskPercent !== null && r.riskPercent !== undefined ? r.riskPercent : null,
                                isCoreRisk: r.isCoreRisk !== undefined ? r.isCoreRisk : true,
                                isSelected: r.isSelected !== undefined ? r.isSelected : true
                            }));
                            
                            // Merge template and policy risks
                            const mergedRisks = mergeTemplateAndPolicyRisks(templateRisks, policyRisks);
                            
                            return {
                                itemId: item.itemId,
                                itemName: item.itemName,
                                itemCode: item.itemCode || '',
                                // Include actual policy values (not empty template values)
                                // Preserve all values including 0 and empty strings
                                beginDate: item.beginDate !== null && item.beginDate !== undefined ? item.beginDate : '',
                                endDate: item.endDate !== null && item.endDate !== undefined ? item.endDate : '',
                                valuation: item.valuation !== null && item.valuation !== undefined ? item.valuation : '',
                                commPercent: item.commPercent !== null && item.commPercent !== undefined ? item.commPercent : '',
                                commAmount: item.commAmount !== null && item.commAmount !== undefined ? item.commAmount : '',
                                // Use merged risks (template + policy)
                                risks: mergedRisks.map(r => ({
                                    riskId: r.riskId,
                                    riskName: r.riskName || '',
                                    riskCode: r.riskCode || '',
                                    riskPercent: r.riskPercent !== null && r.riskPercent !== undefined ? r.riskPercent : null,
                                    commPercent: r.commPercent !== null && r.commPercent !== undefined ? r.commPercent : null,
                                    isCoreRisk: r.isCoreRisk !== null && r.isCoreRisk !== undefined ? r.isCoreRisk : true,
                                    isSelected: r.isSelected !== undefined ? r.isSelected : (r.isCoreRisk === false ? false : true)
                                })),
                                // Include actual questions with answers from policy
                                questions: (item.questions || []).map(q => ({
                                    itemQuestionId: q.itemQuestionId,
                                    itemQuestionName: q.itemQuestionName || '',
                                    answer: q.answer || ''  // Preserve actual answer from policy
                                }))
                            };
                        })
                    }));
                    
                    return transformedProducts;
                };
                
                // If template ID exists, fetch template data first, then process products
                if (policy.policyTemplateId) {
                    fetch(`/core/api/policy-template/${policy.policyTemplateId}/full-data/`, {
                        credentials: 'include',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(templateData => {
                        const transformedProducts = processProductsWithTemplateRisks(templateData);
                        renderProductsData(transformedProducts, products);
                    })
                    .catch(error => {
                        console.error('Error loading template data for risk merging:', error);
                        // Fallback: process without template data (use only policy risks)
                        const transformedProducts = processProductsWithTemplateRisks(null);
                        renderProductsData(transformedProducts, products);
                    });
                } else {
                    // No template ID - process without template data (use only policy risks)
                    const transformedProducts = processProductsWithTemplateRisks(null);
                    renderProductsData(transformedProducts, products);
                }
                
                // Helper function to render products data
                function renderProductsData(transformedProducts, originalProducts) {
                    setTimeout(() => {
                        if (transformedProducts.length > 0) {
                        
                        // Render the products/items in the table with actual policy data
                        // The displayTemplateData function will use the values from transformedProducts
                        displayTemplateData(transformedProducts);
                        
                        // After rendering, ensure input fields have actual values from the policy
                        // Define function to set date values (will be called multiple times to ensure persistence)
                        const setDateValues = () => {
                            originalProducts.forEach((product, productIndex) => {
                                product.items.forEach((item, itemIndex) => {
                                    const itemKey = `${productIndex}-${itemIndex}`;
                                    
                                    // Get the actual values from the original products data
                                    const beginDateValue = item.beginDate;
                                    const endDateValue = item.endDate;
                                    
                                    // Populate date fields - use original item data
                                    if (beginDateValue && beginDateValue.trim() !== '') {
                                        const beginDateInput = document.querySelector(`.item-begin-date[data-item-key="${itemKey}"]`);
                                        if (beginDateInput) {
                                            // Set the value multiple ways to ensure it sticks
                                            beginDateInput.setAttribute('value', beginDateValue);
                                            beginDateInput.value = beginDateValue;
                                            // Force a re-render by clearing and re-setting
                                            beginDateInput.value = '';
                                            beginDateInput.value = beginDateValue;
                                            // Trigger events
                                            beginDateInput.dispatchEvent(new Event('input', { bubbles: true }));
                                            beginDateInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            console.log(`Set beginDate for ${itemKey}: ${beginDateValue}`, beginDateInput.value);
                                            // Also update the data structure
                                            if (policyProductsData[productIndex]?.items[itemIndex]) {
                                                policyProductsData[productIndex].items[itemIndex].beginDate = beginDateValue;
                                            }
                                        }
                                    }
                                    
                                    if (endDateValue && endDateValue.trim() !== '') {
                                        const endDateInput = document.querySelector(`.item-end-date[data-item-key="${itemKey}"]`);
                                        if (endDateInput) {
                                            // Set the value multiple ways to ensure it sticks
                                            endDateInput.setAttribute('value', endDateValue);
                                            endDateInput.value = endDateValue;
                                            // Force a re-render by clearing and re-setting
                                            endDateInput.value = '';
                                            endDateInput.value = endDateValue;
                                            // Trigger events
                                            endDateInput.dispatchEvent(new Event('input', { bubbles: true }));
                                            endDateInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            console.log(`Set endDate for ${itemKey}: ${endDateValue}`, endDateInput.value);
                                            // Also update the data structure
                                            if (policyProductsData[productIndex]?.items[itemIndex]) {
                                                policyProductsData[productIndex].items[itemIndex].endDate = endDateValue;
                                            }
                                        }
                                    }
                                });
                            });
                        };
                        
                        // Use requestAnimationFrame to ensure DOM is fully rendered, then set values
                        // Try multiple times to ensure values persist
                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                setDateValues();
                            }, 100);
                            setTimeout(() => {
                                setDateValues();
                            }, 300);
                            setTimeout(() => {
                                setDateValues();
                                
                                // Also populate other fields
                                originalProducts.forEach((product, productIndex) => {
                                    product.items.forEach((item, itemIndex) => {
                                        const itemKey = `${productIndex}-${itemIndex}`;
                                        
                                        // Populate valuation
                                        if (item.valuation !== null && item.valuation !== undefined) {
                                            const valuationInput = document.querySelector(`.item-valuation[data-item-key="${itemKey}"]`);
                                            if (valuationInput) valuationInput.value = item.valuation;
                                        }
                                        
                                        // Populate commission percent
                                        if (item.commPercent !== null && item.commPercent !== undefined) {
                                            const commPercentInput = document.querySelector(`.item-commission[data-item-key="${itemKey}"]`);
                                            if (commPercentInput) commPercentInput.value = item.commPercent;
                                        }
                                        
                                        // Populate commission amount
                                        if (item.commAmount !== null && item.commAmount !== undefined) {
                                            const commAmountInput = document.querySelector(`.item-comm-amount[data-item-key="${itemKey}"]`);
                                            if (commAmountInput) commAmountInput.value = item.commAmount;
                                        }
                                        
                                        // Update the data structure with actual values from policy
                                        // Note: Risks are already merged and set by displayTemplateData() from transformedProducts
                                        // So we don't overwrite them here - they already contain template + policy merged risks
                                        if (policyProductsData[productIndex] && policyProductsData[productIndex].items[itemIndex]) {
                                            const itemData = policyProductsData[productIndex].items[itemIndex];
                                            // Update basic fields
                                            itemData.beginDate = item.beginDate || '';
                                            itemData.endDate = item.endDate || '';
                                            itemData.valuation = item.valuation !== null && item.valuation !== undefined ? item.valuation : '';
                                            itemData.commPercent = item.commPercent !== null && item.commPercent !== undefined ? item.commPercent : '';
                                            itemData.commAmount = item.commAmount !== null && item.commAmount !== undefined ? item.commAmount : '';
                                            
                                            // Risks are already merged and set by displayTemplateData() - don't overwrite
                                            
                                            // Update questions with actual answers from policy detail table
                                            if (item.questions && Array.isArray(item.questions) && item.questions.length > 0) {
                                                itemData.questions = item.questions.map(q => ({
                                                    itemQuestionId: q.itemQuestionId,
                                                    itemQuestionName: q.itemQuestionName || '',
                                                    answer: q.answer || ''  // Preserve actual answer from ins_policy_main_product_item_question
                                                }));
                                            }
                                        }
                                    });
                                });
                                
                                // Recalculate totals and update data
                                updatePolicyProductsData();
                                updateCommAmountTotal();
                            }, 500);
                        });
                    }
                }, 1000);
                }
                
                // Populate Step 3: Payment schedules
                if (schedules.length > 0) {
                    paymentScheduleData = schedules;
                    // Render schedules in the UI
                    const scheduleList = document.getElementById('payment-schedule-list');
                    if (scheduleList) {
                        scheduleList.innerHTML = '';
                        schedules.forEach((schedule, index) => {
                            const row = document.createElement('div');
                            row.className = 'border rounded p-3 schedule-item';
                            row.setAttribute('data-index', index);
                            row.innerHTML = `
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Огноо</label>
                                        <input type="date" class="schedule-date w-full px-3 py-2 border border-gray-300 rounded-md" data-index="${index}" value="${schedule.date}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Дүн</label>
                                        <input type="number" class="schedule-amount w-full px-3 py-2 border border-gray-300 rounded-md" data-index="${index}" step="0.01" value="${schedule.amount}">
                                    </div>
                                </div>
                                <button type="button" class="remove-schedule mt-2 text-red-600 text-sm" data-index="${index}">Устгах</button>
                            `;
                            scheduleList.appendChild(row);
                            
                            // Add event listeners
                            const dateInput = row.querySelector('.schedule-date');
                            const amountInput = row.querySelector('.schedule-amount');
                            const removeBtn = row.querySelector('.remove-schedule');
                            
                            if (dateInput) {
                                dateInput.addEventListener('input', function() {
                                    const idx = parseInt(this.getAttribute('data-index'));
                                    if (paymentScheduleData[idx]) {
                                        paymentScheduleData[idx].date = this.value;
                                    }
                                });
                            }
                            
                            if (amountInput) {
                                amountInput.addEventListener('input', function() {
                                    const idx = parseInt(this.getAttribute('data-index'));
                                    if (paymentScheduleData[idx]) {
                                        paymentScheduleData[idx].amount = this.value;
                                    }
                                });
                            }
                            
                            if (removeBtn) {
                                removeBtn.addEventListener('click', function() {
                                    const idx = parseInt(this.getAttribute('data-index'));
                                    paymentScheduleData.splice(idx, 1);
                                    row.remove();
                                    reindexPaymentScheduleRows();
                                });
                            }
                        });
                    }
                }
                
                // Populate Step 4: Files
                if (files.length > 0) {
                    filesData = files;
                    // Render files in the UI
                    const filesList = document.getElementById('files-list');
                    if (filesList) {
                        filesList.innerHTML = '';
                        files.forEach((file, index) => {
                            const row = document.createElement('tr');
                            row.className = 'file-item hover:bg-gray-50';
                            row.setAttribute('data-index', index);
                            row.innerHTML = `
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <input type="file" class="file-name w-full px-3 py-2 border border-gray-300 rounded-md" data-index="${index}">
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <input type="text" class="file-path w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" maxlength="100" value="${escapeHtml(file.filePath)}" readonly>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-center">
                                    <button type="button" class="remove-file text-red-600 hover:text-red-800 text-sm" data-index="${index}">
                                        Устгах
                                    </button>
                                </td>
                            `;
                            filesList.appendChild(row);
                            
                            // Add event listeners
                            const fileNameInput = row.querySelector('.file-name');
                            const filePathInput = row.querySelector('.file-path');
                            const removeBtn = row.querySelector('.remove-file');
                            
                            if (fileNameInput) {
                                fileNameInput.addEventListener('change', function() {
                                    const file = this.files[0];
                                    if (file) {
                                        const fileName = file.name;
                                        const filePath = file.name; // Use file name as path, or could use file.path if available
                                        
                                        // Update the readonly path field
                                        if (filePathInput) {
                                            filePathInput.value = filePath;
                                        }
                                        
                                        // Update filesData
                                        if (filesData[index]) {
                                            filesData[index].fileName = fileName;
                                            filesData[index].filePath = filePath;
                                        }
                                    }
                                });
                            }
                            
                            if (removeBtn) {
                                removeBtn.addEventListener('click', function() {
                                    const rowIndex = parseInt(this.getAttribute('data-index'));
                                    filesData.splice(rowIndex, 1);
                                    row.remove();
                                    updateFilesData();
                                    reindexFileItems();
                                });
                            }
                        });
                    }
                }
                
                // Update form action to point to update endpoint
                const policyForm = document.getElementById('policy-form');
                if (policyForm) {
                    policyForm.action = `/core/policies/${policy.policyId}/update/`;
                }
            } else {
                alert('Алдаа: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading policy data:', error);
            alert('Алдаа гарлаа: ' + error.message);
        });
    }
    
    // Escape HTML helper
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Populate Step 5 review page with all policy data
    function populateStep5Review() {
        const container = document.getElementById('step-5-review-content');
        if (!container) return;
        
        // Get Step 1 data
        const policyNo = document.getElementById('policy_no')?.value || '';
        const clientDisplay = document.getElementById('client_id_display')?.value || '';
        const agentSelect = document.getElementById('agent_id');
        const agentText = agentSelect?.options[agentSelect.selectedIndex]?.textContent || '';
        const templateDisplay = document.getElementById('policy_template_id_display')?.value || '';
        const beginDate = document.getElementById('begin_date')?.value || '';
        const endDate = document.getElementById('end_date')?.value || '';
        const currencySelect = document.getElementById('currency_id');
        const currencyText = currencySelect?.options[currencySelect.selectedIndex]?.textContent || '';
        const currencyExchange = document.getElementById('currency_exchange')?.value || '';
        const currencyAmount = document.getElementById('currency_amount')?.value || '';
        const branchSelect = document.getElementById('agent_branch_id');
        const branchText = branchSelect?.options[branchSelect.selectedIndex]?.textContent || '';
        const channelSelect = document.getElementById('agent_channel_id');
        const channelText = channelSelect?.options[channelSelect.selectedIndex]?.textContent || '';
        const directorName = document.getElementById('director_name')?.value || '';
        const description = document.getElementById('description')?.value || '';
        const isActive = document.getElementById('is_active')?.checked ? 'Тийм' : 'Үгүй';
        const hasCoinsurance = document.getElementById('has_coinsurance')?.checked ? 'Тийм' : 'Үгүй';
        
        // Build Step 1 HTML
        let step1HTML = `
            <div class="bg-white border border-gray-200 rounded-lg p-6">
                <h3 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">1. Ерөнхий мэдээлэл</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full border border-gray-300">
                        <tbody class="bg-white">
                            <tr>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50 w-1/3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Гэрээний дугаар</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${escapeHtml(policyNo) || '-'}</div>
                                </td>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50 w-1/3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Харилцагч</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${escapeHtml(clientDisplay) || '-'}</div>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Гэрээний менежер</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${escapeHtml(agentText) || '-'}</div>
                                </td>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Гэрээний загварын дугаар</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${escapeHtml(templateDisplay) || '-'}</div>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Эхлэх огноо</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${beginDate || '-'}</div>
                                </td>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Дуусах огноо</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${endDate || '-'}</div>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Валютын дугаар</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${escapeHtml(currencyText) || '-'}</div>
                                </td>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Валютын ханш</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${currencyExchange || '-'}</div>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Салбарын дугаар</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${escapeHtml(branchText) || '-'}</div>
                                </td>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Сувгийн дугаар</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${escapeHtml(channelText) || '-'}</div>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Захиралын нэр</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${escapeHtml(directorName) || '-'}</div>
                                </td>
                                <td class="px-4 py-3 border-b border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Тайлбар</label>
                                </td>
                                <td class="px-4 py-3 border-b border-gray-300">
                                    <div class="text-sm text-gray-900">${escapeHtml(description) || '-'}</div>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Идэвхтэй эсэх</label>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="text-sm text-gray-900">${isActive}</div>
                                </td>
                                <td class="px-4 py-3 border-r border-gray-300 bg-gray-50">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Хамтран даатгуулагчтай</label>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="text-sm text-gray-900">${hasCoinsurance}</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        // Build Step 2 HTML (Products, Items, Risks, Questions)
        let step2HTML = `
            <div class="bg-white border border-gray-200 rounded-lg p-6">
                <h3 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">2. Даатгалын мэдээлэл</h3>
        `;
        
        if (policyProductsData.length === 0) {
            step2HTML += '<p class="text-sm text-gray-500">Бүтээгдэхүүн олдсонгүй</p>';
        } else {
            step2HTML += `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Бүтээгдэхүүн</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Зүйл</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Эхлэх огноо</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Дуусах огноо</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Үнэлгээ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Хураамж(%)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Хураамж</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Эрсдэл</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Асуулт</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            policyProductsData.forEach((product, productIndex) => {
                product.items.forEach((item, itemIndex) => {
                    const itemKey = `${productIndex}-${itemIndex}`;
                    // Get current values from inputs if available
                    const beginDateInput = document.querySelector(`.item-begin-date[data-item-key="${itemKey}"]`);
                    const endDateInput = document.querySelector(`.item-end-date[data-item-key="${itemKey}"]`);
                    const valuationInput = document.querySelector(`.item-valuation[data-item-key="${itemKey}"]`);
                    const commPercentInput = document.querySelector(`.item-commission[data-item-key="${itemKey}"]`);
                    const commAmountInput = document.querySelector(`.item-comm-amount[data-item-key="${itemKey}"]`);
                    
                    const beginDate = beginDateInput?.value || item.beginDate || '';
                    const endDate = endDateInput?.value || item.endDate || '';
                    const valuation = valuationInput?.value || item.valuation || '';
                    const commPercent = commPercentInput?.value || item.commPercent || '';
                    const commAmount = commAmountInput?.value || item.commAmount || '';
                    const risksCount = item.risks ? item.risks.length : 0;
                    const questionsCount = item.questions ? item.questions.length : 0;
                    
                    // Find product name from template data
                    const templateProduct = templateProductsData.find(p => p.productId === product.productId);
                    const productName = templateProduct ? templateProduct.productName : 'Бүтээгдэхүүн';
                    const productCode = templateProduct ? templateProduct.productCode : '';
                    
                    step2HTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm">
                                <div class="text-gray-900">${escapeHtml(productName)}</div>
                                <div class="text-xs text-gray-500">${escapeHtml(productCode)}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm">
                                <div class="text-gray-900">${escapeHtml(item.itemName)}</div>
                                <div class="text-xs text-gray-500">${escapeHtml(item.itemCode)}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${beginDate || '-'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${endDate || '-'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${valuation || '0.000000'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${commPercent || '0.000'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${commAmount || '0.000000'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-900">${risksCount}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-900">${questionsCount}</td>
                        </tr>
                    `;
                });
            });
            
            // Calculate total commAmount
            let totalCommAmount = 0;
            policyProductsData.forEach((product) => {
                product.items.forEach((item) => {
                    const commAmount = parseFloat(item.commAmount) || 0;
                    totalCommAmount += commAmount;
                });
            });
            
            step2HTML += `
                        </tbody>
                        <tfoot class="bg-gray-100">
                            <tr class="font-semibold">
                                <td class="px-4 py-3 text-sm text-gray-900" colspan="6">Нийт:</td>
                                <td class="px-4 py-3 text-sm text-gray-900 text-right">${totalCommAmount.toFixed(6)}</td>
                                <td class="px-4 py-3 text-sm text-gray-900" colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }
        
        step2HTML += '</div>';
        
        // Build Step 3 HTML (Payment Schedules)
        let step3HTML = `
            <div class="bg-white border border-gray-200 rounded-lg p-6">
                <h3 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">3. Төлбөрийн хуваарь</h3>
        `;
        
        if (paymentScheduleData.length === 0) {
            step3HTML += '<p class="text-sm text-gray-500">Төлбөрийн хуваарь олдсонгүй</p>';
        } else {
            // Get current schedule data from DOM or use stored data
            const scheduleRows = document.querySelectorAll('#payment-schedule-list .schedule-item');
            let schedules = [];
            
            if (scheduleRows.length > 0) {
                scheduleRows.forEach(row => {
                    const dateInput = row.querySelector('.schedule-date');
                    const amountInput = row.querySelector('.schedule-amount');
                    schedules.push({
                        date: dateInput?.value || '',
                        amount: amountInput?.value || ''
                    });
                });
            } else {
                schedules = paymentScheduleData;
            }
            
            step3HTML += `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Төлбөрийн огноо</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Дүн</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            schedules.forEach(schedule => {
                step3HTML += `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${schedule.date || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${schedule.amount || '0.000000'}</td>
                    </tr>
                `;
            });
            
            // Calculate total
            const totalAmount = schedules.reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);
            
            step3HTML += `
                        </tbody>
                        <tfoot class="bg-gray-100">
                            <tr class="font-semibold">
                                <td class="px-4 py-3 text-sm text-gray-900">Нийт:</td>
                                <td class="px-4 py-3 text-sm text-gray-900 text-right">${totalAmount.toFixed(6)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }
        
        step3HTML += '</div>';
        
        // Build Step 4 HTML (Files)
        let step4HTML = `
            <div class="bg-white border border-gray-200 rounded-lg p-6">
                <h3 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">4. Хавсралт</h3>
        `;
        
        // Get current files data from DOM or use stored data
        const fileItems = document.querySelectorAll('#files-list .file-item');
        let files = [];
        
        if (fileItems.length > 0) {
            fileItems.forEach(item => {
                const fileNameInput = item.querySelector('.file-name');
                const filePathInput = item.querySelector('.file-path');
                files.push({
                    fileName: fileNameInput?.value || '',
                    filePath: filePathInput?.value || ''
                });
            });
        } else {
            files = filesData;
        }
        
        if (files.length === 0) {
            step4HTML += '<p class="text-sm text-gray-500">Хавсралт олдсонгүй</p>';
        } else {
            step4HTML += `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Файлын нэр</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300">Файлын зам</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            files.forEach(file => {
                step4HTML += `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${escapeHtml(file.fileName) || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${escapeHtml(file.filePath) || '-'}</td>
                    </tr>
                `;
            });
            
            step4HTML += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        step4HTML += '</div>';
        
        // Combine all sections
        container.innerHTML = step1HTML + step2HTML + step3HTML + step4HTML;
    }
    
    // Initialize
    showStep(1);
    
    // Check for edit parameter before loading dropdowns
    const urlParams = new URLSearchParams(window.location.search);
    const editPolicyId = urlParams.get('edit');
    
    // Wait for all dropdowns to load before loading edit data
    Promise.all([
        loadBranchUsersForAgent(),
        loadCurrencies()
    ]).then(() => {
        // Load logged-in user's branch/channel and set default agent
        loadUserBranchChannel();
        
        // After dropdowns are loaded, load edit data if in edit mode
        if (editPolicyId) {
            loadPolicyDataForEdit(editPolicyId);
        }
    }).catch(error => {
        console.error('Error loading dropdowns:', error);
        // Still try to load edit data even if dropdowns fail
        if (editPolicyId) {
            loadPolicyDataForEdit(editPolicyId);
        }
    });
});

// Generate Word document - must be in global scope for onclick to work
function generatePolicyWord(policyId) {
    // Close success modal
    const modal = document.getElementById('policy-success-modal');
    if (modal) {
        modal.remove();
    }
    
    // Use simple approach: create a link and click it
    // This is more reliable and won't freeze the UI
    const downloadLink = document.createElement('a');
    downloadLink.href = `/core/policies/${policyId}/generate-word/`;
    downloadLink.target = '_blank'; // Open in new tab/window
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    
    // Trigger download
    downloadLink.click();
    
    // Clean up after a short delay
    setTimeout(() => {
        if (downloadLink && downloadLink.parentNode) {
            downloadLink.remove();
        }
    }, 1000);
    
    // Show success message
    const successMsg = document.createElement('div');
    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg z-50';
    successMsg.innerHTML = `
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <span>Гэрээ үүсгэж байна. Шинэ цонхонд нээгдэх эсвэл татагдана.</span>
        </div>
    `;
    document.body.appendChild(successMsg);
    
    setTimeout(() => {
        if (successMsg && successMsg.parentNode) {
            successMsg.remove();
        }
    }, 5000);
    
    // Reload page after a delay
    setTimeout(() => {
        window.location.reload();
    }, 2000);
}
</script>

<!-- Item Selection Modal -->
<div id="item-selection-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Зүйл сонгох</h3>
                <button type="button" onclick="closeItemSelectionModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Search -->
            <div class="mb-4">
                <input type="text" 
                       id="item-search-input" 
                       placeholder="Зүйлийн код эсвэл нэрээр хайх..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <!-- Items List -->
            <div id="items-list-container" class="max-h-96 overflow-y-auto border border-gray-200 rounded-md">
                <div class="text-center py-8 text-gray-500">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="mt-2 text-sm">Уншиж байна...</p>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="mt-4 flex justify-end space-x-3">
                <button type="button" 
                        onclick="closeItemSelectionModal()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    Цуцлах
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include Template Selection Modal -->
{% include 'insurance/component/ins_template_selection_modal.html' %}
{% include 'insurance/component/ins_client_selection_modal.html' %}
{% endblock %}

