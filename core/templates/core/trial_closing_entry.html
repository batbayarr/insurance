{% extends 'base.html' %}
{% load static %}
<!-- Trial Closing Entry - Closing Journal -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<parameter name="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% load humanize %}

{% block title %}Хаалтын Бичилт{% endblock %}

{% block content %}
<div class="">
    <!-- Period Filter Section -->
    <div class="bg-white shadow rounded-lg p-1 mb-2">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center space-x-2">
                <label for="period-select" class="text-sm font-medium text-gray-700">Хугацаа:</label>
                <select id="period-select" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[300px]">
                    <option value="">-- Хугацаа сонгох --</option>
                </select>
            </div>
            <button id="show-button" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ХАРУУЛАХ
            </button>
            <button id="filter-button" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ХААЛТ ХИЙХ
            </button>
            <button id="restore-button" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ХААЛТ НЭЭХ
            </button>
        </div>
    </div>

    <!-- ХААЛТЫН БИЧИЛТ (Closing Journal) -->
    <div id="closing-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: block;">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Огноо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дансны нэр</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валютын дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ханш</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дебит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Кредит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                    </tr>
                </thead>
                <tbody id="closing-tbody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Огноогоо сонгоно уу</h3>
                                <p class="text-sm text-gray-500">Эхлэх ба дуусах огноо сонгоод товч дарна уу.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for Closing Tab -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page-clo" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page-clo" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info-clo" class="text-sm text-gray-700">
                        Нийт <span id="total-count-clo">0</span> бичлэгээс <span id="showing-start-clo">0</span> - <span id="showing-end-clo">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page-desktop-clo" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span id="page-info-clo" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            <!-- Dynamic page buttons will be generated here -->
                        </span>
                        <button id="next-page-desktop-clo" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let closingData = [];
    let currentTab = 'closing';
    let currentPage = 1;
    let pageSize = 20;
    let totalPages = 1;
    let apiCache = new Map();
    let periodsData = []; // Store periods list for quick lookup
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initializeAll();
    });
    
    function initializeAll() {
        fetchPeriodsList().then(() => {
        initializePagination();
        initializePageSizeSelector();
        });
    }
    
    // Fetch periods list from API
    function fetchPeriodsList() {
        return fetch('/core/api/periods-list/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    periodsData = data.periods || [];
                    populatePeriodDropdown();
                } else {
                    console.error('Failed to load periods:', data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching periods:', error);
            });
    }
    
    // Populate period dropdown
    function populatePeriodDropdown() {
        const periodSelect = document.getElementById('period-select');
        if (!periodSelect) return;
        
        // Clear existing options except the first one
        periodSelect.innerHTML = '<option value="">-- Хугацаа сонгох --</option>';
        
        periodsData.forEach(period => {
            const option = document.createElement('option');
            option.value = period.period_id;
            option.textContent = `${period.period_name} (${period.begin_date} - ${period.end_date})${period.is_locked ? ' [Түгжигдсэн]' : ''}`;
            option.dataset.beginDate = period.begin_date;
            option.dataset.endDate = period.end_date;
            periodSelect.appendChild(option);
        });
    }
    
    // Get selected period dates
    function getSelectedPeriodDates() {
        const periodSelect = document.getElementById('period-select');
        if (!periodSelect || !periodSelect.value) {
            return null;
        }
        
        const selectedOption = periodSelect.options[periodSelect.selectedIndex];
        return {
            startDate: selectedOption.dataset.beginDate,
            endDate: selectedOption.dataset.endDate,
            periodId: periodSelect.value
        };
    }
    
    
    function initializePagination() {
        // Closing pagination
        const prevPageClo = document.getElementById('prev-page-clo');
        const nextPageClo = document.getElementById('next-page-clo');
        const prevPageDesktopClo = document.getElementById('prev-page-desktop-clo');
        const nextPageDesktopClo = document.getElementById('next-page-desktop-clo');
        
        if (prevPageClo) prevPageClo.addEventListener('click', () => changePage(currentPage - 1));
        if (nextPageClo) nextPageClo.addEventListener('click', () => changePage(currentPage + 1));
        if (prevPageDesktopClo) prevPageDesktopClo.addEventListener('click', () => changePage(currentPage - 1));
        if (nextPageDesktopClo) nextPageDesktopClo.addEventListener('click', () => changePage(currentPage + 1));
    }
    
    function initializePageSizeSelector() {
        const pageSizeSelect = document.getElementById('page-size-select');
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1;
                renderCurrentTab();
            });
        }
    }
    
    // Function to show records without calculating
    async function showRecords() {
        const periodDates = getSelectedPeriodDates();
        
        if (!periodDates) {
            alert('Хугацаа сонгоно уу');
            return;
        }
        
        const startDate = periodDates.startDate;
        const endDate = periodDates.endDate;
        
        const showButton = document.getElementById('show-button');
        if (showButton) {
            showButton.textContent = 'Ачаалж байна...';
            showButton.disabled = true;
        }
        
        try {
            await fetchClosingJournalData(startDate, endDate);
        } finally {
            if (showButton) {
                showButton.textContent = 'ХАРУУЛАХ';
                showButton.disabled = false;
            }
        }
    }
    
    // Function to check period lock
    async function checkPeriodLock(date) {
        try {
            const response = await fetch(`/core/api/check-period-lock/?date=${date}`);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error checking period lock:', error);
            return { is_locked: false };
        }
    }
    
    // Function to get CSRF token
    function getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (token) return token;
        
        // Fallback: get from cookies
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue || '';
    }
    
    // Function to set period lock status
    async function setPeriodLockStatus(periodId, shouldBeLocked) {
        try {
            // First check current lock status
            const period = periodsData.find(p => p.period_id === periodId);
            if (!period) {
                console.error('Period not found:', periodId);
                return { success: false };
            }
            
            // Only toggle if current status doesn't match desired status
            if (period.is_locked !== shouldBeLocked) {
                const csrfToken = getCsrfToken();
                const periodIdInt = parseInt(periodId, 10);
                const response = await fetch(`/core/period-lock/${periodIdInt}/toggle/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    // Update local period data
                    period.is_locked = data.isLock;
                    // Refresh period dropdown to reflect new status
                    populatePeriodDropdown();
                    return { success: true, isLock: data.isLock };
                } else {
                    console.error('Failed to set period lock:', data.message);
                    return { success: false, error: data.message };
                }
            } else {
                // Already in desired state
                return { success: true, isLock: period.is_locked };
            }
        } catch (error) {
            console.error('Error setting period lock:', error);
            return { success: false, error: error.message };
        }
    }
    
    // Function to show message modal
    function showMessageModal(message, type = 'error', title = 'Анхааруулга') {
        const modal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('message-modal-title');
        const modalText = document.getElementById('message-modal-text');
        const iconContainer = document.getElementById('message-modal-icon-container');
        const errorIcon = document.getElementById('message-modal-icon-error');
        const successIcon = document.getElementById('message-modal-icon-success');
        const warningIcon = document.getElementById('message-modal-icon-warning');
        const infoIcon = document.getElementById('message-modal-icon-info');
        
        if (!modal || !modalTitle || !modalText) {
            alert(message);
            return;
        }
        
        modalText.textContent = message;
        modalTitle.textContent = title;
        
        // Reset all icons
        if (errorIcon) errorIcon.classList.add('hidden');
        if (successIcon) successIcon.classList.add('hidden');
        if (warningIcon) warningIcon.classList.add('hidden');
        if (infoIcon) infoIcon.classList.add('hidden');
        
        // Show appropriate icon
        if (type === 'error' && errorIcon) {
            errorIcon.classList.remove('hidden');
            if (iconContainer) iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100';
        } else if (type === 'success' && successIcon) {
            successIcon.classList.remove('hidden');
            if (iconContainer) iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100';
        } else if (type === 'warning' && warningIcon) {
            warningIcon.classList.remove('hidden');
            if (iconContainer) iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100';
        } else if (type === 'info' && infoIcon) {
            infoIcon.classList.remove('hidden');
            if (iconContainer) iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100';
        }
        
        modal.classList.remove('hidden');
    }
    
    async function applyDateFilter() {
        // Get dates from selected period
        const periodDates = getSelectedPeriodDates();
        
        if (!periodDates) {
            alert('Хугацаа сонгоно уу');
            return;
        }
        
        const startDate = periodDates.startDate;
        const endDate = periodDates.endDate;
        
        // Check period lock before proceeding
        const lockCheck = await checkPeriodLock(endDate);
        if (lockCheck.is_locked) {
            showMessageModal(lockCheck.message || 'Тухайн сар түгжигдсэн байна. Админы зөвшөөрлөөр эрх нээгдэнэ.', 'error', 'Тухайн сар цоожлогдсон байна.');
            return;
        }
        
        apiCache.clear();
        
        const filterButton = document.getElementById('filter-button');
        if (filterButton) {
            filterButton.textContent = 'Тооцоолж байна...';
            filterButton.disabled = true;
        }
        
        let adjustedStartDate = startDate;
        let adjustedEndDate = endDate;
        
        try {
            // Call closing record calculation function
            const closingResult = await callCalculateClosingRecord(startDate, endDate);
            
            // Update dates if they were adjusted
            if (closingResult && closingResult.adjusted_dates) {
                adjustedStartDate = closingResult.adjusted_dates.start_date;
                adjustedEndDate = closingResult.adjusted_dates.end_date;
            }
            
            // Show warnings if there were errors (but don't block)
            if (!closingResult || !closingResult.success) {
                console.warn('Closing record calculation warning:', closingResult?.error || 'Unknown error');
            }
        } catch (error) {
            console.error('Error during calculations:', error);
            // Continue with data fetching even if calculations fail
        }
        
        // Update button text for data fetching
        if (filterButton) {
            filterButton.textContent = 'Ачаалж байна...';
        }
        
        // Fetch closing data using adjusted dates
        try {
            await fetchClosingJournalData(adjustedStartDate, adjustedEndDate);
            
            // After successful closing, set period lock to true
            if (periodDates.periodId) {
                const lockResult = await setPeriodLockStatus(periodDates.periodId, true);
                if (lockResult.success) {
                    console.log('Period locked successfully after closing');
                } else {
                    console.warn('Failed to lock period after closing:', lockResult.error);
                }
            }
        } finally {
            if (filterButton) {
                filterButton.textContent = 'ХААЛТ ХИЙХ';
                filterButton.disabled = false;
            }
        }
    }
    
    async function callCalculateClosingRecord(startDate, endDate) {
        try {
            const url = `/core/api/calculate-closing-record/?start_date=${startDate}&end_date=${endDate}`;
            const response = await fetch(url);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error calling calculate closing record:', error);
            return {
                success: false,
                error: error.message || 'Network error occurred'
            };
        }
    }
    
    function fetchClosingJournalData(startDate, endDate) {
        const cacheKey = `closing_${startDate}_${endDate}`;
        if (apiCache.has(cacheKey)) {
            closingData = apiCache.get(cacheKey);
            renderJournalTable(closingData);
            return Promise.resolve();
        }
        
        const url = `/core/api/cash-documents-filtered/?start_date=${startDate}&end_date=${endDate}&document_type_id=14`;
        return fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closingData = data.details || [];
                    apiCache.set(cacheKey, closingData);
                    renderJournalTable(closingData);
                } else {
                    showError('closing-tbody', data.error || 'Failed to load closing journal data');
                }
            })
            .catch(error => {
                console.error('Error fetching closing journal:', error);
                showError('closing-tbody', 'Network error occurred');
            });
    }
    
    function renderJournalTable(data) {
        const tbody = document.getElementById('closing-tbody');
        
        if (!tbody) {
            return;
        }
        
        if (!data || data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                        <h3 class="text-sm font-medium text-gray-900 mb-1">Мэдээлэл олдсонгүй</h3>
                        <p class="text-sm text-gray-500">Сонгосон хугацаанд мэдээлэл байхгүй байна.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Calculate pagination
        totalPages = Math.ceil(data.length / pageSize);
        if (currentPage > totalPages) currentPage = 1;
        
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const paginatedData = data.slice(startIndex, endIndex);
        
        // Update pagination info
        updatePaginationInfo(data.length, paginatedData.length, startIndex);
        
        // Render journal entry data for closing tab
        let htmlContent = '';
            let totalDebit = 0;
            let totalCredit = 0;
            
            paginatedData.forEach((item) => {
                totalDebit += parseFloat(item.debit_amount) || 0;
                totalCredit += parseFloat(item.credit_amount) || 0;
                
                htmlContent += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_no || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_date || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_code || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_name || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.client_name || ''}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.description || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.currency_name || ''}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.currency_amount, 2)}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.currency_exchange, 4)}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.debit_amount, 2)}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(item.credit_amount, 2)}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.user_name || ''}</td>
                    </tr>
                `;
            });
            
        // Add totals row
            htmlContent += `
                <tr class="bg-gray-100 font-semibold">
                    <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200" colspan="9">НИЙТ:</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(totalDebit, 2)}</td>
                    <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(totalCredit, 2)}</td>
                    <td class="px-1 py-1 text-xs text-gray-900"></td>
                </tr>
            `;
        
        tbody.innerHTML = htmlContent;
    }
    
    function updatePaginationInfo(totalRecords, currentRecords, startIndex) {
        const showingStart = document.getElementById('showing-start-clo');
        const showingEnd = document.getElementById('showing-end-clo');
        const totalCount = document.getElementById('total-count-clo');
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        
        generatePaginationButtons();
    }
    
    function generatePaginationButtons() {
        const pageInfo = document.getElementById('page-info-clo');
        if (!pageInfo) return;
        
        pageInfo.innerHTML = '';
        
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPage
                    ? 'bg-blue-400 text-white hover:bg-blue-500'
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePage(i));
            pageInfo.appendChild(button);
        }
    }
    
    function changePage(newPage) {
        if (newPage < 1 || newPage > totalPages) return;
        
        currentPage = newPage;
        renderCurrentTab();
    }
    
    function renderCurrentTab() {
        renderJournalTable(closingData);
    }
    
    function showError(tbodyId, message) {
        const tbody = document.getElementById(tbodyId);
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="12" class="px-4 py-8 text-center text-red-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="text-sm font-medium text-red-900 mb-1">Алдаа гарлаа</h3>
                            <p class="text-sm text-red-500">${message}</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || isNaN(value)) return '0.00';
        return parseFloat(value).toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }
    
    // Delete closing entries for selected period
    async function deleteClosingEntries(startDate, endDate) {
        const url = `/core/api/delete-closing-entries/?start_date=${startDate}&end_date=${endDate}`;
        return fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    return {
                        success: true,
                        message: data.message || 'Closing entries deleted successfully',
                        deletedCount: data.deleted_count || 0
                    };
                } else {
                    return {
                        success: false,
                        error: data.error || 'Failed to delete closing entries'
                    };
                }
            })
            .catch(error => {
                console.error('Error deleting closing entries:', error);
                return {
                    success: false,
                    error: 'Network error occurred while deleting closing entries'
                };
            });
    }
    
    async function restoreView() {
        // Get dates from selected period
        const periodDates = getSelectedPeriodDates();
        
        if (!periodDates) {
            alert('Хугацаа сонгоно уу');
            return;
        }
        
        const startDate = periodDates.startDate;
        const endDate = periodDates.endDate;
        
        // Check period lock before proceeding
        const lockCheck = await checkPeriodLock(endDate);
        if (lockCheck.is_locked) {
            showMessageModal(lockCheck.message || 'Тухайн сар түгжигдсэн байна. Админы зөвшөөрлөөр эрх нээгдэнэ.', 'error', 'Тухайн сар цоожлогдсон байна.');
            return;
        }
        
        // Get period name for confirmation message
        const periodSelect = document.getElementById('period-select');
        const selectedOption = periodSelect.options[periodSelect.selectedIndex];
        const periodName = selectedOption ? selectedOption.textContent.split(' (')[0] : 'selected period';
        
        // Show confirmation dialog
        const confirmed = confirm(`Та "${periodName}" хугацааны хаалтын бичлэгүүдийг устгахдаа итгэлтэй байна уу?`);
        if (!confirmed) {
            return;
        }
        
        // Clear cache to force fresh data fetch
        apiCache.clear();
        
        // Reset to first page
        currentTab = 'closing';
        currentPage = 1;
        
        // Show loading state
        const restoreButton = document.getElementById('restore-button');
        if (restoreButton) {
            restoreButton.textContent = 'Устгаж байна...';
            restoreButton.disabled = true;
        }
        
        try {
            // Delete closing entries first
            const deleteResult = await deleteClosingEntries(startDate, endDate);
            
            if (deleteResult.success) {
                // Show success message
                if (deleteResult.deletedCount > 0) {
                    alert(`Амжилттай: ${deleteResult.message}`);
                } else {
                    alert('Хаалтын бичлэг олдсонгүй');
                }
                
                // After successful deletion, set period lock to false
                if (periodDates.periodId) {
                    const lockResult = await setPeriodLockStatus(periodDates.periodId, false);
                    if (lockResult.success) {
                        console.log('Period unlocked successfully after deletion');
                    } else {
                        console.warn('Failed to unlock period after deletion:', lockResult.error);
                    }
                }
                
                // Update button text for fetching
                if (restoreButton) {
                    restoreButton.textContent = 'Ачаалж байна...';
                }
                
                // Fetch closing data after deletion
                await fetchClosingJournalData(startDate, endDate);
            } else {
                alert(`Алдаа: ${deleteResult.error}`);
            }
        } finally {
            if (restoreButton) {
                restoreButton.textContent = 'ХААЛТ НЭЭХ';
                restoreButton.disabled = false;
            }
        }
    }
    
    // Event listeners
    document.getElementById('show-button').addEventListener('click', showRecords);
    document.getElementById('filter-button').addEventListener('click', applyDateFilter);
    document.getElementById('restore-button').addEventListener('click', restoreView);
</script>

<!-- Include Message Modal Component -->
{% include 'core/components/message_modal.html' %}

{% endblock %}

