<!-- Inventory Selection Modal Component with Balance Support -->
<div id="inventory-selection-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-4 border w-11/12 max-w-6xl min-w-[1200px] shadow-xl rounded-lg bg-white">
        <!-- Modal Header -->
        <div class="flex justify-between items-center px-4 py-2 bg-white border-b border-gray-200">
            <div>
                <h3 class="text-lg font-medium text-gray-900">Бараа материал сонгох</h3>                
            </div>
            <button onclick="closeInventoryPopup()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Actions Row -->
        <div class="mb-2 flex items-center justify-end space-x-2">
                    <button onclick="showAddInventoryForm()" 
                    class="inline-flex items-center px-2 py-1 text-xs font-bold text-white bg-green-600 hover:bg-green-700 hover:text-white rounded shadow-sm transition-all duration-200 border border-green-600 hover:border-green-700"
                            title="Шинэ бараа материал нэмэх">
                        <svg class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        НЭМЭХ
                    </button>
                    <button onclick="clearAllInventoryFilters()" 
                    class="px-2 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors">
                 Цэвэрлэх
                    </button>
        </div>

        <!-- Add/Edit Inventory Form (Hidden by default) -->
        <div id="inventory-form-container" class="mb-2 hidden">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex justify-between items-center mb-2">
                    <h4 id="inventory-form-title" class="text-sm font-medium text-gray-900">Шинэ бараа материал нэмэх</h4>
                    <button onclick="hideInventoryForm()" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <form id="inventory-form" onsubmit="submitInventoryForm(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div>
                            <label for="inventory-code" class="block text-xs font-medium text-gray-700 mb-1">Барааны код</label>
                            <input type="text" id="inventory-code" name="InventoryCode" maxlength="5"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="inventory-name" class="block text-xs font-medium text-gray-700 mb-1">Барааны нэр *</label>
                            <input type="text" id="inventory-name" name="InventoryName" required
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="inventory-type" class="block text-xs font-medium text-gray-700 mb-1">Барааны төрөл *</label>
                            <select id="inventory-type" name="InventoryTypeId" required
                                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Төрөл сонгох</option>
                                <!-- Options will be populated dynamically from database -->
                            </select>
                        </div>
                        <div>
                            <label for="inventory-measurement" class="block text-xs font-medium text-gray-700 mb-1">Хэмжих нэгж *</label>
                            <select id="inventory-measurement" name="MeasurementId" required
                                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Нэгж сонгох</option>
                                <!-- Options will be populated dynamically from database -->
                            </select>
                        </div>
                        <div>
                            <label for="inventory-unit-cost" class="block text-xs font-medium text-gray-700 mb-1">Нэгжийн өртөг *</label>
                            <input type="number" id="inventory-unit-cost" name="UnitCost" step="0.000001" required
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="inventory-unit-price" class="block text-xs font-medium text-gray-700 mb-1">Нэгжийн үнэ *</label>
                            <input type="number" id="inventory-unit-price" name="UnitPrice" step="0.000001" required
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="inventory-active" name="IsActive" checked
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-xs text-gray-700">Идэвхтэй</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-2 mt-2 pt-2 border-t border-blue-200">
                        <button type="button" onclick="hideInventoryForm()" 
                                class="px-2 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            Цуцлах
                        </button>
                        <button type="submit" id="inventory-submit-btn"
                                class="px-2 py-1 text-xs font-medium text-white bg-green-600 border border-transparent rounded hover:bg-green-700 focus:outline-none focus:ring-1 focus:ring-green-500">
                            <span id="inventory-submit-text">Бараа материал нэмэх</span>
                            <span id="inventory-submit-loading" class="hidden">
                                <svg class="animate-spin -ml-1 mr-2 h-3 w-3 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Хадгалж байна...
                            </span>
                        </button>
                    </div>
                    
                    <input type="hidden" id="inventory-id" name="InventoryId" value="">
                </form>
            </div>
        </div>

        <!-- Inventory List Container -->
        <div id="inventory-list-container" class="max-h-96 overflow-y-auto overflow-x-auto border border-gray-200 rounded-lg min-w-[1100px]">
            <!-- Inventory list will be loaded here -->
        </div>

        <!-- Pagination Container -->
        <div id="inventory-pagination-container" class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 hidden">
            <div class="flex items-center space-x-2">
                <span id="inventory-pagination-info" class="text-xs text-gray-700"></span>
            </div>
            <div class="flex items-center space-x-2">
                <button id="inventory-pagination-prev" onclick="changeInventoryPage(currentInventoryPage - 1)" 
                        class="px-2 py-1 text-xs border border-gray-300 rounded bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Өмнөх
                </button>
                <div id="inventory-pagination-buttons" class="flex items-center space-x-1">
                    <!-- Page number buttons will be generated here -->
                </div>
                <button id="inventory-pagination-next" onclick="changeInventoryPage(currentInventoryPage + 1)" 
                        class="px-2 py-1 text-xs border border-gray-300 rounded bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Дараах
                </button>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 mt-4">
            <button onclick="closeInventoryPopup()" 
                    class="px-4 py-2 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors">
                Цуцлах
            </button>
        </div>
    </div>
</div>

<script>
// Global variables for document context
window.inventoryModalContext = {
    documentDate: null,
    warehouseId: null,
    accountId: null,
    documentTypeId: null
};

// Pagination variables
let currentInventoryPage = 1;
let inventoryPageSize = 15;
let totalInventoryPages = 1;
let allInventoryData = []; // Store all inventory items for filtering and pagination

// Inventory Selection Modal Functions
window.openInventoryPopup = function(inputElement = null, rowId = null, context = null) {
    // Store the current input element and row ID for later use
    window.currentInventoryInput = inputElement;
    window.currentInventoryRowId = rowId;
    
    // Store document context if provided
    if (context) {
        window.inventoryModalContext.documentDate = context.documentDate || null;
        window.inventoryModalContext.warehouseId = context.warehouseId || null;
        window.inventoryModalContext.accountId = context.accountId || null;
        window.inventoryModalContext.documentTypeId = context.documentTypeId || null;
    } else {
        // Clear context if not provided
        window.inventoryModalContext.documentDate = null;
        window.inventoryModalContext.warehouseId = null;
        window.inventoryModalContext.accountId = null;
        window.inventoryModalContext.documentTypeId = null;
    }
    
    // Reset pagination
    currentInventoryPage = 1;
    allInventoryData = [];
    
    // Open inventory selection modal
    const modal = document.getElementById('inventory-selection-modal');
    if (modal) {
        modal.classList.remove('hidden');
        // Load inventories
        loadInventoryList();
    }
}

window.closeInventoryPopup = function() {
    const modal = document.getElementById('inventory-selection-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

window.selectInventory = function(inventoryId, inventoryName, unitCost = '', unitPrice = '') {
    // Check if we're in bulk manage mode (has currentInventoryInput and currentInventoryRowId)
    if (window.currentInventoryInput && window.currentInventoryRowId) {
        // Bulk manage mode - populate the specific row
        const row = window.currentInventoryInput.closest('tr');
        if (row) {
            // Try multiple selectors to find the hidden input
            const hiddenInput = row.querySelector('.inventory-id-input') || 
                               row.querySelector('input[name*="inventory_id_"]') || 
                               row.querySelector('input[name*="new_inventory_id_"]');
            const displayInput = row.querySelector('.inventory-display-input');
            const unitCostInput = row.querySelector('.unit-cost-input');
            const unitPriceInput = row.querySelector('.unit-price-input');
            
            if (hiddenInput && displayInput) {
                hiddenInput.value = inventoryId;
                displayInput.value = inventoryName;
                // Set title attribute to show full inventory name on hover
                displayInput.setAttribute('title', inventoryName);
            }
            
            // Populate unit cost and unit price if inputs exist
            if (unitCostInput) {
                unitCostInput.value = unitCost;
            }
            if (unitPriceInput) {
                unitPriceInput.value = unitPrice;
            }
            
            // Trigger calculation if we're in bulk manage mode
            if (typeof calculateInventoryTotals === 'function') {
                calculateInventoryTotals(row);
            }
        }
    } else {
        // Regular form mode - populate main form fields
        const hiddenInput = document.getElementById('InventoryId');
        const displayInput = document.getElementById('InventoryIdDisplay');
        const unitCostInput = document.getElementById('UnitCost');
        const unitPriceInput = document.getElementById('UnitPrice');
        
        if (hiddenInput && displayInput) {
            hiddenInput.value = inventoryId;
            displayInput.value = inventoryName;
        }
        
        // Populate unit cost and unit price if inputs exist
        if (unitCostInput) {
            unitCostInput.value = unitCost;
        }
        if (unitPriceInput) {
            unitPriceInput.value = unitPrice;
        }
    }
    
    // Clear the stored references
    window.currentInventoryInput = null;
    window.currentInventoryRowId = null;
    
    closeInventoryPopup();
}

// Show add inventory form
function showAddInventoryForm() {
    const formContainer = document.getElementById('inventory-form-container');
    const formTitle = document.getElementById('inventory-form-title');
    const submitText = document.getElementById('inventory-submit-text');
    const inventoryIdInput = document.getElementById('inventory-id');
    
    // Reset form
    document.getElementById('inventory-form').reset();
    inventoryIdInput.value = '';
    document.getElementById('inventory-active').checked = true; // Set default to active
    
    // Update form title and button text
    formTitle.textContent = 'Шинэ бараа материал нэмэх';
    submitText.textContent = 'Бараа материал нэмэх';
    
    // Load inventory types and measurements from database
    populateInventoryTypes();
    populateMeasurements();
    
    // Show form
    formContainer.classList.remove('hidden');
}

// Show edit inventory form
function updateInventory(inventoryId, inventoryName) {
    const formContainer = document.getElementById('inventory-form-container');
    const formTitle = document.getElementById('inventory-form-title');
    const submitText = document.getElementById('inventory-submit-text');
    const inventoryIdInput = document.getElementById('inventory-id');
    
    // Find inventory item in allInventoryData
    const inventoryItem = allInventoryData.find(item => 
        (item.inventoryid || item.id) == inventoryId
    );
    
    // Populate form with existing data
    inventoryIdInput.value = inventoryId;
    document.getElementById('inventory-name').value = inventoryName;
    
    // Update form title and button text
    formTitle.textContent = 'Бараа материал засах';
    submitText.textContent = 'Бараа материал шинэчлэх';
    
    // Load inventory types and measurements from database, then set selected values
    Promise.all([
        populateInventoryTypesPromise(),
        populateMeasurementsPromise()
    ]).then(() => {
        // Populate form fields from inventory item data
        if (inventoryItem) {
            if (inventoryItem.inventorycode || inventoryItem.code) {
                document.getElementById('inventory-code').value = inventoryItem.inventorycode || inventoryItem.code || '';
            }
            // Set InventoryTypeId if available
            if (inventoryItem.inventorytypeid !== undefined && inventoryItem.inventorytypeid !== null) {
                document.getElementById('inventory-type').value = inventoryItem.inventorytypeid;
            }
            // Set MeasurementId if available
            if (inventoryItem.measurementid !== undefined && inventoryItem.measurementid !== null) {
                document.getElementById('inventory-measurement').value = inventoryItem.measurementid;
            }
            if (inventoryItem.unitcost !== undefined && inventoryItem.unitcost !== null) {
                document.getElementById('inventory-unit-cost').value = inventoryItem.unitcost || '';
            } else if (inventoryItem.unitCost) {
                document.getElementById('inventory-unit-cost').value = inventoryItem.unitCost || '';
            }
            if (inventoryItem.unitprice !== undefined && inventoryItem.unitprice !== null) {
                document.getElementById('inventory-unit-price').value = inventoryItem.unitprice || '';
            } else if (inventoryItem.unitPrice) {
                document.getElementById('inventory-unit-price').value = inventoryItem.unitPrice || '';
            }
            if (inventoryItem.isActive !== undefined) {
                document.getElementById('inventory-active').checked = inventoryItem.isActive || false;
            }
        } else {
            // If not found in allInventoryData, fetch from API
            fetch(`/core/api/inventory-list/`, {
                credentials: 'include',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.inventory_data) {
                    const fullItem = data.inventory_data.find(item => item.id == inventoryId);
                    if (fullItem) {
                        if (fullItem.inventorycode || fullItem.code) {
                            document.getElementById('inventory-code').value = fullItem.inventorycode || fullItem.code || '';
                        }
                        if (fullItem.inventorytypeid !== undefined && fullItem.inventorytypeid !== null) {
                            document.getElementById('inventory-type').value = fullItem.inventorytypeid;
                        }
                        if (fullItem.measurementid !== undefined && fullItem.measurementid !== null) {
                            document.getElementById('inventory-measurement').value = fullItem.measurementid;
                        }
                        if (fullItem.unitcost !== undefined && fullItem.unitcost !== null) {
                            document.getElementById('inventory-unit-cost').value = fullItem.unitcost || '';
                        } else if (fullItem.unitCost) {
                            document.getElementById('inventory-unit-cost').value = fullItem.unitCost || '';
                        }
                        if (fullItem.unitprice !== undefined && fullItem.unitprice !== null) {
                            document.getElementById('inventory-unit-price').value = fullItem.unitprice || '';
                        } else if (fullItem.unitPrice) {
                            document.getElementById('inventory-unit-price').value = fullItem.unitPrice || '';
                        }
                        if (fullItem.isActive !== undefined) {
                            document.getElementById('inventory-active').checked = fullItem.isActive || false;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error loading inventory details:', error);
            });
        }
    });
    
    // Show form
    formContainer.classList.remove('hidden');
}

// Hide inventory form
function hideInventoryForm() {
    const formContainer = document.getElementById('inventory-form-container');
    formContainer.classList.add('hidden');
}

// Helper function to get CSRF token
function getCSRFToken() {
    // Try to get from form input first
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        return csrfInput.value;
    }
    
    // Fallback: try to get from cookie
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue || '';
}

// Submit inventory form
function submitInventoryForm(event) {
    event.preventDefault();
    
    const form = document.getElementById('inventory-form');
    const formData = new FormData(form);
    const inventoryId = document.getElementById('inventory-id').value;
    const isEdit = inventoryId !== '';
    
    // Show loading state
    const submitBtn = document.getElementById('inventory-submit-btn');
    const submitText = document.getElementById('inventory-submit-text');
    const submitLoading = document.getElementById('inventory-submit-loading');
    
    // Use shared component if available, otherwise fall back to manual implementation
        if (typeof Silicon4Form !== 'undefined' && Silicon4Form.showLoading) {
        Silicon4Form.showLoading(submitBtn, 'Хадгалж байна...');
    } else {
        // Original implementation (fallback)
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
        submitBtn.disabled = true;
    }
    
    // Determine URL and get CSRF token
    const url = isEdit ? `/core/refinventory/${inventoryId}/update/` : '/core/refinventory/create/';
    const csrfToken = getCSRFToken();
    
    // Use fetch to submit and handle response
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        return response.json().then(data => {
            if (response.ok && data.success) {
            // Success - hide form and refresh inventory list
            hideInventoryForm();
                
                // When adding a new item, display all inventory from ref_inventory
                // When updating, keep current view (balance or regular list)
                if (!isEdit) {
                    // New item created - show all inventory items
                    loadRegularInventoryList();
                } else {
                    // Item updated - refresh current view
            loadInventoryList();
                }
            
            // Show success message
                showInventoryMessage(data.message || (isEdit ? 'Inventory item updated successfully!' : 'Inventory item created successfully!'), 'success');
        } else {
                // Handle validation errors
                let errorMessage = data.message || 'Failed to save inventory item';
                if (data.errors) {
                    const errorList = Object.keys(data.errors).map(key => {
                        return `${key}: ${Array.isArray(data.errors[key]) ? data.errors[key].join(', ') : data.errors[key]}`;
                    }).join('\n');
                    errorMessage = errorMessage + '\n' + errorList;
                }
                showInventoryMessage(errorMessage, 'error');
            }
        });
    })
    .catch(error => {
        console.error('Error saving inventory item:', error);
        showInventoryMessage('Error saving inventory item. Please try again.', 'error');
    })
    .finally(() => {
        // Reset loading state
        // Use shared component if available, otherwise fall back to manual implementation
        if (typeof Silicon4Form !== 'undefined' && Silicon4Form.hideLoading) {
            const originalHtml = isEdit ? 'Бараа материал шинэчлэх' : 'Бараа материал нэмэх';
            Silicon4Form.hideLoading(submitBtn, originalHtml);
        } else {
            // Original implementation (fallback)
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
            submitBtn.disabled = false;
        }
    });
}

// Show message to user
function showInventoryMessage(message, type) {
    // Use shared component if available, otherwise fall back to original implementation
    if (typeof Silicon4Message !== 'undefined' && Silicon4Message.show) {
        Silicon4Message.show(message, type);
    } else {
        // Original implementation (fallback)
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded-md shadow-lg z-50 ${
            type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'
        }`;
        messageDiv.textContent = message;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }
}

// Override soft-delete reload behavior for inventory modal context
document.addEventListener('DOMContentLoaded', function() {
    const originalHandleDeleteSubmit = window.Silicon4SoftDelete?.handleDeleteSubmit;
    if (originalHandleDeleteSubmit && typeof originalHandleDeleteSubmit === 'function') {
        window.Silicon4SoftDelete.handleDeleteSubmit = async function(form) {
            const itemId = form.dataset.itemId;
            const itemName = form.dataset.itemName;
            const deleteUrl = form.action;
            
            const inventoryModal = document.getElementById('inventory-selection-modal');
            const isInventoryDelete = deleteUrl && deleteUrl.includes('/refinventory/') && deleteUrl.includes('/delete/');
            const isInventoryModalContext = inventoryModal && 
                                          !inventoryModal.classList.contains('hidden') &&
                                          isInventoryDelete;
            
            try {
                this.showLoading(true);
                
                const response = await fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        item_name: itemName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.showSuccessMessage(`"${itemName}" has been deleted successfully.`);
                    this.removeItemFromList(itemId);
                    this.closeModal();
                    
                    if (isInventoryModalContext) {
                        setTimeout(() => {
                            if (typeof loadInventoryList === 'function') {
                                loadInventoryList();
                            }
                        }, 500);
                    } else {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } else {
                    this.showErrorMessage(result.message || 'Error deleting item');
                }
            } catch (error) {
                console.error('Delete error:', error);
                this.showErrorMessage('Network error occurred while deleting item');
            } finally {
                this.showLoading(false);
            }
        };
    }
});

function loadInventoryList() {
    const inventoryListContainer = document.getElementById('inventory-list-container');
    if (!inventoryListContainer) return;
    
    // Show loading
    inventoryListContainer.innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Loading inventory items...</p></div>';
    
    // Check if all context parameters are available
    const context = window.inventoryModalContext;
    const hasAllContext = context.documentDate && context.warehouseId && context.accountId;
    
    if (hasAllContext) {
        // Calculate dates: beginDate = documentDate - 1 day, endDate = documentDate
        const documentDate = new Date(context.documentDate);
        const beginDate = new Date(documentDate);
        beginDate.setDate(beginDate.getDate() - 1);
        
        const startDateStr = beginDate.toISOString().split('T')[0];
        const endDateStr = documentDate.toISOString().split('T')[0];
        
        // Load all inventory items first, then merge balance data
        Promise.all([
            // Load all inventory items from JSON API (much faster than HTML parsing)
            fetch(`/core/api/inventory-list/`).then(r => r.json()),
            // Load balance data
            fetch(`/core/api/inventory-balance-warehouse/?start_date=${startDateStr}&end_date=${endDateStr}&warehouse_id=${context.warehouseId}&account_id=${context.accountId}`).then(r => r.json())
        ])
        .then(([inventoryResponse, balanceData]) => {
            if (!inventoryResponse.success) {
                throw new Error(inventoryResponse.error || 'Failed to load inventory');
            }
            
            // Convert JSON inventory data to our format
            const inventoryData = inventoryResponse.inventory_data.map(item => ({
                id: item.id,
                inventoryid: item.inventoryid,
                code: item.code,
                inventorycode: item.inventorycode,
                name: item.name,
                inventoryname: item.inventoryname,
                type: item.type,
                inventorytypename: item.inventorytypename,
                unit: item.unit,
                measurementname: item.measurementname,
                unitCost: item.unitCost,
                unitcost: item.unitcost,
                unitPrice: item.unitPrice,
                unitprice: item.unitprice,
                // Initialize balance fields
                endingquantity: null,
                endingcost: null
            }));
            
            // Merge balance data if available
            if (balanceData.success && balanceData.balance_data) {
                const balanceLookup = {};
                balanceData.balance_data.forEach(b => {
                    balanceLookup[b.inventoryid] = b;
                });
                
                inventoryData.forEach(item => {
                    const balanceItem = balanceLookup[item.inventoryid];
                    if (balanceItem) {
                        item.endingquantity = balanceItem.endingquantity;
                        item.endingcost = balanceItem.endingcost;
                        // Update unit cost/price from balance data if available
                        if (balanceItem.unitcost !== undefined && balanceItem.unitcost !== null) {
                            item.unitcost = balanceItem.unitcost;
                            item.unitCost = balanceItem.unitcost.toString();
                        }
                        if (balanceItem.unitprice !== undefined && balanceItem.unitprice !== null) {
                            item.unitprice = balanceItem.unitprice;
                            item.unitPrice = balanceItem.unitprice.toString();
                        }
                        if (balanceItem.inventorytypename) {
                            item.inventorytypename = balanceItem.inventorytypename;
                            item.type = balanceItem.inventorytypename;
                        }
                    }
                });
            }
            
            // Filter inventory items based on document type
            // For document types 6, 7, 8: only show items with endingquantity > 0
            const documentTypeId = window.inventoryModalContext.documentTypeId;
            let filteredInventoryData = inventoryData;
            
            if (documentTypeId && [6, 7, 8].includes(parseInt(documentTypeId))) {
                filteredInventoryData = inventoryData.filter(item => {
                    const endingQty = parseFloat(item.endingquantity) || 0;
                    return endingQty > 0;
                });
                console.log(`Filtered inventory for document type ${documentTypeId}: showing ${filteredInventoryData.length} items with endingquantity > 0 out of ${inventoryData.length} total`);
            }
            
            // Store all data and render with pagination
            allInventoryData = filteredInventoryData;
            currentInventoryPage = 1;
            renderInventoryTable(filteredInventoryData, true); // true = balance view (shows balance columns)
            })
            .catch(error => {
            console.error('Error loading inventory or balance data:', error);
                // Fallback to regular inventory list
                loadRegularInventoryList();
            });
    } else {
        // Fallback to regular inventory list
        loadRegularInventoryList();
    }
}

// Pagination helper functions
function changeInventoryPage(page) {
    if (page < 1 || page > totalInventoryPages) return;
    currentInventoryPage = page;
    applyInventoryFiltersAndPagination();
}

function updateInventoryPaginationInfo(filteredCount, displayedCount, startIndex) {
    const paginationInfo = document.getElementById('inventory-pagination-info');
    if (paginationInfo) {
        if (filteredCount === 0) {
            paginationInfo.textContent = 'No items found';
        } else {
            const endIndex = Math.min(startIndex + displayedCount, filteredCount);
            paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${filteredCount} items`;
        }
    }
    
    // Update prev/next buttons
    const prevBtn = document.getElementById('inventory-pagination-prev');
    const nextBtn = document.getElementById('inventory-pagination-next');
    if (prevBtn) {
        prevBtn.disabled = currentInventoryPage === 1;
    }
    if (nextBtn) {
        nextBtn.disabled = currentInventoryPage === totalInventoryPages || totalInventoryPages === 0;
    }
}

function generateInventoryPaginationButtons() {
    const paginationButtons = document.getElementById('inventory-pagination-buttons');
    if (!paginationButtons) return;
    
    paginationButtons.innerHTML = '';
    
    if (totalInventoryPages <= 1) return;
    
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentInventoryPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalInventoryPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.className = `px-2 py-1 text-xs rounded-md ${
            i === currentInventoryPage 
                ? 'bg-blue-400 text-white hover:bg-blue-500' 
                : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
        }`;
        button.addEventListener('click', () => changeInventoryPage(i));
        paginationButtons.appendChild(button);
    }
}

function renderInventoryTable(data, isBalanceView = false) {
    const inventoryListContainer = document.getElementById('inventory-list-container');
    if (!inventoryListContainer) return;
    
    if (data.length === 0) {
        inventoryListContainer.innerHTML = `
            <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No inventory items found</h3>
                <p class="mt-1 text-sm text-gray-500">No inventory items match the current filter criteria.</p>
            </div>
        `;
        // Hide pagination
        const paginationContainer = document.getElementById('inventory-pagination-container');
        if (paginationContainer) {
            paginationContainer.classList.add('hidden');
        }
        return;
    }
    
    // Apply filters first
    const codeFilter = document.getElementById('filter-inventory-code');
    const nameFilter = document.getElementById('filter-inventory-name');
    const codeTerm = codeFilter ? codeFilter.value.toLowerCase().trim() : '';
    const nameTerm = nameFilter ? nameFilter.value.toLowerCase().trim() : '';
    
    let filteredData = data.filter(item => {
        const code = (item.inventorycode || item.code || '').toLowerCase();
        const name = (item.inventoryname || item.name || '').toLowerCase();
        const codeMatch = !codeTerm || code.includes(codeTerm);
        const nameMatch = !nameTerm || name.includes(nameTerm);
        return codeMatch && nameMatch;
    });
    
    // Calculate pagination
    totalInventoryPages = Math.ceil(filteredData.length / inventoryPageSize);
    if (totalInventoryPages === 0) totalInventoryPages = 1; // Ensure at least 1 page
    if (currentInventoryPage > totalInventoryPages) currentInventoryPage = 1;
    
    // Get paginated data
    const startIndex = (currentInventoryPage - 1) * inventoryPageSize;
    const endIndex = startIndex + inventoryPageSize;
    const paginatedData = filteredData.slice(startIndex, endIndex);
    
    // Update pagination info
    updateInventoryPaginationInfo(filteredData.length, paginatedData.length, startIndex);
    
    // Render table
    if (isBalanceView) {
        renderBalanceViewTable(paginatedData);
    } else {
        renderRegularViewTable(paginatedData);
    }
    
    // Show pagination if needed
    const paginationContainer = document.getElementById('inventory-pagination-container');
    if (paginationContainer) {
        if (totalInventoryPages > 1) {
            paginationContainer.classList.remove('hidden');
            paginationContainer.classList.add('flex');
            generateInventoryPaginationButtons();
        } else {
            paginationContainer.classList.add('hidden');
            paginationContainer.classList.remove('flex');
        }
    }
    
    // Initialize filter functionality
    initializeInventorySearchFilter();
}

function renderBalanceViewTable(data) {
    const inventoryListContainer = document.getElementById('inventory-list-container');
    if (!inventoryListContainer) return;
    
    let inventoriesHtml = `
        <div class="space-y-0">
            <div style="display: grid; grid-template-columns: 60px 1fr 1fr 60px 1fr 1fr 1fr 1fr 80px 80px; gap: 0;" class="px-1 py-1 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-500 uppercase tracking-wider">
                <div class="border-r border-gray-300 px-1">
                    <div class="mb-1">Код</div>
                    <input type="text" 
                           id="filter-inventory-code" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="border-r border-gray-300 px-1">
                    <div class="mb-1">Барааны нэр</div>
                    <input type="text" 
                           id="filter-inventory-name" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="border-r border-gray-300 px-1">Төрөл</div>
                <div class="border-r border-gray-300 px-1">Нэгж</div>
                <div class="border-r border-gray-300 px-1 text-right">Нэгж.өртөг</div>
                <div class="border-r border-gray-300 px-1 text-right">Нэгж.үнэ</div>
                <div class="border-r border-gray-300 px-1 text-right">Эцсийн тоо</div>
                <div class="border-r border-gray-300 px-1 text-right">Эцсийн өртөг</div>
                <div class="border-r border-gray-300 px-1 text-center">Сонгох</div>
                <div class="px-1 text-center">Үйлдэл</div>
            </div>
    `;
    
    data.forEach(item => {
        const inventoryId = item.inventoryid || '';
        const inventoryCode = item.inventorycode || '-';
        const inventoryName = item.inventoryname || '';
        const inventoryType = item.inventorytypename || '-';
        const inventoryUnit = item.measurementname || '-';
        const unitCost = item.unitcost !== undefined && item.unitcost !== null ? parseFloat(item.unitcost).toFixed(6) : '-';
        const unitPrice = item.unitprice !== undefined && item.unitprice !== null ? parseFloat(item.unitprice).toFixed(6) : '-';
        const endingQuantity = item.endingquantity !== undefined && item.endingquantity !== null ? parseFloat(item.endingquantity).toFixed(6) : '-';
        const endingCost = item.endingcost !== undefined && item.endingcost !== null ? parseFloat(item.endingcost).toFixed(2) : '-';
        
        const formattedInventoryName = inventoryCode && inventoryCode !== '-' ? 
            `${inventoryCode} - ${inventoryName}` : inventoryName;
        
        const unitCostForSelect = item.unitcost !== undefined && item.unitcost !== null ? item.unitcost.toString() : '';
        const unitPriceForSelect = item.unitprice !== undefined && item.unitprice !== null ? item.unitprice.toString() : '';
        
        inventoriesHtml += `
            <div style="display: grid; grid-template-columns: 60px 1fr 1fr 60px 1fr 1fr 1fr 1fr 80px 80px; gap: 0;" class="px-1 py-1 bg-white border-b border-gray-300 hover:bg-gray-50 transition-colors cursor-pointer inventory-row" 
                 data-inventory-code="${inventoryCode.toLowerCase()}" 
                 data-inventory-name="${inventoryName.toLowerCase()}" 
                 onclick="selectInventory('${inventoryId}', '${formattedInventoryName}', '${unitCostForSelect}', '${unitPriceForSelect}')">
                <div class="flex items-center border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${inventoryCode}</span>
                </div>
                <div class="flex items-center border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${inventoryName}</span>
                </div>
                <div class="flex items-center border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${inventoryType}</span>
                </div>
                <div class="flex items-center border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${inventoryUnit}</span>
                </div>
                <div class="flex items-center justify-end border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${unitCost}</span>
                </div>
                <div class="flex items-center justify-end border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${unitPrice}</span>
                </div>
                <div class="flex items-center justify-end border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${endingQuantity}</span>
                </div>
                <div class="flex items-center justify-end border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${endingCost}</span>
                </div>
                <div class="flex items-center justify-center border-r border-gray-300 px-1">
                    <button onclick="event.stopPropagation(); selectInventory('${inventoryId}', '${formattedInventoryName}', '${unitCostForSelect}', '${unitPriceForSelect}')" 
                            class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors">
                        Сонгох
                    </button>
                </div>
                <div class="flex items-center justify-center space-x-1 px-1">
                    <button onclick="event.stopPropagation(); updateInventory('${inventoryId}', '${inventoryName}')" 
                            class="inline-flex items-center p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors"
                            title="Update Inventory Item">
                        <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                    <button type="button"
                            class="inline-flex items-center p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-colors"
                            title="Delete Inventory Item"
                            data-soft-delete
                            data-item-id="${inventoryId}"
                            data-item-name="${formattedInventoryName}"
                            data-delete-url="/core/refinventory/${inventoryId}/delete/">
                        <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        `;
    });
    
    inventoriesHtml += '</div>';
    inventoryListContainer.innerHTML = inventoriesHtml;
}

function renderRegularViewTable(data) {
    const inventoryListContainer = document.getElementById('inventory-list-container');
    if (!inventoryListContainer) return;
    
            let inventoriesHtml = `
                <div class="space-y-0">
            <div class="grid grid-cols-12 gap-0 px-1 py-1 bg-gray-50 border-b border-gray-300 text-xs font-medium text-gray-500 uppercase tracking-wider">
                <div class="col-span-1 border-r border-gray-300 px-1">
                    <div class="mb-1">Код</div>
                    <input type="text" 
                           id="filter-inventory-code" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="col-span-2 border-r border-gray-300 px-1">
                    <div class="mb-1">Барааны нэр</div>
                    <input type="text" 
                           id="filter-inventory-name" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                        <div class="col-span-2 border-r border-gray-300 px-1">Төрөл</div>
                        <div class="col-span-1 border-r border-gray-300 px-1">Нэгж</div>
                        <div class="col-span-2 border-r border-gray-300 px-1 text-right">Нэгжийн өртөг</div>
                        <div class="col-span-2 border-r border-gray-300 px-1 text-right">Нэгжийн үнэ</div>
                        <div class="col-span-1 border-r border-gray-300 px-1 text-center">Сонгох</div>
                        <div class="col-span-1 px-1 text-center">Үйлдэл</div>
                    </div>
            `;
            
    data.forEach(item => {
        const inventoryId = item.inventoryid || item.id || '';
        const inventoryCode = item.inventorycode || item.code || '-';
        const inventoryName = item.inventoryname || item.name || '';
        const inventoryType = item.inventorytypename || item.type || '-';
        const inventoryUnit = item.measurementname || item.unit || '-';
        const unitCost = item.unitcost !== undefined && item.unitcost !== null ? parseFloat(item.unitcost).toFixed(6) : (item.unitCost || '-');
        const unitPrice = item.unitprice !== undefined && item.unitprice !== null ? parseFloat(item.unitprice).toFixed(6) : (item.unitPrice || '-');
        
                    const formattedInventoryName = inventoryCode && inventoryCode !== '-' ? 
                        `${inventoryCode} - ${inventoryName}` : inventoryName;
                    
        const unitCostForSelect = (item.unitcost !== undefined && item.unitcost !== null ? item.unitcost.toString() : '') || item.unitCost || '';
        const unitPriceForSelect = (item.unitprice !== undefined && item.unitprice !== null ? item.unitprice.toString() : '') || item.unitPrice || '';
        
                    inventoriesHtml += `
                        <div class="grid grid-cols-12 gap-0 px-1 py-1 bg-white border-b border-gray-300 hover:bg-gray-50 transition-colors cursor-pointer inventory-row" 
                             data-inventory-code="${inventoryCode.toLowerCase()}" 
                             data-inventory-name="${inventoryName.toLowerCase()}" 
                 onclick="selectInventory('${inventoryId}', '${formattedInventoryName}', '${unitCostForSelect}', '${unitPriceForSelect}')">
                            <div class="col-span-1 flex items-center border-r border-gray-300 px-1">
                                <span class="text-sm text-gray-900">${inventoryCode}</span>
                            </div>
                            <div class="col-span-2 flex items-center border-r border-gray-300 px-1">
                                <span class="text-sm text-gray-900">${inventoryName}</span>
                            </div>
                            <div class="col-span-2 flex items-center border-r border-gray-300 px-1">
                                <span class="text-sm text-gray-900">${inventoryType}</span>
                            </div>
                            <div class="col-span-1 flex items-center border-r border-gray-300 px-1">
                                <span class="text-sm text-gray-900">${inventoryUnit}</span>
                            </div>
                            <div class="col-span-2 flex items-center justify-end border-r border-gray-300 px-1">
                                <span class="text-sm text-gray-900">${unitCost}</span>
                            </div>
                            <div class="col-span-2 flex items-center justify-end border-r border-gray-300 px-1">
                                <span class="text-sm text-gray-900">${unitPrice}</span>
                            </div>
                            <div class="col-span-1 flex items-center justify-center border-r border-gray-300 px-1">
                    <button onclick="event.stopPropagation(); selectInventory('${inventoryId}', '${formattedInventoryName}', '${unitCostForSelect}', '${unitPriceForSelect}')" 
                                        class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors">
                                    Сонгох
                                </button>
                            </div>
                            <div class="col-span-1 flex items-center justify-end space-x-1 px-1">
                                <button onclick="event.stopPropagation(); updateInventory('${inventoryId}', '${inventoryName}')" 
                                        class="inline-flex items-center p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors"
                                        title="Update Inventory Item">
                                    <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button type="button"
                                        class="inline-flex items-center p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-colors"
                                        title="Delete Inventory Item"
                                        data-soft-delete
                                        data-item-id="${inventoryId}"
                                        data-item-name="${formattedInventoryName}"
                                        data-delete-url="/core/refinventory/${inventoryId}/delete/">
                                    <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
            });
            
            inventoriesHtml += '</div>';
            inventoryListContainer.innerHTML = inventoriesHtml;
}

function applyInventoryFiltersAndPagination() {
    if (allInventoryData.length === 0) return;
    
    // Determine if we're in balance view or regular view
    const isBalanceView = allInventoryData.length > 0 && allInventoryData[0].hasOwnProperty('endingquantity');
    renderInventoryTable(allInventoryData, isBalanceView);
}

function renderInventoryListWithBalance(balanceData) {
    // Store all data
    allInventoryData = balanceData;
    currentInventoryPage = 1;
    
    // Render with pagination
    renderInventoryTable(balanceData, true);
}

function loadRegularInventoryList() {
    const inventoryListContainer = document.getElementById('inventory-list-container');
    if (!inventoryListContainer) return;
    
    // Show loading
    inventoryListContainer.innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Loading inventory items...</p></div>';
    
    // Fetch inventories data from JSON API (much faster than HTML parsing)
    fetch(`/core/api/inventory-list/`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to load inventory');
            }
            
            // Convert JSON inventory data to our format
            const inventoryData = data.inventory_data.map(item => ({
                id: item.id,
                inventoryid: item.inventoryid,
                code: item.code,
                inventorycode: item.inventorycode,
                name: item.name,
                inventoryname: item.inventoryname,
                type: item.type,
                inventorytypename: item.inventorytypename,
                unit: item.unit,
                measurementname: item.measurementname,
                unitCost: item.unitCost,
                unitcost: item.unitcost,
                unitPrice: item.unitPrice,
                unitprice: item.unitprice
            }));
            
            // Store all data and render with pagination
            allInventoryData = inventoryData;
            currentInventoryPage = 1;
            renderInventoryTable(inventoryData, false);
        })
        .catch(error => {
            console.error('Error loading inventory items:', error);
            
            if (typeof Silicon4Message !== 'undefined' && Silicon4Message.error) {
                Silicon4Message.error('load-inventory-failed');
            }
            
            inventoryListContainer.innerHTML = `
                <div class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Error loading inventory items</h3>
                    <p class="mt-1 text-sm text-gray-500">Please try again or contact support.</p>
                </div>
            `;
        });
}

// Initialize inventory search filter functionality
function initializeInventorySearchFilter() {
    const codeFilter = document.getElementById('filter-inventory-code');
    const nameFilter = document.getElementById('filter-inventory-name');
    
    if (!codeFilter || !nameFilter) return;
    
    // Debounce function for filter input
    let filterTimeout;
    function applyInventoryFilters() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
            // Reset to page 1 when filtering
            currentInventoryPage = 1;
            // Re-render with filters and pagination
            applyInventoryFiltersAndPagination();
        }, 300);
    }
    
    // Add event listeners to filter inputs (code and name only)
    codeFilter.addEventListener('input', applyInventoryFilters);
    nameFilter.addEventListener('input', applyInventoryFilters);
    
    // Clear all filters function
    window.clearAllInventoryFilters = function() {
        codeFilter.value = '';
        nameFilter.value = '';
        currentInventoryPage = 1;
        applyInventoryFiltersAndPagination();
    };
    
    // Clear filters when modal is closed
    const modal = document.getElementById('inventory-selection-modal');
    if (modal) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (modal.classList.contains('hidden')) {
                        // Clear all filters
                        codeFilter.value = '';
                        nameFilter.value = '';
                        currentInventoryPage = 1;
                        allInventoryData = [];
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true });
    }
}

// Populate inventory types select from API (returns Promise)
function populateInventoryTypesPromise() {
    const select = document.getElementById('inventory-type');
    if (!select) return Promise.resolve();
    
    return fetch('/core/api/refinventorytypes/', {
        credentials: 'include'  // Ensure session cookies are sent for tenant DB routing
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || !data.success || !Array.isArray(data.inventory_types)) {
                console.error('Invalid API response format:', data);
                return;
            }
            // Clear existing
            select.innerHTML = '';
            // Placeholder
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Төрөл сонгох';
            select.appendChild(opt);
            // Options
            data.inventory_types.forEach(t => {
                const o = document.createElement('option');
                o.value = t.InventoryTypeId;
                o.textContent = t.InventoryTypeName;
                select.appendChild(o);
            });
        })
        .catch(error => {
            console.error('Error fetching inventory types:', error);
            // Fallback placeholder
            select.innerHTML = '<option value="">Төрөл сонгох</option>';
        });
}

// Populate inventory types select from API (void function for direct calls)
function populateInventoryTypes() {
    populateInventoryTypesPromise();
}

// Populate measurement units select from API (returns Promise)
function populateMeasurementsPromise() {
    const select = document.getElementById('inventory-measurement');
    if (!select) return Promise.resolve();
    
    return fetch('/core/api/refmeasurements/', {
        credentials: 'include'  // Ensure session cookies are sent for tenant DB routing
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || !data.success || !Array.isArray(data.measurements)) {
                console.error('Invalid API response format:', data);
                return;
            }
            // Clear existing
            select.innerHTML = '';
            // Placeholder
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Нэгж сонгох';
            select.appendChild(opt);
            // Options
            data.measurements.forEach(m => {
                const o = document.createElement('option');
                o.value = m.MeasurementId;
                o.textContent = m.MeasurementName;
                select.appendChild(o);
            });
        })
        .catch(error => {
            console.error('Error fetching measurements:', error);
            // Fallback placeholder
            select.innerHTML = '<option value="">Нэгж сонгох</option>';
        });
}

// Populate measurement units select from API (void function for direct calls)
function populateMeasurements() {
    populateMeasurementsPromise();
}
</script>

<!-- Include Delete Modal Component -->
{% include 'core/components/delete_modal.html' %}

