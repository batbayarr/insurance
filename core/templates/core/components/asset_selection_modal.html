<!-- Asset Selection Modal Component -->
<div id="asset-selection-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-4 border w-11/12 max-w-7xl min-w-[1400px] shadow-xl rounded-lg bg-white">
        <!-- Modal Header -->
        <div class="flex justify-between items-center px-4 py-2 bg-white border-b border-gray-200">
            <div>
                <h3 class="text-lg font-medium text-gray-900">Хөрөнгийн карт сонгох</h3>
            </div>
            <button onclick="closeAssetPopup()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Actions Row -->
        <div class="mb-2 flex items-center justify-end space-x-2">
                    <button onclick="showAddAssetForm()" 
                    class="inline-flex items-center px-2 py-1 text-xs font-bold text-white bg-green-600 hover:bg-green-700 hover:text-white rounded shadow-sm transition-all duration-200 border border-green-600 hover:border-green-700"
                    title="Шинэ хөрөнгийн карт нэмэх">
                <svg class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                НЭМЭХ
                    </button>
                    <button onclick="clearAllAssetFilters()" 
                    class="px-2 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors">
                Цэвэрлэх
                    </button>
        </div>

        <!-- Add/Edit Asset Form (Hidden by default) -->
        <div id="asset-form-container" class="mb-2 hidden">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex justify-between items-center mb-2">
                    <h4 id="asset-form-title" class="text-sm font-medium text-gray-900">Шинэ хөрөнгийн карт нэмэх</h4>
                    <button onclick="hideAssetForm()" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <form id="asset-form" onsubmit="submitAssetForm(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div>
                            <label for="asset-id" class="block text-xs font-medium text-gray-700 mb-1">Хөрөнгө *</label>
                            <select id="asset-id" name="AssetId" required
                                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Хөрөнгө сонгох</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div>
                            <label for="asset-card-code" class="block text-xs font-medium text-gray-700 mb-1">Хөрөнгийн картын код *</label>
                            <input type="text" id="asset-card-code" name="AssetCardCode" maxlength="5" required
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="asset-card-name" class="block text-xs font-medium text-gray-700 mb-1">Хөрөнгийн картын нэр</label>
                            <input type="text" id="asset-card-name" name="AssetCardName" maxlength="50"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="manufactured-date" class="block text-xs font-medium text-gray-700 mb-1">Үйлдвэрлэсэн огноо</label>
                            <input type="date" id="manufactured-date" name="ManufacturedDate"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="received-date" class="block text-xs font-medium text-gray-700 mb-1">Хүлээн авсан огноо</label>
                            <input type="date" id="received-date" name="ReceivedDate"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="months-to-use" class="block text-xs font-medium text-gray-700 mb-1">Ашиглах сар</label>
                            <input type="number" id="months-to-use" name="MonthsToUse" min="1" max="999"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="unit-cost" class="block text-xs font-medium text-gray-700 mb-1">Нэгжийн өртөг *</label>
                            <input type="number" id="unit-cost" name="UnitCost" step="0.000001" required
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="unit-price" class="block text-xs font-medium text-gray-700 mb-1">Нэгжийн үнэ *</label>
                            <input type="number" id="unit-price" name="UnitPrice" step="0.000001" required
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="daily-expense" class="block text-xs font-medium text-gray-700 mb-1">Өдрийн зардал</label>
                            <input type="number" id="daily-expense" name="DailyExpense" step="0.000001" readonly
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Автоматаар тооцоолно">
                            <p class="mt-1 text-xs text-gray-500">Нэгжийн өртөг болон ашиглах сараас тооцоолно</p>
                        </div>
                        <div>
                            <label for="employee-id" class="block text-xs font-medium text-gray-700 mb-1">Ажилтан (Сонголттой)</label>
                            <select id="employee-id" name="EmployeeId"
                                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Ажилтан сонгох</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="asset-active" name="IsDelete" 
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-xs text-gray-700">Устгасан гэж тэмдэглэх</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-2 mt-2 pt-2 border-t border-blue-200">
                        <button type="button" onclick="hideAssetForm()" 
                                class="px-2 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            Цуцлах
                        </button>
                        <button type="submit" id="asset-submit-btn"
                                class="px-2 py-1 text-xs font-medium text-white bg-green-600 border border-transparent rounded hover:bg-green-700 focus:outline-none focus:ring-1 focus:ring-green-500">
                            <span id="asset-submit-text">Хөрөнгийн карт нэмэх</span>
                            <span id="asset-submit-loading" class="hidden">
                                <svg class="animate-spin -ml-1 mr-2 h-3 w-3 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Хадгалж байна...
                            </span>
                        </button>
                    </div>
                    
                    <input type="hidden" id="asset-card-id" name="AssetCardId" value="">
                </form>
            </div>
        </div>

        <!-- Asset List Container -->
        <div id="asset-list-container" class="max-h-96 overflow-y-auto overflow-x-auto border border-gray-200 rounded-lg min-w-[1100px]">
            <!-- Asset list will be loaded here -->
        </div>

        <!-- Pagination Container -->
        <div id="asset-pagination-container" class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 hidden">
            <div class="flex items-center space-x-2">
                <span id="asset-pagination-info" class="text-xs text-gray-700"></span>
            </div>
            <div class="flex items-center space-x-2">
                <button id="asset-pagination-prev" onclick="changeAssetPage(currentAssetPage - 1)" 
                        class="px-2 py-1 text-xs border border-gray-300 rounded bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Өмнөх
                </button>
                <div id="asset-pagination-buttons" class="flex items-center space-x-1">
                    <!-- Page number buttons will be generated here -->
                </div>
                <button id="asset-pagination-next" onclick="changeAssetPage(currentAssetPage + 1)" 
                        class="px-2 py-1 text-xs border border-gray-300 rounded bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Дараах
                </button>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 mt-4">
            <button onclick="closeAssetPopup()" 
                    class="px-4 py-2 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors">
                Цуцлах
            </button>
        </div>
    </div>
</div>

<!-- Include Message Modal -->
{% include 'core/components/message_modal.html' %}

<script>
// Global variables for document context
window.assetModalContext = {
    documentDate: null,
    accountId: null,
    documentTypeId: null
};

// Pagination variables
let currentAssetPage = 1;
let assetPageSize = 15;
let totalAssetPages = 1;
let allAssetData = []; // Store all asset cards for filtering and pagination

// Asset Selection Modal Functions
window.openAssetPopup = function(inputElement = null, rowId = null, context = null) {
    // Store the current input element and row ID for later use
    window.currentAssetInput = inputElement;
    window.currentAssetRowId = rowId;
    
    // Store document context if provided
    if (context) {
        window.assetModalContext.documentDate = context.documentDate || null;
        window.assetModalContext.accountId = context.accountId || null;
        window.assetModalContext.documentTypeId = context.documentTypeId || null;
    } else {
        // Clear context if not provided
        window.assetModalContext.documentDate = null;
        window.assetModalContext.accountId = null;
        window.assetModalContext.documentTypeId = null;
    }
    
    // Reset pagination
    currentAssetPage = 1;
    allAssetData = [];
    
    // Open asset selection modal
    const modal = document.getElementById('asset-selection-modal');
    if (modal) {
        modal.classList.remove('hidden');
        // Load assets
        loadAssetList();
    }
}

window.closeAssetPopup = async function() {
    const modal = document.getElementById('asset-selection-modal');
    if (modal) {
        modal.classList.add('hidden');
    }

    await refreshAccountingAfterAssetChange();
}

window.selectAsset = async function(
    assetCardId,
    assetCardName,
    assetName,
    unitCost = '',
    unitPrice = '',
    cumulatedDepreciation = '',
    dailyExpense = '',
    depreciationExpense = '',
    totalDepreciation = ''
) {
    console.log('DEBUG: selectAsset called with:', {
        assetCardId,
        assetCardName,
        assetName,
        unitCost,
        unitPrice,
        cumulatedDepreciation,
        dailyExpense,
        depreciationExpense,
        totalDepreciation
    });

    const parseNumericValue = (value) => {
        if (value === null || value === undefined) return null;
        if (typeof value === 'number') {
            return isNaN(value) ? null : value;
        }
        const cleaned = value.replace(/,/g, '').trim();
        if (cleaned === '' || cleaned === '-') {
            return null;
        }
        const num = parseFloat(cleaned);
        return isNaN(num) ? null : num;
    };

    const formatNumericValue = (value, decimals = 2) => {
        const num = parseNumericValue(value);
        if (num === null) {
            return (0).toFixed(decimals);
        }
        return num.toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    };

    const contextDocType = window.assetModalContext?.documentTypeId;
    if (contextDocType && parseInt(contextDocType, 10) === 10) {
        try {
            const usageUrl = `/core/api/asset-card-usage-check/?asset_card_id=${encodeURIComponent(assetCardId)}&document_type=${encodeURIComponent(contextDocType)}`;
            const usageResponse = await fetch(usageUrl, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            const usageData = await usageResponse.json();

            if (!usageData.success) {
                console.warn('Asset usage check failed:', usageData.error);
                return;
            }

            if (!usageData.is_available) {
                const warningMessage = usageData.message || 'Тухайн хөрөнгийг орлогод авсан байна. эсвэл элэгдэл байгуулсан байна. эсвэл эхний үлдэгдэлтэй байна.';
                if (typeof showMessageModal === 'function') {
                    showMessageModal(warningMessage, 'warning');
                } else {
                    showAssetMessage(warningMessage, 'warning');
                }
                return;
            }
        } catch (error) {
            console.warn('Failed to check asset card usage:', error);
            return;
        }
    }

    // Check if we're in bulk manage mode (has currentAssetInput and currentAssetRowId)
    if (window.currentAssetInput && window.currentAssetRowId) {
        // Bulk manage mode - populate the specific row
        const row = window.currentAssetInput.closest('tr');
        if (row) {
            // Try multiple selectors to find the hidden input
            const hiddenInput = row.querySelector('.asset-card-id-input') || 
                               row.querySelector('input[name*="asset_card_id_"]') || 
                               row.querySelector('input[name*="new_asset_card_id_"]');
            const displayInput = row.querySelector('.asset-card-display-input');
            const quantityInput = row.querySelector('.quantity-input');
            const unitCostInput = row.querySelector('.unit-cost-input');
            const unitPriceInput = row.querySelector('.unit-price-input');
            const cumulatedDepreciationInput = row.querySelector('.cumulated-depreciation-display');
            const dailyExpenseInput = row.querySelector('.daily-expense-display');
            
            console.log('DEBUG: Bulk manage mode - Found elements:', {hiddenInput, displayInput, quantityInput, unitCostInput, unitPriceInput, cumulatedDepreciationInput, dailyExpenseInput, rowId: window.currentAssetRowId});
            
            if (hiddenInput && displayInput) {
                hiddenInput.value = assetCardId;
                // Format display value as "AssetCardCode - AssetCardName" to match template format
                displayInput.value = assetCardName;
                console.log('DEBUG: Set AssetCardId to:', assetCardId, 'and display to:', assetCardName);
            } else {
                console.error('DEBUG: Missing hiddenInput or displayInput', {hiddenInput, displayInput});
            }
            
            // Set quantity to 1 by default if empty or 0
            if (quantityInput) {
                const currentQuantity = parseFloat(quantityInput.value) || 0;
                if (currentQuantity === 0 || quantityInput.value === '' || quantityInput.value === null) {
                    quantityInput.value = '1';
                    console.log('DEBUG: Set Quantity to 1 (default)');
                }
            }
            
            // Populate unit cost, unit price, cumulated depreciation, and daily expense if inputs exist
            const normalizedUnitCost = parseNumericValue(unitCost);
            const normalizedUnitPrice = parseNumericValue(unitPrice);
            const normalizedCumulatedDepreciation = parseNumericValue(cumulatedDepreciation);
            const normalizedDailyExpense = parseNumericValue(dailyExpense);
            const normalizedDepreciationExpense = parseNumericValue(depreciationExpense);
            const normalizedTotalDepreciation = parseNumericValue(totalDepreciation);
            
            if (unitCostInput) {
                unitCostInput.value = (normalizedUnitCost !== null ? normalizedUnitCost : 0).toFixed(6);
                console.log('DEBUG: Set UnitCost to:', unitCostInput.value);
            }
            if (unitPriceInput) {
                unitPriceInput.value = (normalizedUnitPrice !== null ? normalizedUnitPrice : 0).toFixed(6);
                console.log('DEBUG: Set UnitPrice to:', unitPriceInput.value);
            }
            if (cumulatedDepreciationInput) {
                const formattedCumulated = formatNumericValue(
                    normalizedCumulatedDepreciation !== null ? normalizedCumulatedDepreciation : 0,
                    2
                );
                cumulatedDepreciationInput.value = formattedCumulated;
                console.log('DEBUG: Set CumulatedDepreciation to:', formattedCumulated);
            }
            if (dailyExpenseInput) {
                const formattedDailyExpense = formatNumericValue(
                    normalizedDailyExpense !== null ? normalizedDailyExpense : 0,
                    6
                );
                dailyExpenseInput.value = formattedDailyExpense;
                console.log('DEBUG: Set DailyExpense to:', formattedDailyExpense);
            }
            const depreciationAmountInput = row.querySelector('.depreciation-amount-display');
            const endingDepreciationInput = row.querySelector('.ending-depreciation-display');
            const isDocType11 = contextDocType && parseInt(contextDocType, 10) === 11;
            const hasBackendDepreciation =
                isDocType11 &&
                (normalizedCumulatedDepreciation !== null ||
                    normalizedDepreciationExpense !== null ||
                    normalizedTotalDepreciation !== null);

            if (depreciationAmountInput) {
                const formattedDepAmount = normalizedDepreciationExpense !== null
                    ? formatNumericValue(normalizedDepreciationExpense, 2)
                    : '0.00';
                depreciationAmountInput.value = formattedDepAmount;
            }

            if (endingDepreciationInput) {
                const totalValue = normalizedTotalDepreciation !== null
                    ? normalizedTotalDepreciation
                    : (
                        (normalizedCumulatedDepreciation !== null ? normalizedCumulatedDepreciation : 0) +
                        (normalizedDepreciationExpense !== null ? normalizedDepreciationExpense : 0)
                    );
                endingDepreciationInput.value = formatNumericValue(totalValue, 2);
            }

            if (hasBackendDepreciation) {
                row.dataset.depSource = 'backend';
            } else {
                delete row.dataset.depSource;
            }
            
            // Trigger calculation if we're in bulk manage mode
            if (typeof calculateAssetTotals === 'function') {
                calculateAssetTotals(row);
            }
            
            // Update summary row totals
            if (typeof updateSummaryRowTotals === 'function') {
                updateSummaryRowTotals();
            }

            await refreshAccountingAfterAssetChange();
        } else {
            console.error('DEBUG: Row not found for input element:', window.currentAssetInput);
        }
    } else {
        // Regular form mode - populate main form fields
        console.log('DEBUG: Regular form mode - populating form fields');
        const hiddenInput = document.getElementById('AssetCardId');
        const displayInput = document.getElementById('AssetCardIdDisplay');
        const unitCostInput = document.getElementById('UnitCost');
        const unitPriceInput = document.getElementById('UnitPrice');
        const cumulatedDepreciationInput = document.getElementById('CumulatedDepreciation');
        
        console.log('DEBUG: Found elements:', {hiddenInput, displayInput, unitCostInput, unitPriceInput, cumulatedDepreciationInput});
        
        if (hiddenInput && displayInput) {
            hiddenInput.value = assetCardId;
            displayInput.value = assetCardName;
            console.log('DEBUG: Set AssetCardId to:', assetCardId, 'and display to:', assetCardName);
        }
        
        // Populate unit cost, unit price, and cumulated depreciation if inputs exist
        // Convert "-" or empty values to "0" to ensure valid numbers
        const normalizedUnitCost = (unitCost && unitCost !== '-' && unitCost.trim() !== '') ? unitCost : '0';
        const normalizedUnitPrice = (unitPrice && unitPrice !== '-' && unitPrice.trim() !== '') ? unitPrice : '0';
        const normalizedCumulatedDepreciation = (cumulatedDepreciation && cumulatedDepreciation !== '-' && cumulatedDepreciation.trim() !== '') ? cumulatedDepreciation : '0';
        
        // If values are still missing or invalid, try to fetch from asset card data
        if ((normalizedUnitCost === '0' || normalizedUnitPrice === '0') && assetCardId) {
            // Try to get values from data attributes if available in the modal
            const assetRow = document.querySelector(`[data-asset-card-id="${assetCardId}"]`);
            if (assetRow) {
                const dataUnitCost = assetRow.getAttribute('data-unit-cost');
                const dataUnitPrice = assetRow.getAttribute('data-unit-price');
                const dataCumulatedDepreciation = assetRow.getAttribute('data-cumulated-depreciation');
                if (dataUnitCost && dataUnitCost !== '-') {
                    if (unitCostInput) unitCostInput.value = dataUnitCost;
                }
                if (dataUnitPrice && dataUnitPrice !== '-') {
                    if (unitPriceInput) unitPriceInput.value = dataUnitPrice;
                }
                if (dataCumulatedDepreciation && dataCumulatedDepreciation !== '-') {
                    if (cumulatedDepreciationInput) cumulatedDepreciationInput.value = dataCumulatedDepreciation;
                }
            } else {
                // Set to 0 if no data available
                if (unitCostInput) unitCostInput.value = normalizedUnitCost;
                if (unitPriceInput) unitPriceInput.value = normalizedUnitPrice;
                if (cumulatedDepreciationInput) cumulatedDepreciationInput.value = normalizedCumulatedDepreciation;
            }
        } else {
            // Use normalized values
        if (unitCostInput) {
                unitCostInput.value = normalizedUnitCost;
                console.log('DEBUG: Set UnitCost to:', normalizedUnitCost);
        }
        if (unitPriceInput) {
                unitPriceInput.value = normalizedUnitPrice;
                console.log('DEBUG: Set UnitPrice to:', normalizedUnitPrice);
            }
            if (cumulatedDepreciationInput) {
                cumulatedDepreciationInput.value = normalizedCumulatedDepreciation;
                console.log('DEBUG: Set CumulatedDepreciation to:', normalizedCumulatedDepreciation);
            }
        }
    }
    
    // Clear the stored references
    window.currentAssetInput = null;
    window.currentAssetRowId = null;
    
    await closeAssetPopup();
}

async function refreshAccountingAfterAssetChange() {
    try {
        if (typeof calculateAllDepreciationAmounts === 'function') {
            await calculateAllDepreciationAmounts();
        }
        if (typeof calculateAllEndingDepreciation === 'function') {
            calculateAllEndingDepreciation();
        }
        if (typeof updateSummaryRowTotals === 'function') {
            updateSummaryRowTotals();
        }
        if (typeof window.FillAccountingDetails === 'function') {
            window.FillAccountingDetails();
        }
    } catch (error) {
        console.warn('Failed to refresh accounting after asset change:', error);
    }
}

// Show add asset form
function showAddAssetForm() {
    const formContainer = document.getElementById('asset-form-container');
    const formTitle = document.getElementById('asset-form-title');
    const submitText = document.getElementById('asset-submit-text');
    const assetCardIdInput = document.getElementById('asset-card-id');
    
    // Reset form
    document.getElementById('asset-form').reset();
    assetCardIdInput.value = '';
    document.getElementById('asset-active').checked = false; // Set default to not deleted
    
    // Update form title and button text
    formTitle.textContent = 'Шинэ хөрөнгийн карт нэмэх';
    submitText.textContent = 'Хөрөнгийн карт нэмэх';
    
    // Show form
    formContainer.classList.remove('hidden');
    
    // Load assets and employees for dropdowns
    loadAssetFormData();
    
    // Initialize DailyExpense calculation
    initializeDailyExpenseCalculation();
}

// Show edit asset form
function updateAsset(assetCardId, assetCardName) {
    const formContainer = document.getElementById('asset-form-container');
    const formTitle = document.getElementById('asset-form-title');
    const submitText = document.getElementById('asset-submit-text');
    const assetCardIdInput = document.getElementById('asset-card-id');
    
    // Populate form with existing data
    assetCardIdInput.value = assetCardId;
    document.getElementById('asset-card-name').value = assetCardName;
    
    // Update form title and button text
    formTitle.textContent = 'Хөрөнгийн карт засах';
    submitText.textContent = 'Хөрөнгийн карт шинэчлэх';
    
    // Show form
    formContainer.classList.remove('hidden');
    
    // Load assets and employees for dropdowns
    loadAssetFormData();
    
    // Initialize DailyExpense calculation
    initializeDailyExpenseCalculation();
}

// Hide asset form
function hideAssetForm() {
    const formContainer = document.getElementById('asset-form-container');
    formContainer.classList.add('hidden');
}

// Load assets and employees for form dropdowns
function loadAssetFormData() {
    // Load assets
    fetch('/core/api/assets/')
        .then(response => response.json())
        .then(data => {
            const assetSelect = document.getElementById('asset-id');
            assetSelect.innerHTML = '<option value="">Select Asset</option>';
            data.assets.forEach(asset => {
                const option = document.createElement('option');
                option.value = asset.AssetId;
                option.textContent = asset.AssetName;
                assetSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading assets:', error));
    
    // Load employees
    fetch('/core/api/clients/')
        .then(response => response.json())
        .then(data => {
            const employeeSelect = document.getElementById('employee-id');
            employeeSelect.innerHTML = '<option value="">Select Employee</option>';
            data.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.ClientId;
                option.textContent = client.ClientName;
                employeeSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading employees:', error));
}

// Calculate DailyExpense from UnitCost and MonthsToUse
function calculateDailyExpense() {
    const unitCostInput = document.getElementById('unit-cost');
    const monthsToUseInput = document.getElementById('months-to-use');
    const dailyExpenseInput = document.getElementById('daily-expense');
    
    if (!unitCostInput || !monthsToUseInput || !dailyExpenseInput) return;
    
    const unitCost = parseFloat(unitCostInput.value) || 0;
    const monthsToUse = parseFloat(monthsToUseInput.value) || 0;
    
    if (unitCost > 0 && monthsToUse > 0) {
        // DailyExpense = UnitCost / (MonthsToUse * 30 days per month)
        const dailyExpense = unitCost / (monthsToUse * 30);
        
        // Round to 6 decimal places and ensure it fits within max_digits=24 constraint
        // Format: round to 6 decimals, then convert to string and limit total digits
        let roundedValue = parseFloat(dailyExpense.toFixed(6));
        
        // Ensure the value doesn't exceed 24 digits total (18 before decimal + 6 after)
        const valueStr = roundedValue.toString();
        const parts = valueStr.split('.');
        const integerPart = parts[0];
        const decimalPart = parts[1] || '';
        
        // If integer part has more than 18 digits, we need to adjust
        if (integerPart.length > 18) {
            // Round to fit within 18 digits before decimal
            roundedValue = parseFloat(roundedValue.toExponential(17));
            // Convert back and limit to 6 decimal places
            roundedValue = parseFloat(roundedValue.toFixed(6));
        }
        
        dailyExpenseInput.value = roundedValue.toFixed(6);
    } else {
        dailyExpenseInput.value = '';
    }
}

// Initialize DailyExpense calculation listeners
function initializeDailyExpenseCalculation() {
    const unitCostInput = document.getElementById('unit-cost');
    const monthsToUseInput = document.getElementById('months-to-use');
    
    if (unitCostInput) {
        unitCostInput.addEventListener('input', calculateDailyExpense);
        unitCostInput.addEventListener('change', calculateDailyExpense);
    }
    
    if (monthsToUseInput) {
        monthsToUseInput.addEventListener('input', calculateDailyExpense);
        monthsToUseInput.addEventListener('change', calculateDailyExpense);
    }
    
    // Calculate on initial load if values exist
    calculateDailyExpense();
}

// Submit asset form
function submitAssetForm(event) {
    event.preventDefault();
    
    // Calculate DailyExpense before submission
    calculateDailyExpense();
    
    const form = document.getElementById('asset-form');
    const formData = new FormData(form);
    const assetCardId = document.getElementById('asset-card-id').value;
    const isEdit = assetCardId !== '';
    
    // Show loading state
    const submitBtn = document.getElementById('asset-submit-btn');
    const submitText = document.getElementById('asset-submit-text');
    const submitLoading = document.getElementById('asset-submit-loading');
    
    // Use shared component if available, otherwise fall back to manual implementation
    if (typeof Silicon4Form !== 'undefined' && Silicon4Form.showLoading) {
        Silicon4Form.showLoading(submitBtn, 'Saving...');
    } else {
        // Original implementation (fallback)
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
        submitBtn.disabled = true;
    }
    
    // Determine URL and get CSRF token
    const url = isEdit ? `/core/asset-cards/${assetCardId}/update/` : '/core/asset-cards/create/';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    
    // Use fetch to submit and handle response
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken ? csrfToken.value : '',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
            // Handle JSON response (AJAX request)
            const data = await response.json();
            if (data.success) {
                // Success - hide form and refresh asset list
                hideAssetForm();
                loadAssetList();
                
                // Show success message
                showAssetMessage(data.message || (isEdit ? 'Asset card updated successfully!' : 'Asset card created successfully!'), 'success');
            } else {
                // Handle validation errors
                let errorMessage = data.message || 'Please correct the errors below.';
                if (data.errors) {
                    // Format validation errors
                    const errorList = [];
                    for (const [field, errors] of Object.entries(data.errors)) {
                        if (Array.isArray(errors)) {
                            errors.forEach(err => {
                                errorList.push(`${field}: ${err}`);
                            });
                        } else {
                            errorList.push(`${field}: ${errors}`);
                        }
                    }
                    if (errorList.length > 0) {
                        errorMessage += ' ' + errorList.join('; ');
                    }
                }
                // Use showMessageModal if available, otherwise fall back to showAssetMessage
                if (typeof showMessageModal === 'function') {
                    showMessageModal(errorMessage, 'error');
                } else {
                showAssetMessage(errorMessage, 'error');
                }
            }
        } else {
            // Handle HTML response (regular form submission)
            const text = await response.text();
            if (!response.ok) {
                throw new Error('Failed to save asset card');
            }
            // Heuristic: if returned HTML still contains the form with errorlist, treat as error
            const hasError = /errorlist/gi.test(text) || /id=\"asset-form\"/gi.test(text) && /error/gi.test(text);
            if (hasError) {
                throw new Error('Server validation failed. Please check all required fields.');
            }
            // Success - hide form and refresh asset list
            hideAssetForm();
            loadAssetList();
            showAssetMessage(isEdit ? 'Asset card updated successfully!' : 'Asset card created successfully!', 'success');
        }
    })
    .catch(error => {
        console.error('Error saving asset card:', error);
        // Use showMessageModal if available, otherwise fall back to showAssetMessage
        if (typeof showMessageModal === 'function') {
            showMessageModal(error.message || 'Error saving asset card. Please try again.', 'error');
        } else {
        showAssetMessage(error.message || 'Error saving asset card. Please try again.', 'error');
        }
    })
    .finally(() => {
        // Reset loading state
        // Use shared component if available, otherwise fall back to manual implementation
        if (typeof Silicon4Form !== 'undefined' && Silicon4Form.hideLoading) {
            const originalHtml = isEdit ? 'Update Asset Card' : 'Add Asset Card';
            Silicon4Form.hideLoading(submitBtn, originalHtml);
        } else {
            // Original implementation (fallback)
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
            submitBtn.disabled = false;
        }
    });
}

// Show message to user
function showAssetMessage(message, type) {
    // Use shared component if available, otherwise fall back to original implementation
    if (typeof Silicon4Message !== 'undefined' && Silicon4Message.show) {
        Silicon4Message.show(message, type);
    } else {
        // Original implementation (fallback)
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded-md shadow-lg z-50 ${
            type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'
        }`;
        messageDiv.textContent = message;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }
}

// Show message modal function
function showMessageModal(message, type = 'error', title = null) {
    const modal = document.getElementById('message-modal');
    
    // Fallback to showAssetMessage if modal not found
    if (!modal) {
        console.warn('Message modal not found, falling back to showAssetMessage');
        showAssetMessage(message, type);
        return;
    }
    
    // Get elements
    const iconContainer = document.getElementById('message-modal-icon-container');
    const titleElement = document.getElementById('message-modal-title');
    const textElement = document.getElementById('message-modal-text');
    const okButton = document.getElementById('message-modal-ok-btn');
    
    // Hide all icons
    const icons = {
        error: document.getElementById('message-modal-icon-error'),
        success: document.getElementById('message-modal-icon-success'),
        warning: document.getElementById('message-modal-icon-warning'),
        info: document.getElementById('message-modal-icon-info')
    };
    
    Object.values(icons).forEach(icon => {
        if (icon) icon.classList.add('hidden');
    });
    
    // Set styles based on type
    const typeConfig = {
        error: {
            bgClass: 'bg-red-100',
            btnClass: 'bg-red-500 hover:bg-red-600 focus:ring-red-300',
            defaultTitle: 'Алдаа'
        },
        success: {
            bgClass: 'bg-green-100',
            btnClass: 'bg-green-500 hover:bg-green-600 focus:ring-green-300',
            defaultTitle: 'Амжилттай'
        },
        warning: {
            bgClass: 'bg-yellow-100',
            btnClass: 'bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-300',
            defaultTitle: 'Анхааруулга'
        },
        info: {
            bgClass: 'bg-blue-100',
            btnClass: 'bg-blue-500 hover:bg-blue-600 focus:ring-blue-300',
            defaultTitle: 'Мэдээлэл'
        }
    };
    
    const config = typeConfig[type] || typeConfig.error;
    
    // Set icon container background
    if (iconContainer) {
        iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${config.bgClass}`;
    }
    
    // Show appropriate icon
    if (icons[type]) {
        icons[type].classList.remove('hidden');
    }
    
    // Set title
    if (titleElement) {
        titleElement.textContent = title || config.defaultTitle;
    }
    
    // Set message text
    if (textElement) {
        textElement.textContent = message;
    }
    
    // Set button style
    if (okButton) {
        okButton.className = `px-4 py-2 ${config.btnClass} text-white text-base font-medium rounded-md w-24 hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2`;
    }
    
    // Show modal
    modal.classList.remove('hidden');
}

// Delete asset function
function deleteAsset(assetCardId, assetCardName) {
    const deleteUrl = `/core/asset-cards/${assetCardId}/delete/`;
    const itemName = `asset card "${assetCardName}"`;
    
    // Use standardized delete modal
    Silicon4Delete.showModal(deleteUrl, itemName, function() {
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = deleteUrl;
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        // Add a callback to refresh the asset list after successful deletion
        form.addEventListener('submit', function() {
            setTimeout(() => {
                loadAssetList();
            }, 1000);
        });
        
        // Submit the form
        document.body.appendChild(form);
        form.submit();
    });
}

function loadAssetList() {
    const assetListContainer = document.getElementById('asset-list-container');
    if (!assetListContainer) return;
    
    // Show loading
    assetListContainer.innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Loading asset cards...</p></div>';
    
    // Check if context has documentDate (required for balance calculation)
    const context = window.assetModalContext;
    const hasContext = context.documentDate;
    
    if (hasContext) {
        // Calculate dates: beginDate = documentDate - 1 day, endDate = documentDate
        const documentDate = new Date(context.documentDate);
        const beginDate = new Date(documentDate);
        beginDate.setDate(beginDate.getDate() - 1);
        
        const startDateStr = beginDate.toISOString().split('T')[0];
        const endDateStr = documentDate.toISOString().split('T')[0];
        
        // Load all asset cards first, then merge balance data
        const balanceQuery = new URLSearchParams({
            start_date: startDateStr,
            end_date: endDateStr
        });
        if (context.documentTypeId && parseInt(context.documentTypeId) === 11 && context.documentDate) {
            balanceQuery.append('as_of_date', context.documentDate);
        }
        
        Promise.all([
            // Load all asset cards from API
            fetch('/core/api/asset-cards/').then(r => r.json()),
            // Load balance data
            fetch(`/core/api/ast-balance-data/?${balanceQuery.toString()}`).then(r => r.json())
        ])
        .then(([assetCardsData, balanceData]) => {
            if (!assetCardsData.success || !assetCardsData.asset_cards) {
                throw new Error(assetCardsData.error || 'Failed to load asset cards');
            }
            
            if (assetCardsData.asset_cards.length === 0) {
                assetListContainer.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No asset cards found</h3>
                        <p class="mt-1 text-sm text-gray-500">No asset cards match the current filter criteria.</p>
                    </div>
                `;
                return;
            }
            
            // Convert API data to format expected by renderAssetTable
            let assetData = assetCardsData.asset_cards.map(card => ({
                id: card.AssetCardId,
                assetcardid: card.AssetCardId,
                code: card.AssetCardCode || '-',
                assetcardcode: card.AssetCardCode || '-',
                name: card.AssetCardName || '',
                assetcardname: card.AssetCardName || '',
                assetname: card.AssetName || '-',
                assettypename: card.AssetTypeName || '-', // Get from API
                employee: card.ClientName || '-',
                unitCost: card.UnitCost ? card.UnitCost.toString() : '0',
                unitcost: card.UnitCost || 0,
                unitPrice: card.UnitPrice ? card.UnitPrice.toString() : '0',
                unitprice: card.UnitPrice || 0,
                dailyexpense: card.DailyExpense !== undefined && card.DailyExpense !== null ? card.DailyExpense : 0,
                DailyExpense: card.DailyExpense !== undefined && card.DailyExpense !== null ? card.DailyExpense : 0,
                // Initialize balance fields
                endingquantity: null,
                endingcost: null,
                cumulateddepreciation: null,
                depreciationexpense: null,
                totalexpense: null
            }));
            
            const documentTypeId = window.assetModalContext.documentTypeId;
            const isDocumentType10 = documentTypeId && parseInt(documentTypeId, 10) === 10;

            // Merge balance data if available
            const balanceLookup = {};
            let hasBalanceData = false;
            
            if (balanceData.success && balanceData.balance_data && balanceData.balance_data.length > 0) {
                balanceData.balance_data.forEach(b => {
                    // Filter by accountId if provided in context
                    if (!isDocumentType10 && context.accountId && b.accountid != context.accountId) {
                        return; // Skip this balance item if accountId doesn't match
                    }
                    // Create lookup key by assetcardid
                    const key = b.assetcardid;
                    if (!balanceLookup[key]) {
                        balanceLookup[key] = b;
                    }
                    hasBalanceData = true;
                });
                
                assetData.forEach(item => {
                    // Find matching balance by assetcardid
                    const balanceItem = balanceLookup[item.assetcardid];
                    
                    if (balanceItem) {
                        item.endingquantity = balanceItem.endingquantity;
                        item.endingcost = balanceItem.endingcost;
                        item.cumulateddepreciation = balanceItem.cumulateddepreciation;
                        item.dailyexpense = balanceItem.dailyexpense;
                        // Update asset type name from balance if available (prefer balance data)
                        if (balanceItem.assettypename && balanceItem.assettypename !== '-') {
                            item.assettypename = balanceItem.assettypename;
                        }
                        if (balanceItem.depreciationexpense !== undefined && balanceItem.depreciationexpense !== null) {
                            item.depreciationexpense = balanceItem.depreciationexpense;
                        }
                        if (balanceItem.totalexpense !== undefined && balanceItem.totalexpense !== null) {
                            item.totalexpense = balanceItem.totalexpense;
                        }
                        // Update unit cost/price from balance if available
                        // Note: balance data doesn't have unit cost/price, keep from asset card
                    }
                });
                
                // If filtering by accountId, only show asset cards that have balance data for that account
                if (!isDocumentType10 && context.accountId && hasBalanceData) {
                    assetData = assetData.filter(item => balanceLookup[item.assetcardid]);
                } else if (!isDocumentType10 && context.accountId && !hasBalanceData) {
                    console.warn('No balance data returned for account filter:', context.accountId);
                }
            }
            
            // Filter assets based on document type
            // For document type 11: only show items with endingquantity > 0
            // For all other cases: show all asset cards
            let filteredAssetData = assetData;
            
            if (documentTypeId && parseInt(documentTypeId) === 11 && hasBalanceData) {
                filteredAssetData = assetData.filter(item => {
                    const endingQty = parseFloat(item.endingquantity) || 0;
                    return endingQty > 0;
                });
                console.log(`Filtered assets for document type ${documentTypeId}: showing ${filteredAssetData.length} items with endingquantity > 0 out of ${assetData.length} total`);
            }
            
            // Store all data and render with pagination
            allAssetData = filteredAssetData;
            currentAssetPage = 1;
            renderAssetTable(filteredAssetData, true); // true = balance view (shows balance columns)
        })
        .catch(error => {
            console.error('Error loading asset cards or balance data:', error);
            // Fallback to regular asset list
            loadRegularAssetList();
        });
                    } else {
        // Fallback to regular asset list
        loadRegularAssetList();
    }
}

function loadRegularAssetList() {
    const assetListContainer = document.getElementById('asset-list-container');
    if (!assetListContainer) return;
    
    // Show loading
    assetListContainer.innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Loading asset cards...</p></div>';
    
    // Fetch asset cards from API endpoint
    fetch('/core/api/asset-cards/')
        .then(response => response.json())
        .then(data => {
            if (!data.success || !data.asset_cards) {
                throw new Error(data.error || 'Failed to load asset cards');
            }
            
            if (data.asset_cards.length === 0) {
                assetListContainer.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No asset cards found</h3>
                        <p class="mt-1 text-sm text-gray-500">No asset cards match the current filter criteria.</p>
                        </div>
                    `;
                return;
            }
            
            // Convert API data to format expected by renderAssetTable
            let assetData = data.asset_cards.map(card => ({
                id: card.AssetCardId,
                assetcardid: card.AssetCardId,
                code: card.AssetCardCode || '-',
                assetcardcode: card.AssetCardCode || '-',
                name: card.AssetCardName || '',
                assetcardname: card.AssetCardName || '',
                assetname: card.AssetName || '-',
                assettypename: card.AssetTypeName || '-',
                employee: card.ClientName || '-',
                unitCost: card.UnitCost ? card.UnitCost.toString() : '0',
                unitcost: card.UnitCost || 0,
                unitPrice: card.UnitPrice ? card.UnitPrice.toString() : '0',
                unitprice: card.UnitPrice || 0,
                cumulateddepreciation: card.CumulatedDepreciation !== undefined && card.CumulatedDepreciation !== null ? card.CumulatedDepreciation : 0,
                dailyexpense: card.DailyExpense !== undefined && card.DailyExpense !== null ? card.DailyExpense : 0,
                DailyExpense: card.DailyExpense !== undefined && card.DailyExpense !== null ? card.DailyExpense : 0
            }));
            
            // Store all data and render with pagination
            allAssetData = assetData;
            currentAssetPage = 1;
            renderAssetTable(assetData, false); // false = regular view
        })
        .catch(error => {
            console.error('Error loading asset cards:', error);
            
            // Use shared component for error message if available
            if (typeof Silicon4Message !== 'undefined' && Silicon4Message.error) {
                Silicon4Message.error('load-assets-failed');
            }
            
            assetListContainer.innerHTML = `
                <div class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Error loading asset cards</h3>
                    <p class="mt-1 text-sm text-gray-500">Please try again or contact support.</p>
                </div>
            `;
        });
}

// Pagination helper functions
function changeAssetPage(page) {
    if (page < 1 || page > totalAssetPages) return;
    currentAssetPage = page;
    applyAssetFiltersAndPagination();
}

function updateAssetPaginationInfo(filteredCount, displayedCount, startIndex) {
    const paginationInfo = document.getElementById('asset-pagination-info');
    if (paginationInfo) {
        if (filteredCount === 0) {
            paginationInfo.textContent = 'No items found';
        } else {
            const endIndex = Math.min(startIndex + displayedCount, filteredCount);
            paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${filteredCount} items`;
        }
    }
    
    // Update prev/next buttons
    const prevBtn = document.getElementById('asset-pagination-prev');
    const nextBtn = document.getElementById('asset-pagination-next');
    if (prevBtn) {
        prevBtn.disabled = currentAssetPage === 1;
    }
    if (nextBtn) {
        nextBtn.disabled = currentAssetPage === totalAssetPages || totalAssetPages === 0;
    }
}

function generateAssetPaginationButtons() {
    const paginationButtons = document.getElementById('asset-pagination-buttons');
    if (!paginationButtons) return;
    
    paginationButtons.innerHTML = '';
    
    if (totalAssetPages <= 1) return;
    
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentAssetPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalAssetPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.className = `px-2 py-1 text-xs rounded-md ${
            i === currentAssetPage 
                ? 'bg-blue-400 text-white hover:bg-blue-500' 
                : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
        }`;
        button.addEventListener('click', () => changeAssetPage(i));
        paginationButtons.appendChild(button);
    }
}

function renderAssetTable(data, isBalanceView = false) {
    const assetListContainer = document.getElementById('asset-list-container');
    if (!assetListContainer) return;
    
    if (data.length === 0) {
        assetListContainer.innerHTML = `
            <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No asset cards found</h3>
                <p class="mt-1 text-sm text-gray-500">No asset cards match the current filter criteria.</p>
            </div>
        `;
        // Hide pagination
        const paginationContainer = document.getElementById('asset-pagination-container');
        if (paginationContainer) {
            paginationContainer.classList.add('hidden');
        }
        return;
    }
    
    // Apply filters first
    const codeFilter = document.getElementById('filter-asset-code');
    const nameFilter = document.getElementById('filter-asset-name');
    const assetFilter = document.getElementById('filter-asset-asset');
    const typeFilter = document.getElementById('filter-asset-type');
    const codeTerm = codeFilter ? codeFilter.value.toLowerCase().trim() : '';
    const nameTerm = nameFilter ? nameFilter.value.toLowerCase().trim() : '';
    const assetTerm = assetFilter ? assetFilter.value.toLowerCase().trim() : '';
    const typeTerm = typeFilter ? typeFilter.value.toLowerCase().trim() : '';
    
    let filteredData = data.filter(item => {
        const code = (item.assetcardcode || item.code || '').toLowerCase();
        const name = (item.assetcardname || item.name || '').toLowerCase();
        const asset = (item.assetname || '').toLowerCase();
        const type = (item.assettypename || '').toLowerCase();
        const codeMatch = !codeTerm || code.includes(codeTerm);
        const nameMatch = !nameTerm || name.includes(nameTerm);
        const assetMatch = !assetTerm || asset.includes(assetTerm);
        const typeMatch = !typeTerm || type.includes(typeTerm);
        return codeMatch && nameMatch && assetMatch && typeMatch;
    });
    
    // Calculate pagination
    totalAssetPages = Math.ceil(filteredData.length / assetPageSize);
    if (totalAssetPages === 0) totalAssetPages = 1; // Ensure at least 1 page
    if (currentAssetPage > totalAssetPages) currentAssetPage = 1;
    
    // Get paginated data
    const startIndex = (currentAssetPage - 1) * assetPageSize;
    const endIndex = startIndex + assetPageSize;
    const paginatedData = filteredData.slice(startIndex, endIndex);
    
    // Update pagination info
    updateAssetPaginationInfo(filteredData.length, paginatedData.length, startIndex);
    
    // Render table
    if (isBalanceView) {
        renderBalanceViewTable(paginatedData);
                        } else {
        renderRegularViewTable(paginatedData);
    }
    
    // Show pagination if needed
    const paginationContainer = document.getElementById('asset-pagination-container');
    if (paginationContainer) {
        if (totalAssetPages > 1) {
            paginationContainer.classList.remove('hidden');
            paginationContainer.classList.add('flex');
            generateAssetPaginationButtons();
            } else {
            paginationContainer.classList.add('hidden');
            paginationContainer.classList.remove('flex');
        }
    }
    
    // Initialize filter functionality
    initializeAssetSearchFilter();
}

function renderBalanceViewTable(data) {
    const assetListContainer = document.getElementById('asset-list-container');
    if (!assetListContainer) return;
    
    let assetsHtml = `
        <div class="space-y-0">
            <div style="display: grid; grid-template-columns: 60px 1fr 1fr 0.625fr 1fr 1fr 1fr 1fr 1fr 1fr 80px 80px; gap: 0;" class="px-1 py-1 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-500 uppercase tracking-wider">
                <div class="border-r border-gray-300 px-1">
                    <div class="mb-1">Код</div>
                    <input type="text" 
                           id="filter-asset-code" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="border-r border-gray-300 px-1">
                    <div class="mb-1">Хөрөнгийн картын нэр</div>
                    <input type="text" 
                           id="filter-asset-name" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="border-r border-gray-300 px-1">
                    <div class="mb-1">Хөрөнгө</div>
                    <input type="text" 
                           id="filter-asset-asset" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="border-r border-gray-300 px-1">
                    <div class="mb-1">Төрөл</div>
                    <input type="text" 
                           id="filter-asset-type" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="border-r border-gray-300 px-1 text-right">Нэгж.өртөг</div>
                <div class="border-r border-gray-300 px-1 text-right">Нэгж.үнэ</div>
                <div class="border-r border-gray-300 px-1 text-right">Эцсийн тоо</div>
                <div class="border-r border-gray-300 px-1 text-right">Эцсийн өртөг</div>
                <div class="border-r border-gray-300 px-1 text-right">Элэгдэл</div>
                <div class="border-r border-gray-300 px-1 text-right">Өдрийн зардал</div>
                <div class="border-r border-gray-300 px-1 text-center">Сонгох</div>
                <div class="px-1 text-center">Үйлдэл</div>
            </div>
    `;
    
    data.forEach(item => {
        const assetCardId = item.assetcardid || item.id || '';
        const assetCardCode = item.assetcardcode || item.code || '-';
        const assetCardName = item.assetcardname || item.name || '';
        const assetName = item.assetname || '-';
        const assetTypeName = item.assettypename || '-';
        const unitCost = item.unitcost !== undefined && item.unitcost !== null ? parseFloat(item.unitcost).toFixed(6) : (item.unitCost || '-');
        const unitPrice = item.unitprice !== undefined && item.unitprice !== null ? parseFloat(item.unitprice).toFixed(6) : (item.unitPrice || '-');
        const endingQuantity = item.endingquantity !== undefined && item.endingquantity !== null ? parseFloat(item.endingquantity).toFixed(6) : '-';
        const endingCost = item.endingcost !== undefined && item.endingcost !== null ? parseFloat(item.endingcost).toFixed(2) : '-';
        const baseCumDep = item.cumulateddepreciation !== undefined && item.cumulateddepreciation !== null ? parseFloat(item.cumulateddepreciation) : null;
        const expenseDep = item.depreciationexpense !== undefined && item.depreciationexpense !== null ? parseFloat(item.depreciationexpense) : null;
        const totalExpenseValue = item.totalexpense !== undefined && item.totalexpense !== null ? parseFloat(item.totalexpense) : null;
        const hasCombinedDepreciation = baseCumDep !== null || expenseDep !== null;
        const combinedDepreciationValue = (baseCumDep || 0) + (expenseDep || 0);
        const cumulatedDepreciation = hasCombinedDepreciation ? combinedDepreciationValue.toFixed(2) : '-';
        const dailyExpense = item.dailyexpense !== undefined && item.dailyexpense !== null ? parseFloat(item.dailyexpense).toFixed(6) : '-';
        
        const formattedAssetCardName = assetCardCode && assetCardCode !== '-' ? 
            `${assetCardCode} - ${assetCardName}` : assetCardName;
        
        const unitCostForSelect = item.unitcost !== undefined && item.unitcost !== null ? item.unitcost.toString() : (item.unitCost || '');
        const unitPriceForSelect = item.unitprice !== undefined && item.unitprice !== null ? item.unitprice.toString() : (item.unitPrice || '');
        const cumulatedDepreciationForSelect = baseCumDep !== null ? baseCumDep.toString() : '0';
        const dailyExpenseForSelect = item.dailyexpense !== undefined && item.dailyexpense !== null ? item.dailyexpense.toString() : '0';
        const depreciationExpenseForSelect = expenseDep !== null ? expenseDep.toString() : '0';
        const totalExpenseForSelect = totalExpenseValue !== null ? totalExpenseValue.toString() : combinedDepreciationValue.toString();
        
        assetsHtml += `
            <div style="display: grid; grid-template-columns: 60px 1fr 1fr 0.625fr 1fr 1fr 1fr 1fr 1fr 1fr 80px 80px; gap: 0;" class="px-1 py-1 bg-white border-b border-gray-300 hover:bg-gray-50 transition-colors cursor-pointer asset-row" 
                 data-asset-code="${assetCardCode.toLowerCase()}" 
                 data-asset-name="${assetCardName.toLowerCase()}" 
                 data-asset-type="${assetName.toLowerCase()}"
                 onclick="selectAsset('${assetCardId}', '${formattedAssetCardName}', '${assetName}', '${unitCostForSelect}', '${unitPriceForSelect}', '${cumulatedDepreciationForSelect}', '${dailyExpenseForSelect}', '${depreciationExpenseForSelect}', '${totalExpenseForSelect}')">
                <div class="flex items-center border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${assetCardCode}</span>
                </div>
                <div class="flex items-center border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${assetCardName}</span>
                </div>
                <div class="flex items-center border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${assetName}</span>
                </div>
                <div class="flex items-center border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${assetTypeName}</span>
                </div>
                <div class="flex items-center justify-end border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${unitCost}</span>
                </div>
                <div class="flex items-center justify-end border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${unitPrice}</span>
                </div>
                <div class="flex items-center justify-end border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${endingQuantity}</span>
                </div>
                <div class="flex items-center justify-end border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${endingCost}</span>
                </div>
                <div class="flex items-center justify-end border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${cumulatedDepreciation}</span>
                </div>
                <div class="flex items-center justify-end border-r border-gray-300 px-1">
                    <span class="text-sm text-gray-900">${dailyExpense}</span>
                </div>
                <div class="flex items-center justify-center border-r border-gray-300 px-1">
                    <button onclick="event.stopPropagation(); selectAsset('${assetCardId}', '${formattedAssetCardName}', '${assetName}', '${unitCostForSelect}', '${unitPriceForSelect}', '${cumulatedDepreciationForSelect}', '${dailyExpenseForSelect}', '${depreciationExpenseForSelect}', '${totalExpenseForSelect}')" 
                            class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors">
                        Сонгох
                    </button>
                </div>
                <div class="flex items-center justify-center space-x-1 px-1">
                    <button onclick="event.stopPropagation(); updateAsset('${assetCardId}', '${assetCardName}')" 
                            class="inline-flex items-center p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors"
                            title="Update Asset Card">
                        <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    </button>
                </div>
            </div>
        `;
    });
    
    assetsHtml += '</div>';
    assetListContainer.innerHTML = assetsHtml;
}

function renderRegularViewTable(data) {
    const assetListContainer = document.getElementById('asset-list-container');
    if (!assetListContainer) return;
    
    let assetsHtml = `
        <div class="space-y-0">
            <div class="grid grid-cols-12 gap-0 px-0 py-3 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-600 uppercase tracking-wider">
                <div class="col-span-1 px-4 border-r border-gray-200">
                    <div class="mb-1">Код</div>
                    <input type="text" 
                           id="filter-asset-code" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="col-span-3 px-4 border-r border-gray-200">
                    <div class="mb-1">Хөрөнгийн картын нэр</div>
                    <input type="text" 
                           id="filter-asset-name" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="col-span-3 px-4 border-r border-gray-200">
                    <div class="mb-1">Хөрөнгө</div>
                    <input type="text" 
                           id="filter-asset-asset" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="col-span-1 px-4 border-r border-gray-200">
                    <div class="mb-1">Төрөл</div>
                    <input type="text" 
                           id="filter-asset-type" 
                           placeholder="Filter..." 
                           class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="col-span-1 px-4 border-r border-gray-200 text-right">Нэгжийн өртөг</div>
                <div class="col-span-1 px-4 border-r border-gray-200 text-right">Нэгжийн үнэ</div>
                <div class="col-span-1 px-4 border-r border-gray-200">Ажилтан</div>
                <div class="col-span-1 px-4 text-center">Сонгох</div>
            </div>
    `;
    
    data.forEach(item => {
        const assetCardId = item.assetcardid || item.id || '';
        const assetCardCode = item.assetcardcode || item.code || '-';
        const assetCardName = item.assetcardname || item.name || '';
        const assetName = item.assetname || '-';
        const assetTypeName = item.assettypename || '-';
        const employee = item.employee || '-';
        const unitCost = item.unitcost !== undefined && item.unitcost !== null ? parseFloat(item.unitcost).toFixed(6) : (item.unitCost || '-');
        const unitPrice = item.unitprice !== undefined && item.unitprice !== null ? parseFloat(item.unitprice).toFixed(6) : (item.unitPrice || '-');
        
        const formattedAssetCardName = assetCardCode && assetCardCode !== '-' ? 
            `${assetCardCode} - ${assetCardName}` : assetCardName;
        
        const unitCostForSelect = (item.unitcost !== undefined && item.unitcost !== null ? item.unitcost.toString() : '') || item.unitCost || '';
        const unitPriceForSelect = (item.unitprice !== undefined && item.unitprice !== null ? item.unitprice.toString() : '') || item.unitPrice || '';
        const baseCumDep = item.cumulateddepreciation !== undefined && item.cumulateddepreciation !== null ? parseFloat(item.cumulateddepreciation) : null;
        const expenseDep = item.depreciationexpense !== undefined && item.depreciationexpense !== null ? parseFloat(item.depreciationexpense) : null;
        const totalExpenseValue = item.totalexpense !== undefined && item.totalexpense !== null ? parseFloat(item.totalexpense) : null;
        const hasCombinedDepreciation = baseCumDep !== null || expenseDep !== null;
        const combinedDepreciationValue = (baseCumDep || 0) + (expenseDep || 0);
        const cumulatedDepreciationForSelect = baseCumDep !== null ? baseCumDep.toString() : '0';
        const dailyExpenseForSelect = (item.dailyexpense !== undefined && item.dailyexpense !== null ? item.dailyexpense.toString() : '') || (item.DailyExpense !== undefined && item.DailyExpense !== null ? item.DailyExpense.toString() : '0');
        const depreciationExpenseForSelect = expenseDep !== null ? expenseDep.toString() : '0';
        const totalExpenseForSelect = totalExpenseValue !== null ? totalExpenseValue.toString() : combinedDepreciationValue.toString();
                    
                    assetsHtml += `
                        <div class="grid grid-cols-12 gap-0 px-0 py-3 bg-white border-b border-gray-200 hover:bg-blue-50 transition-colors asset-row cursor-pointer" 
                             data-asset-code="${assetCardCode.toLowerCase()}" 
                             data-asset-name="${assetCardName.toLowerCase()}" 
                             data-asset-type="${assetName.toLowerCase()}"
                             data-employee="${employee.toLowerCase()}"
                 onclick="selectAsset('${assetCardId}', '${formattedAssetCardName}', '${assetName}', '${unitCostForSelect}', '${unitPriceForSelect}', '${cumulatedDepreciationForSelect}', '${dailyExpenseForSelect}', '${depreciationExpenseForSelect}', '${totalExpenseForSelect}')">
                            <div class="col-span-1 px-4 border-r border-gray-200 flex items-center">
                    <span class="text-sm text-gray-900">${assetCardCode}</span>
                            </div>
                            <div class="col-span-3 px-4 border-r border-gray-200 flex items-center">
                    <span class="text-sm text-gray-900">${assetCardName}</span>
                            </div>
                            <div class="col-span-3 px-4 border-r border-gray-200 flex items-center">
                                <span class="text-sm text-gray-900">${assetName}</span>
                            </div>
                            <div class="col-span-1 px-4 border-r border-gray-200 flex items-center">
                    <span class="text-sm text-gray-900">${assetTypeName}</span>
                            </div>
                <div class="col-span-1 px-4 border-r border-gray-200 flex items-center justify-end">
                    <span class="text-sm text-gray-900">${unitCost}</span>
                </div>
                <div class="col-span-1 px-4 border-r border-gray-200 flex items-center justify-end">
                    <span class="text-sm text-gray-900">${unitPrice}</span>
                            </div>
                            <div class="col-span-1 px-4 border-r border-gray-200 flex items-center">
                                <span class="text-sm text-gray-900">${employee}</span>
                            </div>
                            <div class="col-span-1 px-4 flex items-center justify-center">
                    <button onclick="event.stopPropagation(); selectAsset('${assetCardId}', '${formattedAssetCardName}', '${assetName}', '${unitCostForSelect}', '${unitPriceForSelect}', '${cumulatedDepreciationForSelect}', '${dailyExpenseForSelect}', '${depreciationExpenseForSelect}', '${totalExpenseForSelect}')" 
                            class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors">
                        Сонгох
                                </button>
                            </div>
                        </div>
                    `;
            });
            
            assetsHtml += '</div>';
            assetListContainer.innerHTML = assetsHtml;
}

function applyAssetFiltersAndPagination() {
    if (allAssetData.length === 0) return;
    
    // Determine if we're in balance view or regular view
    const isBalanceView = allAssetData.length > 0 && allAssetData[0].hasOwnProperty('endingquantity');
    renderAssetTable(allAssetData, isBalanceView);
}

// Initialize asset search filter functionality
function initializeAssetSearchFilter() {
    const codeFilter = document.getElementById('filter-asset-code');
    const nameFilter = document.getElementById('filter-asset-name');
    const assetFilter = document.getElementById('filter-asset-asset');
    const typeFilter = document.getElementById('filter-asset-type');
    
    if (!codeFilter || !nameFilter) return;
    
    // Debounce function for filter input
    let filterTimeout;
    function applyAssetFilters() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
            // Reset to page 1 when filtering
            currentAssetPage = 1;
            // Re-render with filters and pagination
            applyAssetFiltersAndPagination();
        }, 300);
    }
    
    // Add event listeners to filter inputs
    codeFilter.addEventListener('input', applyAssetFilters);
    nameFilter.addEventListener('input', applyAssetFilters);
    if (assetFilter) assetFilter.addEventListener('input', applyAssetFilters);
    if (typeFilter) typeFilter.addEventListener('input', applyAssetFilters);
    
    // Clear all filters function
    window.clearAllAssetFilters = function() {
        codeFilter.value = '';
        nameFilter.value = '';
        if (assetFilter) assetFilter.value = '';
        if (typeFilter) typeFilter.value = '';
        currentAssetPage = 1;
        applyAssetFiltersAndPagination();
    };
    
    // Clear filters when modal is closed
    const modal = document.getElementById('asset-selection-modal');
    if (modal) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (modal.classList.contains('hidden')) {
                        // Clear all filters
                        codeFilter.value = '';
                        nameFilter.value = '';
                        if (assetFilter) assetFilter.value = '';
                        if (typeFilter) typeFilter.value = '';
                        currentAssetPage = 1;
                        allAssetData = [];
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true });
    }
}
</script>
