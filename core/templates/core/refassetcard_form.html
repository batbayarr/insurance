{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Silicon-AI Accounting{% endblock %}

{% block content %}
<div class="bg-gray-100 p-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-3">
            <div class="mb-3">
                <h1 class="text-base lg:text-lg xl:text-xl font-medium text-gray-900">{% if asset_card %}Үндсэн хөрөнгийн карт шинэчлэх{% else %}Үндсэн хөрөнгийн карт үүсгэх{% endif %}</h1>
            </div>
            <p class="text-xs text-gray-600">{% if asset_card %}Карт шинэчлэх{% else %}Шинэ карт үүсгэх{% endif %}</p>
        </div>
        
        <!-- Form -->
        <div class="bg-white shadow rounded p-2 max-w-2xl">
        <form method="post" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="rounded-md bg-red-50 p-4 mb-2">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-xs font-medium text-red-800">
                            Илгээлтэд алдаа гарлаа
                        </h3>
                        <div class="mt-2 text-xs text-red-700">
                            <ul class="list-disc pl-5 space-y-1">
                                {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="border-gray-300 border">
                <!-- Asset -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.AssetId.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            ХӨРӨНГИЙН НЭР: <span class="text-red-500">*</span>
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {% if selected_asset %}
                                <select id="id_AssetId" name="AssetId" disabled class="w-full px-2 py-1 text-xs border border-gray-300 rounded bg-gray-100 cursor-not-allowed">
                                    <option value="{{ selected_asset.AssetId }}" selected>{{ selected_asset.AssetCode }} - {{ selected_asset.AssetName }}</option>
                                </select>
                                <input type="hidden" name="AssetId" value="{{ selected_asset.AssetId }}">
                            {% else %}
                                {{ form.AssetId }}
                            {% endif %}
                        </div>
                        {% if form.AssetId.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.AssetId.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Employee -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="EmployeeIdDisplay" class="text-xs text-gray-700 font-normal uppercase">
                            ЭД ХАРИУЦАГЧ:
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_input]:border [&_input]:text-xs w-full">
                            <input type="text"
                                   id="EmployeeIdDisplay"
                                   name="EmployeeIdDisplay"
                                   readonly
                                   placeholder="Эд хариуцлагчийг сонгох..."
                                   onclick="openClientPopup(this, null, { clientTypeId: 3 })"
                                   value="{% if asset_card and asset_card.ClientId %}{{ asset_card.ClientId.ClientCode }} - {{ asset_card.ClientId.ClientName }}{% endif %}"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded cursor-pointer bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <input type="hidden" id="id_ClientId" name="ClientId" value="{{ form.ClientId.value|default:'' }}">
                        </div>
                        {% if form.EmployeeId.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.EmployeeId.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Asset Card Code -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.AssetCardCode.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            КАРТЫН №:
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.AssetCardCode }}
                        </div>
                        {% if form.AssetCardCode.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.AssetCardCode.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Asset Card Name -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.AssetCardName.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            ТАЙЛБАР
                                                </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.AssetCardName }}
                        </div>
                        {% if form.AssetCardName.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.AssetCardName.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Manufactured Date -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.ManufacturedDate.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            ҮЙЛДВЭРЛЭСЭН ОГНОО:
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.ManufacturedDate }}
                        </div>
                        {% if form.ManufacturedDate.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.ManufacturedDate.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Received Date -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.ReceivedDate.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            АШИГЛАЛТАНД АВСАН ОГНОО:
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.ReceivedDate }}
                        </div>
                        {% if form.ReceivedDate.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.ReceivedDate.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Months To Use -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.MonthsToUse.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            АШИГЛАХ САР:
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.MonthsToUse }}
                        </div>
                        {% if form.MonthsToUse.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.MonthsToUse.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Unit Cost -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.UnitCost.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            НЭГЖ ӨРТӨГ:
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.UnitCost }}
                        </div>
                        {% if form.UnitCost.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.UnitCost.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Unit Price -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.UnitPrice.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            НЭГЖ ҮНЭ:
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.UnitPrice }}
                        </div>
                        {% if form.UnitPrice.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.UnitPrice.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Daily Expense -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.DailyExpense.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            ӨДРИЙН ЭЛЭГДЭЛ:
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.DailyExpense }}
                        </div>
                        {% if form.DailyExpense.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.DailyExpense.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Cumulated Depreciation -->
                <div class="grid grid-cols-[1fr_4fr] border-b border-gray-200 p-2">
                    <div class="flex items-center border-r border-gray-200 pr-2">
                        <label for="{{ form.CumulatedDepreciation.id_for_label }}" class="text-xs text-gray-700 font-normal uppercase">
                            ЭХНИЙ ЭЛЭГДЭЛ:
                        </label>
                    </div>
                    <div class="flex justify-start pl-2">
                        <div class="[&_input]:border-gray-300 [&_select]:border-gray-300 [&_input]:border [&_select]:border [&_input]:text-xs [&_select]:text-xs">
                            {{ form.CumulatedDepreciation }}
                        </div>
                        {% if form.CumulatedDepreciation.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.CumulatedDepreciation.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex items-center gap-2 mt-4 pt-4 border-t">
                <div class="flex gap-2">
                    <a href="{% url 'core:ref_asset_card_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Цуцлах
                    </a>
                    <button type="submit" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        {% if asset_card %}
                        Шинэчлэх
                        {% else %}
                        Нэмэх
                        {% endif %}
                    </button>
                </div>
            </div>
        </form>
        </div>
    </div>
</div>

<script>
// Number formatting utilities
function normalizeNumericValue(value) {
    if (value === undefined || value === null) {
        return '';
    }
    return String(value).replace(/,/g, '').trim();
}

function parseNumericValue(value, defaultValue = 0) {
    const normalized = normalizeNumericValue(value);
    if (normalized === '') {
        return defaultValue;
    }
    const parsed = parseFloat(normalized);
    return isNaN(parsed) ? defaultValue : parsed;
}

function formatNumericInput(value, decimals = 2) {
    if (value === undefined || value === null || value === '') {
        return '';
    }
    
    // Convert to string and trim
    const strValue = String(value).trim();
    if (strValue === '' || strValue === '-') {
        return '';
    }
    
    const normalized = normalizeNumericValue(strValue);
    if (normalized === '' || normalized === '-') {
        return '';
    }
    
    // Handle partial decimal inputs (e.g., "123." or "123.4")
    // Don't format if it ends with a decimal point (user might still be typing)
    if (normalized.endsWith('.')) {
        // Format the integer part with thousand separators, keep the decimal point
        const intPart = normalized.slice(0, -1);
        if (intPart === '' || intPart === '-') {
            return normalized;
        }
        const num = parseFloat(intPart);
        if (isNaN(num) || !isFinite(num)) {
            return normalized;
        }
        try {
            return num.toLocaleString('en-US', { maximumFractionDigits: 0 }) + '.';
        } catch (e) {
            return normalized;
        }
    }
    
    const num = parseFloat(normalized);
    if (isNaN(num) || !isFinite(num)) {
        // Return original normalized value if it looks like it might be a number
        // This preserves partial inputs like "123." or "-"
        if (/^-?\d*\.?\d*$/.test(normalized)) {
            return normalized;
        }
        // If it doesn't look like a number, return original value to prevent clearing
        // The validation will catch invalid values later
        return strValue;
    }
    
    // Format with specified decimal places and thousand separators
    try {
        return num.toLocaleString('en-US', { 
            minimumFractionDigits: decimals, 
            maximumFractionDigits: decimals 
        });
    } catch (e) {
        // Fallback to manual formatting if toLocaleString fails
        return num.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
}

function formatNumericField(input, decimals = 2) {
    if (!input) return;
    const currentValue = input.value;
    // Don't format if the field is empty or just whitespace
    if (!currentValue || currentValue.trim() === '') {
        return;
    }
    
    // Preserve the original value in case formatting fails
    const originalValue = currentValue.trim();
    const formatted = formatNumericInput(currentValue, decimals);
    
    // Only update if:
    // 1. The formatted value is different from current
    // 2. The formatted value is not empty (to prevent clearing)
    // 3. The formatted value is a valid number (not NaN when parsed)
    if (formatted !== '' && formatted !== currentValue) {
        // Double-check that formatted value is valid
        const normalized = normalizeNumericValue(formatted);
        if (normalized !== '' && !isNaN(parseFloat(normalized))) {
            input.value = formatted;
        } else {
            // If formatting produced invalid result, keep original value
            input.value = originalValue;
        }
    } else if (formatted === '' && originalValue !== '') {
        // If formatting would clear a non-empty value, keep original
        input.value = originalValue;
    }
}

// Function to calculate days of usage from ReceivedDate and MonthsToUse
function calculateDaysOfUsage(receivedDate, monthsToUse) {
    if (!receivedDate || !monthsToUse || monthsToUse <= 0) {
        return null;
    }
    
    const startDate = new Date(receivedDate);
    const endDate = new Date(startDate);
    
    // Add months to the received date
    const month = endDate.getMonth();
    const year = endDate.getFullYear();
    const day = endDate.getDate();
    
    // Calculate new month and year
    let newMonth = month + parseInt(monthsToUse);
    let newYear = year;
    
    // Handle year rollover
    while (newMonth >= 12) {
        newMonth -= 12;
        newYear += 1;
    }
    
    // Set the new date
    endDate.setFullYear(newYear, newMonth, day);
    
    // Handle cases where the day doesn't exist in the target month (e.g., Jan 31 -> Feb 28)
    if (endDate.getDate() !== day) {
        endDate.setDate(0); // Go to last day of previous month
    }
    
    // Calculate difference in days
    const diffTime = endDate - startDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays > 0 ? diffDays : null;
}

// Function to calculate DailyExpense
function calculateDailyExpense() {
    try {
    const receivedDateInput = document.getElementById('id_ReceivedDate');
    const monthsToUseInput = document.getElementById('id_MonthsToUse');
    const unitCostInput = document.getElementById('id_UnitCost');
        const unitPriceInput = document.getElementById('id_UnitPrice');
    const dailyExpenseInput = document.getElementById('id_DailyExpense');
    
        if (!receivedDateInput || !monthsToUseInput || !dailyExpenseInput) {
            console.log('calculateDailyExpense: Missing required inputs', {
                receivedDateInput: !!receivedDateInput,
                monthsToUseInput: !!monthsToUseInput,
                dailyExpenseInput: !!dailyExpenseInput
            });
        return;
    }
    
        // Get values and normalize them (remove commas, etc.)
        const receivedDate = receivedDateInput.value ? receivedDateInput.value.trim() : '';
        const monthsToUseRaw = monthsToUseInput.value ? normalizeNumericValue(String(monthsToUseInput.value)) : '';
        
        // Use UnitPrice if available, otherwise fall back to UnitCost
        let unitValueRaw = '';
        if (unitPriceInput && unitPriceInput.value && unitPriceInput.value.trim() !== '') {
            unitValueRaw = normalizeNumericValue(String(unitPriceInput.value));
        } else if (unitCostInput && unitCostInput.value && unitCostInput.value.trim() !== '') {
            unitValueRaw = normalizeNumericValue(String(unitCostInput.value));
        }
        
        // Parse numeric values - handle empty strings properly
        const monthsToUse = monthsToUseRaw === '' ? 0 : parseFloat(monthsToUseRaw);
        const unitValue = unitValueRaw === '' ? 0 : parseFloat(unitValueRaw);
        
        console.log('calculateDailyExpense: Values', {
            receivedDate,
            monthsToUseRaw,
            monthsToUse,
            unitValueRaw,
            unitValue,
            unitPriceValue: unitPriceInput ? unitPriceInput.value : 'N/A',
            unitCostValue: unitCostInput ? unitCostInput.value : 'N/A'
        });
        
        // Validate inputs - ReceivedDate, MonthsToUse, and UnitPrice/UnitCost must be present and valid
        if (!receivedDate || isNaN(monthsToUse) || monthsToUse <= 0 || isNaN(unitValue) || unitValue <= 0) {
            console.log('calculateDailyExpense: Validation failed', {
                hasReceivedDate: !!receivedDate,
                monthsToUseValid: !isNaN(monthsToUse) && monthsToUse > 0,
                unitValueValid: !isNaN(unitValue) && unitValue > 0
            });
        return;
    }
    
    const daysOfUsage = calculateDaysOfUsage(receivedDate, monthsToUse);
        console.log('calculateDailyExpense: daysOfUsage', daysOfUsage);
    
    if (daysOfUsage && daysOfUsage > 0) {
            const dailyExpense = unitValue / daysOfUsage;
            console.log('calculateDailyExpense: dailyExpense calculated', dailyExpense);
            
            // Format with 2 decimal places and thousand separators
            const formattedValue = formatNumericInput(dailyExpense, 2);
            console.log('calculateDailyExpense: formattedValue', formattedValue);
            
            // Only update if we got a valid formatted value
            if (formattedValue && formattedValue !== '') {
                // Set flag to prevent blur handler from reformatting
                window.dailyExpenseJustCalculated = true;
                
                dailyExpenseInput.value = formattedValue;
        
        // Visual feedback
        dailyExpenseInput.style.backgroundColor = '#dcfce7';
        setTimeout(() => {
            dailyExpenseInput.style.backgroundColor = '';
        }, 2000);
                
                console.log('calculateDailyExpense: Successfully updated DailyExpense');
            } else {
                console.log('calculateDailyExpense: Formatted value is empty');
            }
        } else {
            console.log('calculateDailyExpense: Invalid daysOfUsage', daysOfUsage);
        }
    } catch (error) {
        console.error('calculateDailyExpense: Error', error);
    }
}

// Make function globally accessible
window.calculateDailyExpense = calculateDailyExpense;

// Form validation function
function validateForm() {
    let isValid = true;
    const errors = [];
    
    // Validate AssetId (required)
    const assetIdInput = document.getElementById('id_AssetId');
    const assetIdHidden = document.querySelector('input[name="AssetId"][type="hidden"]');
    const assetIdValue = assetIdInput?.value || assetIdHidden?.value;
    if (!assetIdValue || assetIdValue === '') {
        isValid = false;
        errors.push('Хөрөнгийн нэрийг сонгох шаардлагатай.');
        if (assetIdInput && !assetIdInput.disabled) {
            assetIdInput.classList.add('border-red-500');
        }
    } else {
        if (assetIdInput) {
            assetIdInput.classList.remove('border-red-500');
        }
    }
    
    // Validate MonthsToUse (must be positive if provided)
    const monthsToUseInput = document.getElementById('id_MonthsToUse');
    if (monthsToUseInput && monthsToUseInput.value) {
        const monthsToUse = parseNumericValue(monthsToUseInput.value);
        if (isNaN(monthsToUse) || monthsToUse <= 0) {
            isValid = false;
            errors.push('Ашиглах сар нь эерэг тоо байх ёстой.');
            monthsToUseInput.classList.add('border-red-500');
        } else {
            monthsToUseInput.classList.remove('border-red-500');
        }
    }
    
    // Validate UnitCost (must be positive if provided)
    const unitCostInput = document.getElementById('id_UnitCost');
    if (unitCostInput && unitCostInput.value) {
        const unitCost = parseNumericValue(unitCostInput.value);
        if (isNaN(unitCost) || unitCost <= 0) {
            isValid = false;
            errors.push('Нэгж өртөг нь эерэг тоо байх ёстой.');
            unitCostInput.classList.add('border-red-500');
        } else {
            unitCostInput.classList.remove('border-red-500');
        }
    }
    
    // Validate UnitPrice (must be positive if provided)
    const unitPriceInput = document.getElementById('id_UnitPrice');
    if (unitPriceInput && unitPriceInput.value) {
        const unitPrice = parseNumericValue(unitPriceInput.value);
        if (isNaN(unitPrice) || unitPrice <= 0) {
            isValid = false;
            errors.push('Нэгж үнэ нь эерэг тоо байх ёстой.');
            unitPriceInput.classList.add('border-red-500');
        } else {
            unitPriceInput.classList.remove('border-red-500');
        }
    }
    
    // Validate DailyExpense (must be positive if provided)
    const dailyExpenseInput = document.getElementById('id_DailyExpense');
    if (dailyExpenseInput && dailyExpenseInput.value) {
        const dailyExpense = parseNumericValue(dailyExpenseInput.value);
        if (isNaN(dailyExpense) || dailyExpense <= 0) {
            isValid = false;
            errors.push('Өдрийн элэгдэл нь эерэг тоо байх ёстой.');
            dailyExpenseInput.classList.add('border-red-500');
        } else {
            dailyExpenseInput.classList.remove('border-red-500');
        }
    }
    
    // Validate CumulatedDepreciation (must be non-negative if provided)
    const cumulatedDepInput = document.getElementById('id_CumulatedDepreciation');
    if (cumulatedDepInput && cumulatedDepInput.value) {
        const cumulatedDep = parseNumericValue(cumulatedDepInput.value);
        if (isNaN(cumulatedDep) || cumulatedDep < 0) {
            isValid = false;
            errors.push('Эхний элэгдэл нь сөрөг биш тоо байх ёстой.');
            cumulatedDepInput.classList.add('border-red-500');
        } else {
            cumulatedDepInput.classList.remove('border-red-500');
        }
    }
    
    // Validate UnitCost > CumulatedDepreciation
    if (unitCostInput && cumulatedDepInput && unitCostInput.value && cumulatedDepInput.value) {
        const unitCost = parseNumericValue(unitCostInput.value);
        const cumulatedDep = parseNumericValue(cumulatedDepInput.value);
        if (unitCost <= cumulatedDep) {
            isValid = false;
            errors.push('Нэгжийн өртөг нь эхний элэгдлээс их байх ёстой.');
            unitCostInput.classList.add('border-red-500');
            cumulatedDepInput.classList.add('border-red-500');
        }
    }
    
    // Validate dates if provided
    const manufacturedDateInput = document.getElementById('id_ManufacturedDate');
    if (manufacturedDateInput && manufacturedDateInput.value) {
        const manufacturedDate = new Date(manufacturedDateInput.value);
        if (isNaN(manufacturedDate.getTime())) {
            isValid = false;
            errors.push('Үйлдвэрлэсэн огноо буруу байна.');
            manufacturedDateInput.classList.add('border-red-500');
        } else {
            manufacturedDateInput.classList.remove('border-red-500');
        }
    }
    
    const receivedDateInput = document.getElementById('id_ReceivedDate');
    if (receivedDateInput && receivedDateInput.value) {
        const receivedDate = new Date(receivedDateInput.value);
        if (isNaN(receivedDate.getTime())) {
            isValid = false;
            errors.push('Ашиглалтанд авсан огноо буруу байна.');
            receivedDateInput.classList.add('border-red-500');
        } else {
            receivedDateInput.classList.remove('border-red-500');
        }
        
        // Validate ReceivedDate >= ManufacturedDate if both are provided
        if (manufacturedDateInput && manufacturedDateInput.value) {
            const manufacturedDate = new Date(manufacturedDateInput.value);
            if (receivedDate < manufacturedDate) {
                isValid = false;
                errors.push('Ашиглалтанд авсан огноо нь үйлдвэрлэсэн огнооноос хойш байх ёстой.');
                receivedDateInput.classList.add('border-red-500');
                manufacturedDateInput.classList.add('border-red-500');
            }
        }
    }
    
    return { isValid, errors };
}

document.addEventListener('DOMContentLoaded', function() {
    // Pre-populate AssetId from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const selectedAssetId = urlParams.get('selected_asset');
    if (selectedAssetId) {
        const assetSelect = document.getElementById('id_AssetId');
        if (assetSelect && !assetSelect.disabled) {
            assetSelect.value = selectedAssetId;
            // Disable the field so user cannot change it
            assetSelect.disabled = true;
            assetSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
            // Create hidden input to ensure value is submitted
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'AssetId';
            hiddenInput.value = selectedAssetId;
            assetSelect.parentNode.appendChild(hiddenInput);
        }
    }
    
    // Format initial values for numeric fields (only if they have values)
    const numericFields = [
        { id: 'id_UnitCost', decimals: 2 },
        { id: 'id_UnitPrice', decimals: 2 },
        { id: 'id_DailyExpense', decimals: 2 },
        { id: 'id_CumulatedDepreciation', decimals: 2 }
    ];
    
    // Also handle MonthsToUse separately (integer, no decimals)
    // Note: monthsToUseInput will be declared again later for event listeners
    const monthsToUseInputSetup = document.getElementById('id_MonthsToUse');
    if (monthsToUseInputSetup) {
        if (monthsToUseInputSetup.type === 'number') {
            monthsToUseInputSetup.type = 'text';
            monthsToUseInputSetup.setAttribute('inputmode', 'numeric');
        }
    }
    
    // Ensure numeric fields are text inputs (not number inputs) to support formatting
    numericFields.forEach(field => {
        const input = document.getElementById(field.id);
        if (input) {
            // Change to text input if it's a number input (to support comma formatting)
            if (input.type === 'number') {
                input.type = 'text';
                input.setAttribute('inputmode', 'numeric');
            }
            
            // Format initial value if present
            if (input.value && input.value.trim() !== '') {
                const normalized = normalizeNumericValue(input.value);
                if (normalized !== '' && !isNaN(parseFloat(normalized))) {
                    formatNumericField(input, field.decimals);
                }
            }
        }
    });
    
    // Make DailyExpense read-only (calculated field)
    const dailyExpenseInput = document.getElementById('id_DailyExpense');
    if (dailyExpenseInput) {
        dailyExpenseInput.setAttribute('readonly', 'readonly');
        dailyExpenseInput.classList.add('bg-gray-100', 'cursor-not-allowed');
    }
    
    // Auto-fill UnitPrice from UnitCost on page load if UnitCost has value
    const unitCostInputForInit = document.getElementById('id_UnitCost');
    const unitPriceInputForInit = document.getElementById('id_UnitPrice');
    if (unitCostInputForInit && unitPriceInputForInit) {
        const unitCostValue = unitCostInputForInit.value;
        const unitPriceValue = unitPriceInputForInit.value;
        // Only auto-fill if UnitCost has value and UnitPrice is empty
        if (unitCostValue && unitCostValue.trim() !== '' && (!unitPriceValue || unitPriceValue.trim() === '')) {
            unitPriceInputForInit.value = unitCostValue;
            // Format it after a short delay
            setTimeout(function() {
                formatNumericField(unitPriceInputForInit, 2);
            }, 100);
        }
    }
    
    // Track if DailyExpense was just calculated to prevent reformatting
    window.dailyExpenseJustCalculated = false;
    
    // Add event listeners for numeric field formatting
    numericFields.forEach(field => {
        const input = document.getElementById(field.id);
        if (input) {
            const isDailyExpense = field.id === 'id_DailyExpense';
            
            // Format on blur - this is when user finishes typing
            input.addEventListener('blur', function() {
                // Skip formatting for DailyExpense if it was just calculated
                if (isDailyExpense && window.dailyExpenseJustCalculated) {
                    window.dailyExpenseJustCalculated = false;
                    return;
                }
                
                // Only format if there's a value
                const currentValue = input.value;
                if (currentValue && currentValue.trim() !== '') {
                    // Store original value before formatting
                    const originalValue = currentValue.trim();
                    formatNumericField(input, field.decimals);
                    // If formatting cleared the value, restore original
                    if (!input.value || input.value.trim() === '') {
                        input.value = originalValue;
                    }
                }
            });
            
            // Remove error styling when user starts typing
            input.addEventListener('input', function(e) {
                e.target.classList.remove('border-red-500');
                // If user manually edits DailyExpense, allow formatting
                if (isDailyExpense) {
                    window.dailyExpenseJustCalculated = false;
                }
            });
            
            // Format on paste
            input.addEventListener('paste', function(e) {
                setTimeout(() => {
                    // Clean pasted value first, then format
                    const value = e.target.value;
                    const cleaned = normalizeNumericValue(value);
                    if (cleaned !== value && cleaned !== '') {
                        e.target.value = cleaned;
                    }
                    if (e.target.value && e.target.value.trim() !== '') {
                        formatNumericField(input, field.decimals);
                    }
                }, 10);
            });
        }
    });
    
    // Add event listeners for automatic calculation
    // Note: dailyExpenseInput already declared above
    const receivedDateInput = document.getElementById('id_ReceivedDate');
    const monthsToUseInput = document.getElementById('id_MonthsToUse');
    const unitCostInput = document.getElementById('id_UnitCost');
    
    // Immediate calculation function (for change events)
    function immediateCalculation() {
        console.log('immediateCalculation: called');
        calculateDailyExpense();
    }
    
    // Function to trigger calculation after formatting completes
    function triggerCalculation() {
        console.log('triggerCalculation: called');
        // Use setTimeout to ensure any blur formatting completes first
        setTimeout(function() {
            calculateDailyExpense();
        }, 250);
    }
    
    if (receivedDateInput) {
        console.log('Setting up event listeners for receivedDateInput');
        receivedDateInput.addEventListener('change', immediateCalculation);
        receivedDateInput.addEventListener('blur', triggerCalculation);
        receivedDateInput.addEventListener('input', function() {
            clearTimeout(window.calculationTimeout);
            window.calculationTimeout = setTimeout(calculateDailyExpense, 800);
        });
    } else {
        console.log('receivedDateInput not found');
    }
    
    if (monthsToUseInput) {
        console.log('Setting up event listeners for monthsToUseInput');
        
        // Store previous value to detect changes
        let previousMonthsToUseValue = monthsToUseInput.value || '';
        
        // Function to check if value changed and trigger calculation
        function checkAndCalculateMonthsToUse() {
            const currentValue = monthsToUseInput.value || '';
            if (currentValue !== previousMonthsToUseValue) {
                console.log('monthsToUseInput: value changed from', previousMonthsToUseValue, 'to', currentValue);
                previousMonthsToUseValue = currentValue;
                // Normalize value if needed
                if (currentValue.trim() !== '') {
                    const normalized = normalizeNumericValue(currentValue);
                    if (normalized !== '' && !isNaN(parseFloat(normalized))) {
                        const numValue = parseInt(normalized, 10);
                        if (!isNaN(numValue) && numValue.toString() !== currentValue) {
                            monthsToUseInput.value = numValue.toString();
                            previousMonthsToUseValue = numValue.toString();
                        }
                    }
                }
                // Trigger calculation
                immediateCalculation();
            }
        }
        
        // Change event - fires when value changes and field loses focus
        monthsToUseInput.addEventListener('change', function(e) {
            console.log('monthsToUseInput: change event fired, value:', e.target.value);
            checkAndCalculateMonthsToUse();
        });
        
        // Blur event - fires when field loses focus
        monthsToUseInput.addEventListener('blur', function(e) {
            console.log('monthsToUseInput: blur event fired, value:', e.target.value);
            checkAndCalculateMonthsToUse();
            // Also trigger calculation after a short delay
            setTimeout(function() {
                triggerCalculation();
            }, 100);
        });
        
        // Input event - fires on every keystroke
        monthsToUseInput.addEventListener('input', function(e) {
            console.log('monthsToUseInput: input event fired, value:', e.target.value);
            clearTimeout(window.monthsToUseCalculationTimeout);
            window.monthsToUseCalculationTimeout = setTimeout(function() {
                console.log('monthsToUseInput: triggering calculation after input delay');
                checkAndCalculateMonthsToUse();
            }, 500);
        });
        
        // Also listen for keyup to catch immediate changes
        monthsToUseInput.addEventListener('keyup', function(e) {
            // Trigger on Enter key
            if (e.key === 'Enter') {
                console.log('monthsToUseInput: Enter key pressed');
                checkAndCalculateMonthsToUse();
            }
        });
        
        // Force trigger on paste
        monthsToUseInput.addEventListener('paste', function(e) {
            setTimeout(function() {
                console.log('monthsToUseInput: paste event, triggering calculation');
                checkAndCalculateMonthsToUse();
            }, 10);
        });
    } else {
        console.log('monthsToUseInput not found');
    }
    
    // Function to auto-fill UnitPrice from UnitCost
    function autoFillUnitPrice() {
        const unitPriceInput = document.getElementById('id_UnitPrice');
        if (unitCostInput && unitPriceInput) {
            const unitCostValue = unitCostInput.value;
            if (unitCostValue && unitCostValue.trim() !== '') {
                // Copy the value (will be formatted on blur)
                unitPriceInput.value = unitCostValue;
                // Trigger formatting
                setTimeout(function() {
                    formatNumericField(unitPriceInput, 2);
                }, 100);
            }
        }
    }
    
    if (unitCostInput) {
        console.log('Setting up event listeners for unitCostInput');
        // Auto-fill UnitPrice when UnitCost changes
        unitCostInput.addEventListener('change', function() {
            console.log('unitCostInput: change event');
            autoFillUnitPrice();
            immediateCalculation();
        });
        unitCostInput.addEventListener('blur', function() {
            console.log('unitCostInput: blur event');
            // Auto-fill after formatting completes
            setTimeout(function() {
                autoFillUnitPrice();
            }, 300);
            triggerCalculation();
        });
        unitCostInput.addEventListener('input', function() {
            console.log('unitCostInput: input event');
            clearTimeout(window.calculationTimeout);
            window.calculationTimeout = setTimeout(function() {
                autoFillUnitPrice();
                calculateDailyExpense();
            }, 800);
        });
    } else {
        console.log('unitCostInput not found');
    }
    
    // Add event listeners for UnitPrice to trigger calculation
    const unitPriceInput = document.getElementById('id_UnitPrice');
    if (unitPriceInput) {
        console.log('Setting up event listeners for unitPriceInput');
        unitPriceInput.addEventListener('change', function() {
            console.log('unitPriceInput: change event');
            immediateCalculation();
        });
        unitPriceInput.addEventListener('blur', function() {
            console.log('unitPriceInput: blur event');
            triggerCalculation();
        });
        unitPriceInput.addEventListener('input', function() {
            console.log('unitPriceInput: input event');
            clearTimeout(window.calculationTimeout);
            window.calculationTimeout = setTimeout(calculateDailyExpense, 800);
        });
    } else {
        console.log('unitPriceInput not found');
    }
    
    // Auto-focus on the first input field
    const firstInput = document.querySelector('input[type="text"]:not([readonly]), select:not([disabled])');
    if (firstInput) {
        firstInput.focus();
    }
    
    // Form submission handler with validation and value normalization
    const form = document.querySelector('form');
    const submitButton = document.querySelector('button[type="submit"]');
    if (submitButton && form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Validate form
            const validation = validateForm();
            if (!validation.isValid) {
                alert(validation.errors.join('\n'));
                // Focus on first error field
                const firstErrorField = document.querySelector('.border-red-500');
                if (firstErrorField) {
                    firstErrorField.focus();
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            // Normalize numeric values (remove commas) before submission
            numericFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && input.value) {
                    input.value = normalizeNumericValue(input.value);
                }
            });
            
            // Normalize MonthsToUse if it exists
            if (monthsToUseInput && monthsToUseInput.value) {
                monthsToUseInput.value = normalizeNumericValue(monthsToUseInput.value);
            }
            
            // Disable submit button and show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Боловсруулж байна...';
            
            // Submit the form
            form.submit();
        });
    }
    
    // Add real-time validation feedback
    const allInputs = form.querySelectorAll('input, select');
    allInputs.forEach(input => {
        input.addEventListener('blur', function() {
            // Remove error styling on blur if value is valid
            if (input.value && !input.classList.contains('border-red-500')) {
                input.classList.remove('border-red-500');
            }
        });
    });
});
</script>

<!-- Include Client Selection Modal -->
{% include 'core/components/client_selection_modal.html' %}
{% endblock %}
