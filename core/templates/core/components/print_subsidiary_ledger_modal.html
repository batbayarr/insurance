<!-- Subsidiary Ledger Modal -->
<div id="print-subsidiary-ledger-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-4 border-b border-gray-200">
            <div>
                <h3 class="text-lg font-medium text-gray-900" id="modal-ledger-title">ДЭД ДАНСНЫ ТАЙЛАН</h3>
                <p class="text-sm text-gray-600" id="modal-ledger-date-range"></p>
            </div>
            <button onclick="closePrintSubsidiaryLedgerModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="py-4">
            <!-- Account Info -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Код</label>
                        <p class="text-sm text-gray-900" id="modal-ledger-account-code"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Дансны Нэр</label>
                        <p class="text-sm text-gray-900" id="modal-ledger-account-name"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Төрөл</label>
                        <p class="text-sm text-gray-900" id="modal-ledger-account-type"></p>
                    </div>
                </div>
            </div>

            <!-- Client Info (if applicable) -->
            <div id="modal-ledger-client-info" class="mb-4 p-4 bg-blue-50 rounded-lg hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Харилцагчийн Код</label>
                        <p class="text-sm text-gray-900" id="modal-ledger-client-code"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Харилцагчийн Нэр</label>
                        <p class="text-sm text-gray-900" id="modal-ledger-client-name"></p>
                    </div>
                </div>
            </div>

            <!-- Balance Summary -->
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Эхний үлдэгдэл</label>
                        <p class="text-sm font-semibold text-gray-900" id="modal-ledger-beginning-balance"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Дебит гүйлгээ</label>
                        <p class="text-sm font-semibold text-gray-900" id="modal-ledger-total-debit"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Кредит гүйлгээ</label>
                        <p class="text-sm font-semibold text-gray-900" id="modal-ledger-total-credit"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Эцсийн үлдэгдэл</label>
                        <p class="text-sm font-semibold text-gray-900" id="modal-ledger-ending-balance"></p>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="modal-ledger-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-sm text-gray-600">уншиж байна...</p>
            </div>

            <!-- Error State -->
            <div id="modal-ledger-error" class="text-center py-8 hidden">
                <div class="text-red-600">
                    <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">сүлжээний алдаа гарлаа</h3>
                    <p class="mt-1 text-sm text-gray-500" id="modal-ledger-error-message"></p>
                </div>
            </div>

            <!-- Empty State -->
            <div id="modal-ledger-empty" class="text-center py-8 hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Гүйлгээ оруулаагүй байна.</h3>
                <p class="mt-1 text-sm text-gray-500">Гүйлгээ оруулаагүй байна.</p>
            </div>

            <!-- Documents Table (for regular view) -->
            <div id="modal-ledger-documents" class="hidden">
                <!-- Expand/Collapse Controls -->
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-sm font-medium text-gray-700">Document Details</h4>
                    <div class="flex space-x-2">
                        <button id="expand-all-btn-ledger" 
                                class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Дэлгэрэнгүй үзүүлэх
                        </button>
                        <button id="collapse-all-btn-ledger" 
                                class="px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Хураангуй үзүүлэх
                        </button>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <div id="modal-ledger-documents-list">
                        <!-- Document groups will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Pagination Controls -->
                <div class="flex items-center justify-between px-4 py-3 bg-white border-t border-gray-200 sm:px-6">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prev-page-mobile-ledger" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            өмнөх
                        </button>
                        <button id="next-page-mobile-ledger" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            дараах
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Showing <span id="page-start-ledger" class="font-medium">1</span> to <span id="page-end-ledger" class="font-medium">10</span> of <span id="total-items-ledger" class="font-medium">0</span> results
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <button id="prev-page-ledger" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="sr-only">Previous</span>
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <div id="page-numbers-ledger" class="flex">
                                    <!-- Page numbers will be generated by JavaScript -->
                                </div>
                                <button id="next-page-ledger" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="sr-only">Next</span>
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex justify-end pt-4 border-t border-gray-200">
            <button onclick="closePrintSubsidiaryLedgerModal()" 
                    class="px-4 py-2 bg-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                Close
            </button>
        </div>
    </div>
</div>

<script>
// Cache bust: Updated 2025-10-19 20:30 - Match account statement modal structure
function showPrintSubsidiaryLedgerModal() {
    document.getElementById('print-subsidiary-ledger-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closePrintSubsidiaryLedgerModal() {
    document.getElementById('print-subsidiary-ledger-modal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function formatNumber(num) {
    if (num === null || num === undefined || num === 0) return '-';
    return parseFloat(num).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function formatCurrency(num) {
    if (num === null || num === undefined || isNaN(num)) return '-';
    const formatted = parseFloat(num).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    return formatted === '0.00' ? '-' : formatted;
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US');
}

// Pagination variables
let allDocuments = [];
let currentPageLedger = 1;
const itemsPerPageLedger = 10;

function populateSubsidiaryLedgerModal(data, balanceData) {
    try {
        console.log('populateSubsidiaryLedgerModal called with data:', data);
        console.log('Documents array:', data.documents);
        
        // Populate account info
        document.getElementById('modal-ledger-title').textContent = `${data.account.AccountCode} - ${data.account.AccountName}`;
        document.getElementById('modal-ledger-date-range').textContent = `${data.date_range.begin_date} to ${data.date_range.end_date}`;
        document.getElementById('modal-ledger-account-code').textContent = data.account.AccountCode;
        document.getElementById('modal-ledger-account-name').textContent = data.account.AccountName;
        document.getElementById('modal-ledger-account-type').textContent = data.account.AccountType;

        // Populate client info if available
        if (data.client) {
            document.getElementById('modal-ledger-client-info').classList.remove('hidden');
            document.getElementById('modal-ledger-client-code').textContent = data.client.ClientCode || '-';
            document.getElementById('modal-ledger-client-name').textContent = data.client.ClientName || '-';
        } else {
            document.getElementById('modal-ledger-client-info').classList.add('hidden');
        }

        // Populate balance summary from trial balance data
        const beginningBalance = (balanceData.beginningBalanceDebit || 0) + (balanceData.beginningBalanceCredit || 0);
        const endingBalance = (balanceData.endingBalanceDebit || 0) + (balanceData.endingBalanceCredit || 0);
        
        document.getElementById('modal-ledger-beginning-balance').textContent = formatCurrency(beginningBalance);
        document.getElementById('modal-ledger-total-debit').textContent = formatCurrency(data.total_debit);
        document.getElementById('modal-ledger-total-credit').textContent = formatCurrency(data.total_credit);
        document.getElementById('modal-ledger-ending-balance').textContent = formatCurrency(endingBalance);

        // Store all documents and initialize pagination (documents are already grouped by the API)
        allDocuments = data.documents || [];
        currentPageLedger = 1;
        
        if (allDocuments.length > 0) {
            displayDocuments();
            setupPaginationLedger();
            document.getElementById('modal-ledger-documents').classList.remove('hidden');
            document.getElementById('modal-ledger-empty').classList.add('hidden');
        } else {
            document.getElementById('modal-ledger-documents').classList.add('hidden');
            document.getElementById('modal-ledger-empty').classList.remove('hidden');
        }

        // Hide loading and error states
        document.getElementById('modal-ledger-loading').classList.add('hidden');
        document.getElementById('modal-ledger-error').classList.add('hidden');
    } catch (error) {
        console.error('Error in populateSubsidiaryLedgerModal:', error);
        showModalLedgerError('Error loading subsidiary ledger: ' + error.message);
    }
}

function displayDocuments() {
    try {
        console.log('displayDocuments called with', allDocuments.length, 'documents');
        const container = document.getElementById('modal-ledger-documents-list');
        container.innerHTML = '';

        const startIndex = (currentPageLedger - 1) * itemsPerPageLedger;
        const endIndex = startIndex + itemsPerPageLedger;
        const pageDocuments = allDocuments.slice(startIndex, endIndex);

        console.log('Processing', pageDocuments.length, 'documents for current page');
        pageDocuments.forEach((doc, index) => {
            console.log('Processing document', index, ':', doc.DocumentId);
            const documentGroup = createDocumentGroup(doc);
            container.appendChild(documentGroup);
        });

        updatePaginationInfoLedger();
    } catch (error) {
        console.error('Error in displayDocuments:', error);
        throw error;
    }
}

function createDocumentGroup(doc) {
    try {
        console.log('Creating document group for:', doc.DocumentId);
        const group = document.createElement('div');
        group.className = 'border border-gray-200 rounded-lg overflow-hidden';
    
    // Document header
    const header = document.createElement('div');
    header.className = 'bg-gray-50 px-4 py-3 cursor-pointer hover:bg-gray-100 transition-colors';
    header.onclick = () => toggleDetails(doc.DocumentId);
    
    header.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-4">
                    <span class="text-gray-900">Баримт:${doc.DocumentNo || '-'}</span>
                    <span class="text-sm text-gray-600">Огноо:${formatDate(doc.DocumentDate)}</span>
                    <span class="text-sm text-gray-600">Загвар:${doc.DocumentType || '-'}</span>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${doc.DocumentCategory || '-'}</span>
                </div>
                <div class="text-sm text-gray-600 mt-1">Гүйлгээний утга:${doc.DocumentDescription || 'No description'}</div>
            </div>
            
        </div>
    `;
    
    // Document details (expanded by default)
    const details = document.createElement('div');
    details.className = 'border-t border-gray-200 border-l-2 border-r-2 border-b-2 border-blue-200 bg-blue-50';
    details.id = `details-${doc.DocumentId}`;
    
    // Calculate totals for this document
    const docTotalDebit = doc.details.reduce((sum, detail) => sum + (detail.DebitAmount || 0), 0);
    const docTotalCredit = doc.details.reduce((sum, detail) => sum + (detail.CreditAmount || 0), 0);
    
    const table = document.createElement('div');
    table.className = 'overflow-x-auto';
    table.innerHTML = `
        <table class="min-w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дансны Код</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Харилцагч</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Валют нэр</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ханш</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Валют дүн</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Дебит</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Кредит</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                ${doc.details.map(detail => `
                    <tr class="${detail.IsMatchingAccount ? 'bg-yellow-50' : 'hover:bg-gray-50'}">
                        <td class="px-4 py-2 text-sm text-gray-900">
                            <span class="text-gray-900">${detail.AccountCode || '-'}</span>
                            <span class="text-gray-600">- ${detail.AccountName || '-'}</span>
                            ${detail.IsMatchingAccount ? '<span class="ml-2 text-xs bg-yellow-200 text-yellow-800 px-1 py-0.5 rounded">Target</span>' : ''}
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            ${detail.ClientCode ? `${detail.ClientCode} - ${detail.ClientName}` : '-'}
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-900">${detail.CurrencyName || '-'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 text-right">${detail.CurrencyExchange ? Number(detail.CurrencyExchange).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 6 }) : '-'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(detail.CurrencyAmount)}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(detail.DebitAmount)}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(detail.CreditAmount)}</td>
                    </tr>
                `).join('')}
            </tbody>
            <tfoot class="bg-gray-100 border-t-2 border-gray-300">
                <tr class="font-medium">
                    <td colspan="5" class="px-4 py-2 text-sm text-gray-900">НИЙТ:</td>
                    <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(docTotalDebit)}</td>
                    <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(docTotalCredit)}</td>
                </tr>
            </tfoot>
        </table>
    `;
    
    details.appendChild(table);
    
        group.appendChild(header);
        group.appendChild(details);
        
        return group;
    } catch (error) {
        console.error('Error in createDocumentGroup:', error);
        console.error('Document object:', doc);
        throw error;
    }
}

function toggleDetails(documentId) {
    const details = document.getElementById(`details-${documentId}`);
    const icon = document.getElementById(`icon-${documentId}`);
    
    if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        if (icon) icon.style.transform = 'rotate(180deg)';
    } else {
        details.classList.add('hidden');
        if (icon) icon.style.transform = 'rotate(0deg)';
    }
}

function expandAllDetails() {
    // Expand all document details
    allDocuments.forEach(doc => {
        const details = document.getElementById(`details-${doc.DocumentId}`);
        const icon = document.getElementById(`icon-${doc.DocumentId}`);
        
        if (details) {
            details.classList.remove('hidden');
        }
        if (icon) {
            icon.style.transform = 'rotate(180deg)';
        }
    });
}

function collapseAllDetails() {
    // Collapse all document details
    allDocuments.forEach(doc => {
        const details = document.getElementById(`details-${doc.DocumentId}`);
        const icon = document.getElementById(`icon-${doc.DocumentId}`);
        
        if (details) {
            details.classList.add('hidden');
        }
        if (icon) {
            icon.style.transform = 'rotate(0deg)';
        }
    });
}

function setupPaginationLedger() {
    const totalPages = Math.ceil(allDocuments.length / itemsPerPageLedger);
    
    // Clear existing page numbers
    const pageNumbersContainer = document.getElementById('page-numbers-ledger');
    if (pageNumbersContainer) {
        pageNumbersContainer.innerHTML = '';

        // Generate page number buttons
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                i === currentPageLedger 
                    ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' 
                    : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
            }`;
            pageButton.addEventListener('click', () => goToPageLedger(i));
            pageNumbersContainer.appendChild(pageButton);
        }
    }

    // Setup navigation buttons
    const prevBtn = document.getElementById('prev-page-ledger');
    const nextBtn = document.getElementById('next-page-ledger');
    const prevBtnMobile = document.getElementById('prev-page-mobile-ledger');
    const nextBtnMobile = document.getElementById('next-page-mobile-ledger');
    
    if (prevBtn) prevBtn.onclick = () => goToPageLedger(currentPageLedger - 1);
    if (nextBtn) nextBtn.onclick = () => goToPageLedger(currentPageLedger + 1);
    if (prevBtnMobile) prevBtnMobile.onclick = () => goToPageLedger(currentPageLedger - 1);
    if (nextBtnMobile) nextBtnMobile.onclick = () => goToPageLedger(currentPageLedger + 1);
}

function goToPageLedger(page) {
    const totalPages = Math.ceil(allDocuments.length / itemsPerPageLedger);
    if (page >= 1 && page <= totalPages) {
        currentPageLedger = page;
        displayDocuments();
        setupPaginationLedger();
    }
}

function updatePaginationInfoLedger() {
    const startIndex = (currentPageLedger - 1) * itemsPerPageLedger + 1;
    const endIndex = Math.min(currentPageLedger * itemsPerPageLedger, allDocuments.length);
    
    const pageStartEl = document.getElementById('page-start-ledger');
    const pageEndEl = document.getElementById('page-end-ledger');
    const totalItemsEl = document.getElementById('total-items-ledger');
    
    if (pageStartEl) pageStartEl.textContent = startIndex;
    if (pageEndEl) pageEndEl.textContent = endIndex;
    if (totalItemsEl) totalItemsEl.textContent = allDocuments.length;

    // Update button states
    const totalPages = Math.ceil(allDocuments.length / itemsPerPageLedger);
    const prevBtn = document.getElementById('prev-page-ledger');
    const nextBtn = document.getElementById('next-page-ledger');
    const prevBtnMobile = document.getElementById('prev-page-mobile-ledger');
    const nextBtnMobile = document.getElementById('next-page-mobile-ledger');
    
    if (prevBtn) prevBtn.disabled = currentPageLedger === 1;
    if (nextBtn) nextBtn.disabled = currentPageLedger >= totalPages;
    if (prevBtnMobile) prevBtnMobile.disabled = currentPageLedger === 1;
    if (nextBtnMobile) nextBtnMobile.disabled = currentPageLedger >= totalPages;
}

function showModalLedgerLoading() {
    document.getElementById('modal-ledger-loading').classList.remove('hidden');
    document.getElementById('modal-ledger-documents').classList.add('hidden');
    document.getElementById('modal-ledger-empty').classList.add('hidden');
    document.getElementById('modal-ledger-error').classList.add('hidden');
}

function showModalLedgerError(message) {
    const errorMsgEl = document.getElementById('modal-ledger-error-message');
    if (errorMsgEl) errorMsgEl.textContent = message;
    document.getElementById('modal-ledger-error').classList.remove('hidden');
    document.getElementById('modal-ledger-loading').classList.add('hidden');
    document.getElementById('modal-ledger-documents').classList.add('hidden');
    document.getElementById('modal-ledger-empty').classList.add('hidden');
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('print-subsidiary-ledger-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closePrintSubsidiaryLedgerModal();
            }
        });
    }
    
    // Expand/Collapse All buttons
    const expandAllBtn = document.getElementById('expand-all-btn-ledger');
    const collapseAllBtn = document.getElementById('collapse-all-btn-ledger');
    
    if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function() {
            expandAllDetails();
        });
    }
    
    if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function() {
            collapseAllDetails();
        });
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('print-subsidiary-ledger-modal');
        if (modal && !modal.classList.contains('hidden')) {
            closePrintSubsidiaryLedgerModal();
        }
    }
});
</script>
