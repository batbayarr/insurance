{% load humanize %}
<!-- Inventory Document Detail Grids -->
<div class="space-y-6">
    <!-- Inventory Document Items Grid -->
    <div class="bg-white shadow overflow-hidden rounded-lg border border-gray-200">
        <div class="px-3 py-2 lg:px-6 border-b border-gray-200">
            <h3 class="text-base leading-5 font-medium text-gray-900">ПАДААНЫ МЭДЭЭЛЭЛ</h3>
        </div>
        
        {% if selected_document and document_items %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 border border-gray-200" style="table-layout: auto;">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Бараа материал</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Тоо хэмжээ</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Нэгжийн өртөг</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Нэгжийн үнэ</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Нийт өртөг</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Нийт үнэ</th>
                    </tr>
                </thead>
                <tbody id="items-tbody" class="bg-white divide-y divide-gray-200">
                    {% for item in document_items %}
                    <tr class="hover:bg-gray-50"
                        data-inventory-code="{% if item.InventoryId %}{{ item.InventoryId.InventoryCode }}{% endif %}"
                        data-inventory-name="{% if item.InventoryId %}{{ item.InventoryId.InventoryName }}{% endif %}"
                        data-measurement-name="{% if item.InventoryId.MeasurementId %}{{ item.InventoryId.MeasurementId.MeasurementName }}{% endif %}">
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">
                            {% if item.InventoryId %}
                                <span title="{{ item.InventoryId.InventoryName }}">{% if item.InventoryId.InventoryCode %}{{ item.InventoryId.InventoryCode }} - {% endif %}{{ item.InventoryId.InventoryName }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                            {{ item.Quantity|floatformat:2|intcomma }}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                            {{ item.UnitCost|floatformat:2|intcomma }}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                            {{ item.UnitPrice|floatformat:2|intcomma }}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right total-cost">
                            {% widthratio item.Quantity 1 item.UnitCost as total_cost %}
                            {{ total_cost|floatformat:2|intcomma }}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right total-price">
                            {% widthratio item.Quantity 1 item.UnitPrice as total_price %}
                            {{ total_price|floatformat:2|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <!-- Summary Row for Items -->
                {% if document_items %}
                <tfoot class="bg-gray-50">
                    <tr class="border-t-2 border-gray-300">
                        <td colspan="4" class="px-2 py-1 text-xs text-gray-900 text-right">
                            TOTALS:
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                            <span id="display-total-cost" class="font-medium text-green-600">0.00</span>
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                            <span id="display-total-price" class="font-medium text-green-600">0.00</span>
                        </td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
        {% elif selected_document %}
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <h3 class="mt-2 text-xs font-medium text-gray-900">No inventory items</h3>
            <p class="mt-1 text-xs text-gray-500">This document has no inventory items yet.</p>
        </div>
        {% else %}
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <h3 class="mt-2 text-xs font-medium text-gray-900">No document selected</h3>
            <p class="mt-1 text-xs text-gray-500">Select a document from the list above to view its inventory items.</p>
        </div>
        {% endif %}
    </div>

    <!-- Accounting Detail Grid (Journal Entries) -->
    <div class="bg-white shadow overflow-hidden rounded-lg border border-gray-200">
        <div class="px-3 py-2 lg:px-6 border-b border-gray-200">
            <h3 class="text-base leading-5 font-medium text-gray-900">Журналын бичилт</h3>
        </div>
        
        {% if selected_document and document_details %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 border border-gray-200" style="table-layout: auto;">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ханш</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют.Дүн</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дебит дүн(₮)</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Кредит дүн(₮)</th>
                    </tr>
                </thead>
                <tbody id="detail-tbody" class="bg-white divide-y divide-gray-200">
                    {% for detail in document_details %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">
                            {% if detail.AccountId %}
                                <span class="account-format" title="{{ detail.AccountId.AccountCode }} - {{ detail.AccountId.AccountName }}">{{ detail.AccountId.AccountCode }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">
                            {% if detail.ClientId %}
                                {{ detail.ClientId.ClientCode }} - {{ detail.ClientId.ClientName }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">
                            {% if detail.CurrencyId %}
                                <span title="{{ detail.CurrencyId.CurrencyId }} - {{ detail.CurrencyId.Currency_name }}">{{ detail.CurrencyId.Currency_name }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                            {{ detail.CurrencyExchange|floatformat:2|intcomma }}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                            {{ detail.CurrencyAmount|floatformat:2|intcomma }}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right debit-amount">
                            {% if detail.DebitAmount %}{{ detail.DebitAmount|floatformat:2|intcomma }}{% else %}0.00{% endif %}
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right credit-amount">
                            {% if detail.CreditAmount %}{{ detail.CreditAmount|floatformat:2|intcomma }}{% else %}0.00{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <!-- Summary Row for Accounting Details -->
                {% if document_details %}
                <tfoot class="bg-gray-50">
                    <tr class="border-t-2 border-gray-300">
                        <td colspan="5" class="px-2 py-1 text-xs text-gray-900 text-right">
                            TOTALS:
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                            <span id="display-total-debit" class="font-medium text-green-600">0.00</span>
                        </td>
                        <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                            <span id="display-total-credit" class="font-medium text-green-600">0.00</span>
                        </td>
                    </tr>
                    <!-- Balance Status Row -->
                    <tr>
                        <td colspan="7" class="px-2 py-1 text-xs text-gray-900 text-center">
                            <span id="display-balance-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                Calculating...
                            </span>
                        </td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
        {% elif selected_document %}
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <h3 class="mt-2 text-xs font-medium text-gray-900">No accounting details</h3>
            <p class="mt-1 text-xs text-gray-500">This document has no accounting details yet.</p>
        </div>
        {% else %}
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <h3 class="mt-2 text-xs font-medium text-gray-900">No document selected</h3>
            <p class="mt-1 text-xs text-gray-500">Select a document from the list above to view its accounting details.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Inventory Document Detail Grid Template
// The calculation functions are now defined in the master-detail template
// This ensures they're always available when needed

// Try to call the calculation functions if they're available
if (typeof window.calculateInventoryItemTotals === 'function' && typeof window.calculateInventoryAccountingTotals === 'function') {
    // Multiple execution attempts to ensure they run
    window.calculateInventoryItemTotals();
    window.calculateInventoryAccountingTotals();
    
    setTimeout(() => {
        window.calculateInventoryItemTotals();
        window.calculateInventoryAccountingTotals();
    }, 50);
    
    setTimeout(() => {
        window.calculateInventoryItemTotals();
        window.calculateInventoryAccountingTotals();
    }, 100);
}
</script>
