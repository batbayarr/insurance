{% extends 'base.html' %}
{% load static %}
<!-- FORCE NO CACHE - New File -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="cache-bust" content="NEW-FILE-v3.7-2025-01-31-16:15">
{% load humanize %}

{% block title %}Cash Journal{% endblock %}

{% block content %}
<script src="{% static 'js/print-journal.js' %}"></script>
<div class="">
    <!-- Date Filter Section -->
    <div class="bg-white shadow rounded-lg p-1 mb-2">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center space-x-2">
                <label for="start-date" class="text-sm font-medium text-gray-700">Эхлэх огноо:</label>
                <input type="date" id="start-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-center space-x-2">
                <label for="end-date" class="text-sm font-medium text-gray-700">Дуусах огноо:</label>
                <input type="date" id="end-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="filter-button" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                СЭРГЭЭХ
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white shadow rounded-lg mb-4">
        <div class="border-b-2 border-gray-300">
            <nav class="flex space-x-2 px-6 p-3">
                <button id="tab-documents" onclick="switchToDocumentsView()" class="border border-blue-500 text-blue-600 bg-blue-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    БҮХ БАРИМТ
                </button>
                <button id="tab-unrelated" onclick="showUnrelatedDocuments()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ГҮЙЛГЭЭНД ХОЛБООГҮЙ БАРИМТ
                </button>
                <button id="tab-detail" onclick="switchToDetailView()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ЖУРНАЛ
                </button>
                <button id="tab-deleted" onclick="showDeletedDocuments()" class="border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50 whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    УСТГАСАН БАРИМТ
                </button>
            </nav>
        </div>
    </div>

    <!-- Cash Documents View (Hidden by default) -->
    <div id="cash-documents-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-24">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-20">Огноо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-20 whitespace-nowrap">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-12">БТ</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-8">НӨТ</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-16">Валют</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют.дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ханш</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дүн(₮)</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 w-20">Хэрэглэгч</th>
                    </tr>
                    <!-- Filter Row -->
                    <tr class="bg-gray-100">
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-document-no" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-date" placeholder="Filter..."
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-account" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="9">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-document-type" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-client" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-description" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="70">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-is-vat" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-currency" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="3">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-currency-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-currency-exchange" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-mnt-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-user" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                    </tr>
                </thead>
                <tbody id="documents-tbody" class="bg-white divide-y divide-gray-200">
                    <!-- Documents will be loaded here via AJAX -->
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Ready to filter</h3>
                                <p class="text-sm text-gray-500">Select date range and click Filter to load documents.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr class="border-t-2 border-gray-300">
                        <td colspan="8" class="px-2 py-2 text-xs text-gray-900 border-r border-gray-200 text-right">НИЙТ:</td>
                        <td id="total-currency-amount" class="px-1 py-2 text-xs text-gray-900 border-r border-gray-200 text-right">0.00</td>
                        <td class="px-1 py-2 text-xs text-gray-900 border-r border-gray-200"></td>
                        <td id="total-amount-mnt" class="px-1 py-2 text-xs text-gray-900 border-r border-gray-200 text-right">0.00</td>
                        <td class="px-1 py-2 text-xs text-gray-900"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info" class="text-sm text-gray-700">
                        Нийт <span id="total-count">0</span> бичлэгээс <span id="showing-start">0</span> - <span id="showing-end">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label for="page-size-select" class="text-sm font-medium text-gray-700">Хуудасны хэмжээ:</label>
                        <select id="page-size-select" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="40">40</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="printDocumentsView()" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            ХЭВЛЭХ
                        </button>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button id="prev-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Previous</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <span id="page-info" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                <!-- Dynamic page buttons will be generated here -->
                            </span>
                            <button id="next-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Next</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash Journal Detail View (Hidden by default) -->
    <div id="cash-journal-detail-view" class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200" style="display: none;">
                
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Огноо</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 whitespace-nowrap">Данс</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дансны нэр</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валютын дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ханш</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дебит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Кредит дүн</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">МӨНГӨН ГҮЙЛГЭЭНИЙ МӨР</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                    </tr>
                    <!-- Filter Row -->
                    <tr class="bg-gray-100">
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-document-no" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-document-date" placeholder="Filter..."
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-account-code" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="9">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-account-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-client-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-description" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="70">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-currency" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   maxlength="3">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-currency-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-currency-exchange" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-debit-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-credit-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-cashflow-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-detail-user-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    <!-- Detail data will be loaded here via AJAX -->
                    <tr>
                        <td colspan="13" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load journal details.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for ЖУРНАЛ tab -->
        <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prev-page-detail" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Өмнөх
                </button>
                <button id="next-page-detail" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Дараа
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p id="pagination-info-detail" class="text-sm text-gray-700">
                        Нийт <span id="total-count-detail">0</span> бичлэгээс <span id="showing-start-detail">0</span> - <span id="showing-end-detail">0</span> бичлэг харагдаж байна
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <button onclick="printDetailView()" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            ХЭВЛЭХ
                        </button>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page-desktop-detail" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span id="page-info-detail" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            <!-- Dynamic page buttons will be generated here -->
                        </span>
                    <button id="next-page-desktop-detail" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="context-menu" class="hidden fixed bg-white border border-gray-300 rounded-md shadow-lg z-50 py-1 min-w-[140px]">
    <button id="context-menu-view" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
        ГҮЙЛГЭЭ ҮЗЭХ
    </button>
</div>

<script>
    // Cash Journal - Optimized Version
    
    // Global variables
    let documentsData = [];
    let detailsData = [];  // For ЖУРНАЛ tab
    let currentPage = 1;
    let pageSize = 20;
    let totalPages = 1;
    let isDeleteFilter = false;
    let isUnrelatedFilter = false; // Filter flag for unrelated documents (documents without details)
    let isRendering = false;
    let currentActiveTab = 'documents'; // Track which tab is currently active
    
    // Pagination variables for ЖУРНАЛ tab
    let currentPageDetail = 1;
    let pageSizeDetail = 20;
    let totalPagesDetail = 1;
    
    // API cache
    let apiCache = new Map();
    let currentCacheKey = '';
    
    // Context menu tracking
    let contextMenuTargetDocumentId = null;
    let contextMenuOutsideHandler = null;
    
    
    // Define filter inputs array (corrected column order) - Updated 2024
    const FILTER_INPUTS = [
        'DocumentNo', 'DocumentDate', 'AccountCode', 'DocumentType', 'ClientName', 
        'Description', 'VAT', 'CurrencyCode', 'CurrencyAmount', 'CurrencyExchange', 'Amount', 'UserName'
    ];
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        initializeAll();
    });
    
    function initializeAll() {
        initializeDateInputs();
        initializeFilters();
        initializePagination();
        setupContextMenuListeners();
        loadInitialDocuments();
    }
    
    function initializeDateInputs() {
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const pageSizeSelect = document.getElementById('page-size-select');
        
        if (startDateInput) {
            startDateInput.addEventListener('change', function() {
                // Date change handler
            });
        }
        
        if (endDateInput) {
            endDateInput.addEventListener('change', function() {
                // Date change handler
            });
        }
        
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                const newPageSize = parseInt(this.value);
                pageSize = newPageSize;
                pageSizeDetail = newPageSize; // Also update detail page size
                currentPage = 1; // Reset to first page when changing page size
                currentPageDetail = 1; // Reset detail page too
                if (documentsData && documentsData.length > 0) {
                    applyFrontendFilter();
                }
                if (detailsData && detailsData.length > 0) {
                    renderDetailsTableWithPagination(detailsData);
                }
            });
        }
    }
    
    function initializeFilters() {
        // Initialize filters for БАРИМТ tab
        const filterInputs = document.querySelectorAll('#cash-documents-view input[placeholder="Filter..."]');
        filterInputs.forEach((input, index) => {
            input.addEventListener('input', applyFilters);
        });
        
        // Initialize filters for ЖУРНАЛ tab
        const detailFilterInputs = document.querySelectorAll('#cash-journal-detail-view input[placeholder="Filter..."]');
        detailFilterInputs.forEach((input, index) => {
            input.addEventListener('input', applyDetailFiltersAndRender);
        });
    }
    
    function applyDetailFiltersAndRender() {
        // Debounce the filter application
        clearTimeout(window.detailFilterTimeout);
        window.detailFilterTimeout = setTimeout(() => {
            if (detailsData && detailsData.length > 0) {
                currentPageDetail = 1; // Reset to first page when filtering
                renderDetailsTableWithPagination(detailsData);
            }
        }, 300);
    }
    
    function initializePagination() {
        // БАРИМТ tab pagination
        const prevPage = document.getElementById('prev-page');
        const nextPage = document.getElementById('next-page');
        const prevPageDesktop = document.getElementById('prev-page-desktop');
        const nextPageDesktop = document.getElementById('next-page-desktop');
        
        if (prevPage) prevPage.addEventListener('click', () => changePage(currentPage - 1));
        if (nextPage) nextPage.addEventListener('click', () => changePage(currentPage + 1));
        if (prevPageDesktop) prevPageDesktop.addEventListener('click', () => changePage(currentPage - 1));
        if (nextPageDesktop) nextPageDesktop.addEventListener('click', () => changePage(currentPage + 1));
        
        // ЖУРНАЛ tab pagination
        const prevPageDetail = document.getElementById('prev-page-detail');
        const nextPageDetail = document.getElementById('next-page-detail');
        const prevPageDesktopDetail = document.getElementById('prev-page-desktop-detail');
        const nextPageDesktopDetail = document.getElementById('next-page-desktop-detail');
        
        if (prevPageDetail) prevPageDetail.addEventListener('click', () => changePageDetail(currentPageDetail - 1));
        if (nextPageDetail) nextPageDetail.addEventListener('click', () => changePageDetail(currentPageDetail + 1));
        if (prevPageDesktopDetail) prevPageDesktopDetail.addEventListener('click', () => changePageDetail(currentPageDetail - 1));
        if (nextPageDesktopDetail) nextPageDesktopDetail.addEventListener('click', () => changePageDetail(currentPageDetail + 1));
    }
    
    function loadInitialDocuments() {
        setDefaultDateValues();
        
        // Only set default dates - user must click СЭРГЭЭХ button to load data
        // This ensures only the СЭРГЭЭХ button triggers data loading
    }
    
    function setDefaultDateValues() {
        // Use user's local system date
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        // Format dates for HTML date input (YYYY-MM-DD)
        const formatDateForInput = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        
        if (startDateInput && !startDateInput.value) {
            startDateInput.value = formatDateForInput(firstDay);
        }
        if (endDateInput && !endDateInput.value) {
            endDateInput.value = formatDateForInput(lastDay);
        }
    }
    
    function applyDateFilter() {
        // This is the ONLY function that triggers data loading from server
        // Called only when СЭРГЭЭХ button is clicked
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        // Store current active tab before refreshing
        const detailView = document.getElementById('cash-journal-detail-view');
        const documentsView = document.getElementById('cash-documents-view');
        
        if (detailView && detailView.style.display !== 'none') {
            currentActiveTab = 'detail';
        } else if (documentsView && documentsView.style.display !== 'none') {
            // Check which tab is active
            const tabDeleted = document.getElementById('tab-deleted');
            const tabUnrelated = document.getElementById('tab-unrelated');
            if (tabDeleted && tabDeleted.classList.contains('border-blue-500')) {
                currentActiveTab = 'deleted';
            } else if (tabUnrelated && tabUnrelated.classList.contains('border-blue-500')) {
                currentActiveTab = 'unrelated';
            } else {
                currentActiveTab = 'documents';
            }
        }
        
        // Clear cache before new API call
        apiCache.clear();
        currentCacheKey = '';
        
        // Reset delete filter and unrelated filter based on active tab
        if (currentActiveTab === 'deleted') {
            isDeleteFilter = true;
            isUnrelatedFilter = false;
        } else if (currentActiveTab === 'unrelated') {
            isDeleteFilter = false;
            isUnrelatedFilter = true;
        } else {
            isDeleteFilter = false;
            isUnrelatedFilter = false;
        }
        
        // Clear all filter inputs in all tabs before fetching new data
        // Clear filters in БАРИМТ tab
        if (documentsView) {
            const filterInputs = documentsView.querySelectorAll('input[placeholder="Filter..."]');
            filterInputs.forEach(input => {
                input.value = '';
            });
        }
        
        // Clear filters in ЖУРНАЛ tab
        if (detailView) {
            const filterInputs = detailView.querySelectorAll('input[placeholder="Filter..."]');
            filterInputs.forEach(input => {
                input.value = '';
            });
        }
        
        // Show loading state
        const filterButton = document.getElementById('filter-button');
        if (filterButton) {
            filterButton.textContent = 'Loading...';
            filterButton.disabled = true;
        }
        
        // Fetch ALL data for ALL tabs (documents + details) in one call
        // This is the ONLY place that makes server requests
        fetchAllDocumentsFromServer();
    }
    
    function fetchAllDocumentsFromServer() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // Fetch ALL data (documents + details) for all tabs in one call
        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate,
            page: '1',
            page_size: '2000'  // Large page size to get all records
        });
        
        const cacheKey = `${startDate}_${endDate}_comprehensive_data`;
        
        if (apiCache.has(cacheKey)) {
            const cachedData = apiCache.get(cacheKey);
            documentsData = cachedData.documents;
            detailsData = cachedData.details;
            
            // Restore active tab after loading from cache
            restoreActiveTab();
            return;
        }
        
        const url = `/core/api/cash-documents-filtered/?${params}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cache the response
                    apiCache.set(cacheKey, data);
                    currentCacheKey = cacheKey;
                    
                    // Store both documents and details data
                    documentsData = data.documents;
                    detailsData = data.details;
                    
                    // Restore active tab after loading
                    restoreActiveTab();
                } else {
                    showDocumentsError(data.error || 'Failed to load comprehensive data');
                }
            })
            .catch(error => {
                showDocumentsError('Network error occurred');
            })
            .finally(() => {
                // Reset filter button
                const filterButton = document.getElementById('filter-button');
                if (filterButton) {
                    filterButton.textContent = 'СЭРГЭЭХ';
                    filterButton.disabled = false;
                }
            });
    }
    
    function restoreActiveTab() {
        const detailView = document.getElementById('cash-journal-detail-view');
        const documentsView = document.getElementById('cash-documents-view');
        
        if (currentActiveTab === 'detail') {
            if (detailView && documentsView) {
                detailView.style.display = 'block';
                documentsView.style.display = 'none';
                updateTabStyling('detail');
            }
            if (detailsData && detailsData.length > 0) {
                renderDetailsTable(detailsData);
            }
        } else if (currentActiveTab === 'deleted') {
            if (documentsView && detailView) {
                documentsView.style.display = 'block';
                detailView.style.display = 'none';
                updateTabStyling('deleted');
            }
            isDeleteFilter = true;
            isUnrelatedFilter = false;
            applyFrontendFilter();
        } else if (currentActiveTab === 'unrelated') {
            if (documentsView && detailView) {
                documentsView.style.display = 'block';
                detailView.style.display = 'none';
                updateTabStyling('unrelated');
            }
            isDeleteFilter = false;
            isUnrelatedFilter = true;
            applyFrontendFilter();
        } else { // Default to 'documents'
            if (documentsView && detailView) {
                documentsView.style.display = 'block';
                detailView.style.display = 'none';
                updateTabStyling('documents');
            }
            isDeleteFilter = false;
            isUnrelatedFilter = false;
            applyFrontendFilter();
        }
    }
    
    function applyFrontendFilter() {
        if (!documentsData || documentsData.length === 0) {
            return;
        }
        
        let filteredData = documentsData;
        
        // Apply delete filter based on current tab
        if (isDeleteFilter) {
            // Show only deleted documents (УСТГАСАН БАРИМТ tab)
            filteredData = documentsData.filter(doc => doc.IsDelete === true);
        } else if (isUnrelatedFilter) {
            // Show only active documents without details (ГҮЙЛГЭЭНД ХОЛБООГҮЙ БАРИМТ tab)
            // Must have IsDelete=false
            filteredData = documentsData.filter(doc => {
                if (doc.IsDelete === true) return false; // Exclude deleted documents
                
                // Check if document has any details in detailsData
                const hasDetails = detailsData && detailsData.some(detail => 
                    detail.document_id === doc.DocumentId || detail.document_no === doc.DocumentNo
                );
                
                return !hasDetails; // Return documents without details
            });
        } else {
            // Show only active documents (БҮХ БАРИМТ tab)
            // Must have IsDelete=false
            filteredData = documentsData.filter(doc => doc.IsDelete === false);
        }
        
        // Apply column filters if any (only from cash-documents-view, using AND logic - all filters must match)
        const documentsView = document.getElementById('cash-documents-view');
        if (documentsView) {
            const filterInputs = documentsView.querySelectorAll('input[placeholder="Filter..."]');
            const filterValues = Array.from(filterInputs).map(input => input.value.toLowerCase().trim());
            
            // Check if any filter has a value
            if (filterValues.some(filter => filter.length > 0)) {
                filteredData = filteredData.filter(doc => {
                    const values = [
                        String(doc.DocumentNo || '').toLowerCase(),
                        String(doc.DocumentDate || '').toLowerCase(),
                        String(doc.AccountCode || '').toLowerCase(),
                        String(doc.DocumentTypeCode || '').toLowerCase(),
                        String(doc.ClientName || '').toLowerCase(),
                        String(doc.Description || '').toLowerCase(),
                        doc.IsVat ? 'y' : 'n',
                        String(doc.CurrencyName || '').toLowerCase(),
                        String(doc.CurrencyAmount || '').toLowerCase(),
                        String(doc.CurrencyExchange || '').toLowerCase(),
                        String(doc.CurrencyMNT || '').toLowerCase(),
                        String(doc.UserName || doc.CreatedBy || '').toLowerCase()
                    ];
                    
                    // AND logic: ALL filters must match (every filter that has a value must match)
                    return filterValues.every((filter, index) => 
                        !filter || values[index].includes(filter)
                    );
                });
            }
        }
        
        // Calculate totals for ALL filtered data (not just current page)
        let totalCurrencyAmount = 0;
        let totalAmountMNT = 0;
        filteredData.forEach(doc => {
            totalCurrencyAmount += parseFloat(doc.CurrencyAmount || 0);
            totalAmountMNT += parseFloat(doc.CurrencyMNT || 0);
        });
        
        // Calculate pagination
        totalPages = Math.ceil(filteredData.length / pageSize);
        if (currentPage > totalPages) currentPage = 1;
        
        // Get paginated data
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const paginatedData = filteredData.slice(startIndex, endIndex);
        
        // Update pagination info
        updatePaginationInfo(filteredData.length, paginatedData.length, startIndex);
        
        // Use normal rendering with paginated data
        renderDocumentsTable(paginatedData);
        
        // Update summary totals with ALL filtered data totals
        updateSummaryTotals(totalCurrencyAmount, totalAmountMNT);
        
        updateFilterCount(filteredData.length);
    }
    
    function renderDocumentsTable(documents) {
        if (isRendering) {
            return;
        }
        
        isRendering = true;
        
        const tbody = document.getElementById('documents-tbody');
        if (!tbody) {
            isRendering = false;
            return;
        }
        
        if (!documents || documents.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-sm font-medium text-gray-900 mb-1">No documents found</h3>
                            <p class="text-sm text-gray-500">No documents found in the selected date range.</p>
                        </div>
                    </td>
                </tr>
            `;
            isRendering = false;
            return;
        }
        
        // Use normal rendering
        renderNormalTable(documents);
        
        isRendering = false;
    }
    
    function renderNormalTable(documents) {
        const tbody = document.getElementById('documents-tbody');
        
        // Clear existing content
        tbody.innerHTML = '';
        
        // Use DocumentFragment for better performance
        const fragment = document.createDocumentFragment();
        
        // Calculate totals for summary row
        let totalCurrencyAmount = 0;
        let totalAmountMNT = 0;
        
        documents.forEach((doc, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 cursor-pointer';
            row.setAttribute('data-document-id', doc.DocumentId);
            
            // Pre-format data for better performance
            const documentNo = doc.DocumentNo || '';
            const documentDate = doc.DocumentDate || '';
            const accountCode = doc.AccountCode || '';
            const documentType = doc.DocumentTypeCode || '';
            const clientName = doc.ClientName || '';
            const description = truncateText(doc.Description || '', 50);
            const vat = doc.IsVat ? 'Y' : 'N';
            const currencyName = doc.CurrencyName || '';
            const currencyAmount = parseFloat(doc.CurrencyAmount || 0);
            const currencyExchange = formatNumber(doc.CurrencyExchange || 0, 4);
            const amount = parseFloat(doc.CurrencyMNT || 0);
            const userName = doc.UserName || doc.CreatedBy || 'N/A';
            
            // Accumulate totals
            totalCurrencyAmount += currencyAmount;
            totalAmountMNT += amount;
            
            row.innerHTML = `
                <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${documentNo}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${documentDate}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${accountCode}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${documentType}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${clientName}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${description}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${vat}</td>
                <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${currencyName}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(currencyAmount, 2)}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${currencyExchange}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${formatNumber(amount, 2)}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${userName}</td>
            `;
            
            fragment.appendChild(row);
        });
        
        tbody.appendChild(fragment);
        
        // Update summary row totals
        updateSummaryTotals(totalCurrencyAmount, totalAmountMNT);
    }
    
    function updateSummaryTotals(totalCurrencyAmount, totalAmountMNT) {
        const totalCurrencyAmountEl = document.getElementById('total-currency-amount');
        const totalAmountMNTEl = document.getElementById('total-amount-mnt');
        
        if (totalCurrencyAmountEl) {
            totalCurrencyAmountEl.textContent = formatNumber(totalCurrencyAmount, 2);
        }
        if (totalAmountMNTEl) {
            totalAmountMNTEl.textContent = formatNumber(totalAmountMNT, 2);
        }
    }
    
    
    function updatePaginationInfo(totalRecords, currentRecords, startIndex) {
        const showingStart = document.getElementById('showing-start');
        const showingEnd = document.getElementById('showing-end');
        const totalCount = document.getElementById('total-count');
        const currentPageSpan = document.getElementById('current-page');
        const totalPagesSpan = document.getElementById('total-pages');
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        if (currentPageSpan) currentPageSpan.textContent = currentPage;
        if (totalPagesSpan) totalPagesSpan.textContent = totalPages;
        
        // Generate dynamic pagination
        generatePaginationButtons();
    }
    
    function updateDocumentsPaginationInfo(data) {
        const showingStart = document.getElementById('showing-start');
        const showingEnd = document.getElementById('showing-end');
        const totalCount = document.getElementById('total-count');
        const currentPageSpan = document.getElementById('current-page');
        const totalPagesSpan = document.getElementById('total-pages');
        
        if (showingStart) showingStart.textContent = ((data.page - 1) * data.page_size) + 1;
        if (showingEnd) showingEnd.textContent = Math.min(data.page * data.page_size, data.total);
        if (totalCount) totalCount.textContent = data.total;
        if (currentPageSpan) currentPageSpan.textContent = data.page;
        if (totalPagesSpan) totalPagesSpan.textContent = data.total_pages;
        
        currentPage = data.page;
        totalPages = data.total_pages;
        
        // Generate dynamic pagination
        generatePaginationButtons();
    }
    
    function generatePaginationButtons() {
        const pageInfo = document.getElementById('page-info');
        if (!pageInfo) return;
        
        // Clear existing buttons
        pageInfo.innerHTML = '';
        
        // Calculate pagination range
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // Generate page buttons
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPage 
                    ? 'bg-blue-400 text-white hover:bg-blue-500' 
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePage(i));
            pageInfo.appendChild(button);
        }
    }
    
    function changePage(newPage) {
        if (newPage < 1 || newPage > totalPages) return;
        
        currentPage = newPage;
        // Only use cached data - no server calls
        if (documentsData && documentsData.length > 0) {
            applyFrontendFilter();
        } else {
            // Show empty state if no cached data
            const tbody = document.getElementById('documents-tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">No data loaded</h3>
                                <p class="text-sm text-gray-500">Please select date range and click СЭРГЭЭХ to load data.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    function changePageDetail(newPage) {
        if (newPage < 1 || newPage > totalPagesDetail) return;
        
        currentPageDetail = newPage;
        // Re-render details table with pagination
        if (detailsData && detailsData.length > 0) {
            renderDetailsTableWithPagination(detailsData);
        }
    }
    
    function applyFilters() {
        // Debounce the filter application
        clearTimeout(window.filterTimeout);
        window.filterTimeout = setTimeout(applyFiltersImmediate, 300);
    }
    
    function applyFiltersImmediate() {
        applyFrontendFilter();
    }
    
    function updateFilterCount(count) {
        // Filter count updated
    }
    
    function showDocumentsError(message) {
        const tbody = document.getElementById('documents-tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="px-4 py-8 text-center text-red-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="text-sm font-medium text-red-900 mb-1">Error loading documents</h3>
                            <p class="text-sm text-red-500">${message}</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    // ===== Context Menu Handling =====
    function setupContextMenuListeners() {
        const documentsContainer = document.getElementById('cash-documents-view');
        if (documentsContainer && !documentsContainer.dataset.contextMenuSetup) {
            documentsContainer.addEventListener('contextmenu', handleContextMenuEvent);
            documentsContainer.dataset.contextMenuSetup = 'true';
        }
        
        const detailContainer = document.getElementById('cash-journal-detail-view');
        if (detailContainer && !detailContainer.dataset.contextMenuSetup) {
            detailContainer.addEventListener('contextmenu', handleContextMenuEvent);
            detailContainer.dataset.contextMenuSetup = 'true';
        }
    }
    
    function handleContextMenuEvent(event) {
        // Don't show context menu in УСТГАСАН БАРИМТ tab
        if (isDeleteFilter) {
            return; // Prevent context menu for deleted documents
        }
        
        const row = event.target.closest('tr[data-document-id]');
        if (row) {
            const documentId = row.getAttribute('data-document-id');
            if (documentId) {
                event.preventDefault();
                showContextMenu(event, documentId);
            }
        }
    }
    
    function showContextMenu(event, documentId) {
        const contextMenu = document.getElementById('context-menu');
        if (!contextMenu) return;
        
        contextMenuTargetDocumentId = documentId;
        contextMenu.style.left = `${event.pageX}px`;
        contextMenu.style.top = `${event.pageY}px`;
        contextMenu.classList.remove('hidden');
        
        const viewButton = document.getElementById('context-menu-view');
        if (viewButton) {
            viewButton.onclick = () => {
                navigateToCashMasterDetail(contextMenuTargetDocumentId);
            };
        }
        
        if (contextMenuOutsideHandler) {
            document.removeEventListener('click', contextMenuOutsideHandler);
        }
        contextMenuOutsideHandler = function(e) {
            if (!contextMenu.contains(e.target)) {
                hideContextMenu();
            }
        };
        setTimeout(() => document.addEventListener('click', contextMenuOutsideHandler), 0);
        document.addEventListener('keydown', handleContextMenuKeydown);
    }
    
    function hideContextMenu() {
        const contextMenu = document.getElementById('context-menu');
        if (contextMenu) {
            contextMenu.classList.add('hidden');
        }
        if (contextMenuOutsideHandler) {
            document.removeEventListener('click', contextMenuOutsideHandler);
            contextMenuOutsideHandler = null;
        }
        document.removeEventListener('keydown', handleContextMenuKeydown);
    }
    
    function handleContextMenuKeydown(event) {
        if (event.key === 'Escape') {
            hideContextMenu();
        }
    }
    
    function navigateToCashMasterDetail(documentId) {
        if (!documentId) return;
        const params = new URLSearchParams({
            selected_document: documentId
        });
        
        const startDate = document.getElementById('start-date')?.value;
        const endDate = document.getElementById('end-date')?.value;
        if (startDate) {
            params.set('begin_date', startDate);
        }
        if (endDate) {
            params.set('end_date', endDate);
        }
        
        window.location.href = `/core/cashdocuments/?${params.toString()}`;
        hideContextMenu();
    }
    
    function switchToDetailView() {
        // Switch to detail view - uses ONLY cached data, no server calls
        // Show the detail view
        document.getElementById('cash-journal-detail-view').style.display = 'block';
        
        // Hide the documents view
        document.getElementById('cash-documents-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('detail');
        
        // Set current active tab
        currentActiveTab = 'detail';
        
        // Display cached details data (loaded by СЭРГЭЭХ button)
        if (detailsData && detailsData.length > 0) {
            renderDetailsTable(detailsData);
        } else {
            const tbody = document.querySelector('#cash-journal-detail-view tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 012-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load journal details.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    function renderDetailsTable(details) {
        // Use the new paginated version
        renderDetailsTableWithPagination(details);
    }
    
    // Global variable to store filtered details data
    let filteredDetailsData = [];
    
    function renderDetailsTableWithPagination(details) {
        const tbody = document.querySelector('#cash-journal-detail-view tbody');
        if (!tbody) {
            return;
        }
        
        if (!details || details.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-sm font-medium text-gray-900 mb-1">No detail data found</h3>
                            <p class="text-sm text-gray-500">No document details found in the selected date range.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Apply filters first
        filteredDetailsData = applyDetailFilters(details);
        
        // Calculate pagination
        totalPagesDetail = Math.ceil(filteredDetailsData.length / pageSizeDetail);
        if (currentPageDetail > totalPagesDetail) currentPageDetail = 1;
        
        // Get paginated data
        const startIndex = (currentPageDetail - 1) * pageSizeDetail;
        const endIndex = startIndex + pageSizeDetail;
        const paginatedDetails = filteredDetailsData.slice(startIndex, endIndex);
        
        // Update pagination info
        updatePaginationInfoDetail(filteredDetailsData.length, paginatedDetails.length, startIndex);
        
        // Group details by document (document_no + document_date)
        const groupedByDocument = {};
        paginatedDetails.forEach((item) => {
            const docKey = `${item.document_no}_${item.document_date}`;
            if (!groupedByDocument[docKey]) {
                groupedByDocument[docKey] = [];
            }
            groupedByDocument[docKey].push(item);
        });
        
        let htmlContent = '';
        let totalDebit = 0;
        let totalCredit = 0;
        
        // Render grouped by document with borders
        Object.keys(groupedByDocument).forEach((docKey, docIndex) => {
            const docItems = groupedByDocument[docKey];
            const isLastDocument = docIndex === Object.keys(groupedByDocument).length - 1;
            
            docItems.forEach((item, itemIndex) => {
                // Calculate totals
                totalDebit += parseFloat(item.debit_amount) || 0;
                totalCredit += parseFloat(item.credit_amount) || 0;
                
                const isLastItem = itemIndex === docItems.length - 1;
                // Add border only after the last row of each document batch (except the last document)
                // No borders between rows within the same document batch
                // Use same style as column borders (border-b border-gray-200)
                const rowBorderClass = isLastItem && !isLastDocument 
                    ? 'border-b border-gray-200' 
                    : '';
                
                htmlContent += `
                    <tr class="hover:bg-gray-50 ${rowBorderClass}" data-document-id="${item.document_id || ''}">
                        <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_no || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.document_date || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_code || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.account_name || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.client_name || ''}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.description || ''}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${item.currency_name || ''}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.currency_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.currency_exchange.toLocaleString('en-US', {minimumFractionDigits: 4, maximumFractionDigits: 4})}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.debit_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${item.credit_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.cash_flow_name || '-'}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">${item.user_name || ''}</td>
                    </tr>
                `;
            });
        });
        
        // Add totals row
        htmlContent += `
            <tr class="bg-gray-100 border-t border-gray-200">
                <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200" colspan="9">НИЙТ:</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalDebit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${totalCredit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200"></td>
                <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200"></td>
            </tr>
        `;
        
        tbody.innerHTML = htmlContent;
    }
    
    function applyDetailFilters(details) {
        if (!details || details.length === 0) {
            return [];
        }
        
        let filtered = details;
        
        // Get filter values
        const filters = {
            documentNo: document.getElementById('filter-detail-document-no')?.value.toLowerCase().trim() || '',
            documentDate: document.getElementById('filter-detail-document-date')?.value.toLowerCase().trim() || '',
            accountCode: document.getElementById('filter-detail-account-code')?.value.toLowerCase().trim() || '',
            accountName: document.getElementById('filter-detail-account-name')?.value.toLowerCase().trim() || '',
            clientName: document.getElementById('filter-detail-client-name')?.value.toLowerCase().trim() || '',
            description: document.getElementById('filter-detail-description')?.value.toLowerCase().trim() || '',
            currency: document.getElementById('filter-detail-currency')?.value.toLowerCase().trim() || '',
            currencyAmount: document.getElementById('filter-detail-currency-amount')?.value.toLowerCase().trim() || '',
            currencyExchange: document.getElementById('filter-detail-currency-exchange')?.value.toLowerCase().trim() || '',
            debitAmount: document.getElementById('filter-detail-debit-amount')?.value.toLowerCase().trim() || '',
            creditAmount: document.getElementById('filter-detail-credit-amount')?.value.toLowerCase().trim() || '',
            cashFlowName: document.getElementById('filter-detail-cashflow-name')?.value.toLowerCase().trim() || '',
            userName: document.getElementById('filter-detail-user-name')?.value.toLowerCase().trim() || ''
        };
        
        // Apply filters
        if (Object.values(filters).some(f => f.length > 0)) {
            filtered = details.filter(item => {
                const values = {
                    documentNo: String(item.document_no || '').toLowerCase(),
                    documentDate: String(item.document_date || '').toLowerCase(),
                    accountCode: String(item.account_code || '').toLowerCase(),
                    accountName: String(item.account_name || '').toLowerCase(),
                    clientName: String(item.client_name || '').toLowerCase(),
                    description: String(item.description || '').toLowerCase(),
                    currency: String(item.currency_name || '').toLowerCase(),
                    currencyAmount: String(item.currency_amount || '').toLowerCase(),
                    currencyExchange: String(item.currency_exchange || '').toLowerCase(),
                    debitAmount: String(item.debit_amount || '').toLowerCase(),
                    creditAmount: String(item.credit_amount || '').toLowerCase(),
                    cashFlowName: String(item.cash_flow_name || '').toLowerCase(),
                    userName: String(item.user_name || '').toLowerCase()
                };
                
                return Object.keys(filters).every(key => {
                    const filterValue = filters[key];
                    if (!filterValue) return true;
                    
                    // Handle numeric filters
                    if (key.includes('Amount') || key.includes('Exchange')) {
                        if (filterValue.startsWith('>=')) {
                            const num = parseFloat(filterValue.substring(2));
                            return !isNaN(num) && parseFloat(values[key]) >= num;
                        } else if (filterValue.startsWith('<=')) {
                            const num = parseFloat(filterValue.substring(2));
                            return !isNaN(num) && parseFloat(values[key]) <= num;
                        } else if (filterValue.startsWith('>')) {
                            const num = parseFloat(filterValue.substring(1));
                            return !isNaN(num) && parseFloat(values[key]) > num;
                        } else if (filterValue.startsWith('<')) {
                            const num = parseFloat(filterValue.substring(1));
                            return !isNaN(num) && parseFloat(values[key]) < num;
                        } else if (filterValue.startsWith('=')) {
                            const num = parseFloat(filterValue.substring(1));
                            return !isNaN(num) && parseFloat(values[key]) === num;
                        } else {
                            const num = parseFloat(filterValue);
                            if (!isNaN(num)) {
                                return parseFloat(values[key]) === num;
                            }
                        }
                    }
                    
                    // Text filters
                    return values[key].includes(filterValue);
                });
            });
        }
        
        return filtered;
    }
    
    function updatePaginationInfoDetail(totalRecords, currentRecords, startIndex) {
        const showingStart = document.getElementById('showing-start-detail');
        const showingEnd = document.getElementById('showing-end-detail');
        const totalCount = document.getElementById('total-count-detail');
        const currentPageSpan = document.getElementById('current-page-detail');
        const totalPagesSpan = document.getElementById('total-pages-detail');
        
        if (showingStart) showingStart.textContent = startIndex + 1;
        if (showingEnd) showingEnd.textContent = startIndex + currentRecords;
        if (totalCount) totalCount.textContent = totalRecords;
        if (currentPageSpan) currentPageSpan.textContent = currentPageDetail;
        if (totalPagesSpan) totalPagesSpan.textContent = totalPagesDetail;
        
        // Generate dynamic pagination
        generatePaginationButtonsDetail();
    }
    
    function generatePaginationButtonsDetail() {
        const pageInfo = document.getElementById('page-info-detail');
        if (!pageInfo) return;
        
        // Clear existing buttons
        pageInfo.innerHTML = '';
        
        // Calculate pagination range
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPageDetail - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPagesDetail, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // Generate page buttons
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-2 py-1 text-sm rounded-md ${
                i === currentPageDetail 
                    ? 'bg-blue-400 text-white hover:bg-blue-500' 
                    : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
            }`;
            button.addEventListener('click', () => changePageDetail(i));
            pageInfo.appendChild(button);
        }
    }
    
    function switchToDocumentsView() {
        // Switch to documents view - uses ONLY cached data, no server calls
        // Show the documents view
        document.getElementById('cash-documents-view').style.display = 'block';
        
        // Hide the detail view
        document.getElementById('cash-journal-detail-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('documents');
        
        // Set to active documents filter
        isDeleteFilter = false;
        isUnrelatedFilter = false;
        
        // Set current active tab
        currentActiveTab = 'documents';
        
        // Display cached documents data (loaded by СЭРГЭЭХ button)
        if (documentsData && documentsData.length > 0) {
            applyFrontendFilter();
        } else {
            const tbody = document.getElementById('documents-tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load documents.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    
    function showDeletedDocuments() {
        // Switch to deleted documents view - uses ONLY cached data, no server calls
        // Show the documents view
        document.getElementById('cash-documents-view').style.display = 'block';
        
        // Hide the detail view
        document.getElementById('cash-journal-detail-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('deleted');
        
        // Set to deleted documents filter
        isDeleteFilter = true;
        isUnrelatedFilter = false;
        
        // Set current active tab
        currentActiveTab = 'deleted';
        
        // Display cached documents data filtered by deleted status (loaded by СЭРГЭЭХ button)
        if (documentsData && documentsData.length > 0) {
            applyFrontendFilter();
        } else {
            const tbody = document.getElementById('documents-tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load deleted documents.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    function showUnrelatedDocuments() {
        // Switch to unrelated documents view - uses ONLY cached data, no server calls
        // Show the documents view
        document.getElementById('cash-documents-view').style.display = 'block';
        
        // Hide the detail view
        document.getElementById('cash-journal-detail-view').style.display = 'none';
        
        // Update tab styling
        updateTabStyling('unrelated');
        
        // Set to unrelated documents filter
        isDeleteFilter = false;
        isUnrelatedFilter = true;
        
        // Set current active tab
        currentActiveTab = 'unrelated';
        
        // Display cached documents data filtered by unrelated status (loaded by СЭРГЭЭХ button)
        if (documentsData && documentsData.length > 0) {
            applyFrontendFilter();
        } else {
            const tbody = document.getElementById('documents-tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 class="text-sm font-medium text-gray-900 mb-1">Select date range and filter</h3>
                                <p class="text-sm text-gray-500">Please select start and end dates, then click Filter to load documents unrelated to transactions.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
    
    
    function updateTabStyling(activeTab) {
        // Use IDs for more reliable tab selection
        const tabDocuments = document.getElementById('tab-documents');
        const tabDetail = document.getElementById('tab-detail');
        const tabDeleted = document.getElementById('tab-deleted');
        const tabUnrelated = document.getElementById('tab-unrelated');
        
        // Reset all tabs
        [tabDocuments, tabDetail, tabDeleted, tabUnrelated].forEach(tab => {
            if (tab) {
                tab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
                tab.classList.add('border-gray-300', 'text-gray-500');
            }
        });
        
        // Set active tab
        if (activeTab === 'documents' && tabDocuments) {
            tabDocuments.classList.remove('border-gray-300', 'text-gray-500');
            tabDocuments.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        } else if (activeTab === 'detail' && tabDetail) {
            tabDetail.classList.remove('border-gray-300', 'text-gray-500');
            tabDetail.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        } else if (activeTab === 'deleted' && tabDeleted) {
            tabDeleted.classList.remove('border-gray-300', 'text-gray-500');
            tabDeleted.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        } else if (activeTab === 'unrelated' && tabUnrelated) {
            tabUnrelated.classList.remove('border-gray-300', 'text-gray-500');
            tabUnrelated.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        }
    }
    
    function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || isNaN(value)) return '0.00';
        return parseFloat(value).toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }
    
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }
    
    // Print function for БАРИМТ and УСТГАСАН БАРИМТ tabs
    function printDocumentsView() {
        // Hide other views before printing
        const detailView = document.getElementById('cash-journal-detail-view');
        if (detailView) {
            detailView.style.display = 'none';
        }
        const documentsView = document.getElementById('cash-documents-view');
        if (documentsView) {
            documentsView.style.display = 'block';
        }
        window.print();
    }
    
    // Print function for ЖУРНАЛ tab
    function printDetailView() {
        // Check if we have data to print
        if (!detailsData || detailsData.length === 0) {
            alert('No data to print. Please load data first.');
            return;
        }
        
        // Get date range from filter inputs
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // Calculate grand totals from ALL filtered data (not just current page)
        let totalDebit = 0;
        let totalCredit = 0;
        
        detailsData.forEach((item) => {
            totalDebit += parseFloat(item.debit_amount) || 0;
            totalCredit += parseFloat(item.credit_amount) || 0;
        });
        
        // Define column headers (excluding AccountName and User columns)
        const columnHeaders = [
            'Баримт',
            'Огноо',
            'Данс',
            'Харилцагч',
            'Гүйлгээний утга',
            'Валют',
            'Валютын дүн',
            'Ханш',
            'Дебит дүн',
            'Кредит дүн'
        ];
        
        // Call the generic print function
        if (typeof window.printJournalTable === 'function') {
            window.printJournalTable({
                title: 'ЕРӨНХИЙ ЖУРНАЛ',
                startDate: startDate,
                endDate: endDate,
                allData: detailsData, // All filtered rows, not just current page
                columnHeaders: columnHeaders,
                totals: {
                    debit: totalDebit,
                    credit: totalCredit
                }
            });
        } else {
            alert('Print system not loaded. Please refresh the page.');
        }
    }
    
    // Event listeners
    document.getElementById('filter-button').addEventListener('click', applyDateFilter);
    
    // Add click handler for table rows in БАРИМТ tab
    document.addEventListener('DOMContentLoaded', function() {
        const tbody = document.getElementById('documents-tbody');
        if (tbody) {
            tbody.addEventListener('click', function(e) {
                const row = e.target.closest('tr[data-document-id]');
                if (row) {
                    const documentId = row.getAttribute('data-document-id');
                    if (documentId) {
                        window.location.href = `/core/cashdocuments/${documentId}/bulk-manage-details/`;
                    }
                }
            });
        }
    });
</script>
{% endblock %}
