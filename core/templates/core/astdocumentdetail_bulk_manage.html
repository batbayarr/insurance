{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Manage Asset Document Items - {{ document.DocumentNo }} - Silicon-AI Accounting{% endblock %}

{% block content %}
<style>
/* Hide step controllers (spinner arrows) for number inputs */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type="number"] {
    -moz-appearance: textfield;
}
</style>
<div data-exchange-rate="1.0">
    <!-- Header -->
    <div class="flex justify-between items-center px-3 py-2 lg:px-6 bg-white border-b border-gray-200">
        <div>
            <h1 class="text-base lg:text-lg xl:text-xl font-medium text-gray-900">Хөрөнгийн бичилт</h1>
            <p class="text-xs text-gray-600">Баримтын №: {{ document.DocumentNo }} - {{ document.Description|truncatechars:100 }}</p>
        </div>
    </div>

    <!-- Document Data for JavaScript (align with inventory generic hooks) -->
    <script id="document-data" type="application/json">
    {
        "DocumentId": {{ document.DocumentId }},
        "DocumentTypeId": {{ document.DocumentTypeId.DocumentTypeId }},
        "AccountId": {% if document.AccountId %}{{ document.AccountId.AccountId }}{% else %}null{% endif %},
        "DepreciationAccountId": {% if depreciation_account_id %}{{ depreciation_account_id }}{% else %}null{% endif %},
            "ExpenseAccountId": {% if expense_account_id %}{{ expense_account_id }}{% else %}null{% endif %},
        "TemplateId": {% if document.TemplateId %}{{ document.TemplateId.TemplateId }}{% else %}null{% endif %},
        "IsVat": {% if document.IsVat %}true{% else %}false{% endif %},
        "ClientId": {{ document.ClientId.ClientId }},
        "VatAccountId": {% if document.VatAccountId %}{{ document.VatAccountId.AccountId }}{% else %}null{% endif %},
        "VatPercent": {{ VAT_RATE_PERCENT }},
        "template_details": [
            {% for td in template_details %}
            {
                "AccountId": {{ td.AccountId.AccountId }},
                "AccountCode": "{{ td.AccountId.AccountCode }}",
                "AccountName": "{{ td.AccountId.AccountName }}",
                "AccountTypeId": {{ td.AccountId.AccountTypeId.AccountTypeId }},
                "IsDebit": {% if td.IsDebit %}true{% else %}false{% endif %}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        "ClientCode": "{{ document.ClientId.ClientCode }}",
        "ClientName": "{{ document.ClientId.ClientName }}",
        "DocumentDate": "{{ document.DocumentDate|date:'Y-m-d' }}"
    }
    </script>

    <!-- Main Form -->
    <div class="bg-white shadow overflow-hidden rounded-lg border border-gray-200">
        




        <div class="p-4">
            <div class="px-4 py-2 lg:px-6 border-b border-gray-200" style="padding-right: 0px !important;">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-base lg:text-lg xl:text-xl font-medium text-gray-900">Хөрөнгийн бичилт</h3>
                    </div>
                    
                    <button type="button" id="add-new-asset-row-btn"
                            class="inline-flex items-center justify-center px-2 py-1 lg:px-3 lg:py-1.5 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span>МӨР НЭМЭХ</span>
                    </button>
                </div>
            </div>

            {% csrf_token %}
            
            <!-- Details Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">ID</th>
                            <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хөрөнгө (Asset Card) *</th>
                            <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200" style="display: none;">Тоо хэмжээ *</th>
                            <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Нэгжийн өртөг *</th>
                            <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Нэгжийн үнэ *</th>
                            <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 daily-expense-header" {% if document.DocumentTypeId.DocumentTypeId != 11 %}style="display: none;"{% endif %}>Өдрийн зардал</th>
                            <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">ЭХНИЙ ЭЛЭГДЭЛ</th>
                            <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Байгуулсан</th>
                            <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 predicted-depreciation-header" {% if document.DocumentTypeId.DocumentTypeId != 11 %}style="display: none;"{% endif %}>Байгуулах</th>
                            <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">ЭЦСИЙН ЭЛЭГДЭЛ</th>
                            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Үйлдэл</th>
                        </tr>
                    </thead>
                    <tbody id="details-tbody" class="bg-white divide-y divide-gray-200">
                        {% for item in document_items %}
                        <tr class="hover:bg-gray-50 existing-row" data-item-id="{{ item.DocumentItemId }}" data-dep-source="backend">
                            <td class="px-4 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
                                {{ item.DocumentItemId }}
                            </td>
                            <td class="px-2 py-1 border-r border-gray-200">
                                <div class="relative">
                                    <input type="hidden" name="asset_card_id_{{ item.DocumentItemId }}" 
                                           value="{% if item.AssetCardId %}{{ item.AssetCardId.AssetCardId }}{% endif %}" 
                                           class="asset-card-id-input"
                                           required>
                                    <input type="text" 
                                           value="{% if item.AssetCardId %}{% if item.AssetCardId.AssetCardCode %}{{ item.AssetCardId.AssetCardCode }} - {% endif %}{{ item.AssetCardId.AssetCardName }}{% endif %}" 
                                           class="asset-card-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500-display" 
                                           placeholder="Хөрөнгийн карт сонгох" 
                                           readonly 
                                           onclick="openAssetPopupWithContext(this, '{{ item.DocumentItemId }}')">
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                </div>
                            </td>
                            <td class="px-1 py-1 text-right border-r border-gray-200" style="display: none;">
                                <input type="number" name="quantity_{{ item.DocumentItemId }}" min="0" required readonly
                                       value="{{ item.Quantity|floatformat:2 }}"
                                       class="quantity-input w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50 cursor-not-allowed" 
                                       placeholder="0.00">
                            </td>
                            <td class="px-1 py-1 text-right border-r border-gray-200">
                                <input type="number" name="unit_cost_{{ item.DocumentItemId }}" min="0" required readonly
                                       value="{{ item.UnitCost|floatformat:2 }}"
                                       class="unit-cost-input w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50 cursor-not-allowed" 
                                       placeholder="0.00">
                            </td>
                            <td class="px-1 py-1 text-right border-r border-gray-200">
                                <input type="number" name="unit_price_{{ item.DocumentItemId }}" min="0" required
                                       value="{{ item.UnitPrice|floatformat:2 }}"
                                       class="unit-price-input w-full border border-gray-300 rounded px-1 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="0.00">
                            </td>
                            <td class="px-1 py-1 text-right border-r border-gray-200 daily-expense-cell" {% if document.DocumentTypeId.DocumentTypeId != 11 %}style="display: none;"{% endif %}>
                                <input type="text" name="daily_expense_{{ item.DocumentItemId }}" readonly
                                       value="{% if item.AssetCardId and item.AssetCardId.DailyExpense %}{{ item.AssetCardId.DailyExpense|floatformat:2 }}{% else %}0.00{% endif %}"
                                       class="daily-expense-display w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50" 
                                       placeholder="0.00">
                            </td>
                            <td class="px-1 py-1 text-right border-r border-gray-200">
                                <input type="text" name="cumulated_depreciation_{{ item.DocumentItemId }}" readonly
                                       value="{% if item.balance_cumulated_depreciation is not None %}{{ item.balance_cumulated_depreciation|floatformat:2 }}{% elif item.initial_depreciation is not None %}{{ item.initial_depreciation|floatformat:2 }}{% else %}0.00{% endif %}"
                                       class="cumulated-depreciation-display w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50" 
                                       placeholder="0.00">
                            </td>
                            <td class="px-1 py-1 text-right border-r border-gray-200">
                                <input type="text" name="depreciation_amount_{{ item.DocumentItemId }}" readonly
                                       value="{% if item.balance_depreciation_expense is not None %}{{ item.balance_depreciation_expense|floatformat:2 }}{% else %}0.00{% endif %}"
                                       class="depreciation-amount-display w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50" 
                                       placeholder="0.00">
                            </td>
                            <td class="px-1 py-1 text-right border-r border-gray-200 predicted-depreciation-cell" {% if document.DocumentTypeId.DocumentTypeId != 11 %}style="display: none;"{% endif %}>
                                <input type="text" name="predicted_depreciation_{{ item.DocumentItemId }}" readonly
                                       value="{% if document.DocumentTypeId.DocumentTypeId == 11 %}{{ item.balance_predicted_depreciation|default:0|floatformat:2 }}{% else %}0.00{% endif %}"
                                       class="predicted-depreciation-display w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50" 
                                       placeholder="0.00">
                            </td>
                            <td class="px-1 py-1 text-right border-r border-gray-200">
                                <input type="text" name="ending_depreciation_{{ item.DocumentItemId }}" readonly
                                       value="{% if item.total_expense is not None %}{{ item.total_expense|floatformat:2 }}{% else %}0.00{% endif %}"
                                       class="ending-depreciation-display w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50" 
                                       placeholder="0.00">
                            </td>
                            <td class="px-2 py-1 whitespace-nowrap text-right text-xs font-medium">
                                <div class="flex items-center justify-end space-x-1 lg:space-x-2">
                                    <button type="button" onclick="removeRow(this)" 
                                            class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                    <input type="hidden" name="delete_{{ item.DocumentItemId }}" value="false" id="delete_{{ item.DocumentItemId }}">
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-gray-100 border-t-2 border-gray-300">
                        <tr>
                            <td class="px-4 py-1 text-xs font-medium text-gray-900 border-r border-gray-200 text-left">НИЙТЛЭЛ</td>
                            <td class="px-2 py-1 text-xs font-medium text-gray-900 border-r border-gray-200 text-left"></td>
                            <td class="px-1 py-1 text-xs font-medium text-gray-900 border-r border-gray-200 text-right" style="display: none;">
                                <span id="sum-quantity" class="block text-right">0.00</span>
                            </td>
                            <td class="px-1 py-1 text-xs font-medium text-gray-900 border-r border-gray-200 text-right">
                                <span id="sum-unit-cost" class="block text-right">0.00</span>
                            </td>
                            <td class="px-1 py-1 text-xs font-medium text-gray-900 border-r border-gray-200 text-right">
                                <span id="sum-unit-price" class="block text-right">0.00</span>
                            </td>
                            <td class="px-1 py-1 text-xs font-medium text-gray-900 border-r border-gray-200 text-right daily-expense-cell" {% if document.DocumentTypeId.DocumentTypeId != 11 %}style="display: none;"{% endif %}>
                                <span id="sum-daily-expense" class="block text-right">0.00</span>
                            </td>
                            <td class="px-1 py-1 text-xs font-medium text-gray-900 border-r border-gray-200 text-right">
                                <span id="sum-cumulated-depreciation" class="block text-right">0.00</span>
                            </td>
                            <td class="px-1 py-1 text-xs font-medium text-gray-900 border-r border-gray-200 text-right">
                                <span id="sum-depreciation-amount" class="block text-right">0.00</span>
                            </td>
                            <td class="px-1 py-1 text-xs font-medium text-gray-900 border-r border-gray-200 text-right predicted-depreciation-cell" {% if document.DocumentTypeId.DocumentTypeId != 11 %}style="display: none;"{% endif %}>
                                <span id="sum-predicted-depreciation" class="block text-right">0.00</span>
                            </td>
                            <td class="px-1 py-1 text-xs font-medium text-gray-900 border-r border-gray-200 text-right">
                                <span id="sum-ending-depreciation" class="block text-right">0.00</span>
                            </td>
                            <td class="px-2 py-1"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Accounting Details Section -->
            {% if not user.groups.all.0.name == 'baraa_nyarav' %}
            <div class="mt-8">
                <div class="px-4 py-2 lg:px-6 border-b border-gray-200"  style="padding-right: 0px !important;">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-base lg:text-lg xl:text-xl font-medium text-gray-900">Журналын бичилт</h3>
                        </div>
                        <button type="button" id="add-new-detail-row-btn" 
                                class="inline-flex items-center justify-center px-2 py-1 lg:px-3 lg:py-1.5 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span>МӨР НЭМЭХ</span>
                        </button>
                    </div>
                </div>
        <!-- Accounting Details Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 border border-gray-200" style="table-layout: auto;">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">ID</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Данс *</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">харилцагч</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валют</th>
                        <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Ханш</th>
                        <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Валютын дүн *</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дебит эсэх *</th>
                        <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дебит дүн</th>
                        <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Кредит дүн</th>
                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Үйлдэл</th>
                    </tr>
                </thead>
                <tbody id="details-accounting-tbody" class="bg-white divide-y divide-gray-200">
                    {% for detail in document_details %}
                    <tr class="hover:bg-gray-50 existing-detail-row" data-detail-id="{{ detail.DocumentDetailId }}">
                        <td class="px-4 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
                            {{ detail.DocumentDetailId }}
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <div class="relative">
                                <input type="hidden" name="detail_account_id_{{ detail.DocumentDetailId }}" 
                                       value="{% if detail.AccountId %}{{ detail.AccountId.AccountId }}{% endif %}" 
                                       required>
                                <input type="text" 
                                       value="{% if detail.AccountId %}{{ detail.AccountId.AccountCode }} - {{ detail.AccountId.AccountName }}{% endif %}" 
                                       class="account-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500-display" 
                                       placeholder="Данс сонгох" 
                                       readonly 
                                      onclick="openAccountPopup(this, 'detail_{{ detail.DocumentDetailId }}', { modalTitle: 'Select Account', modalSubtitle: 'Choose an account for asset transactions' })">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <div class="relative">
                                <input type="hidden" name="detail_client_id_{{ detail.DocumentDetailId }}" 
                                       value="{% if detail.ClientId %}{{ detail.ClientId.ClientId }}{% endif %}">
                                <input type="text" 
                                       value="{% if detail.ClientId %}{{ detail.ClientId.ClientCode }} - {{ detail.ClientId.ClientName }}{% endif %}" 
                                       class="client-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500-readonly cursor-pointer" 
                                       placeholder="Харилцагч сонгох" 
                                       readonly 
                                       onclick="openClientPopup(this, 'detail_{{ detail.DocumentDetailId }}')">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <select name="detail_currency_id_{{ detail.DocumentDetailId }}" required class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Валют сонгох</option>
                                {% for currency in currencies %}
                                <option value="{{ currency.CurrencyId }}" {% if detail.CurrencyId and currency.CurrencyId == detail.CurrencyId.CurrencyId %}selected{% endif %}>
                                    {{ currency.CurrencyId }} - {{ currency.Currency_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="px-1 py-1 text-right border-r border-gray-200">
                            <input type="number" name="detail_currency_exchange_{{ detail.DocumentDetailId }}" min="0" 
                                   value="{% if detail.CurrencyExchange %}{{ detail.CurrencyExchange|floatformat:4 }}{% else %}1.0000{% endif %}"
                                   class="w-full border border-gray-300 rounded px-1 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="1.000000">
                        </td>
                        <td class="px-1 py-1 text-right border-r border-gray-200">
                            <input type="number" name="detail_currency_amount_{{ detail.DocumentDetailId }}" min="0" required
                                   value="{{ detail.CurrencyAmount }}"
                                   class="w-full border border-gray-300 rounded px-1 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="0.00">
                        </td>
                        <td class="px-2 py-1 text-left border-r border-gray-200">
                            <select name="detail_is_debit_{{ detail.DocumentDetailId }}" required class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Төрөл сонгох</option>
                                <option value="true" {% if detail.IsDebit %}selected{% endif %}>Дебит</option>
                                <option value="false" {% if not detail.IsDebit %}selected{% endif %}>Кредит</option>
                            </select>
                        </td>
                        <td class="px-1 py-1 text-right border-r border-gray-200">
                            <input type="number" name="detail_debit_amount_{{ detail.DocumentDetailId }}" min="0"
                                   value="{% if detail.IsDebit %}{{ detail.DebitAmount|floatformat:2 }}{% endif %}"
                                   class="w-full border border-gray-300 rounded px-1 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="0.00">
                        </td>
                        <td class="px-1 py-1 text-right border-r border-gray-200">
                            <input type="number" name="detail_credit_amount_{{ detail.DocumentDetailId }}" min="0"
                                   value="{% if not detail.IsDebit %}{{ detail.CreditAmount|floatformat:2 }}{% endif %}"
                                   class="w-full border border-gray-300 rounded px-1 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="0.00">
                        </td>
                        <td class="px-2 py-1 whitespace-nowrap text-right text-xs font-medium">
                            <div class="flex items-center justify-end space-x-1 lg:space-x-2">
                                <button type="button" onclick="removeDetailRow(this)" 
                                        class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                    <tfoot class="bg-gray-100 border-t-2 border-gray-300">
                        <tr>
                            <td class="px-4 py-1 text-xs text-gray-900 border-r border-gray-200 text-left"></td>
                            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-left"></td>
                            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-left"></td>
                            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-left"></td>
                            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right"></td>
                            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right"></td>
                            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-left"></td>
                            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                                <span id="sum-debit-amount" class="block text-right">0.00</span>
                            </td>
                            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">
                                <span id="sum-credit-amount" class="block text-right">0.00</span>
                            </td>
                            <td class="px-2 py-1"></td>
                        </tr>
                    </tfoot>
            </table>
        </div>
        
            </div>
            {% endif %}
            
            <!-- Summary and Actions -->
            <div class="flex justify-between items-center pt-4 border-t border-gray-200 mt-4">
                <div class="text-xs text-gray-600">
                    <div class="flex items-center space-x-3 lg:space-x-6">
                        <span class="text-xs"><span id="row-counter">{{ document_items|length }}</span> rows ready to save</span>
                        <div class="flex items-center space-x-2 lg:space-x-3">
                            <span class="text-gray-500 text-xs">Balance:</span>
                            <span class="text-gray-500 text-xs">Дебит:</span>
                            <span id="total-debit" class="font-medium text-red-600 text-xs">0.00</span>
                            <span class="text-gray-400">|</span>
                            <span class="text-gray-500 text-xs">Кредит:</span>
                            <span id="total-credit" class="font-medium text-green-600 text-xs">0.00</span>
                            <span id="balance-status" class="ml-2 lg:ml-3 px-2 py-1 lg:px-3 text-xs rounded-full"></span>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2 lg:space-x-4">
                    <a href="{% url 'core:astdocument_master_detail' %}?selected_document={{ document.DocumentId }}" 
                       class="px-2 py-1 lg:px-3 lg:py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        ЦУЦЛАХ
                    </a>
                    <button type="button" id="save-all-items" 
                            class="inline-flex items-center justify-center px-2 py-1 lg:px-3 lg:py-1.5 text-xs font-medium text-white bg-blue-600 border border-transparent rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            onclick="submitViaAPI();">
                        ХАДГАЛАХ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- No Details Message -->
    {% if not document_items %}
    <div class="bg-white shadow rounded-lg border border-gray-200 p-16 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        <h3 class="mt-4 text-xs font-medium text-gray-900">No items found</h3>
        <p class="mt-2 text-xs text-gray-500">Эхний хөрөнгийн бичлэг үүсгэхийн тулд "Шинэ мөр нэмэх" дээр дарна уу.</p>
    </div>
    {% endif %}
</div>

<!-- Include Asset Selection Modal -->
{% include 'core/components/asset_selection_modal.html' %}

<!-- Include Account Selection Modal -->
{% include 'core/components/account_selection_modal.html' %}

<!-- Include Client Selection Modal -->
{% include 'core/components/client_selection_modal.html' %}

<!-- Include Delete Modal -->
{% include 'core/components/delete_modal.html' %}

<!-- Include Message Modal -->
{% include 'core/components/message_modal.html' %}

<!-- Include asset-specific FillAccountingDetails function -->
<script src="{% static 'js/fill-accounting-details-asset.js' %}"></script>

<script>
// Function to show message modal
function showMessageModal(message, type = 'error') {
    const modal = document.getElementById('message-modal');
    const title = document.getElementById('message-modal-title');
    const text = document.getElementById('message-modal-text');
    const iconContainer = document.getElementById('message-modal-icon-container');
    const errorIcon = document.getElementById('message-modal-icon-error');
    const successIcon = document.getElementById('message-modal-icon-success');
    const warningIcon = document.getElementById('message-modal-icon-warning');
    const infoIcon = document.getElementById('message-modal-icon-info');
    
    if (!modal || !title || !text) return;
    
    // Set message text
    text.textContent = message;
    
    // Set title based on type
    const titles = {
        'error': 'Алдаа',
        'success': 'Амжилттай',
        'warning': 'Анхааруулга',
        'info': 'Мэдээлэл'
    };
    title.textContent = titles[type] || 'Алдаа';
    
    // Reset all icons
    errorIcon.classList.add('hidden');
    successIcon.classList.add('hidden');
    warningIcon.classList.add('hidden');
    infoIcon.classList.add('hidden');
    
    // Show appropriate icon and set container color
    if (type === 'error') {
        errorIcon.classList.remove('hidden');
        iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100';
    } else if (type === 'success') {
        successIcon.classList.remove('hidden');
        iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100';
    } else if (type === 'warning') {
        warningIcon.classList.remove('hidden');
        iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100';
    } else if (type === 'info') {
        infoIcon.classList.remove('hidden');
        iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100';
    }
    
    // Show modal
    modal.classList.remove('hidden');
}

// VAT Rate from global constants (available via context processor)
const VAT_RATE = {{ VAT_RATE }};

// Local wrapper so generic listeners can trigger recalculation like inventory
// Must be defined before DOMContentLoaded so setupFillAccountingDetailsListeners can find it
window.FillAccountingDetails = function() {
    console.log('FillAccountingDetails called');
    
    // Call the generic FillAccountingDetails function with asset-specific config
    if (typeof window.FillAccountingDetailsGeneric === 'function') {
        console.log('FillAccountingDetailsGeneric function found');
        
        // Ensure functions are available
        if (typeof addDetailRow !== 'function') {
            console.error('addDetailRow function not defined');
            return;
        }
        if (typeof updateBalanceDisplay !== 'function') {
            console.error('updateBalanceDisplay function not defined');
            return;
        }
        
        console.log('All required functions available, calling FillAccountingDetailsGeneric...');
        
        window.FillAccountingDetailsGeneric({
            documentDataId: 'document-data',
            firstTableId: 'details-tbody',
            secondTableId: 'details-accounting-tbody',
            documentTypes: [10, 11],
            debugPrefix: 'Asset',
            addDetailRowFunction: addDetailRow,
            updateBalanceDisplayFunction: updateBalanceDisplay
        });
    } else {
        console.error('Generic FillAccountingDetailsGeneric function not loaded');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Get document's default exchange rate from data attribute
    window.documentExchangeRate = parseFloat(document.querySelector('[data-exchange-rate]').getAttribute('data-exchange-rate') || '1.0');
    
    // Flag to track if automatic records have been generated
    window.autoRecordsGenerated = false;
    
    // Show/hide dailyExpense column based on documentType
    const documentDataScript = document.getElementById('document-data');
    if (documentDataScript) {
        try {
            const documentData = JSON.parse(documentDataScript.textContent);
            const documentTypeId = documentData.DocumentTypeId;
            
            if (documentTypeId === 11) {
                // Show dailyExpense column
                const dailyExpenseCells = document.querySelectorAll('.daily-expense-cell');
                dailyExpenseCells.forEach(cell => {
                    cell.style.display = '';
                });
                const dailyExpenseHeaders = document.querySelectorAll('.daily-expense-header');
                dailyExpenseHeaders.forEach(header => {
                    header.style.display = '';
                });
            } else {
                // Hide dailyExpense column
                const dailyExpenseCells = document.querySelectorAll('.daily-expense-cell');
                dailyExpenseCells.forEach(cell => {
                    cell.style.display = 'none';
                });
                const dailyExpenseHeaders = document.querySelectorAll('.daily-expense-header');
                dailyExpenseHeaders.forEach(header => {
                    header.style.display = 'none';
                });
            }
        } catch (e) {
            console.error('Error parsing document data:', e);
        }
    }
    
    // Set up listeners to trigger recalculation similar to inventory
    if (typeof setupFillAccountingDetailsListeners === 'function') {
        setupFillAccountingDetailsListeners({
            documentDataId: 'document-data',
            firstTableId: 'details-tbody',
            secondTableId: 'details-accounting-tbody',
            documentTypes: [10, 11],
            debugPrefix: 'Asset'
        });
    }

    // Add new asset row when button is clicked
    const addNewAssetRowBtn = document.getElementById('add-new-asset-row-btn');
    if (addNewAssetRowBtn) {
        addNewAssetRowBtn.addEventListener('click', function() {
            window.addNewRow();
        });
    }
    
    // Add new detail row when button is clicked
    const addNewDetailRowBtn = document.getElementById('add-new-detail-row-btn');
    if (addNewDetailRowBtn) {
        addNewDetailRowBtn.addEventListener('click', function() {
            // Check if first table (asset items) has any rows
            const assetTbody = document.getElementById('details-tbody');
            if (assetTbody) {
                const visibleAssetRows = assetTbody.querySelectorAll('tr:not([style*="display: none"])');
                if (visibleAssetRows.length === 0) {
                    alert('Падааны мэдээлэл оруулна уу?');
                    return;
                }
            }
            addNewDetailRow();
        });
    }
    
    // API submission function
    window.submitViaAPI = function() {
        try {
            // Check if first table (asset items) has any rows before submission
            const assetTbody = document.getElementById('details-tbody');
            if (assetTbody) {
                const visibleAssetRows = assetTbody.querySelectorAll('tr:not([style*="display: none"])');
                if (visibleAssetRows.length === 0) {
                    alert('Падааны мэдээлэл оруулна уу?');
                    return;
                }
            }
            
            // Check for duplicate AssetCardId
            const assetCardIds = [];
            const visibleRows = assetTbody.querySelectorAll('tr:not([style*="display: none"])');
            
            visibleRows.forEach(row => {
                // Check for existing rows
                const existingAssetCardId = row.querySelector('input[name*="asset_card_id_"]')?.value;
                // Check for new rows
                const newAssetCardId = row.querySelector('input[name*="new_asset_card_id_"]')?.value;
                
                const assetCardId = existingAssetCardId || newAssetCardId;
                
                if (assetCardId && assetCardId.trim() !== '') {
                    assetCardIds.push(assetCardId);
                }
            });
            
            // Check for duplicates
            const duplicates = assetCardIds.filter((id, index) => assetCardIds.indexOf(id) !== index);
            if (duplicates.length > 0) {
                // Show modal with error message
                showMessageModal('Баримтад хөрөнгийн нэр нэгээс дээш удаа орсон байна. Засна уу?', 'error');
                return;
            }
            
            // Collect asset items data (first table)
            const items = {};
            const newItems = [];
            const deletedItems = [];
            
            // Process existing asset items
            const existingItemRows = document.querySelectorAll('#details-tbody tr.existing-row');
            existingItemRows.forEach(row => {
                const itemId = row.getAttribute('data-item-id');
                const deleteInput = row.querySelector('input[name*="delete_"]');
                
                if (deleteInput && deleteInput.value === 'true') {
                    deletedItems.push(itemId);
                } else {
                    const assetCardId = row.querySelector('input[name*="asset_card_id_"]')?.value;
                    const quantity = row.querySelector('input[name*="quantity_"]')?.value;
                    const unitCost = row.querySelector('input[name*="unit_cost_"]')?.value;
                    const unitPrice = row.querySelector('input[name*="unit_price_"]')?.value;
                    const predictedDepreciation = row.querySelector('input[name*="predicted_depreciation_"]')?.value || '0';
                    
                    if (assetCardId && quantity && unitCost && unitPrice) {
                        items[itemId] = {
                            asset_card_id: assetCardId,
                            quantity: quantity,
                            unit_cost: unitCost,
                            unit_price: unitPrice,
                            predicted_depreciation: predictedDepreciation.replace(/,/g, '') // Remove commas
                        };
                    }
                }
            });
            
            // Process new asset items
            const newItemRows = document.querySelectorAll('#details-tbody tr.new-row');
            newItemRows.forEach(row => {
                const assetCardId = row.querySelector('input[name*="new_asset_card_id_"]')?.value;
                const quantity = row.querySelector('input[name*="new_quantity_"]')?.value;
                const unitCost = row.querySelector('input[name*="new_unit_cost_"]')?.value;
                const unitPrice = row.querySelector('input[name*="new_unit_price_"]')?.value;
                const predictedDepreciation = row.querySelector('input[name*="new_predicted_depreciation_"]')?.value || '0';
                
                if (assetCardId && quantity && unitCost && unitPrice) {
                    newItems.push({
                        asset_card_id: assetCardId,
                        quantity: quantity,
                        unit_cost: unitCost,
                        unit_price: unitPrice,
                        predicted_depreciation: predictedDepreciation.replace(/,/g, '') // Remove commas
                    });
                }
            });
            
            // Collect accounting details data (second table) - exclude deleted rows
            const details = [];
            const detailRows = document.querySelectorAll('#details-accounting-tbody tr:not([style*="display: none"])');
            
            detailRows.forEach((row, index) => {
                // Look for both existing and new row patterns
                const accountId = row.querySelector('input[name*="detail_account_id"]')?.value || row.querySelector('input[name*="new_detail_account_id"]')?.value;
                const clientId = row.querySelector('input[name*="detail_client_id"]')?.value || row.querySelector('input[name*="new_detail_client_id"]')?.value;
                const currencyId = row.querySelector('select[name*="detail_currency_id"]')?.value || row.querySelector('select[name*="new_detail_currency_id"]')?.value;
                const currencyExchange = row.querySelector('input[name*="detail_currency_exchange"]')?.value || row.querySelector('input[name*="new_detail_currency_exchange"]')?.value;
                const currencyAmount = row.querySelector('input[name*="detail_currency_amount"]')?.value || row.querySelector('input[name*="new_detail_currency_amount"]')?.value;
                const isDebitVal = row.querySelector('select[name*="detail_is_debit"]')?.value || row.querySelector('select[name*="new_detail_is_debit"]')?.value;
                
                // Enforce currency required
                if (!currencyId) {
                    throw new Error('Currency is required for all accounting rows.');
                }

                if (accountId && currencyAmount && isDebitVal) {
                    // Convert string "true"/"false" to boolean true/false
                    const isDebit = isDebitVal === 'true';
                    
                    // Get the calculated debit/credit amounts from the form
                    const debitAmount = row.querySelector('input[name*="detail_debit_amount"]')?.value || row.querySelector('input[name*="new_detail_debit_amount"]')?.value || '0';
                    const creditAmount = row.querySelector('input[name*="detail_credit_amount"]')?.value || row.querySelector('input[name*="new_detail_credit_amount"]')?.value || '0';
                    
                    details.push({
                        account_id: accountId,
                        client_id: clientId,
                        currency_id: currencyId,
                        currency_exchange: currencyExchange || '1.0',
                        currency_amount: currencyAmount,
                        is_debit: isDebit,
                        debit_amount: debitAmount,
                        credit_amount: creditAmount
                    });
                }
            });
            
            // Validate balance before submission (sum of debits = sum of credits)
            if (details.length > 0) {
                let totalDebit = 0;
                let totalCredit = 0;
                
                details.forEach(detail => {
                    totalDebit += parseFloat(detail.debit_amount) || 0;
                    totalCredit += parseFloat(detail.credit_amount) || 0;
                });
                
                const difference = Math.abs(totalDebit - totalCredit);
                const tolerance = 0.01;
                
                if (difference > tolerance) {
                    alert(`Баланс тэнцэхгүй байна!\nДебит: ${totalDebit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\nКредит: ${totalCredit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\nЗөрүү: ${difference.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);
                    return;
                }
            }
            
            // Submit to API
            const documentId = "{{ document.DocumentId }}";
            const apiUrl = `/core/astdocuments/${documentId}/bulk-manage-details/api/`;
            
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ 
                    items: items,
                    new_items: newItems,
                    deleted_items: deletedItems,
                    details: details 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect to master detail page
                    window.location.href = `/core/astdocuments/?selected_document=${documentId}`;
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('API Error:', error);
                alert(`API Error: ${error.message}`);
            });
                
            } catch (error) {
            console.error('Error in API submission:', error);
            alert(`Error: ${error.message}`);
        }
    };
    
    // Add event listeners to existing detail inputs
    initializeDetailEventListeners();
    
    // Initialize asset item calculations
    initializeAssetCalculations();
    
    // Format all existing calculated fields
    formatAllCalculatedFields();
    
    // Recalculate all asset totals on page load
    recalculateAllAssetTotals();
    
    // Force recalculate all existing amounts on page load
    forceRecalculateAllAmounts();
    
    // Initialize balance display
    updateBalanceDisplay();
    
    // Initialize asset totals summary
    updateAssetTotalsSummary();
    
    // Calculate depreciation amounts for all existing rows on page load
    calculateAllDepreciationAmounts();
    
    // Calculate ending depreciation for all existing rows on page load
    calculateAllEndingDepreciation();
    
    // Update summary row totals on page load
    updateSummaryRowTotals();
    
    // Fetch predicted depreciation for all existing items if documentTypeId === 11
    if (documentDataScript) {
        try {
            const documentData = JSON.parse(documentDataScript.textContent);
            if (documentData.DocumentTypeId === 11 && documentData.DocumentDate && documentData.AccountId) {
                fetchPredictedDepreciationForAllItems(documentData);
            }
        } catch (e) {
            console.error('Error parsing document data for predicted depreciation fetch:', e);
        }
    }
});

// Function to fetch predicted depreciation for all existing items
async function fetchPredictedDepreciationForAllItems(documentData) {
    const documentTypeId = documentData.DocumentTypeId;
    const documentDate = documentData.DocumentDate;
    const accountId = documentData.AccountId;
    
    if (documentTypeId !== 11 || !documentDate || !accountId) {
        return;
    }
    
    // Get all existing item rows
    const existingRows = document.querySelectorAll('#details-tbody tr.existing-row');
    if (existingRows.length === 0) {
        return;
    }
    
    // Build API query parameters
    const documentDateObj = new Date(documentDate);
    const beginDate = new Date(documentDateObj);
    beginDate.setDate(beginDate.getDate() - 1);
    
    const startDateStr = beginDate.toISOString().split('T')[0];
    const endDateStr = documentDateObj.toISOString().split('T')[0];
    
    const balanceQuery = new URLSearchParams({
        start_date: startDateStr,
        end_date: endDateStr,
        as_of_date: documentDate,
        account_id: accountId,
        document_type_id: documentTypeId
    });
    
    try {
        // Fetch balance data from API
        const response = await fetch(`/core/api/ast-balance-data/?${balanceQuery.toString()}`);
        const balanceData = await response.json();
        
        if (!balanceData.success || !balanceData.balance_data) {
            console.error('Failed to fetch balance data:', balanceData.error);
            return;
        }
        
        // Create lookup map by assetcardid
        const balanceLookup = {};
        balanceData.balance_data.forEach(item => {
            const assetCardId = item.assetcardid;
            if (assetCardId) {
                balanceLookup[assetCardId] = item;
            }
        });
        
        // Update each row with predicted depreciation
        existingRows.forEach(row => {
            const assetCardIdInput = row.querySelector('input[name*="asset_card_id_"]');
            if (!assetCardIdInput || !assetCardIdInput.value) {
                return;
            }
            
            const assetCardId = parseInt(assetCardIdInput.value);
            const balanceItem = balanceLookup[assetCardId];
            
            if (balanceItem) {
                // Get predicted depreciation value
                const predictedDepreciation = balanceItem.predicteddepreciation || 
                                            balanceItem.Predicteddepreciation || 
                                            balanceItem.PredictedDepreciation || 
                                            0;
                
                // Find the predicted depreciation input field
                const predictedDepInput = row.querySelector('input[name*="predicted_depreciation_"]');
                if (predictedDepInput) {
                    // Store the raw numeric value (no formatting) for reliable parsing
                    const numericValue = parseFloat(predictedDepreciation) || 0;
                    // Set the value as a clean number string (no commas) for calculations
                    predictedDepInput.value = numericValue.toFixed(2);
                }
            }
        });
        
        // Update summary totals after updating values
        if (typeof updateSummaryRowTotals === 'function') {
            updateSummaryRowTotals();
        }
        
        // Note: FillAccountingDetails is NOT called here during initial load
        // It will be triggered by user actions (input changes, row additions, etc.)
    } catch (error) {
        console.error('Error fetching predicted depreciation:', error);
    }
}

// Cache period begin dates per document date to avoid stale lookups
const periodBeginDateCache = new Map();

// Function to get period begin date for a document date
async function getPeriodBeginDate(documentDate) {
    if (!documentDate) {
        return null;
    }

    if (periodBeginDateCache.has(documentDate)) {
        return periodBeginDateCache.get(documentDate);
    }
    
    try {
        const response = await fetch(`/core/api/period-begin-date/?document_date=${documentDate}`);
        const data = await response.json();
        
        if (data.success) {
            periodBeginDateCache.set(documentDate, data.begin_date);
            return data.begin_date;
        } else {
            console.error('Error getting period begin date:', data.error);
            // Fallback: calculate first day of month from document date
            const date = new Date(documentDate);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const beginDate = `${year}-${month}-01`;
            periodBeginDateCache.set(documentDate, beginDate);
            return beginDate;
        }
    } catch (error) {
        console.error('Error fetching period begin date:', error);
        // Fallback: calculate first day of month from document date
        const date = new Date(documentDate);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const beginDate = `${year}-${month}-01`;
        periodBeginDateCache.set(documentDate, beginDate);
        return beginDate;
    }
}

// Function to calculate depreciation amount for a row
async function calculateDepreciationAmount(row) {
    const dailyExpenseInput = row.querySelector('.daily-expense-display');
    const depreciationAmountInput = row.querySelector('.depreciation-amount-display');
    
    if (!dailyExpenseInput || !depreciationAmountInput) {
        return;
    }

    if (row && row.dataset && row.dataset.depSource === 'backend') {
        return;
    }
    
    // Get document date from document-data JSON
    const documentDataScript = document.getElementById('document-data');
    if (!documentDataScript) {
        return;
    }
    
    try {
        const documentData = JSON.parse(documentDataScript.textContent);
        const documentDate = documentData.DocumentDate;
        
        if (!documentDate) {
            depreciationAmountInput.value = '0.00';
            return;
        }
        
        // Get daily expense value
        const dailyExpense = parseFloat(dailyExpenseInput.value) || 0;
        
        if (dailyExpense === 0) {
            depreciationAmountInput.value = '0.00';
            return;
        }
        
        // Get period begin date
        const beginDate = await getPeriodBeginDate(documentDate);
        
        // Calculate days difference: (documentDate - beginDate) + 1
        const docDate = new Date(documentDate);
        const begDate = new Date(beginDate);
        const timeDiff = docDate.getTime() - begDate.getTime();
        const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1; // +1 to include both dates
        
        // Calculate depreciation amount
        const depreciationAmount = daysDiff * dailyExpense;
        
        // Format with 2 decimal places and thousands separator
        depreciationAmountInput.value = depreciationAmount.toLocaleString('en-US', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        });
        
        // Trigger ending depreciation calculation after depreciation amount is calculated
        if (typeof calculateEndingDepreciation === 'function') {
            calculateEndingDepreciation(row);
        }
        
        // Update summary row totals
        if (typeof updateSummaryRowTotals === 'function') {
            updateSummaryRowTotals();
        }
    } catch (error) {
        console.error('Error calculating depreciation amount:', error);
        depreciationAmountInput.value = '0.00';
    }
}

// Function to calculate depreciation amounts for all rows
async function calculateAllDepreciationAmounts() {
    const tbody = document.getElementById('details-tbody');
    if (!tbody) {
        return;
    }
    
    const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])');
    for (const row of visibleRows) {
        await calculateDepreciationAmount(row);
    }
}

// Function to calculate ending depreciation (cumulatedDepreciation + depreciationAmount)
function calculateEndingDepreciation(row) {
    const cumulatedDepreciationInput = row.querySelector('.cumulated-depreciation-display');
    const depreciationAmountInput = row.querySelector('.depreciation-amount-display');
    const endingDepreciationInput = row.querySelector('.ending-depreciation-display');
    
    if (!endingDepreciationInput) {
        return;
    }

    if (row && row.dataset && row.dataset.depSource === 'backend') {
        return;
    }
    
    try {
        // Get cumulated depreciation value (remove thousands separators)
        const cumulatedDepreciation = cumulatedDepreciationInput ? 
            parseFloat(cumulatedDepreciationInput.value.replace(/,/g, '')) || 0 : 0;
        
        // Get depreciation amount value (remove thousands separators)
        const depreciationAmount = depreciationAmountInput ? 
            parseFloat(depreciationAmountInput.value.replace(/,/g, '')) || 0 : 0;
        
        // Calculate ending depreciation
        const endingDepreciation = cumulatedDepreciation + depreciationAmount;
        
        // Format with 2 decimal places and thousands separator
        endingDepreciationInput.value = endingDepreciation.toLocaleString('en-US', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        });
        
        // Update summary row totals
        if (typeof updateSummaryRowTotals === 'function') {
            updateSummaryRowTotals();
        }
    } catch (error) {
        console.error('Error calculating ending depreciation:', error);
        endingDepreciationInput.value = '0.00';
    }
}

// Function to calculate ending depreciation for all rows
function calculateAllEndingDepreciation() {
    const tbody = document.getElementById('details-tbody');
    if (!tbody) {
        return;
    }
    
    const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])');
    visibleRows.forEach(row => {
        calculateEndingDepreciation(row);
    });
}

// Function to add a new row
window.addNewRow = function() {
    const tbody = document.getElementById('details-tbody');
    if (!tbody) {
        return;
    }
    const newRowCounter = tbody.querySelectorAll('tr.new-row').length;
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 new-row';
    row.innerHTML = `
        <td class="px-4 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
            <span class="text-green-600 font-medium">NEW</span>
        </td>
        <td class="px-2 py-1 border-r border-gray-200">
            <div class="relative">
                <input type="hidden" name="new_asset_card_id_${newRowCounter}" class="asset-card-id-input" required>
                <input type="text" class="asset-card-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 cursor-pointer" 
                                       placeholder="Хөрөнгийн карт сонгох"
                       readonly 
                       onclick="openAssetPopupWithContext(this, 'new_${newRowCounter}')">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200" style="display: none;">
            <input type="number" name="new_quantity_${newRowCounter}" min="0" required readonly
                   class="quantity-input w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50 cursor-not-allowed" 
                   placeholder="0.00">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="number" name="new_unit_cost_${newRowCounter}" min="0" required readonly
                   class="unit-cost-input w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50 cursor-not-allowed" 
                   placeholder="0.00">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="number" name="new_unit_price_${newRowCounter}" min="0" required
                   class="unit-price-input w-full border border-gray-300 rounded px-1 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200 daily-expense-cell" style="display: none;">
            <input type="text" name="new_daily_expense_${newRowCounter}" readonly
                   class="daily-expense-display w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50" 
                   placeholder="0.00">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="text" name="new_cumulated_depreciation_${newRowCounter}" readonly
                   class="cumulated-depreciation-display w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50" 
                   placeholder="0.00">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="text" name="new_depreciation_amount_${newRowCounter}" readonly
                   class="depreciation-amount-display w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50" 
                   placeholder="0.00">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200 predicted-depreciation-cell" style="display: none;">
            <input type="text" name="new_predicted_depreciation_${newRowCounter}" readonly
                   class="predicted-depreciation-display w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50" 
                   placeholder="0.00">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="text" name="new_ending_depreciation_${newRowCounter}" readonly
                   class="ending-depreciation-display w-full border border-gray-300 rounded px-1 py-1 text-xs text-right bg-gray-50" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1 whitespace-nowrap text-right text-xs font-medium">
            <div class="flex items-center justify-end space-x-1 lg:space-x-2">
                <button type="button" onclick="removeNewRow(this)" 
                        class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </td>
    `;
    tbody.appendChild(row);
    addAssetCalculationListeners(row);
    formatAssetRowNumericFields(row);
    
    // Show/hide dailyExpense and predicted depreciation cells based on documentType
    const documentDataScript = document.getElementById('document-data');
    if (documentDataScript) {
        try {
            const documentData = JSON.parse(documentDataScript.textContent);
            const documentTypeId = documentData.DocumentTypeId;
            const dailyExpenseCell = row.querySelector('.daily-expense-cell');
            const predictedDepreciationCell = row.querySelector('.predicted-depreciation-cell');
            if (dailyExpenseCell) {
                if (documentTypeId === 11) {
                    dailyExpenseCell.style.display = '';
                } else {
                    dailyExpenseCell.style.display = 'none';
                }
            }
            if (predictedDepreciationCell) {
                if (documentTypeId === 11) {
                    predictedDepreciationCell.style.display = '';
                } else {
                    predictedDepreciationCell.style.display = 'none';
                }
            }
        } catch (e) {
            console.error('Error parsing document data:', e);
        }
    }
    
    // Note: FillAccountingDetails will be called after asset is selected via refreshAccountingAfterAssetChange
    // Don't call it here because predicted depreciation won't be populated yet for new rows
    
    // Calculate depreciation amount for the new row
    if (typeof calculateDepreciationAmount === 'function') {
        calculateDepreciationAmount(row);
    }
    
    // Calculate ending depreciation for the new row
    if (typeof calculateEndingDepreciation === 'function') {
        calculateEndingDepreciation(row);
    }
}

// Function to remove a new row
window.removeNewRow = function(button) {
    const row = button.closest('tr');
    if (row) {
        row.remove();
        updateAssetTotalsSummary();
        
        // Update summary row totals
        if (typeof updateSummaryRowTotals === 'function') {
            updateSummaryRowTotals();
        }
        
        // Automatically fill accounting details when a row is removed
        if (typeof window.FillAccountingDetails === 'function') {
            window.FillAccountingDetails();
        }
    }
}

// Function to remove an existing row (mark for deletion)
window.removeRow = function(button) {
    const row = button.closest('tr');
    if (row) {
        const itemId = row.querySelector('input[name^="asset_card_id_"]').name.replace('asset_card_id_', '');
        const deleteInput = document.getElementById('delete_' + itemId);
        if (deleteInput) {
            deleteInput.value = 'true';
        }
        // Hide the row visually but keep it in DOM so delete flag is submitted
        row.style.display = 'none';
        updateAssetTotalsSummary();
        
        // Update summary row totals
        if (typeof updateSummaryRowTotals === 'function') {
            updateSummaryRowTotals();
        }
        
        // Automatically fill accounting details when a row is deleted
        if (typeof window.FillAccountingDetails === 'function') {
            window.FillAccountingDetails();
        }
    }
}

// Helper function to add a detail row to the second table (asset)
function addDetailRow(data) {
    const detailsTbody = document.getElementById('details-accounting-tbody');
    if (!detailsTbody) {
        console.error('details-accounting-tbody not found');
        return;
    }
    const rowId = data.rowId || `auto_${Date.now()}`;
    const newRow = document.createElement('tr');
    newRow.className = 'hover:bg-gray-50 new-detail-row';
    newRow.setAttribute('data-row-id', rowId);
    newRow.innerHTML = `
        <td class="px-4 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${rowId}</td>
        <td class="px-2 py-1 border-r border-gray-200">
            <div class="relative">
                <input type="hidden" name="new_detail_account_id_${rowId}" value="${data.accountId}" required>
                <input type="text" value="${data.accountDisplay}" 
                       class="account-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 cursor-pointer" 
                       readonly 
                       onclick="openAccountPopup(this, 'new_detail_${rowId}', { modalTitle: 'Select Account', modalSubtitle: 'Choose an account for asset transactions' })">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
        </td>
        <td class="px-2 py-1 border-r border-gray-200">
            <div class="relative">
                <input type="hidden" name="new_detail_client_id_${rowId}" value="${data.clientId ?? ''}">
                <input type="text" value="${data.clientDisplay ?? ''}" 
                       class="client-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 cursor-pointer bg-gray-50" 
                       readonly 
                       onclick="openClientPopup(this, 'new_detail_${rowId}')">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
        </td>
        <td class="px-2 py-1 border-r border-gray-200">
            <select name="new_detail_currency_id_${rowId}" class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="${data.currencyId ?? 1}" selected>${data.currencyId ?? 1} - MNT</option>
            </select>
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="number" name="new_detail_currency_exchange_${rowId}" min="0"
                   value="${data.currencyExchange ?? 1}"
                   class="w-full border border-gray-300 rounded px-1 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="1.000000">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="number" name="new_detail_currency_amount_${rowId}" min="0" required
                   value="${data.currencyAmount ?? '0.000000'}"
                   class="w-full border border-gray-300 rounded px-1 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1 text-left border-r border-gray-200">
            <select name="new_detail_is_debit_${rowId}" required class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="true" ${data.isDebit ? 'selected' : ''}>Дебит</option>
                <option value="false" ${!data.isDebit ? 'selected' : ''}>Кредит</option>
            </select>
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="number" name="new_detail_debit_amount_${rowId}" min="0"
                   value="${data.isDebit ? (data.currencyAmount ?? '0.000000') : '0.000000'}"
                   class="w-full border border-gray-300 rounded px-1 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="number" name="new_detail_credit_amount_${rowId}" min="0"
                   value="${!data.isDebit ? (data.currencyAmount ?? '0.000000') : '0.000000'}"
                   class="w-full border border-gray-300 rounded px-1 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1 whitespace-nowrap text-right text-xs font-medium">
            <div class="flex items-center justify-end space-x-1 lg:space-x-2">
                <button type="button" onclick="removeNewDetailRow(this)" 
                        class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </td>`;

    detailsTbody.appendChild(newRow);
    addEventListenersToDetailRow(newRow);
    updateBalanceDisplay();
}

// Add new accounting detail row
function addNewDetailRow() {
    // Check if first table (asset items) has any rows
    const assetTbody = document.getElementById('details-tbody');
    if (!assetTbody) {
        return;
    }
    
    // Count visible asset rows (excluding deleted ones)
    const visibleAssetRows = assetTbody.querySelectorAll('tr:not([style*="display: none"])');
    if (visibleAssetRows.length === 0) {
        alert('Падааны мэдээлэл оруулна уу?');
        return;
    }
    
    const tbody = document.getElementById('details-accounting-tbody');
    if (!tbody) {
        return;
    }
    
    // Check if there are existing rows in the second table
    const existingRows = tbody.querySelectorAll('tr.existing-detail-row');
    const hasExistingRows = existingRows.length > 0;
    
    // Get document type and VAT information from the page
    const documentType = {{ document.DocumentTypeId.DocumentTypeId }};
    const isVat = {{ document.IsVat|yesno:"true,false" }};
    
    // Calculate total cost amount from first table
    const totalCostAmount = calculateTotalCostAmount();
    
    // Check if this is the first time adding a detail row and if we should auto-generate records
    // Only auto-generate if there are no existing rows and it's the first time
    const shouldAutoGenerate = !window.autoRecordsGenerated && (documentType === 10 || documentType === 11) && !hasExistingRows;
    
    // For delete all and insert approach, use sequential numbering for all rows
    const newRowCounter = tbody.querySelectorAll('tr').length;
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 new-detail-row';
    row.innerHTML = `
        <td class="px-4 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
            <span class="text-green-600 font-medium">NEW</span>
        </td>
        <td class="px-2 py-1 border-r border-gray-200">
            <div class="relative">
                <input type="hidden" name="new_detail_account_id_${newRowCounter}" required>
                <input type="text" class="account-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 cursor-pointer" 
                       placeholder="Данс сонгох" 
                       readonly 
                       onclick="openAccountPopup(this, 'new_detail_${newRowCounter}', { modalTitle: 'Данс сонгох', modalSubtitle: 'Хөрөнгийн гүйлгээний данс сонгох' })">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
        </td>
        <td class="px-2 py-1 border-r border-gray-200">
            <div class="relative">
                <input type="hidden" name="new_detail_client_id_${newRowCounter}">
                <input type="text" class="client-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 cursor-pointer bg-gray-50" 
                       placeholder="Харилцагч сонгох" 
                       readonly 
                       onclick="openClientPopup(this, 'new_detail_${newRowCounter}')">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
        </td>
        <td class="px-2 py-1 text-left border-r border-gray-200">
            <select name="new_detail_currency_id_${newRowCounter}" required class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Валют сонгох</option>
                {% for currency in currencies %}
                <option value="{{ currency.CurrencyId }}">{{ currency.CurrencyId }} - {{ currency.Currency_name }}</option>
                {% endfor %}
            </select>
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="number" name="new_detail_currency_exchange_${newRowCounter}" min="0" value="1.0000"
                   class="w-full border border-gray-300 rounded px-0 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="1.000000">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="number" name="new_detail_currency_amount_${newRowCounter}" min="0" required
                   class="w-full border border-gray-300 rounded px-0 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1 text-left border-r border-gray-200">
            <select name="new_detail_is_debit_${newRowCounter}" required class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Төрөл сонгох</option>
                <option value="true">Дебит</option>
                <option value="false">Кредит</option>
            </select>
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="number" name="new_detail_debit_amount_${newRowCounter}" min="0"
                   class="w-full border border-gray-300 rounded px-0 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-1 py-1 text-right border-r border-gray-200">
            <input type="number" name="new_detail_credit_amount_${newRowCounter}" min="0"
                   class="w-full border border-gray-300 rounded px-0 py-1 text-xs text-right focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1 whitespace-nowrap text-right text-xs font-medium">
            <div class="flex items-center justify-end space-x-1 lg:space-x-2">
                <button type="button" onclick="removeNewDetailRow(this)" 
                        class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </td>
    `;
    tbody.appendChild(row);
    addEventListenersToDetailRow(row);
    
    // Auto-populate the row based on document type and VAT settings (only on first time)
    if (shouldAutoGenerate) {
        autoPopulateDetailRow(row, documentType, isVat, totalCostAmount);
        window.autoRecordsGenerated = true; // Mark that auto-records have been generated
    }
    
    updateBalanceDisplay();
}

// Calculate total cost amount from first table
function calculateTotalCostAmount() {
    const tbody = document.getElementById('details-tbody');
    if (!tbody) return 0;
    
    let totalCost = 0;
    const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])');
    
    visibleRows.forEach(row => {
        const quantityInput = row.querySelector('.quantity-input');
        const unitCostInput = row.querySelector('.unit-cost-input');
        
        if (quantityInput && unitCostInput) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitCost = parseFloat(unitCostInput.value) || 0;
            totalCost += quantity * unitCost;
        }
    });
    
    return totalCost;
}

// Auto-populate detail row based on document type and VAT settings
function autoPopulateDetailRow(row, documentType, isVat, totalCostAmount) {
    // Get master document information
    const masterAccountId = '{{ document.AccountId.AccountId }}';
    const masterAccountCode = '{{ document.AccountId.AccountCode }}';
    const masterAccountName = '{{ document.AccountId.AccountName }}';
    const masterClientId = '{{ document.ClientId.ClientId }}';
    const masterClientCode = '{{ document.ClientId.ClientCode }}';
    const masterClientName = '{{ document.ClientId.ClientName }}';
    
    // Get form elements from the row
    const accountHiddenInput = row.querySelector('input[name*="new_detail_account_id"]');
    const accountDisplayInput = row.querySelector('.account-display-input');
    const clientHiddenInput = row.querySelector('input[name*="new_detail_client_id"]');
    const clientDisplayInput = row.querySelector('.client-display-input');
    const currencyAmountInput = row.querySelector('input[name*="new_detail_currency_amount"]');
    const isDebitSelect = row.querySelector('select[name*="new_detail_is_debit"]');
    const debitAmountInput = row.querySelector('input[name*="new_detail_debit_amount"]');
    const creditAmountInput = row.querySelector('input[name*="new_detail_credit_amount"]');
    
    // Set account information
    if (accountHiddenInput && accountDisplayInput) {
        accountHiddenInput.value = masterAccountId;
        accountDisplayInput.value = `${masterAccountCode} - ${masterAccountName}`;
    }
    
    // Set client information
    if (clientHiddenInput && clientDisplayInput) {
        clientHiddenInput.value = masterClientId;
        clientDisplayInput.value = `${masterClientCode} - ${masterClientName}`;
    }
    
    // Set currency amount
    if (currencyAmountInput) {
        currencyAmountInput.value = totalCostAmount.toFixed(2);
    }
    
    // Handle different scenarios based on document type and VAT
    if (documentType === 10) { // Asset Receipt
        if (!isVat) {
            // Document Type 10, No VAT: Single debit record
            if (isDebitSelect) isDebitSelect.value = 'true';
            if (debitAmountInput) debitAmountInput.value = totalCostAmount.toFixed(2);
            if (creditAmountInput) creditAmountInput.value = '0.00';
        } else {
            // Document Type 10, With VAT: Two records
            // totalCostAmount is the base cost (without VAT), calculate VAT from it
            const costAmount = totalCostAmount; // This is the base cost (1000)
            const vatAmount = totalCostAmount * VAT_RATE; // Calculate VAT (1000 * 0.1 = 100)
            
            // First record: Debit for cost amount (base cost)
            if (isDebitSelect) isDebitSelect.value = 'true';
            if (debitAmountInput) debitAmountInput.value = costAmount.toFixed(2);
            if (creditAmountInput) creditAmountInput.value = '0.00';
            
            // Update currency amount to show base cost
            if (currencyAmountInput) {
                currencyAmountInput.value = costAmount.toFixed(2);
            }
            
            // Add second record for VAT credit
            setTimeout(() => {
                addVatCreditRecord(vatAmount);
            }, 100);
        }
    } else if (documentType === 11) { // Asset Issue
        if (!isVat) {
            // Document Type 11, No VAT: Single credit record
            if (isDebitSelect) isDebitSelect.value = 'false';
            if (debitAmountInput) debitAmountInput.value = '0.00';
            if (creditAmountInput) creditAmountInput.value = totalCostAmount.toFixed(2);
        } else {
            // Document Type 11, With VAT: Two records
            // totalCostAmount is the base cost (without VAT), calculate VAT from it
            const costAmount = totalCostAmount; // This is the base cost (1000)
            const vatAmount = totalCostAmount * VAT_RATE; // Calculate VAT (1000 * 0.1 = 100)
            
            // First record: Credit for cost amount (base cost)
            if (isDebitSelect) isDebitSelect.value = 'false';
            if (debitAmountInput) debitAmountInput.value = '0.00';
            if (creditAmountInput) creditAmountInput.value = costAmount.toFixed(2);
            
            // Update currency amount to show base cost
            if (currencyAmountInput) {
                currencyAmountInput.value = costAmount.toFixed(2);
            }
            
            // Add second record for VAT debit
            setTimeout(() => {
                addVatDebitRecord(vatAmount);
            }, 100);
        }
    }
    
    // Trigger amount calculation
    if (currencyAmountInput) {
        currencyAmountInput.dispatchEvent(new Event('input'));
    }
}

// Add VAT credit record
function addVatCreditRecord(vatAmount) {
    const tbody = document.getElementById('details-accounting-tbody');
    if (!tbody) return;
    
    // Get master document information
    const masterAccountId = '{{ document.AccountId.AccountId }}';
    const masterAccountCode = '{{ document.AccountId.AccountCode }}';
    const masterAccountName = '{{ document.AccountId.AccountName }}';
    const masterClientId = '{{ document.ClientId.ClientId }}';
    const masterClientCode = '{{ document.ClientId.ClientCode }}';
    const masterClientName = '{{ document.ClientId.ClientName }}';
    
    // Get VAT account information from master document
    const vatAccountId = '{{ document.VatAccountId.AccountId }}';
    const vatAccountCode = '{{ document.VatAccountId.AccountCode }}';
    const vatAccountName = '{{ document.VatAccountId.AccountName }}';
    
    // Use the VAT amount passed as parameter (already calculated)
    
    // For delete all and insert approach, use sequential numbering for all rows
    const newRowCounter = tbody.querySelectorAll('tr').length;
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 new-detail-row';
    row.innerHTML = `
        <td class="px-4 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
            <span class="text-green-600 font-medium">NEW</span>
        </td>
        <td class="px-2 py-1">
            <div class="relative">
                <input type="hidden" name="new_detail_account_id_${newRowCounter}" required>
                <input type="text" class="account-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 cursor-pointer" 
                       placeholder="Данс сонгох" 
                       readonly 
                       onclick="openAccountPopup(this, 'new_detail_${newRowCounter}', { modalTitle: 'Данс сонгох', modalSubtitle: 'Хөрөнгийн гүйлгээний данс сонгох' })">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
        </td>
        <td class="px-2 py-1">
            <div class="relative">
                <input type="hidden" name="new_detail_client_id_${newRowCounter}">
                <input type="text" class="client-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 cursor-pointer bg-gray-50" 
                       placeholder="Харилцагч сонгох" 
                       readonly 
                       onclick="openClientPopup(this, 'new_detail_${newRowCounter}')">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
        </td>
        <td class="px-2 py-1">
            <select name="new_detail_currency_id_${newRowCounter}" class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Валют сонгох</option>
                {% for currency in currencies %}
                <option value="{{ currency.CurrencyId }}">{{ currency.CurrencyId }} - {{ currency.Currency_name }}</option>
                {% endfor %}
            </select>
        </td>
        <td class="px-2 py-1">
            <input type="number" name="new_detail_currency_exchange_${newRowCounter}" min="0" value="1.0000"
                   class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="1.000000">
        </td>
        <td class="px-2 py-1">
            <input type="number" name="new_detail_currency_amount_${newRowCounter}" min="0" required
                   class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1">
            <select name="new_detail_is_debit_${newRowCounter}" required class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Төрөл сонгох</option>
                <option value="true">Дебит</option>
                <option value="false">Кредит</option>
            </select>
        </td>
        <td class="px-2 py-1">
            <input type="number" name="new_detail_debit_amount_${newRowCounter}" min="0"
                   class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1">
            <input type="number" name="new_detail_credit_amount_${newRowCounter}" min="0"
                   class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1 whitespace-nowrap text-right text-xs font-medium">
            <div class="flex items-center justify-end space-x-1 lg:space-x-2">
                <button type="button" onclick="removeNewDetailRow(this)" 
                        class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </td>
    `;
    tbody.appendChild(row);
    addEventListenersToDetailRow(row);
    
    // Auto-populate the VAT credit record
    const accountHiddenInput = row.querySelector('input[name*="new_detail_account_id"]');
    const accountDisplayInput = row.querySelector('.account-display-input');
    const clientHiddenInput = row.querySelector('input[name*="new_detail_client_id"]');
    const clientDisplayInput = row.querySelector('.client-display-input');
    const currencyAmountInput = row.querySelector('input[name*="new_detail_currency_amount"]');
    const isDebitSelect = row.querySelector('select[name*="new_detail_is_debit"]');
    const debitAmountInput = row.querySelector('input[name*="new_detail_debit_amount"]');
    const creditAmountInput = row.querySelector('input[name*="new_detail_credit_amount"]');
    
    // Set account information (VAT account from master)
    if (accountHiddenInput && accountDisplayInput) {
        accountHiddenInput.value = vatAccountId;
        accountDisplayInput.value = `${vatAccountCode} - ${vatAccountName}`;
    }
    
    // Set client information (same as master)
    if (clientHiddenInput && clientDisplayInput) {
        clientHiddenInput.value = masterClientId;
        clientDisplayInput.value = `${masterClientCode} - ${masterClientName}`;
    }
    
    // Set currency amount (VAT amount)
    if (currencyAmountInput) {
        currencyAmountInput.value = vatAmount.toFixed(2);
    }
    
    // Set as credit record
    if (isDebitSelect) isDebitSelect.value = 'false';
    if (debitAmountInput) debitAmountInput.value = '0.00';
    if (creditAmountInput) creditAmountInput.value = vatAmount.toFixed(2);
    
    // Trigger amount calculation
    if (currencyAmountInput) {
        currencyAmountInput.dispatchEvent(new Event('input'));
    }
    
    // Mark that auto-records have been generated (VAT record is part of auto-generation)
    window.autoRecordsGenerated = true;
    
    updateBalanceDisplay();
}

// Add VAT debit record (for Asset Issue with VAT)
function addVatDebitRecord(vatAmount) {
    const tbody = document.getElementById('details-accounting-tbody');
    if (!tbody) return;
    
    // Get master document information
    const masterAccountId = '{{ document.AccountId.AccountId }}';
    const masterAccountCode = '{{ document.AccountId.AccountCode }}';
    const masterAccountName = '{{ document.AccountId.AccountName }}';
    const masterClientId = '{{ document.ClientId.ClientId }}';
    const masterClientCode = '{{ document.ClientId.ClientCode }}';
    const masterClientName = '{{ document.ClientId.ClientName }}';
    
    // Get VAT account information from master document
    const vatAccountId = '{{ document.VatAccountId.AccountId }}';
    const vatAccountCode = '{{ document.VatAccountId.AccountCode }}';
    const vatAccountName = '{{ document.VatAccountId.AccountName }}';
    
    // Use the VAT amount passed as parameter (already calculated)
    
    // For delete all and insert approach, use sequential numbering for all rows
    const newRowCounter = tbody.querySelectorAll('tr').length;
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 new-detail-row';
    row.innerHTML = `
        <td class="px-4 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
            <span class="text-green-600 font-medium">NEW</span>
        </td>
        <td class="px-2 py-1">
            <div class="relative">
                <input type="hidden" name="new_detail_account_id_${newRowCounter}" required>
                <input type="text" class="account-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 cursor-pointer" 
                       placeholder="Данс сонгох" 
                       readonly 
                       onclick="openAccountPopup(this, 'new_detail_${newRowCounter}', { modalTitle: 'Данс сонгох', modalSubtitle: 'Хөрөнгийн гүйлгээний данс сонгох' })">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
        </td>
        <td class="px-2 py-1">
            <div class="relative">
                <input type="hidden" name="new_detail_client_id_${newRowCounter}">
                <input type="text" class="client-display-input w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 cursor-pointer bg-gray-50" 
                       placeholder="Харилцагч сонгох" 
                       readonly 
                       onclick="openClientPopup(this, 'new_detail_${newRowCounter}')">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
        </td>
        <td class="px-2 py-1">
            <select name="new_detail_currency_id_${newRowCounter}" class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Валют сонгох</option>
                {% for currency in currencies %}
                <option value="{{ currency.CurrencyId }}">{{ currency.CurrencyId }} - {{ currency.Currency_name }}</option>
                {% endfor %}
            </select>
        </td>
        <td class="px-2 py-1">
            <input type="number" name="new_detail_currency_exchange_${newRowCounter}" min="0" value="1.0000"
                   class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="1.000000">
        </td>
        <td class="px-2 py-1">
            <input type="number" name="new_detail_currency_amount_${newRowCounter}" min="0" required
                   class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1">
            <select name="new_detail_is_debit_${newRowCounter}" required class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Төрөл сонгох</option>
                <option value="true">Дебит</option>
                <option value="false">Кредит</option>
            </select>
        </td>
        <td class="px-2 py-1">
            <input type="number" name="new_detail_debit_amount_${newRowCounter}" min="0"
                   class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1">
            <input type="number" name="new_detail_credit_amount_${newRowCounter}" min="0"
                   class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" 
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1 whitespace-nowrap text-right text-xs font-medium">
            <div class="flex items-center justify-end space-x-1 lg:space-x-2">
                <button type="button" onclick="removeNewDetailRow(this)" 
                        class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </td>
    `;
    tbody.appendChild(row);
    addEventListenersToDetailRow(row);
    
    // Auto-populate the VAT debit record
    const accountHiddenInput = row.querySelector('input[name*="new_detail_account_id"]');
    const accountDisplayInput = row.querySelector('.account-display-input');
    const clientHiddenInput = row.querySelector('input[name*="new_detail_client_id"]');
    const clientDisplayInput = row.querySelector('.client-display-input');
    const currencyAmountInput = row.querySelector('input[name*="new_detail_currency_amount"]');
    const isDebitSelect = row.querySelector('select[name*="new_detail_is_debit"]');
    const debitAmountInput = row.querySelector('input[name*="new_detail_debit_amount"]');
    const creditAmountInput = row.querySelector('input[name*="new_detail_credit_amount"]');
    
    // Set account information (VAT account from master)
    if (accountHiddenInput && accountDisplayInput) {
        accountHiddenInput.value = vatAccountId;
        accountDisplayInput.value = `${vatAccountCode} - ${vatAccountName}`;
    }
    
    // Set client information (same as master)
    if (clientHiddenInput && clientDisplayInput) {
        clientHiddenInput.value = masterClientId;
        clientDisplayInput.value = `${masterClientCode} - ${masterClientName}`;
    }
    
    // Set currency amount (VAT amount)
    if (currencyAmountInput) {
        currencyAmountInput.value = vatAmount.toFixed(2);
    }
    
    // Set as debit record
    if (isDebitSelect) isDebitSelect.value = 'true';
    if (debitAmountInput) debitAmountInput.value = vatAmount.toFixed(2);
    if (creditAmountInput) creditAmountInput.value = '0.00';
    
    // Trigger amount calculation
    if (currencyAmountInput) {
        currencyAmountInput.dispatchEvent(new Event('input'));
    }
    
    // Mark that auto-records have been generated (VAT record is part of auto-generation)
    window.autoRecordsGenerated = true;
    
    updateBalanceDisplay();
}

// Add event listeners to a detail row
function addEventListenersToDetailRow(row) {
    const currencyAmountInput = row.querySelector('input[name*="detail_currency_amount"]');
    if (currencyAmountInput) {
        currencyAmountInput.addEventListener('input', function() {
            updateDetailDebitCreditAmounts(this);
        });
    }
    
    // Add event listener to currency exchange input
    const currencyExchangeInput = row.querySelector('input[name*="detail_currency_exchange"]');
    if (currencyExchangeInput) {
        currencyExchangeInput.addEventListener('input', function() {
            // Recalculate amounts when exchange rate changes
            const currencyAmountInput = row.querySelector('input[name*="detail_currency_amount"]');
            if (currencyAmountInput) {
                updateDetailDebitCreditAmounts(currencyAmountInput);
            }
        });
    }
    
    // Add event listener to IsDebit select
    const isDebitSelect = row.querySelector('select[name*="detail_is_debit"]');
    if (isDebitSelect) {
        isDebitSelect.addEventListener('change', function() {
            updateDetailAmountsFromIsDebit(this);
        });
    }
    
    // Add validation for debit/credit amounts
    const debitInput = row.querySelector('input[name*="detail_debit_amount"]');
    const creditInput = row.querySelector('input[name*="detail_credit_amount"]');
    
    if (debitInput && creditInput) {
        // When debit amount is entered, clear credit amount
        debitInput.addEventListener('input', function() {
            const debitValue = parseFloat(this.value) || 0;
            if (debitValue > 0) {
                creditInput.value = '0.00';
            }
            updateBalanceDisplay();
        });
        
        // When credit amount is entered, clear debit amount
        creditInput.addEventListener('input', function() {
            const creditValue = parseFloat(this.value) || 0;
            if (creditValue > 0) {
                debitInput.value = '0.00';
            }
            updateBalanceDisplay();
        });
    }
}

// Auto-populate debit/credit amounts based on currency amount and IsDebit selection
function updateDetailDebitCreditAmounts(currencyAmountInput) {
    const row = currencyAmountInput.closest('tr');
    const currencyAmountValue = parseFloat(currencyAmountInput.value) || 0;
    const currencyExchangeInput = row.querySelector('input[name*="detail_currency_exchange"]');
    const currencyExchange = currencyExchangeInput ? parseFloat(currencyExchangeInput.value) : window.documentExchangeRate;
    const isDebitSelect = row.querySelector('select[name*="detail_is_debit"]');
    const debitInput = row.querySelector('input[name*="detail_debit_amount"]');
    const creditInput = row.querySelector('input[name*="detail_credit_amount"]');
    
    if (debitInput && creditInput && isDebitSelect) {
        // Clear both fields first
        debitInput.value = '0.00';
        creditInput.value = '0.00';
        
        // If there's a currency amount and IsDebit is selected, calculate MNT amount
        if (currencyAmountValue > 0 && isDebitSelect.value !== '') {
            const calculatedAmount = (currencyExchange * currencyAmountValue).toFixed(2);
            const formattedAmount = parseFloat(calculatedAmount).toFixed(2);
            
            // DO NOT overwrite currency_amount input
            // Only update debit/credit display fields
            if (isDebitSelect.value === 'true') {
                debitInput.value = formattedAmount;
                creditInput.value = '0.00';
            } else if (isDebitSelect.value === 'false') {
                debitInput.value = '0.00';
                creditInput.value = formattedAmount;
            }
        }
    }
    
    // Update balance display
    updateBalanceDisplay();
}

// Auto-populate debit/credit amounts when IsDebit selection changes
function updateDetailAmountsFromIsDebit(isDebitSelect) {
    const row = isDebitSelect.closest('tr');
    const currencyAmountInput = row.querySelector('input[name*="detail_currency_amount"]');
    const currencyExchangeInput = row.querySelector('input[name*="detail_currency_exchange"]');
    const debitInput = row.querySelector('input[name*="detail_debit_amount"]');
    const creditInput = row.querySelector('input[name*="detail_credit_amount"]');
    
    if (currencyAmountInput && debitInput && creditInput) {
        const currencyAmountValue = parseFloat(currencyAmountInput.value) || 0;
        const currencyExchange = currencyExchangeInput ? parseFloat(currencyExchangeInput.value) : window.documentExchangeRate;
        
        // Clear both fields first
        debitInput.value = '0.00';
        creditInput.value = '0.00';
        
        // Auto-populate based on IsDebit selection with currency exchange calculation
        if (currencyAmountValue > 0 && isDebitSelect.value !== '') {
            const calculatedAmount = (currencyExchange * currencyAmountValue).toFixed(2);
            const formattedAmount = parseFloat(calculatedAmount).toFixed(2);
            
            // DO NOT overwrite currency_amount input
            // Only update debit/credit display fields
            if (isDebitSelect.value === 'true') {
                debitInput.value = formattedAmount;
                creditInput.value = '0.00';
            } else if (isDebitSelect.value === 'false') {
                debitInput.value = '0.00';
                creditInput.value = formattedAmount;
            }
        }
    }
    
    // Update balance display
    updateBalanceDisplay();
}

// Function to remove a new detail row
window.removeNewDetailRow = function(button) {
    const row = button.closest('tr');
    if (row) {
        row.remove();
        updateBalanceDisplay();
    }
}


// Remove accounting detail row
function removeDetailRow(button) {
    const row = button.closest('tr');
    if (!row) return;
    
    row.remove();
    
    // Update balance display
    updateBalanceDisplay();
}

// Add calculation event listeners to asset row
function addAssetCalculationListeners(row) {
    // Quantity and unit_cost are read-only, so no input listeners needed
    // Only unit_price can be edited and should trigger recalculation
    const unitPriceInput = row.querySelector('.unit-price-input');
    
    if (unitPriceInput) {
        unitPriceInput.addEventListener('input', function() {
            calculateAssetTotals(row);
        });
    }
}

// Calculate totals for asset row (triggers ending depreciation calculation)
function calculateAssetTotals(row) {
    formatAssetRowNumericFields(row);

    // Trigger ending depreciation calculation when unit price changes
    if (typeof calculateEndingDepreciation === 'function') {
        calculateEndingDepreciation(row);
    }
    
    // Update summary row totals
    if (typeof updateSummaryRowTotals === 'function') {
        updateSummaryRowTotals();
    }
    
    // Automatically fill accounting details when values change
    if (typeof window.FillAccountingDetails === 'function') {
        window.FillAccountingDetails();
    }
}

// Recalculate all asset totals (now just triggers ending depreciation calculation)
function recalculateAllAssetTotals() {
    // Recalculate ending depreciation for all rows
    calculateAllEndingDepreciation();
}

// Ensure first-table numeric inputs always show two decimals
function formatAssetRowNumericFields(row) {
    if (!row) {
        return;
    }

    const selectors = ['.quantity-input', '.unit-cost-input', '.unit-price-input', '.daily-expense-display'];

    selectors.forEach(selector => {
        const input = row.querySelector(selector);
        if (!input) {
            return;
        }

        const numericValue = parseFloat((input.value || '').toString().replace(/,/g, ''));
        if (isNaN(numericValue)) {
            return;
        }

        input.value = numericValue.toFixed(2);
    });
}

// Format all existing calculated fields on page load
function formatAllCalculatedFields() {
    // Format cumulated depreciation and ending depreciation fields
    const tbody = document.getElementById('details-tbody');
    if (!tbody) return;
    
    const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])');
    visibleRows.forEach(row => {
        formatAssetRowNumericFields(row);

        const cumulatedDepreciationDisplay = row.querySelector('.cumulated-depreciation-display');
        const endingDepreciationDisplay = row.querySelector('.ending-depreciation-display');
        
        if (cumulatedDepreciationDisplay && cumulatedDepreciationDisplay.value) {
            const value = parseFloat(cumulatedDepreciationDisplay.value.replace(/,/g, '')) || 0;
            cumulatedDepreciationDisplay.value = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        if (endingDepreciationDisplay && endingDepreciationDisplay.value) {
            const value = parseFloat(endingDepreciationDisplay.value.replace(/,/g, '')) || 0;
            endingDepreciationDisplay.value = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    });
}

// Initialize asset calculations for existing rows
function initializeAssetCalculations() {
    const tbody = document.getElementById('details-tbody');
    if (!tbody) return;
    
    tbody.querySelectorAll('tr').forEach(row => {
        addAssetCalculationListeners(row);
    });
}

// Initialize detail event listeners
function initializeDetailEventListeners() {
    const tbody = document.getElementById('details-accounting-tbody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    rows.forEach(row => {
        initializeDetailRowEventListeners(row);
    });
}

// Initialize event listeners for a specific detail row
function initializeDetailRowEventListeners(row) {
    const currencyAmountInput = row.querySelector('input[name*="currency_amount"]');
    const currencyExchangeInput = row.querySelector('input[name*="currency_exchange"]');
    const isDebitSelect = row.querySelector('select[name*="is_debit"]');
    const debitAmountInput = row.querySelector('input[name*="debit_amount"]');
    const creditAmountInput = row.querySelector('input[name*="credit_amount"]');
    
    if (currencyAmountInput) {
        currencyAmountInput.addEventListener('input', () => calculateAmountsForRow(row));
    }
    
    if (currencyExchangeInput) {
        currencyExchangeInput.addEventListener('input', () => calculateAmountsForRow(row));
    }
    
    if (isDebitSelect) {
        isDebitSelect.addEventListener('change', () => calculateAmountsForRow(row));
    }
}

// Calculate amounts for a specific detail row
function calculateAmountsForRow(row) {
    const currencyAmountInput = row.querySelector('input[name*="currency_amount"]');
    const currencyExchangeInput = row.querySelector('input[name*="currency_exchange"]');
    const isDebitSelect = row.querySelector('select[name*="is_debit"]');
    const debitAmountInput = row.querySelector('input[name*="debit_amount"]');
    const creditAmountInput = row.querySelector('input[name*="credit_amount"]');
    
    if (!currencyAmountInput || !currencyExchangeInput || !isDebitSelect || !debitAmountInput || !creditAmountInput) return;
    
    const currencyAmount = parseFloat(currencyAmountInput.value) || 0;
    const currencyExchange = parseFloat(currencyExchangeInput.value) || 1.0;
    const isDebit = isDebitSelect.value === 'true';
    
    const localAmount = currencyAmount * currencyExchange;
    
    if (isDebit) {
        debitAmountInput.value = localAmount.toFixed(2);
        creditAmountInput.value = '';
    } else {
        creditAmountInput.value = localAmount.toFixed(2);
        debitAmountInput.value = '';
    }
    
    // Update balance display
    updateBalanceDisplay();
}

// Force recalculate all amounts
function forceRecalculateAllAmounts() {
    const tbody = document.getElementById('details-accounting-tbody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    rows.forEach(row => {
        calculateAmountsForRow(row);
    });
}

// Update balance display
function updateBalanceDisplay() {
    const tbody = document.getElementById('details-accounting-tbody');
    if (!tbody) return;
    
    let totalDebit = 0;
    let totalCredit = 0;
    
    const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])');
    visibleRows.forEach(row => {
        const debitAmountInput = row.querySelector('input[name*="debit_amount"]');
        const creditAmountInput = row.querySelector('input[name*="credit_amount"]');
        
        if (debitAmountInput && debitAmountInput.value) {
            totalDebit += parseFloat(debitAmountInput.value) || 0;
        }
        
        if (creditAmountInput && creditAmountInput.value) {
            totalCredit += parseFloat(creditAmountInput.value) || 0;
        }
    });
    
    // Update display elements
    const totalDebitElement = document.getElementById('total-debit');
    const totalCreditElement = document.getElementById('total-credit');
    const balanceStatusElement = document.getElementById('balance-status');
    
    if (totalDebitElement) totalDebitElement.textContent = totalDebit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    if (totalCreditElement) totalCreditElement.textContent = totalCredit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    if (balanceStatusElement) {
        const difference = Math.abs(totalDebit - totalCredit);
        const tolerance = 0.01;
        
        if (difference <= tolerance) {
            balanceStatusElement.textContent = 'Balanced';
            balanceStatusElement.className = 'ml-2 lg:ml-3 px-2 py-1 lg:px-3 text-xs rounded-full bg-green-100 text-green-800';
        } else {
            balanceStatusElement.textContent = `Off by ${difference.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            balanceStatusElement.className = 'ml-2 lg:ml-3 px-2 py-1 lg:px-3 text-xs rounded-full bg-red-100 text-red-800';
        }
    }
    
    // Update summary totals
    const sumDebitElement = document.getElementById('sum-debit-amount');
    const sumCreditElement = document.getElementById('sum-credit-amount');
    
    if (sumDebitElement) sumDebitElement.textContent = totalDebit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    if (sumCreditElement) sumCreditElement.textContent = totalCredit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Update asset totals summary
function updateAssetTotalsSummary() {
    // Recalculate ending depreciation for all rows
    calculateAllEndingDepreciation();
    
    // Update summary row totals
    updateSummaryRowTotals();
}

// Recalculate footer totals for the asset table
function updateSummaryRowTotals() {
    const tbody = document.getElementById('details-tbody');
    if (!tbody) {
        return;
    }

    const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])');

    let totalQuantity = 0;
    let totalUnitCost = 0;
    let totalUnitPrice = 0;
    let totalDailyExpense = 0;
    let totalCumulatedDep = 0;
    let totalDepAmount = 0;
    let totalPredictedDep = 0;
    let totalEndingDep = 0;

    visibleRows.forEach(row => {
        const quantityInput = row.querySelector('.quantity-input');
        const unitCostInput = row.querySelector('.unit-cost-input');
        const unitPriceInput = row.querySelector('.unit-price-input');
        const dailyExpenseInput = row.querySelector('.daily-expense-display');
        const cumulatedInput = row.querySelector('.cumulated-depreciation-display');
        const depAmountInput = row.querySelector('.depreciation-amount-display');
        const predictedInput = row.querySelector('.predicted-depreciation-display');
        const endingInput = row.querySelector('.ending-depreciation-display');

        if (quantityInput) {
            totalQuantity += parseFloat(quantityInput.value) || 0;
        }
        if (unitCostInput) {
            totalUnitCost += parseFloat(unitCostInput.value) || 0;
        }
        if (unitPriceInput) {
            totalUnitPrice += parseFloat(unitPriceInput.value) || 0;
        }
        if (dailyExpenseInput) {
            totalDailyExpense += parseFloat(dailyExpenseInput.value.replace(/,/g, '')) || 0;
        }
        if (cumulatedInput) {
            totalCumulatedDep += parseFloat(cumulatedInput.value.replace(/,/g, '')) || 0;
        }
        if (depAmountInput) {
            totalDepAmount += parseFloat(depAmountInput.value.replace(/,/g, '')) || 0;
        }
        if (predictedInput) {
            totalPredictedDep += parseFloat(predictedInput.value.replace(/,/g, '')) || 0;
        }
        if (endingInput) {
            totalEndingDep += parseFloat(endingInput.value.replace(/,/g, '')) || 0;
        }
    });

    const updateText = (id, text) => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = text;
        }
    };

    updateText('sum-quantity', totalQuantity.toFixed(2));
    updateText('sum-unit-cost', totalUnitCost.toFixed(2));
    updateText('sum-unit-price', totalUnitPrice.toFixed(2));
    updateText('sum-daily-expense', totalDailyExpense.toFixed(2));
    updateText('sum-cumulated-depreciation', totalCumulatedDep.toFixed(2));
    updateText('sum-depreciation-amount', totalDepAmount.toFixed(2));
    updateText('sum-predicted-depreciation', totalPredictedDep.toFixed(2));
    updateText('sum-ending-depreciation', totalEndingDep.toFixed(2));
}

// Asset card selection functions
function openAssetCardPopup(inputElement, rowId) {
    // Call the actual asset popup function from the modal
    if (typeof window.openAssetPopup === 'function') {
        window.openAssetPopup(inputElement, rowId);
    } else {
        console.log('Asset popup function not available for row:', rowId);
    }
}

// Helper function to open asset popup with document context
function openAssetPopupWithContext(inputElement, rowId) {
    // Get document data from the JSON script tag
    const documentDataScript = document.getElementById('document-data');
    if (documentDataScript) {
        try {
            const documentData = JSON.parse(documentDataScript.textContent);
            const context = {
                documentDate: documentData.DocumentDate || null,
                accountId: documentData.AccountId || null,
                documentTypeId: documentData.DocumentTypeId || null
            };
            // Call the modal's openAssetPopup function with context
            if (typeof window.openAssetPopup === 'function') {
                window.openAssetPopup(inputElement, rowId, context);
            }
        } catch (e) {
            console.error('Error parsing document data:', e);
            // Fallback to regular call without context
            if (typeof window.openAssetPopup === 'function') {
                window.openAssetPopup(inputElement, rowId);
            }
        }
    } else {
        // Fallback to regular call without context
        if (typeof window.openAssetPopup === 'function') {
            window.openAssetPopup(inputElement, rowId);
        }
    }
}

// Account selection functions
function openAccountPopup(inputElement, rowId, options = {}) {
    // Store the current input element and row ID for later use
    window.currentAccountInput = inputElement;
    window.currentAccountRowId = rowId;
    
    // Open account selection modal
    const modal = document.getElementById('account-selection-modal');
    if (modal) {
        modal.classList.remove('hidden');
        // Load accounts with the provided options
        if (typeof window.loadAccountList === 'function') {
            window.loadAccountList(options);
        }
    }
}

// Client selection functions
function openClientPopup(inputElement, rowId) {
    // Store the current input element and row ID for later use
    window.currentClientInput = inputElement;
    window.currentClientRowId = rowId;
    
    // Open client selection modal
    const modal = document.getElementById('client-selection-modal');
    if (modal) {
        modal.classList.remove('hidden');
        // Load clients
        if (typeof window.loadClientList === 'function') {
            window.loadClientList();
        }
    }
}
</script>

{% endblock %}
