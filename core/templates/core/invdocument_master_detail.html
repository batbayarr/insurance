{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Inventory Documents - Silicon-AI Accounting{% endblock %}

{% block content %}
<div>
    <div class="flex justify-between items-center px-3 py-2 lg:px-6 bg-white border-b border-gray-200">
        <div>
            <h1 class="text-base lg:text-lg xl:text-xl font-medium text-gray-900">БАРАА МАТЕРИАЛЫН МОДУЛЬ</h1>            
        </div>
        {% if perms.core.add_inv_document %}
        <a href="{% url 'core:invdocument_create' %}" class="inline-flex items-center px-2 py-1 lg:px-3 lg:py-1.5 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg class="mr-1.5 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            НЭМЭХ
        </a>
        {% endif %}
    </div>

    <!-- Date Range Filter -->
    <div class="bg-white border-b border-gray-200 px-3 py-2 lg:px-6">
        <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center space-x-2">
                <label for="start-date" class="text-sm font-medium text-gray-700">Эхлэх огноо:</label>
                <input type="date" id="start-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-center space-x-2">
                <label for="end-date" class="text-sm font-medium text-gray-700">Дуусах огноо:</label>
                <input type="date" id="end-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="apply-date-filter" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                СЭРГЭЭХ
            </button>
        </div>
    </div>

    <!-- Master Grid (Inventory Documents) -->
    <div id="inventory-document-container" 
         class="bg-white shadow overflow-hidden rounded-lg border border-gray-200">
        
        <!-- Responsive table with horizontal scroll -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Төрөл</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Огноо</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200" style="min-width: 80px;">Данс</th>
                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200" style="width: 40px; max-width: 40px;">НӨТ</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Агуулах</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэрэглэгч</th>
                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Үйлдэл</th>
                    </tr>
                    <!-- Filter Row -->
                    <tr class="bg-gray-100">
                        <td class="px-4 py-1 border-r border-gray-200">
                            <input type="text" id="filter-document-no" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-document-type" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-client" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-date" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-description" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200" style="min-width: 80px;">
                            <input type="text" id="filter-account" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200" style="width: 40px; max-width: 40px;">
                            <input type="text" id="filter-isvat" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-warehouse" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-created-by" placeholder="Filter..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </td>
                        <td class="px-2 py-1">
                            <button id="clear-filters" class="w-full px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 focus:ring-1 focus:ring-blue-500">
                                Clear
                            </button>
                        </td>
                    </tr>
                </thead>
                <tbody id="documents-tbody" class="bg-white divide-y divide-gray-200">
                    <!-- Documents will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
        <div class="flex-1 flex justify-between sm:hidden">
            <button id="prev-page-btn" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Өмнөх
                                </button>
            <button id="next-page-btn" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Дараа
                                </button>
                            </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p id="pagination-info" class="text-sm text-gray-700">
                    Нийт <span id="total-count">0</span> бичлэгээс <span id="showing-start">0</span> - <span id="showing-end">0</span> бичлэг харагдаж байна
                </p>
        </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <label for="page-size-select" class="text-sm font-medium text-gray-700">Хуудасны хэмжээ:</label>
                    <select id="page-size-select" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="10" selected>10</option>
                    </select>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
                        </button>
                        <span id="page-info" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            <!-- Dynamic page buttons will be generated here -->
                        </span>
                        <button id="next-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                        </button>
                    </nav>
            </div>
        </div>
        </div>
    </div>

    <!-- Detail Grid will be loaded here via AJAX -->
    <div id="detail-grid-container">
        <!-- Detail grid content will be dynamically loaded here -->
    </div>
</div>

<!-- Include Delete Modal -->
{% include 'core/components/delete_modal.html' %}

<!-- Inventory Document Print System -->
<script src="{% static 'js/print-invdocument.js' %}"></script>

<script>
// Prevent script re-execution
if (!window.invDocumentScriptLoaded) {
    window.invDocumentScriptLoaded = true;

// API-Based Data Management
let allDocumentsData = [];
let filteredData = [];
let currentPage = 1;
let pageSize = 10;
let totalPages = 1;
let currentApiRequest = null;
let currentDetailRequest = null;  // For AbortController on detail loading
const detailCache = new Map();     // Cache loaded details
const currentUserId = parseInt('{{ request.user.id|default:"0" }}', 10) || 0;
const hasChangePermission = '{{ perms.core.change_inv_document|yesno:"true,false" }}' === 'true';
const hasDeletePermission = '{{ perms.core.delete_inv_document|yesno:"true,false" }}' === 'true';

window.isInitialDocumentFilterLoad = window.isInitialDocumentFilterLoad || false;

function getInputValue(elementId) {
    const element = document.getElementById(elementId);
    return element ? element.value : '';
}

function getFilterValue(elementId) {
    const value = getInputValue(elementId);
    return value ? value.toLowerCase().trim() : '';
}

// Helper function to save date range to localStorage
function saveDateRangeToLocalStorage(startDate, endDate) {
    try {
        localStorage.setItem('invdocument_date_range', JSON.stringify({
            startDate: startDate,
            endDate: endDate
        }));
    } catch (e) {
        console.warn('Failed to save date range to localStorage:', e);
    }
}

// Helper function to load date range from localStorage
function loadDateRangeFromLocalStorage() {
    try {
        const saved = localStorage.getItem('invdocument_date_range');
        if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed.startDate && parsed.endDate) {
                return {
                    startDate: parsed.startDate,
                    endDate: parsed.endDate
                };
            }
        }
    } catch (e) {
        console.warn('Failed to load date range from localStorage:', e);
    }
    return null;
}

// Helper function to save all filter states to localStorage
function saveAllFiltersToLocalStorage() {
    try {
        const filters = {
            documentNo: getInputValue('filter-document-no'),
            documentType: getInputValue('filter-document-type'),
            client: getInputValue('filter-client'),
            date: getInputValue('filter-date'),
            description: getInputValue('filter-description'),
            account: getInputValue('filter-account'),
            isVat: getInputValue('filter-isvat'),
            warehouse: getInputValue('filter-warehouse'),
            createdBy: getInputValue('filter-created-by'),
            pageSize: pageSize,
            currentPage: currentPage
        };
        localStorage.setItem('invdocument_all_filters', JSON.stringify(filters));
    } catch (e) {
        console.warn('Failed to save filters to localStorage:', e);
    }
}

// Helper function to load all filter states from localStorage
function loadAllFiltersFromLocalStorage() {
    try {
        const saved = localStorage.getItem('invdocument_all_filters');
        if (saved) {
            return JSON.parse(saved);
        }
    } catch (e) {
        console.warn('Failed to load filters from localStorage:', e);
    }
    return null;
}

// Helper function to clear client-side filters (optionally preserving selected_document)
function clearAllClientSideFilters(preserveSelectedDocument = false) {
    const filterIds = [
        'filter-document-no', 'filter-document-type', 'filter-client',
        'filter-date', 'filter-description', 'filter-account',
        'filter-isvat', 'filter-warehouse', 'filter-created-by'
    ];

    filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.value = '';
        }
    });

    currentPage = 1;

    if (!preserveSelectedDocument) {
        const currentUrl = new URL(window.location);
        if (currentUrl.searchParams.has('selected_document')) {
            currentUrl.searchParams.delete('selected_document');
            window.history.pushState({}, '', currentUrl.toString());
        }
    }

    try {
        localStorage.removeItem('invdocument_all_filters');
    } catch (e) {
        console.warn('Failed to clear filters from localStorage:', e);
    }

    if (!preserveSelectedDocument) {
        resetDetailView();
    }
}

// Initialize date inputs with local system date
function initializeDateInputs() {
    // Store the promise for external access when needed (declared at function scope)
    let searchPromise = null;

    // Format dates for HTML date input (YYYY-MM-DD)
    const formatDateForInput = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    // Check URL parameters for selected_document and date range
    const urlParams = new URLSearchParams(window.location.search);
    const selectedDocumentId = urlParams.get('selected_document');
    const beginDateParam = urlParams.get('begin_date');
    const endDateParam = urlParams.get('end_date');

    let useDocumentFilter = false;
    let usePassedDateRange = false;

    if (beginDateParam && endDateParam) {
        usePassedDateRange = true;
    }

    if (selectedDocumentId) {
        try {
            localStorage.removeItem('invdocument_all_filters');
        } catch (e) {
            console.warn('Failed to clear filters from localStorage:', e);
        }
        currentPage = 1;
        useDocumentFilter = true;
    }
    
    // Use user's local system date
    const today = new Date();
    let firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    let lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    if (usePassedDateRange && beginDateParam && endDateParam) {
        firstDay = beginDateParam;
        lastDay = endDateParam;
    } else {
    const savedDateRange = loadDateRangeFromLocalStorage();
    if (savedDateRange) {
        firstDay = new Date(savedDateRange.startDate);
        lastDay = new Date(savedDateRange.endDate);
    } else {
        {% if selected_document %}
        if (selectedDocumentId) {
            const docDate = new Date('{{ selected_document.DocumentDate|date:"Y-m-d" }}');
            if (docDate < firstDay || docDate > lastDay) {
                const docYear = docDate.getFullYear();
                const docMonth = docDate.getMonth();
                firstDay = new Date(docYear, docMonth, 1);
                lastDay = new Date(docYear, docMonth + 1, 0);
                if (docDate < firstDay) firstDay = new Date(docDate);
                if (docDate > lastDay) lastDay = new Date(docDate);
            }
        }
        {% endif %}
        }
    }
    
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const pageSizeSelect = document.getElementById('page-size-select');
    const applyButton = document.getElementById('apply-date-filter');
    
    if (startDateInput && endDateInput) {
        if (useDocumentFilter) {
            requestAnimationFrame(() => {
                const filterIds = [
                    'filter-document-no', 'filter-document-type', 'filter-client',
                    'filter-date', 'filter-description', 'filter-account',
                    'filter-isvat', 'filter-warehouse', 'filter-created-by'
                ];

                filterIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = '';
                    }
                });
            });
        }

        if (usePassedDateRange && beginDateParam && endDateParam) {
            startDateInput.value = beginDateParam;
            endDateInput.value = endDateParam;
        } else {
            startDateInput.value = typeof firstDay === 'string' ? firstDay : formatDateForInput(firstDay);
            endDateInput.value = typeof lastDay === 'string' ? lastDay : formatDateForInput(lastDay);
        }

        saveDateRangeToLocalStorage(startDateInput.value, endDateInput.value);
        
        const saveAndFetch = (startDate, endDate, skipLocalStorage = false) => {
            if (!skipLocalStorage) {
            saveDateRangeToLocalStorage(startDate, endDate);
            }
            return fetchDocuments(startDate, endDate);
        };
        
        let isProgrammaticClick = false;
        let skipFilterClear = false;

        if (applyButton) {
            applyButton.addEventListener('click', () => {
                const startValue = startDateInput.value;
                const endValue = endDateInput.value;
                if (!startValue || !endValue) {
                    alert('Please select both start and end dates');
                    return;
                }
                
                // Always clear frontend filters when user clicks refresh
                clearAllClientSideFilters(); // This removes selected_document from URL
                resetDetailView();
                currentPage = 1;
                
                // Reset flags to ensure clean state
                isProgrammaticClick = false;
                skipFilterClear = false;
                
                // Fetch data within the date range
                searchPromise = saveAndFetch(startValue, endValue);
            });
        }

        startDateInput.addEventListener('change', () => {
            saveDateRangeToLocalStorage(startDateInput.value, endDateInput.value);
        });
        endDateInput.addEventListener('change', () => {
            saveDateRangeToLocalStorage(startDateInput.value, endDateInput.value);
        });
        
        startDateInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                clearAllClientSideFilters();
                saveAndFetch(startDateInput.value, endDateInput.value);
            }
        });
        endDateInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                clearAllClientSideFilters();
                saveAndFetch(startDateInput.value, endDateInput.value);
            }
        });

        if (!useDocumentFilter) {
            const savedFilters = loadAllFiltersFromLocalStorage();

            if (savedFilters) {
                if (savedFilters.pageSize) {
                    pageSize = parseInt(savedFilters.pageSize);
                    if (pageSizeSelect) {
                        pageSizeSelect.value = pageSize;
                    }
                }

                if (savedFilters.currentPage) {
                    currentPage = parseInt(savedFilters.currentPage);
                }

                const filterIds = [
                    'filter-document-no', 'filter-document-type', 'filter-client',
                    'filter-date', 'filter-description', 'filter-account',
                    'filter-isvat', 'filter-warehouse', 'filter-created-by'
                ];

                const filterMap = {
                    'filter-document-no': 'documentNo',
                    'filter-document-type': 'documentType',
                    'filter-client': 'client',
                    'filter-date': 'date',
                    'filter-description': 'description',
                    'filter-account': 'account',
                    'filter-isvat': 'isVat',
                    'filter-warehouse': 'warehouse',
                    'filter-created-by': 'createdBy'
                };

                filterIds.forEach(filterId => {
                    const input = document.getElementById(filterId);
                    const savedKey = filterMap[filterId];
                    if (input && savedFilters[savedKey] !== undefined) {
                        input.value = savedFilters[savedKey];
                    }
                });
            }
        } else {
            setTimeout(() => {
                const filterIds = [
                    'filter-document-no', 'filter-document-type', 'filter-client',
                    'filter-date', 'filter-description', 'filter-account',
                    'filter-isvat', 'filter-warehouse', 'filter-created-by'
                ];

                filterIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = '';
                    }
                });
            }, 100);
    }
    
    if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', (e) => {
                pageSize = parseInt(e.target.value);
            currentPage = 1;
                saveAllFiltersToLocalStorage();
            applyFrontendFilter();
        });
    }
    
        if (useDocumentFilter) {
            // Clear filters and fetch with selected document
            clearAllClientSideFilters(true); // Preserve selected_document in URL
            
            // Get date values (from URL params or inputs)
            const fetchStartDate = usePassedDateRange && beginDateParam ? beginDateParam : startDateInput.value;
            const fetchEndDate = usePassedDateRange && endDateParam ? endDateParam : endDateInput.value;
            
            // Directly fetch documents with date range and selected document
            window.isInitialDocumentFilterLoad = true;
            fetchDocuments(fetchStartDate, fetchEndDate, selectedDocumentId).then(() => {
                window.isInitialDocumentFilterLoad = false;
                setTimeout(() => {
                    applyFrontendFilter();
                    if (selectedDocumentId) {
                        setTimeout(() => {
                            loadDocumentDetails(selectedDocumentId);
                        }, 100);
                    }
                }, 100);
            }).catch(error => {
                window.isInitialDocumentFilterLoad = false;
                console.error('Error during search:', error);
            });
        } else {
            fetchDocuments(startDateInput.value, endDateInput.value);
        }
    }
}

// Fetch documents from API
function fetchDocuments(startDate, endDate, selectedDocumentIdParam = null) {
    const tbody = document.getElementById('documents-tbody');
    if (!tbody) return Promise.resolve();
    
    // Cancel previous request if still in flight
    if (currentApiRequest) {
        currentApiRequest.abort();
        currentApiRequest = null;
    }
    
    // Show loading state
    tbody.innerHTML = '<tr><td colspan="12" class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-sm text-gray-600">Ачааллаж байна...</p></td></tr>';
    
    const urlParams = new URLSearchParams(window.location.search);
    let selectedDocumentId = selectedDocumentIdParam || urlParams.get('selected_document');
    
    let url = `/core/api/inventory-documents-master/?start_date=${startDate}&end_date=${endDate}`;
    if (selectedDocumentId) {
        url += `&selected_document=${selectedDocumentId}`;
    }
    
    // Create new AbortController for this request
    currentApiRequest = new AbortController();
    
    return fetch(url, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        signal: currentApiRequest.signal
    })
    .then(response => response.json())
    .then(data => {
        // Clear request reference on success
        currentApiRequest = null;
        
        if (data.success) {
            allDocumentsData = data.documents;
            
            // If selected_document is in URL, optionally set document number filter for visual feedback
            const selectedDocumentIdFromUrl = urlParams.get('selected_document');
            if (selectedDocumentIdFromUrl) {
                const selectedDoc = data.documents.find(doc => doc.DocumentId == selectedDocumentIdFromUrl);
                const documentNoFilter = document.getElementById('filter-document-no');
                if (selectedDoc && documentNoFilter && !documentNoFilter.value) {
                    documentNoFilter.value = selectedDoc.DocumentNo || '';
                }
            }
            
            // If filter_document_no is in URL, set document number filter
            const filterDocumentNo = urlParams.get('filter_document_no');
            if (filterDocumentNo) {
                const documentNoFilter = document.getElementById('filter-document-no');
                if (documentNoFilter) {
                    documentNoFilter.value = filterDocumentNo;
                }
            }
            
            if (!window.isInitialDocumentFilterLoad) {
            applyFrontendFilter();
            } else {
                setTimeout(() => {
                    applyFrontendFilter();
                    window.isInitialDocumentFilterLoad = false;
                    if (selectedDocumentId) {
                        setTimeout(() => loadDocumentDetails(selectedDocumentId), 100);
                    }
                }, 50);
            }
        } else {
            tbody.innerHTML = '<tr><td colspan="12" class="text-center py-8 text-red-600">Алдаа гарлаа: ' + (data.error || 'Unknown error') + '</td></tr>';
        }
    })
    .catch(error => {
        // Clear request reference
        currentApiRequest = null;
        
        // Only show error if it's not an abort error (abort is intentional)
        if (error.name !== 'AbortError') {
            console.error('Error fetching documents:', error);
            tbody.innerHTML = '<tr><td colspan="12" class="text-center py-8 text-red-600">Сүлжээний алдаа гарлаа</td></tr>';
        }
        window.isInitialDocumentFilterLoad = false;
        // If AbortError, silently ignore (user triggered it by changing filters)
    });
}

// Apply frontend filtering with null-safe operations
function applyFrontendFilter() {
    // Get filter values
    const filters = {
        documentNo: getFilterValue('filter-document-no'),
        documentType: getFilterValue('filter-document-type'),
        client: getFilterValue('filter-client'),
        date: getFilterValue('filter-date'),
        description: getFilterValue('filter-description'),
        account: getFilterValue('filter-account'),
        isvat: getFilterValue('filter-isvat'),
        warehouse: getFilterValue('filter-warehouse'),
        createdBy: getFilterValue('filter-created-by')
    };
    
    // Check for selected_document in URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    let selectedDocumentId = urlParams.get('selected_document');
    
    // Handle selected_document navigation (backend already filtered)
    if (selectedDocumentId) {
        if (!allDocumentsData || allDocumentsData.length === 0) {
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            if (startDateInput && endDateInput) {
                const fetchPromise = fetchDocuments(startDateInput.value, endDateInput.value, selectedDocumentId);
                if (fetchPromise && typeof fetchPromise.then === 'function') {
                    fetchPromise.then(() => {
                        applyFrontendFilter();
                    });
                }
            }
            return;
        }
        
        if (allDocumentsData.length === 1) {
            const selectedDoc = allDocumentsData[0];
            const documentNoFilter = document.getElementById('filter-document-no');
            if (documentNoFilter && selectedDoc.DocumentNo && !documentNoFilter.value) {
                documentNoFilter.value = selectedDoc.DocumentNo;
            }
            
            filteredData = [selectedDoc];
            const pageData = [selectedDoc];
            currentPage = 1;
            totalPages = 1;
            
            renderDocumentsTable(pageData);
            updatePaginationInfo(1, 1, 1);
            generatePaginationButtons();
            
            setTimeout(() => {
                updateRowSelection(selectedDocumentId);
                loadDocumentDetails(selectedDocumentId);
            }, 200);
            
            saveAllFiltersToLocalStorage();
            return;
        } else {
            filteredData = [];
            renderDocumentsTable(filteredData);
            updatePaginationInfo(0, 0, 0);
            generatePaginationButtons();
            saveAllFiltersToLocalStorage();
            return;
        }
    }
    
    if (!allDocumentsData || !Array.isArray(allDocumentsData)) {
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        if (startDateInput && endDateInput) {
            const fetchPromise = fetchDocuments(startDateInput.value, endDateInput.value);
            if (fetchPromise && typeof fetchPromise.then === 'function') {
                fetchPromise.then(() => {
                    applyFrontendFilter();
                });
            }
        }
        return;
    }
    
    // Filter data with null-safe operations
    filteredData = allDocumentsData.filter(doc => {
        if (filters.documentNo && !(doc.DocumentNo || '').toLowerCase().includes(filters.documentNo)) return false;
        if (filters.documentType && !(doc.DocumentTypeCode || '').toLowerCase().includes(filters.documentType)) return false;
        if (filters.client && !(doc.ClientName || '').toLowerCase().includes(filters.client)) return false;
        if (filters.date && !(doc.DocumentDate || '').toLowerCase().includes(filters.date)) return false;
        if (filters.description && !(doc.Description || '').toLowerCase().includes(filters.description)) return false;
        if (filters.account && !(doc.AccountCode || '').toLowerCase().includes(filters.account)) return false;
        if (filters.isvat) {
            const vatValue = doc.IsVat ? 'y' : 'n';
            if (!vatValue.includes(filters.isvat)) return false;
        }
        if (filters.warehouse && !(doc.WarehouseCode || '').toLowerCase().includes(filters.warehouse)) return false;
        if (filters.createdBy && !(doc.CreatedByUsername || '').toLowerCase().includes(filters.createdBy)) return false;
        return true;
    });
    
    // Calculate pagination
    totalPages = Math.ceil(filteredData.length / pageSize);
    if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;
    
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredData.length);
    const pageData = filteredData.slice(startIndex, endIndex);
    
    // Render table
    renderDocumentsTable(pageData);
    
    // Update pagination info
    updatePaginationInfo(startIndex + 1, endIndex, filteredData.length);

    // Persist filters
    saveAllFiltersToLocalStorage();
}

// Render documents table with DocumentFragment for performance
function renderDocumentsTable(documents) {
    const tbody = document.getElementById('documents-tbody');
    if (!tbody) return;
    
    const fragment = document.createDocumentFragment();
    
    documents.forEach(doc => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.setAttribute('data-document-id', doc.DocumentId);
        tr.setAttribute('data-document-type-id', doc.DocumentTypeId || '');
        tr.setAttribute('data-client-register', doc.ClientRegister || '');
        tr.setAttribute('data-account-code', doc.AccountCode || '');
        tr.setAttribute('data-account-name', doc.AccountName || '');
        tr.setAttribute('data-warehouse-name', doc.WarehouseName || '');
        
        // Build action buttons based on permissions
        let actionButtons = '';
        
        // Manage Details button
        actionButtons += `
            <button class="manage-details-btn text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50" 
                    data-document-id="${doc.DocumentId}"
                    data-document-date="${doc.DocumentDate}"
                    title="Manage Details">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                    </svg>
                                </button>
        `;
                                
        // Print button
        actionButtons += `
                                <button class="print-document-btn" 
                    data-document-id="${doc.DocumentId}"
                                        class="inline-flex items-center p-1 border border-transparent text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                                        title="Print Document">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                    </svg>
                                </button>
        `;
        
        // Edit button (if user has permission and is the creator)
        if (hasChangePermission && doc.CreatedById === currentUserId) {
            actionButtons += `
                <button class="edit-document-btn text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50" 
                        data-document-id="${doc.DocumentId}"
                        data-document-date="${doc.DocumentDate}"
                        title="Edit Document">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
            `;
        }
        
        // Delete button (if user has permission and is the creator)
        if (hasDeletePermission && doc.CreatedById === currentUserId) {
            actionButtons += `
                                <button class="delete-document-btn text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50" 
                        data-delete-url="/core/invdocuments/${doc.DocumentId}/delete/"
                        data-document-name="Document ${doc.DocumentNo}" 
                                        title="Delete Document">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
            `;
        }
        
        tr.innerHTML = `
            <td class="px-4 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${doc.DocumentNo || '-'}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${doc.DocumentTypeCode || '-'}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${doc.ClientName || '-'}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${doc.DocumentDate || '-'}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
                <span title="${doc.Description || ''}">${truncateText(doc.Description || '', 50)}</span>
                        </td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200" style="min-width: 80px;">
                <span class="account-format" title="${doc.AccountCode || ''} - ${doc.AccountName || ''}">${doc.AccountCode || '-'}</span>
            </td>
            <td class="px-2 py-1 text-center text-xs text-gray-900 border-r border-gray-200" style="width: 40px; max-width: 40px;">
                ${doc.IsVat ? 'Y' : 'N'}
            </td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">
                <span class="warehouse-format" title="${doc.WarehouseCode || ''} - ${doc.WarehouseName || ''}">${doc.WarehouseCode || '-'}</span>
            </td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">${doc.CreatedByUsername || '-'}</td>
            <td class="px-2 py-1 whitespace-nowrap text-center text-sm font-medium">
                <div class="flex items-center justify-center space-x-2">
                    ${actionButtons}
        </div>
            </td>
        `;
        
        fragment.appendChild(tr);
    });
    
    tbody.innerHTML = '';
    tbody.appendChild(fragment);
    
    const urlParams = new URLSearchParams(window.location.search);
    const selectedDocumentId = urlParams.get('selected_document');
    if (selectedDocumentId) {
        updateRowSelection(selectedDocumentId);
    }
    
    // Event handlers are already attached via delegation, no need to re-initialize
}

// Update row selection visual state
function updateRowSelection(selectedDocumentId) {
    const allRows = document.querySelectorAll('tbody tr[data-document-id]');
    allRows.forEach(row => {
        row.classList.remove('bg-blue-50');
    });

    const selectedRow = document.querySelector(`tr[data-document-id="${selectedDocumentId}"]`);
    if (selectedRow) {
        selectedRow.classList.add('bg-blue-50');
    }
}

function resetDetailView() {
    detailCache.clear();
    updateRowSelection(null);
    const detailContainer = document.getElementById('detail-grid-container');
    if (detailContainer) {
        detailContainer.innerHTML = `
            <div class="text-center py-12 text-sm text-gray-500">
                Баримт сонгоно уу.
            </div>
        `;
    }
}

// Show loading state for detail grid
function showDetailLoadingState() {
    const detailContainer = document.getElementById('detail-grid-container');
    if (detailContainer) {
        detailContainer.innerHTML = `
            <div class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <h3 class="mt-2 text-xs font-medium text-gray-900">Loading details...</h3>
                <p class="mt-1 text-xs text-gray-500">Please wait while we load the document details.</p>
            </div>
        `;
    }
}

// Hide loading state (content replacement handles this)
function hideDetailLoadingState() {
    // Intentionally left blank
}

// Show error state for detail grid
function showDetailErrorState() {
    const detailContainer = document.getElementById('detail-grid-container');
    if (detailContainer) {
        detailContainer.innerHTML = `
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="mt-2 text-xs font-medium text-gray-900">Error loading details</h3>
                <p class="mt-1 text-xs text-gray-500">There was an error loading the document details. Please try again.</p>
                <div class="mt-6">
                    <button onclick="location.reload()" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700">
                        Reload Page
                    </button>
                </div>
            </div>
        `;
    }
}

// Render detail content (shared between cached and fresh data)
function renderDetailContent(html) {
    const detailContainer = document.getElementById('detail-grid-container');
    if (!detailContainer) {
        return;
    }

    detailContainer.innerHTML = html;

    setTimeout(() => {
        if (typeof window.calculateInventoryItemTotals === 'function') {
            window.calculateInventoryItemTotals();
        }
        if (typeof window.calculateInventoryAccountingTotals === 'function') {
            window.calculateInventoryAccountingTotals();
        }
    }, 100);

    if (typeof Silicon4Grid !== 'undefined') {
        Silicon4Grid.initializeGrid({
            tableSelector: '#detail-grid-container table',
            autoAdjust: true,
            responsive: true
        });
    }
}

// Helper function to truncate text
function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// Helper function to format numbers
function formatNumber(num) {
    return parseFloat(num).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Update pagination info
function updatePaginationInfo(start, end, total) {
    const showingStart = document.getElementById('showing-start');
    const showingEnd = document.getElementById('showing-end');
    const totalCount = document.getElementById('total-count');
    
    if (showingStart) showingStart.textContent = total === 0 ? 0 : start;
    if (showingEnd) showingEnd.textContent = end;
    if (totalCount) totalCount.textContent = total;
    
    generatePaginationButtons();
}

// Generate pagination buttons
function generatePaginationButtons() {
    const pageInfo = document.getElementById('page-info');
    if (!pageInfo) return;
    
    // Clear existing buttons
    pageInfo.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Calculate pagination range
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust start page if we're near the end
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Generate page buttons
    for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.className = `px-2 py-1 text-sm rounded-md ${
            i === currentPage 
                ? 'bg-blue-400 text-white hover:bg-blue-500' 
                : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'
        }`;
        button.addEventListener('click', () => changePage(i));
        pageInfo.appendChild(button);
    }
}

// Change page
function changePage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    
    // Remove selected_document from URL when user manually changes page
    const currentUrl = new URL(window.location);
    if (currentUrl.searchParams.has('selected_document')) {
        currentUrl.searchParams.delete('selected_document');
        window.history.replaceState({}, '', currentUrl.toString());
    }
    
    applyFrontendFilter();
}

// Initialize pagination listeners
function initializePaginationListeners() {
    // Mobile pagination buttons
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    
    if (prevBtn) prevBtn.onclick = () => changePage(currentPage - 1);
    if (nextBtn) nextBtn.onclick = () => changePage(currentPage + 1);
    
    // Desktop pagination buttons
    const prevDesktopBtn = document.getElementById('prev-page-desktop');
    const nextDesktopBtn = document.getElementById('next-page-desktop');
    
    if (prevDesktopBtn) prevDesktopBtn.onclick = () => changePage(currentPage - 1);
    if (nextDesktopBtn) nextDesktopBtn.onclick = () => changePage(currentPage + 1);
}

// Debounce utility function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize filter listeners
function initializeFilterListeners() {
    const debouncedFilter = debounce(applyFrontendFilter, 300);
    
    // Add event listeners to all filter inputs
    const filterInputs = [
        'filter-document-no', 'filter-document-type', 'filter-client', 'filter-date',
        'filter-description', 'filter-account', 'filter-isvat', 'filter-warehouse',
        'filter-created-by'
    ];
    
    filterInputs.forEach(filterId => {
        const input = document.getElementById(filterId);
        if (input) {
            input.addEventListener('input', debouncedFilter);
        }
    });
    
    // Clear filters button
    const clearButton = document.getElementById('clear-filters');
    if (clearButton) {
        clearButton.addEventListener('click', function() {
            clearAllClientSideFilters();
            applyFrontendFilter();
        });
    }
}

// Initialize event handlers with delegation pattern
function initializeEventHandlers() {
    const tbody = document.getElementById('documents-tbody');
    if (!tbody) return;
    
    // Check if already initialized to prevent duplicates
    if (tbody.hasAttribute('data-handlers-initialized')) return;
    
    // Single delegated event listener for all row interactions
    tbody.addEventListener('click', function(e) {
        // Handle row clicks for document selection
        const row = e.target.closest('tr[data-document-id]');
        if (row && !e.target.closest('button') && !e.target.closest('a')) {
            const documentId = row.getAttribute('data-document-id');
            if (documentId) {
                loadDocumentDetails(documentId);
            }
            return;
        }
        
        // Handle manage details buttons
        const manageDetailsBtn = e.target.closest('.manage-details-btn');
        if (manageDetailsBtn) {
            console.log('Manage Details button clicked!', manageDetailsBtn);
            e.stopPropagation();
            
            const documentId = manageDetailsBtn.getAttribute('data-document-id');
            const documentDate = manageDetailsBtn.getAttribute('data-document-date');
            
            console.log('Document ID:', documentId, 'Date:', documentDate);
            
            // Check period lock before allowing manage details
            checkPeriodLockForManageDetails(documentId, documentDate);
            return;
        }
        
        // Handle edit document buttons
        const editBtn = e.target.closest('.edit-document-btn');
        if (editBtn) {
            console.log('Edit button clicked!', editBtn);
            e.stopPropagation();
            
            const documentId = editBtn.getAttribute('data-document-id');
            const documentDate = editBtn.getAttribute('data-document-date');
            
            console.log('Document ID:', documentId, 'Date:', documentDate);
            
            // Check period lock before allowing edit
            checkPeriodLockForEdit(documentId, documentDate);
            return;
        }
        
        // Handle delete buttons
        const deleteBtn = e.target.closest('.delete-document-btn');
        if (deleteBtn) {
            e.preventDefault();
            e.stopPropagation();
            const deleteUrl = deleteBtn.getAttribute('data-delete-url');
            const documentName = deleteBtn.getAttribute('data-document-name');
            if (deleteUrl && documentName) {
                Silicon4Delete.showModal(deleteUrl, documentName);
            }
            return;
        }
        
        // Handle print buttons
        const printBtn = e.target.closest('.print-document-btn');
        if (printBtn) {
            e.preventDefault();
            e.stopPropagation();
            const documentId = printBtn.getAttribute('data-document-id');
            if (documentId) {
                printDocument(documentId);
            }
            return;
        }
    });
    
    // Mark as initialized
    tbody.setAttribute('data-handlers-initialized', 'true');
}

// Load document details via AJAX with caching and request cancellation
function loadDocumentDetails(documentId) {
    if (detailCache.has(documentId)) {
        renderCachedDetails(documentId);
        return;
    }
    
    if (currentDetailRequest) {
        currentDetailRequest.abort();
        currentDetailRequest = null;
    }
    
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('selected_document', documentId);
    window.history.pushState({}, '', currentUrl.toString());

    updateRowSelection(documentId);
    showDetailLoadingState();

    currentDetailRequest = new AbortController();
    
    fetch(`/core/invdocuments/?selected_document=${documentId}&ajax=1`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'text/html'
        },
        signal: currentDetailRequest.signal
    })
    .then(response => {
        currentDetailRequest = null;
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();
    })
    .then(html => {
        detailCache.set(documentId, html);
        renderDetailContent(html);
    })
    .catch(error => {
        currentDetailRequest = null;
        if (error.name !== 'AbortError') {
            console.error('Error loading document details:', error);
            showDetailErrorState();
        }
    });
}

function renderCachedDetails(documentId) {
    const html = detailCache.get(documentId);
    if (html) {
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('selected_document', documentId);
        window.history.pushState({}, '', currentUrl.toString());

        updateRowSelection(documentId);
        renderDetailContent(html);
    }
}

// Print document
async function printDocument(documentId) {
    // Build minimal document data from the selected row
    const row = document.querySelector(`tr[data-document-id="${documentId}"]`);
    if (!row) return;
    const cells = row.querySelectorAll('td');
    const documentNo = cells[0]?.textContent?.trim() || '';
    const clientName = cells[2]?.textContent?.trim() || '';
    const documentDate = cells[3]?.textContent?.trim() || '';
    const description = cells[4]?.textContent?.trim() || '';
    const documentTypeId = parseInt(row.getAttribute('data-document-type-id') || '0');
    // Extract IsVat from column 6 (index 6) - it shows 'Y' or 'N'
    const isVat = cells[6]?.textContent?.trim() === 'Y';
    // Extract ClientRegister from data attribute
    const clientRegister = row.getAttribute('data-client-register') || '';
    // Extract WarehouseName from data attribute or fallback to cell title attribute
    let warehouseName = row.getAttribute('data-warehouse-name') || '';
    // Extract AccountCode and AccountName from data attributes or fallback to cell title attribute
    let accountCode = row.getAttribute('data-account-code') || '';
    let accountName = row.getAttribute('data-account-name') || '';
    
    // Fallback: extract warehouse name from warehouse cell title attribute if not in data attribute
    if (!warehouseName) {
        const warehouseCell = cells[7]; // Warehouse column is typically at index 7
        if (warehouseCell) {
            const warehouseSpan = warehouseCell.querySelector('span[title]');
            if (warehouseSpan) {
                const title = warehouseSpan.getAttribute('title') || '';
                // Title format: "WarehouseCode - WarehouseName"
                const titleParts = title.split(' - ');
                if (titleParts.length > 1) {
                    warehouseName = titleParts[1].trim();
                }
            }
        }
    }
    
    // Fallback: extract from account cell title attribute if not in data attributes
    if (!accountCode || !accountName) {
        const accountCell = cells[5];
        if (accountCell) {
            const accountSpan = accountCell.querySelector('span[title]');
            if (accountSpan) {
                const title = accountSpan.getAttribute('title') || '';
                // Title format: "AccountCode - AccountName"
                const titleParts = title.split(' - ');
                if (!accountCode && titleParts.length > 0) {
                    accountCode = titleParts[0].trim();
                }
                if (!accountName && titleParts.length > 1) {
                    accountName = titleParts[1].trim();
                }
            }
            // Final fallback to cell text content for accountCode
            if (!accountCode) {
                accountCode = accountCell.textContent?.trim() || '';
            }
        }
    }

    // Collect items from live DOM first (if the selected detail is already rendered)
    let items = [];
    const liveDetail = document.getElementById('detail-grid-container');
    if (liveDetail) {
        const liveTbody = liveDetail.querySelector('#items-tbody');
        if (liveTbody) {
            const liveRows = liveTbody.querySelectorAll('tr');
            liveRows.forEach((r, idx) => {
                const tds = r.querySelectorAll('td');
                // Extract from data attributes (preferred) or fallback to cell content
                const inventoryCode = r.getAttribute('data-inventory-code') || tds[0]?.textContent.trim() || '';
                const inventoryName = r.getAttribute('data-inventory-name') || '';
                const measurementName = r.getAttribute('data-measurement-name') || '';
                
                // Extract inventoryName from title attribute if not in data attribute
                let extractedInventoryName = inventoryName;
                if (!extractedInventoryName && tds[0]) {
                    const titleSpan = tds[0].querySelector('span[title]');
                    if (titleSpan) {
                        const title = titleSpan.getAttribute('title') || '';
                        // Title format: "InventoryCode - InventoryName"
                        const titleParts = title.split(' - ');
                        if (titleParts.length > 1) {
                            extractedInventoryName = titleParts[1].trim();
                        }
                    }
                }
                
                // Table structure: InventoryCode (col 0), Quantity (col 1), UnitCost (col 2), UnitPrice (col 3), TotalCost (col 4), TotalPrice (col 5)
                if (tds.length >= 6) {
                    items.push({
                        no: String(idx + 1),
                        inventoryCode: inventoryCode,
                        name: extractedInventoryName,
                        unit: measurementName,
                        qty: tds[1]?.textContent.trim() || '',
                        unitPrice: tds[3]?.textContent.trim() || '',
                        total: tds[5]?.textContent.trim() || '',
                        vat: '', // Not in the detail grid
                        totalNoVat: '' // Not in the detail grid
                    });
                }
            });
        }
    }

    // If no items from live DOM, try to get cached/fetched detail HTML and parse
    if (items.length === 0) {
        let detailHtml = detailCache.get(documentId);
        if (!detailHtml) {
            try {
                const resp = await fetch(`?selected_document=${documentId}&ajax=1`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (resp.ok) {
                    detailHtml = await resp.text();
                    detailCache.set(documentId, detailHtml);
                }
            } catch (e) {
                console.warn('Failed to fetch detail for printing:', e);
            }
        }
        if (detailHtml) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(detailHtml, 'text/html');
            // Prefer #items-tbody if present, else first tbody under detail
            let itemsTbody = doc.getElementById('items-tbody');
            if (!itemsTbody) {
                const detailRoot = doc.getElementById('detail-grid-container') || doc;
                itemsTbody = detailRoot.querySelector('tbody');
            }
            if (itemsTbody) {
                const rows = itemsTbody.querySelectorAll('tr');
                rows.forEach((r, idx) => {
                    const tds = r.querySelectorAll('td');
                    // Extract from data attributes (preferred) or fallback to cell content
                    const inventoryCode = r.getAttribute('data-inventory-code') || tds[0]?.textContent.trim() || '';
                    const inventoryName = r.getAttribute('data-inventory-name') || '';
                    const measurementName = r.getAttribute('data-measurement-name') || '';
                    
                    // Extract inventoryName from title attribute if not in data attribute
                    let extractedInventoryName = inventoryName;
                    if (!extractedInventoryName && tds[0]) {
                        const titleSpan = tds[0].querySelector('span[title]');
                        if (titleSpan) {
                            const title = titleSpan.getAttribute('title') || '';
                            // Title format: "InventoryCode - InventoryName"
                            const titleParts = title.split(' - ');
                            if (titleParts.length > 1) {
                                extractedInventoryName = titleParts[1].trim();
                            }
                        }
                    }
                    
                    // Table structure: InventoryCode (col 0), Quantity (col 1), UnitCost (col 2), UnitPrice (col 3), TotalCost (col 4), TotalPrice (col 5)
                    if (tds.length >= 6) {
                        items.push({
                            no: String(idx + 1),
                            inventoryCode: inventoryCode,
                            name: extractedInventoryName,
                            unit: measurementName,
                            qty: tds[1]?.textContent.trim() || '',
                            unitPrice: tds[3]?.textContent.trim() || '',
                            total: tds[5]?.textContent.trim() || '',
                            vat: '', // Not in the detail grid
                            totalNoVat: '' // Not in the detail grid
                        });
                    }
                });
            }
        }
    }

    window.InvDocPrint.print({
        documentId,
        documentNo,
        documentDate,
        description,
        clientName,
        clientRegister,
        accountCode,
        accountName,
        warehouseName,
        documentTypeId,
        isVat,
        items,
        createdBy: '{{ request.user.username|default:"" }}'
    });
}

// Initialize everything when DOM is loaded
function initializeAll() {
    initializeEventHandlers();
    initializeDateInputs();
    initializeFilterListeners();
    initializePaginationListeners();
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeAll();
});

// Inventory Document Calculation Functions (moved here to ensure they're always available)
function calculateInventoryItemTotals() {
    const itemsTbody = document.getElementById('items-tbody');
    if (!itemsTbody) {
        console.warn('Inventory: No items tbody found');
        return;
    }
    
    const totalCostCells = itemsTbody.querySelectorAll('td.total-cost');
    const totalPriceCells = itemsTbody.querySelectorAll('td.total-price');
    
    let totalCost = 0;
    let totalPrice = 0;
    
    // Calculate total cost
    totalCostCells.forEach((cell) => {
        const value = parseFloat(cell.textContent.replace(/,/g, '')) || 0;
        totalCost += value;
    });
    
    // Calculate total price
    totalPriceCells.forEach((cell) => {
        const value = parseFloat(cell.textContent.replace(/,/g, '')) || 0;
        totalPrice += value;
    });
    
    // Update display elements
    const totalCostElement = document.getElementById('display-total-cost');
    const totalPriceElement = document.getElementById('display-total-price');
    
    if (totalCostElement) {
        const formattedCost = totalCost.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        totalCostElement.textContent = formattedCost;
    }
    
    if (totalPriceElement) {
        const formattedPrice = totalPrice.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        totalPriceElement.textContent = formattedPrice;
    }
}

function calculateInventoryAccountingTotals() {
    const tbody = document.getElementById('detail-tbody');
    if (!tbody) {
        console.warn('Inventory: No detail tbody found');
        return;
    }
    
    const rows = tbody.querySelectorAll('tr');
    let totalDebit = 0;
    let totalCredit = 0;
    
    // Calculate totals and update currency conversions
    rows.forEach((row) => {
        const currencyAmountCell = row.querySelector('td:nth-child(5)'); // Currency Amount column
        const currencyExchangeCell = row.querySelector('td:nth-child(4)'); // Exchange Rate column
        const debitCell = row.querySelector('td.debit-amount');
        const creditCell = row.querySelector('td.credit-amount');
        
        if (currencyAmountCell && currencyExchangeCell) {
            const currencyAmount = parseFloat(currencyAmountCell.textContent.replace(/,/g, '')) || 0;
            const currencyExchange = parseFloat(currencyExchangeCell.textContent.replace(/,/g, '')) || 0;
            
            // Calculate converted amount
            const convertedAmount = currencyAmount * currencyExchange;
            
            // Update debit/credit cells with calculated amounts
            if (debitCell && creditCell) {
                const currentDebit = parseFloat(debitCell.textContent.replace(/,/g, '')) || 0;
                const currentCredit = parseFloat(creditCell.textContent.replace(/,/g, '')) || 0;
                
                // Only update if there's a debit or credit amount (not both zero)
                if (currentDebit > 0 || currentCredit > 0) {
                    if (currentDebit > 0) {
                        debitCell.textContent = convertedAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        totalDebit += convertedAmount;
                    } else if (currentCredit > 0) {
                        creditCell.textContent = convertedAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        totalCredit += convertedAmount;
                    }
                }
            }
        } else {
            // Fallback: use existing debit/credit amounts if currency conversion not available
            if (debitCell) {
                const value = parseFloat(debitCell.textContent.replace(/,/g, '')) || 0;
                totalDebit += value;
            }
            if (creditCell) {
                const value = parseFloat(creditCell.textContent.replace(/,/g, '')) || 0;
                totalCredit += value;
            }
        }
    });
    
    const difference = totalDebit - totalCredit;
    
    // Update display elements
    const totalDebitElement = document.getElementById('display-total-debit');
    const totalCreditElement = document.getElementById('display-total-credit');
    const balanceStatusElement = document.getElementById('display-balance-status');
    
    if (totalDebitElement) {
        const formattedDebit = totalDebit.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        totalDebitElement.textContent = formattedDebit;
    }
    
    if (totalCreditElement) {
        const formattedCredit = totalCredit.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        totalCreditElement.textContent = formattedCredit;
    }
    
    if (balanceStatusElement) {
        if (Math.abs(difference) < 0.01) {
            balanceStatusElement.textContent = 'balanced ✓';
            balanceStatusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
        } else {
            balanceStatusElement.textContent = `not balanced (${difference.toFixed(2)})`;
            balanceStatusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
        }
    }
}

// Make functions globally available
window.calculateInventoryItemTotals = calculateInventoryItemTotals;
window.calculateInventoryAccountingTotals = calculateInventoryAccountingTotals;
console.log('✅ Inventory calculation functions defined in master-detail template');

// Check period lock before allowing edit
function checkPeriodLockForEdit(documentId, documentDate) {
    console.log('checkPeriodLockForEdit called with:', documentId, documentDate);
    
    if (!documentDate) {
        console.log('No date, proceeding to edit');
        // No date, proceed to edit
        window.location.href = `/core/invdocuments/${documentId}/update/`;
        return;
    }
    
    console.log('Checking period lock for date:', documentDate);
    
    // Check period lock via API
    fetch(`/core/api/check-period-lock/?date=${documentDate}`)
        .then(response => response.json())
        .then(data => {
            console.log('Period lock API response:', data);
            if (data.is_locked) {
                console.log('Period is locked, showing modal');
                // Show modal for locked period
                if (typeof showMessageModal === 'function') {
                    showMessageModal(data.message, 'error', 'Тухайн сар цоожлогдсон байна.');
                } else {
                    alert(data.message);
                }
            } else {
                console.log('Period not locked, proceeding to edit');
                // Not locked, proceed to edit
                window.location.href = `/core/invdocuments/${documentId}/update/`;
            }
        })
        .catch(error => {
            console.error('Period lock check failed:', error);
            // On error, allow edit (fail open)
            window.location.href = `/core/invdocuments/${documentId}/update/`;
        });
}

// Check period lock before allowing manage details
function checkPeriodLockForManageDetails(documentId, documentDate) {
    console.log('checkPeriodLockForManageDetails called with:', documentId, documentDate);
    
    if (!documentDate) {
        console.log('No date, proceeding to manage details');
        // No date, proceed to manage details
        window.location.href = `/core/invdocuments/${documentId}/bulk-manage-details/`;
        return;
    }
    
    console.log('Checking period lock for date:', documentDate);
    
    // Check period lock via API
    fetch(`/core/api/check-period-lock/?date=${documentDate}`)
        .then(response => response.json())
        .then(data => {
            console.log('Period lock API response:', data);
            if (data.is_locked) {
                console.log('Period is locked, showing modal');
                // Show modal for locked period
                if (typeof showMessageModal === 'function') {
                    showMessageModal(data.message, 'error', 'Тухайн сар цоожлогдсон байна.');
                } else {
                    alert(data.message);
                }
            } else {
                console.log('Period not locked, proceeding to manage details');
                // Not locked, proceed to manage details
                window.location.href = `/core/invdocuments/${documentId}/bulk-manage-details/`;
            }
        })
        .catch(error => {
            console.error('Period lock check failed:', error);
            // On error, allow manage details (fail open)
            window.location.href = `/core/invdocuments/${documentId}/bulk-manage-details/`;
        });
}

} // End of execution guard
</script>

<!-- Include Message Modal Component -->
{% include 'core/components/message_modal.html' %}

{% endblock %}
