{% extends 'base.html' %}
{% load humanize %}

{% block title %}Asset Documents - Silicon-AI Accounting{% endblock %}

{% block content %}
<div>
    <div class="flex justify-between items-center px-3 py-2 lg:px-6 bg-white border-b border-gray-200">
        <div>
            <h1 class="text-base lg:text-lg xl:text-xl font-medium text-gray-900">ХӨРӨНГИЙН МОДУЛЬ</h1>            
        </div>
        {% if perms.core.add_ast_document %}
        <a href="{% url 'core:astdocument_create' %}" class="inline-flex items-center px-2 py-1 lg:px-3 lg:py-1.5 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg class="mr-1.5 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Нэмэх
        </a>
        {% endif %}
    </div>

    <!-- Master Grid (Asset Documents) -->
    <!-- Date Range Filter -->
    <div class="bg-white border-b border-gray-200 px-3 py-2 lg:px-6">
        <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center space-x-2">
                <label for="start-date" class="text-sm font-medium text-gray-700">Эхлэх огноо:</label>
                <input type="date" id="start-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-center space-x-2">
                <label for="end-date" class="text-sm font-medium text-gray-700">Дуусах огноо:</label>
                <input type="date" id="end-date" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="apply-date-filter" class="bg-blue-600 text-white whitespace-nowrap py-1 px-3 font-normal text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                СЭРГЭЭХ
            </button>
        </div>
    </div>

    <div id="asset-document-container" 
         class="bg-white shadow overflow-hidden rounded-lg border border-gray-200">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Баримт</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Төрөл</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагч</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Огноо</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Гүйлгээний утга</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200" style="min-width: 80px;">Данс</th>
                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200" style="width: 40px; max-width: 40px;">Н</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Өртөг</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Үнэ</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Хэн</th>
                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Үйлдэл</th>
                    </tr>
                    <tr class="bg-gray-100">
                        <td class="px-4 py-1 border-r border-gray-200"><input type="text" id="filter-document-no" placeholder="Filter..." class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></td>
                        <td class="px-2 py-1 border-r border-gray-200"><input type="text" id="filter-document-type" placeholder="Filter..." class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></td>
                        <td class="px-2 py-1 border-r border-gray-200"><input type="text" id="filter-client" placeholder="Filter..." class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></td>
                        <td class="px-2 py-1 border-r border-gray-200"><input type="text" id="filter-date" placeholder="Filter..." class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></td>
                        <td class="px-2 py-1 border-r border-gray-200"><input type="text" id="filter-description" placeholder="Filter..." class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></td>
                        <td class="px-2 py-1 border-r border-gray-200" style="min-width: 80px;"><input type="text" id="filter-account" placeholder="Filter..." class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></td>
                        <td class="px-2 py-1 border-r border-gray-200" style="width: 40px; max-width: 40px;"><input type="text" id="filter-isvat" placeholder="Filter..." class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></td>
                        <td class="px-2 py-1 border-r border-gray-200"><input type="number" id="filter-cost-amount" placeholder="Filter..." class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" step="0.000001"></td>
                        <td class="px-2 py-1 border-r border-gray-200"><input type="number" id="filter-price-amount" placeholder="Filter..." class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" step="0.000001"></td>
                        <td class="px-2 py-1 border-r border-gray-200"><input type="text" id="filter-created-by" placeholder="Filter..." class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></td>
                        <td class="px-2 py-1"><button id="clear-filters" class="w-full px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 focus:ring-1 focus:ring-blue-500">Clear</button></td>
                    </tr>
                </thead>
                <tbody id="documents-tbody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="bg-white px-4 py-1 flex items-center justify-between border-t border-gray-200 sm:px-6">
        <div class="flex-1 flex justify-between sm:hidden">
            <button id="prev-page-btn" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Өмнөх
                                </button>
            <button id="next-page-btn" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Дараа
                                </button>
                            </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p id="pagination-info" class="text-sm text-gray-700">
                    Нийт <span id="total-count">0</span> бичлэгээс <span id="showing-start">0</span> - <span id="showing-end">0</span> бичлэг харагдаж байна
                </p>
        </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <label for="page-size-select" class="text-sm font-medium text-gray-700">Хуудасны хэмжээ:</label>
                    <select id="page-size-select" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="10" selected>10</option>
                    </select>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
                        </button>
                        <span id="page-info" class="relative inline-flex gap-2 items-center px-4 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            <!-- Dynamic page buttons will be generated here -->
                        </span>
                        <button id="next-page-desktop" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                        </button>
                    </nav>
            </div>
        </div>
        </div>
    </div>

    <!-- Detail Grid will be loaded here via AJAX -->
    <div id="detail-grid-container">
        <!-- Detail grid content will be dynamically loaded here -->
    </div>
</div>

<!-- Include Delete Modal -->
{% include 'core/components/delete_modal.html' %}

<script>
// Prevent script re-execution
if (!window.astDocumentScriptLoaded) {
    window.astDocumentScriptLoaded = true;

// API-Based Data Management (mirror inventory pattern)
let allDocumentsData = [];
let filteredData = [];
let currentPage = 1;
let pageSize = 10;
let totalPages = 1;
let currentApiRequest = null;
let currentDetailRequest = null;
const detailCache = new Map();
const currentUserId = {{ request.user.id }};
const hasChangePermission = {% if perms.core.change_ast_document %}true{% else %}false{% endif %};
const hasDeletePermission = {% if perms.core.delete_ast_document %}true{% else %}false{% endif %};

// Safe HTML escaper for dynamic content
function escapeHtml(value) {
    const str = String(value == null ? '' : value);
    return str.replace(/[&<>"'`=\\/]/g, function (s) {
        return ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            '/': '&#x2F;',
            '`': '&#x60;',
            '=': '&#x3D;'
        })[s];
    });
}

function initializeDateInputs() {
    const today = new Date();
    let firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    let lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    // Check if selected_document is in URL and adjust date range if needed
    const urlParams = new URLSearchParams(window.location.search);
    const selectedDocumentId = urlParams.get('selected_document');
    {% if selected_document %}
    if (selectedDocumentId) {
        // Get document date from server-side context
        const docDate = new Date('{{ selected_document.DocumentDate|date:"Y-m-d" }}');
        // If document date is outside current month, adjust date range to include it
        if (docDate < firstDay || docDate > lastDay) {
            // Use document date ± 1 month, or use document date's month
            const docYear = docDate.getFullYear();
            const docMonth = docDate.getMonth();
            firstDay = new Date(docYear, docMonth, 1);
            lastDay = new Date(docYear, docMonth + 1, 0);
            // Ensure we include at least the document date
            if (docDate < firstDay) firstDay = new Date(docDate);
            if (docDate > lastDay) lastDay = new Date(docDate);
        }
    }
    {% endif %}
    
    const formatDateForInput = (date) => `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const applyButton = document.getElementById('apply-date-filter');
    const pageSizeSelect = document.getElementById('page-size-select');
    const defaultStart = formatDateForInput(firstDay);
    const defaultEnd = formatDateForInput(lastDay);
    if (startDateInput && endDateInput) {
        if (!startDateInput.value) startDateInput.value = defaultStart;
        if (!endDateInput.value) endDateInput.value = defaultEnd;
    }
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', () => { pageSize = parseInt(pageSizeSelect.value); currentPage = 1; applyFrontendFilter(); });
    }
    if (applyButton && startDateInput && endDateInput) {
        applyButton.addEventListener('click', () => {
            const startValue = startDateInput.value;
            const endValue = endDateInput.value;
            if (!startValue || !endValue) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Always clear frontend filters when user clicks refresh
            clearAllClientSideFilters();
            currentPage = 1;
            
            // Fetch data within the date range
            fetchDocuments(startValue, endValue);
        });
    }
    // Always fetch at load with defaults if inputs are missing
    const start = (startDateInput && startDateInput.value) ? startDateInput.value : defaultStart;
    const end = (endDateInput && endDateInput.value) ? endDateInput.value : defaultEnd;
    fetchDocuments(start, end);
}

function fetchDocuments(startDate, endDate) {
    const tbody = document.getElementById('documents-tbody');
    if (!tbody) return;
    if (currentApiRequest) { currentApiRequest.abort(); currentApiRequest = null; }
    tbody.innerHTML = '<tr><td colspan="11" class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-sm text-gray-600">Ачааллаж байна...</p></td></tr>';
    const url = `/core/api/asset-documents-master/?start_date=${encodeURIComponent(startDate)}&end_date=${encodeURIComponent(endDate)}`;
    currentApiRequest = new AbortController();
    fetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, signal: currentApiRequest.signal })
        .then(r => r.json())
        .then(data => {
            currentApiRequest = null;
            if (data.success) {
                allDocumentsData = (data.documents || []).slice().sort((a, b) => {
                    const idA = parseInt(a.DocumentId, 10) || 0;
                    const idB = parseInt(b.DocumentId, 10) || 0;
                    return idB - idA;
                });
                currentPage = 1;
                
                // If selected_document is in URL, optionally set document number filter for visual feedback
                const urlParams = new URLSearchParams(window.location.search);
                const selectedDocumentId = urlParams.get('selected_document');
                if (selectedDocumentId) {
                    const selectedDoc = data.documents.find(doc => doc.DocumentId == selectedDocumentId);
                    const documentNoFilter = document.getElementById('filter-document-no');
                    if (selectedDoc && documentNoFilter && !documentNoFilter.value) {
                        documentNoFilter.value = selectedDoc.DocumentNo || '';
                    }
                }
                
                applyFrontendFilter();
            }
            else { tbody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-red-600">Алдаа гарлаа</td></tr>'; }
        })
        .catch(err => { currentApiRequest = null; if (err.name !== 'AbortError') { console.error(err); tbody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-red-600">Сүлжээний алдаа гарлаа</td></tr>'; } });
}

function applyFrontendFilter() {
    const filters = {
        documentNo: document.getElementById('filter-document-no')?.value.toLowerCase().trim() || '',
        documentType: document.getElementById('filter-document-type')?.value.toLowerCase().trim() || '',
        client: document.getElementById('filter-client')?.value.toLowerCase().trim() || '',
        date: document.getElementById('filter-date')?.value.toLowerCase().trim() || '',
        description: document.getElementById('filter-description')?.value.toLowerCase().trim() || '',
        account: document.getElementById('filter-account')?.value.toLowerCase().trim() || '',
        isvat: document.getElementById('filter-isvat')?.value.toLowerCase().trim() || '',
        costAmount: document.getElementById('filter-cost-amount')?.value.toLowerCase().trim() || '',
        priceAmount: document.getElementById('filter-price-amount')?.value.toLowerCase().trim() || '',
        createdBy: document.getElementById('filter-created-by')?.value.toLowerCase().trim() || ''
    };
    // Check for selected_document in URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const selectedDocumentId = urlParams.get('selected_document');
    
    filteredData = allDocumentsData.filter(doc => {
        // If selected_document is in URL, filter to only that document
        if (selectedDocumentId && doc.DocumentId != selectedDocumentId) return false;
        
        if (filters.documentNo && !(doc.DocumentNo || '').toLowerCase().includes(filters.documentNo)) return false;
        if (filters.documentType && !(doc.DocumentTypeCode || '').toLowerCase().includes(filters.documentType)) return false;
        if (filters.client && !(doc.ClientName || '').toLowerCase().includes(filters.client)) return false;
        if (filters.date && !(doc.DocumentDate || '').toLowerCase().includes(filters.date)) return false;
        if (filters.description && !(doc.Description || '').toLowerCase().includes(filters.description)) return false;
        if (filters.account && !(doc.AccountCode || '').toLowerCase().includes(filters.account)) return false;
        if (filters.isvat) { const v = doc.IsVat ? 'y' : 'n'; if (!v.includes(filters.isvat)) return false; }
        if (filters.costAmount && !(doc.CostAmount || 0).toString().includes(filters.costAmount)) return false;
        if (filters.priceAmount && !(doc.PriceAmount || 0).toString().includes(filters.priceAmount)) return false;
        if (filters.createdBy && !(doc.CreatedByUsername || '').toLowerCase().includes(filters.createdBy)) return false;
        return true;
    });
    totalPages = Math.ceil(filteredData.length / pageSize);
    if (currentPage > totalPages) currentPage = Math.max(1, totalPages);
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredData.length);
    renderDocumentsTable(filteredData.slice(startIndex, endIndex));
    updatePaginationInfo(startIndex + 1, endIndex, filteredData.length);
}

function renderDocumentsTable(documents) {
    const tbody = document.getElementById('documents-tbody');
    if (!tbody) return;
    const fragment = document.createDocumentFragment();
    documents.forEach(doc => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.setAttribute('data-document-id', doc.DocumentId);
        tr.setAttribute('data-document-type-id', doc.DocumentTypeId || '');
        tr.setAttribute('data-client-register', doc.ClientRegister || '');
        tr.setAttribute('data-account-code', doc.AccountCode || '');
        tr.setAttribute('data-account-name', doc.AccountName || '');
        tr.setAttribute('data-document-date', doc.DocumentDate || '');
        
        // Build action buttons based on permissions
        let actionButtons = '';
        // Manage Details button
        actionButtons += `
            <a href="/core/astdocuments/${doc.DocumentId}/bulk-manage-details/" 
                                   class="manage-details-link text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50"
                                   data-document-id="${doc.DocumentId}"
                                   data-document-date="${doc.DocumentDate || ''}"
                                   title="Manage Details">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                    </svg>
                                </a>
        `;
        // Print button
        actionButtons += `
                                <button class="print-document-btn" 
                    data-document-id="${doc.DocumentId}"
                                        class="inline-flex items-center p-1 border border-transparent text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                                        title="Print Document">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                    </svg>
                                </button>
        `;
        // Edit button (if user has permission and is the creator)
        if (hasChangePermission && doc.CreatedById === currentUserId) {
            actionButtons += `
                <button class="edit-document-btn text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50" 
                        data-document-id="${doc.DocumentId}"
                        data-document-date="${doc.DocumentDate}"
                        title="Edit Document">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
            `;
        }
        
        // Delete button (if user has permission and is the creator)
        if (hasDeletePermission && doc.CreatedById === currentUserId) {
            actionButtons += `
                                <button class="delete-document-btn text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50" 
                        data-delete-url="/core/astdocuments/${doc.DocumentId}/delete/"
                        data-document-name="Document ${doc.DocumentNo}" 
                                        title="Delete Document">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
            `;
        }
        tr.innerHTML = `
            <td class="px-4 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${escapeHtml(doc.DocumentNo || '-')}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${escapeHtml(doc.DocumentTypeCode || '-')}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${escapeHtml(doc.ClientName || '-')}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">${escapeHtml(doc.DocumentDate || '-')}</td>
            <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
                <span title="${escapeHtml(doc.Description || '')}">${truncateText(doc.Description || '', 50)}</span>
                        </td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200" style="min-width: 80px;"><span class="account-format" title="${escapeHtml(doc.AccountCode || '')} - ${escapeHtml(doc.AccountName || '')}">${escapeHtml(doc.AccountCode || '-')}</span></td>
            <td class="px-2 py-1 text-center text-xs text-gray-900 border-r border-gray-200" style="width: 40px; max-width: 40px;">${doc.IsVat ? 'Y' : 'N'}</td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${doc.CostAmount != null && doc.CostAmount !== '' && !isNaN(parseFloat(doc.CostAmount)) ? parseFloat(doc.CostAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-'}</td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200 text-right">${doc.PriceAmount != null && doc.PriceAmount !== '' && !isNaN(parseFloat(doc.PriceAmount)) ? parseFloat(doc.PriceAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-'}</td>
            <td class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">${escapeHtml(doc.CreatedByUsername || '-')}</td>
            <td class="px-2 py-1 whitespace-nowrap text-center text-sm font-medium"><div class="flex items-center justify-center space-x-2">${actionButtons}</div></td>`;
        fragment.appendChild(tr);
    });
    tbody.innerHTML = '';
    tbody.appendChild(fragment);
    
    // Event handlers are already attached via delegation, no need to re-initialize
}

// Helper function to truncate text
function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// Helper function to format numbers
function formatNumber(num) {
    return parseFloat(num).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function updatePaginationInfo(start, end, total) {
    const showingStart = document.getElementById('showing-start');
    const showingEnd = document.getElementById('showing-end');
    const totalCount = document.getElementById('total-count');
    if (showingStart) showingStart.textContent = total === 0 ? 0 : start;
    if (showingEnd) showingEnd.textContent = end;
    if (totalCount) totalCount.textContent = total;
    generatePaginationButtons();
}

function generatePaginationButtons() {
    const pageInfo = document.getElementById('page-info');
    if (!pageInfo) return;
    pageInfo.innerHTML = '';
    if (totalPages <= 1) return;
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    if (endPage - startPage < maxVisiblePages - 1) startPage = Math.max(1, endPage - maxVisiblePages + 1);
    for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.className = `px-2 py-1 text-sm rounded-md ${i === currentPage ? 'bg-blue-400 text-white hover:bg-blue-500' : 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50'}`;
        button.addEventListener('click', () => changePage(i));
        pageInfo.appendChild(button);
    }
}

function changePage(page) { if (page < 1 || page > totalPages) return; currentPage = page; applyFrontendFilter(); }

function initializePaginationListeners() {
    // Mobile pagination buttons
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    
    if (prevBtn) prevBtn.onclick = () => changePage(currentPage - 1);
    if (nextBtn) nextBtn.onclick = () => changePage(currentPage + 1);
    
    // Desktop pagination buttons
    const prevDesktopBtn = document.getElementById('prev-page-desktop');
    const nextDesktopBtn = document.getElementById('next-page-desktop');
    
    if (prevDesktopBtn) prevDesktopBtn.onclick = () => changePage(currentPage - 1);
    if (nextDesktopBtn) nextDesktopBtn.onclick = () => changePage(currentPage + 1);
}

// Helper function to clear all client-side filters
function clearAllClientSideFilters() {
    const filterInputs = ['filter-document-no','filter-document-type','filter-client','filter-date','filter-description','filter-account','filter-isvat','filter-cost-amount','filter-price-amount','filter-created-by'];
    filterInputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    
    // Remove selected_document from URL if present
    const currentUrl = new URL(window.location);
    if (currentUrl.searchParams.has('selected_document')) {
        currentUrl.searchParams.delete('selected_document');
        window.history.pushState({}, '', currentUrl.toString());
    }
}

function initializeFilterListeners() {
    const debouncedFilter = (fn => { let t; return function(...args){ clearTimeout(t); t = setTimeout(() => fn.apply(this,args), 300); }; })(applyFrontendFilter);
    const filterInputs = ['filter-document-no','filter-document-type','filter-client','filter-date','filter-description','filter-account','filter-isvat','filter-cost-amount','filter-price-amount','filter-created-by'];
    filterInputs.forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('input', debouncedFilter); });
    const clearButton = document.getElementById('clear-filters');
    if (clearButton) clearButton.addEventListener('click', function(){ clearAllClientSideFilters(); applyFrontendFilter(); });
}

function initializeEventHandlers() {
    const tbody = document.getElementById('documents-tbody');
    if (!tbody) return;
    if (tbody.hasAttribute('data-handlers-initialized')) return;
    tbody.addEventListener('click', function(e) {
        const row = e.target.closest('tr[data-document-id]');
        if (row && !e.target.closest('button') && !e.target.closest('a')) {
            const documentId = row.getAttribute('data-document-id');
            if (documentId) loadDocumentDetails(documentId);
            return;
        }
        
        // Handle manage details link
        const manageDetailsLink = e.target.closest('.manage-details-link');
        if (manageDetailsLink) {
            e.preventDefault();
            e.stopPropagation();
            const documentId = manageDetailsLink.getAttribute('data-document-id');
            const documentDate = manageDetailsLink.getAttribute('data-document-date');
            if (documentId) {
                checkPeriodLockForManageDetails(documentId, documentDate);
            }
            return;
        }
        
        const editBtn = e.target.closest('.edit-document-btn');
        if (editBtn) {
            e.stopPropagation();
            const documentId = editBtn.getAttribute('data-document-id');
            const documentDate = editBtn.getAttribute('data-document-date');
            checkPeriodLockForEdit(documentId, documentDate);
            return;
        }
        const deleteBtn = e.target.closest('.delete-document-btn');
        if (deleteBtn) {
            e.preventDefault(); e.stopPropagation();
            const deleteUrl = deleteBtn.getAttribute('data-delete-url');
            const documentName = deleteBtn.getAttribute('data-document-name');
            const row = deleteBtn.closest('tr[data-document-id]');
            if (row && deleteUrl && documentName) {
                const documentId = row.getAttribute('data-document-id');
                const documentDate = row.getAttribute('data-document-date');
                const documentTypeId = parseInt(row.getAttribute('data-document-type-id') || '0');
                
                // Check period lock and depreciation for all document types before delete
                checkDocumentPeriodDepreciationBeforeDelete(documentId, documentDate, deleteUrl, documentName, documentTypeId);
            }
            return;
        }
        const printBtn = e.target.closest('.print-document-btn');
        if (printBtn) {
            e.preventDefault();
            e.stopPropagation();
            const documentId = printBtn.getAttribute('data-document-id');
            if (documentId) {
                printDocument(documentId);
            }
            return;
        }
    });
    tbody.setAttribute('data-handlers-initialized','true');
}

function loadDocumentDetails(documentId) {
    if (detailCache.has(documentId)) { renderCachedDetails(documentId); return; }
    if (currentDetailRequest) { currentDetailRequest.abort(); currentDetailRequest = null; }
    // Update URL state and selection
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('selected_document', documentId);
    window.history.pushState({}, '', currentUrl.toString());
    updateRowSelection(documentId);
    // Show loading state
    showDetailLoadingState();
    currentDetailRequest = new AbortController();
    const detailsUrl = `/core/astdocuments/?selected_document=${encodeURIComponent(documentId)}&ajax=1`;
    fetch(detailsUrl, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'text/html' }, signal: currentDetailRequest.signal })
        .then(r => { if (!r.ok) throw new Error('Network response was not ok'); return r.text(); })
        .then(html => { currentDetailRequest = null; detailCache.set(documentId, html); renderDetailContent(html); })
        .catch(err => { currentDetailRequest = null; if (err.name !== 'AbortError') { showDetailErrorState(); }});
}

function renderCachedDetails(documentId) {
    const html = detailCache.get(documentId);
    if (html) {
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('selected_document', documentId);
        window.history.pushState({}, '', currentUrl.toString());
        updateRowSelection(documentId);
        renderDetailContent(html);
    }
}

// Render detail content (shared between cached and fresh data)
function renderDetailContent(html) {
    const detailContainer = document.getElementById('detail-grid-container');
    if (detailContainer) {
        detailContainer.innerHTML = html;
        setTimeout(() => {
            if (typeof window.calculateAssetItemTotals === 'function') {
                window.calculateAssetItemTotals();
            }
            if (typeof window.calculateAssetAccountingTotals === 'function') {
                window.calculateAssetAccountingTotals();
            }
        }, 100);
    }
    if (typeof Silicon4Grid !== 'undefined') {
        Silicon4Grid.initializeGrid({
            tableSelector: '#detail-grid-container table',
            autoAdjust: true,
            maxWidth: 800,
            responsive: false
        });
    }
}

// Update row selection visual state
function updateRowSelection(selectedDocumentId) {
    const allRows = document.querySelectorAll('tbody tr[data-document-id]');
    allRows.forEach(row => { row.classList.remove('bg-blue-50'); });
    const selectedRow = document.querySelector(`tr[data-document-id="${selectedDocumentId}"]`);
    if (selectedRow) { selectedRow.classList.add('bg-blue-50'); }
}

// Show loading state for detail grid
function showDetailLoadingState() {
    const detailContainer = document.getElementById('detail-grid-container');
    if (detailContainer) {
        const loadingHtml = `
            <div class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <h3 class="mt-2 text-xs font-medium text-gray-900">Loading details...</h3>
                <p class="mt-1 text-xs text-gray-500">Please wait while we load the document details.</p>
            </div>
        `;
        detailContainer.innerHTML = loadingHtml;
    }
}

// Hide loading state (no-op; content will replace)
function hideDetailLoadingState() {}

// Show error state for detail grid
function showDetailErrorState() {
    const detailContainer = document.getElementById('detail-grid-container');
    if (detailContainer) {
        const errorHtml = `
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="mt-2 text-xs font-medium text-gray-900">Error loading details</h3>
                <p class="mt-1 text-xs text-gray-500">There was an error loading the document details. Please try again.</p>
                <div class="mt-6">
                    <button onclick="location.reload()" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700">Reload Page</button>
                </div>
            </div>
        `;
        detailContainer.innerHTML = errorHtml;
    }
}

// Print document
async function printDocument(documentId) {
    // Build minimal document data from the selected row
    const row = document.querySelector(`tr[data-document-id="${documentId}"]`);
    if (!row) return;
    const cells = row.querySelectorAll('td');
    const documentNo = cells[0]?.textContent?.trim() || '';
    const clientName = cells[2]?.textContent?.trim() || '';
    const documentDate = cells[3]?.textContent?.trim() || '';
    const description = cells[4]?.textContent?.trim() || '';
    const documentTypeId = parseInt(row.getAttribute('data-document-type-id') || '0');
    // Extract IsVat from column 6 (index 6) - it shows 'Y' or 'N'
    const isVat = cells[6]?.textContent?.trim() === 'Y';
    // Extract ClientRegister from data attribute
    const clientRegister = row.getAttribute('data-client-register') || '';
    // Extract AccountCode and AccountName from data attributes or fallback to cell title attribute
    let accountCode = row.getAttribute('data-account-code') || '';
    let accountName = row.getAttribute('data-account-name') || '';
    
    // Fallback: extract from account cell title attribute if not in data attributes
    if (!accountCode || !accountName) {
        const accountCell = cells[5];
        if (accountCell) {
            const accountSpan = accountCell.querySelector('span[title]');
            if (accountSpan) {
                const title = accountSpan.getAttribute('title') || '';
                // Title format: "AccountCode - AccountName"
                const titleParts = title.split(' - ');
                if (!accountCode && titleParts.length > 0) {
                    accountCode = titleParts[0].trim();
                }
                if (!accountName && titleParts.length > 1) {
                    accountName = titleParts[1].trim();
                }
            }
            // Final fallback to cell text content for accountCode
            if (!accountCode) {
                accountCode = accountCell.textContent?.trim() || '';
            }
        }
    }

    // Collect items from live DOM first (if the selected detail is already rendered)
    let items = [];
    const liveDetail = document.getElementById('detail-grid-container');
    if (liveDetail) {
        const liveTbody = liveDetail.querySelector('#items-tbody');
        if (liveTbody) {
            const liveRows = liveTbody.querySelectorAll('tr');
            liveRows.forEach((r, idx) => {
                const tds = r.querySelectorAll('td');
                // Extract from data attributes (preferred) or fallback to cell content
                const assetCardCode = r.getAttribute('data-asset-card-code') || tds[0]?.textContent.trim() || '';
                const assetCardName = r.getAttribute('data-asset-card-name') || '';
                
                // Extract assetCardName from title attribute if not in data attribute
                let extractedAssetCardName = assetCardName;
                if (!extractedAssetCardName && tds[0]) {
                    const titleSpan = tds[0].querySelector('span[title]');
                    if (titleSpan) {
                        const title = titleSpan.getAttribute('title') || '';
                        // Title format: "AssetCardCode - AssetCardName"
                        const titleParts = title.split(' - ');
                        if (titleParts.length > 1) {
                            extractedAssetCardName = titleParts[1].trim();
                        }
                    }
                }
                
                // Table structure: AssetCardCode (col 0), Quantity (col 1), UnitCost (col 2), UnitPrice (col 3), TotalCost (col 4), TotalPrice (col 5)
                if (tds.length >= 6) {
                    items.push({
                        no: String(idx + 1),
                        assetCardCode: assetCardCode,
                        name: extractedAssetCardName,
                        qty: tds[1]?.textContent.trim() || '',
                        unitPrice: tds[3]?.textContent.trim() || '',
                        total: tds[5]?.textContent.trim() || '',
                        vat: '', // Not in the detail grid
                        totalNoVat: '' // Not in the detail grid
                    });
                }
            });
        }
    }

    // If no items from live DOM, try to get cached/fetched detail HTML and parse
    if (items.length === 0) {
        let detailHtml = detailCache.get(documentId);
        if (!detailHtml) {
            try {
                const resp = await fetch(`?selected_document=${documentId}&ajax=1`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (resp.ok) {
                    detailHtml = await resp.text();
                    detailCache.set(documentId, detailHtml);
                }
            } catch (e) {
                console.warn('Failed to fetch detail for printing:', e);
            }
        }
        if (detailHtml) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(detailHtml, 'text/html');
            // Prefer #items-tbody if present, else first tbody under detail
            let itemsTbody = doc.getElementById('items-tbody');
            if (!itemsTbody) {
                const detailRoot = doc.getElementById('detail-grid-container') || doc;
                itemsTbody = detailRoot.querySelector('tbody');
            }
            if (itemsTbody) {
                const rows = itemsTbody.querySelectorAll('tr');
                rows.forEach((r, idx) => {
                    const tds = r.querySelectorAll('td');
                    // Extract from data attributes (preferred) or fallback to cell content
                    const assetCardCode = r.getAttribute('data-asset-card-code') || tds[0]?.textContent.trim() || '';
                    const assetCardName = r.getAttribute('data-asset-card-name') || '';
                    
                    // Extract assetCardName from title attribute if not in data attribute
                    let extractedAssetCardName = assetCardName;
                    if (!extractedAssetCardName && tds[0]) {
                        const titleSpan = tds[0].querySelector('span[title]');
                        if (titleSpan) {
                            const title = titleSpan.getAttribute('title') || '';
                            // Title format: "AssetCardCode - AssetCardName"
                            const titleParts = title.split(' - ');
                            if (titleParts.length > 1) {
                                extractedAssetCardName = titleParts[1].trim();
                            }
                        }
                    }
                    
                    // Table structure: AssetCardCode (col 0), Quantity (col 1), UnitCost (col 2), UnitPrice (col 3), TotalCost (col 4), TotalPrice (col 5)
                    if (tds.length >= 6) {
                        items.push({
                            no: String(idx + 1),
                            assetCardCode: assetCardCode,
                            name: extractedAssetCardName,
                            qty: tds[1]?.textContent.trim() || '',
                            unitPrice: tds[3]?.textContent.trim() || '',
                            total: tds[5]?.textContent.trim() || '',
                            vat: '', // Not in the detail grid
                            totalNoVat: '' // Not in the detail grid
                        });
                    }
                });
            }
        }
    }

    // Use generic print function for assets
    if (typeof Silicon4Print !== 'undefined' && Silicon4Print.document) {
        Silicon4Print.document(documentId, documentNo, documentDate, description, clientName, 'Хөрөнгийн баримт', accountCode, accountName, '', documentTypeId, isVat, items, '{{ request.user.username|default:"" }}');
    }
}

// Check period lock and depreciation before allowing edit
async function checkPeriodLockForEdit(documentId, documentDate) {
    console.log('checkPeriodLockForEdit called with:', documentId, documentDate);
    
    if (!documentDate) {
        // No date, proceed to edit
        window.location.href = `/core/astdocuments/${documentId}/update/`;
        return;
    }
    
    console.log('Checking period lock and depreciation for date:', documentDate);
    
    try {
        // First check period lock
        const lockResponse = await fetch(`/core/api/check-period-lock/?date=${documentDate}`);
        const lockData = await lockResponse.json();
        
        if (lockData.is_locked) {
            // Show modal for locked period
            if (typeof showMessageModal === 'function') {
                showMessageModal(lockData.message, 'error', 'Тухайн сар цоожлогдсон байна.');
            } else {
                alert(lockData.message);
            }
            return;
        }
        
        // Period not locked, check depreciation for document's period (current month)
        const depResponse = await fetch(`/core/api/check-document-period-depreciation/?document_id=${documentId}`);
        const depData = await depResponse.json();
        
        if (!depData.success) {
            console.error('Depreciation check API error:', depData.error);
            // On error, allow edit (fail open)
            window.location.href = `/core/astdocuments/${documentId}/update/`;
            return;
        }
        
        if (depData.has_depreciation_for_period) {
            // Show modal for depreciation in period
            const errorMessage = depData.message || 'Энэ сарын элэгдэл бодогдсон тул энэ баримтыг засах болон устгах боломжгүй. Элэгдлийн бичилтээ эхлээд устгана уу?';
            if (typeof showMessageModal === 'function') {
                showMessageModal(errorMessage, 'error', 'Анхааруулга');
            } else if (typeof Silicon4Message !== 'undefined' && Silicon4Message.error) {
                Silicon4Message.error(errorMessage);
            } else {
                alert(errorMessage);
            }
            return;
        }
        
        // Not locked and no depreciation, proceed to edit
        window.location.href = `/core/astdocuments/${documentId}/update/`;
    } catch (error) {
        console.error('Period lock or depreciation check failed:', error);
        // On error, allow edit (fail open)
        window.location.href = `/core/astdocuments/${documentId}/update/`;
    }
}

// Check if depreciation exists for document's period before allowing delete
async function checkDocumentPeriodDepreciationBeforeDelete(documentId, deleteUrl, documentName, documentTypeId) {
    console.log('checkDocumentPeriodDepreciationBeforeDelete called with:', documentId);
    
    try {
        // Check if depreciation exists for document's period
        const depResponse = await fetch(`/core/api/check-document-period-depreciation/?document_id=${documentId}`);
        const depData = await depResponse.json();
        
        if (!depData.success) {
            console.error('Depreciation check API error:', depData.error);
            // On error, proceed with delete (fail open)
            if (documentTypeId === 10) {
                // For DocumentTypeId = 10, also check disposal
                checkAssetDocumentBalanceBeforeDelete(documentId, deleteUrl, documentName);
            } else {
                // For other types, proceed with delete
                Silicon4Delete.showModal(deleteUrl, documentName);
            }
            return;
        }
        
        if (depData.has_depreciation_for_period) {
            // Show modal for depreciation in period
            const errorMessage = depData.message || 'Энэ сарын элэгдэл бодогдсон тул энэ баримтыг засах болон устгах боломжгүй. Элэгдлийн бичилтээ эхлээд устгана уу?';
                if (typeof showMessageModal === 'function') {
                showMessageModal(errorMessage, 'error', 'Анхааруулга');
            } else if (typeof Silicon4Message !== 'undefined' && Silicon4Message.error) {
                Silicon4Message.error(errorMessage);
                } else {
                alert(errorMessage);
                }
                return;
            }
            
        // No depreciation issue, proceed with appropriate delete check
        if (documentTypeId === 10) {
            // For DocumentTypeId = 10, also check disposal
            checkAssetDocumentBalanceBeforeDelete(documentId, deleteUrl, documentName);
        } else {
            // For other types, proceed with delete
            Silicon4Delete.showModal(deleteUrl, documentName);
        }
    } catch (error) {
        console.error('Depreciation check failed:', error);
        // On error, proceed with delete (fail open)
        if (documentTypeId === 10) {
            // For DocumentTypeId = 10, also check disposal
            checkAssetDocumentBalanceBeforeDelete(documentId, deleteUrl, documentName);
        } else {
            // For other types, proceed with delete
            Silicon4Delete.showModal(deleteUrl, documentName);
        }
    }
}

// Check if asset cards have been disposed before allowing delete (for DocumentTypeId = 10)
async function checkAssetDocumentBalanceBeforeDelete(documentId, deleteUrl, documentName) {
    console.log('checkAssetDocumentBalanceBeforeDelete called with:', documentId);
    
    try {
        // Call API to check if asset cards have been disposed (DocumentTypeId = 11)
        const balanceResponse = await fetch(`/core/api/check-asset-document-balance/?document_id=${documentId}`);
        const balanceData = await balanceResponse.json();
        
        console.log('Disposal check API response:', balanceData);
        if (balanceData.success) {
            if (balanceData.can_delete) {
                // No disposal found, proceed with delete
                Silicon4Delete.showModal(deleteUrl, documentName);
            } else {
                // Asset cards have been disposed, show error message
                const errorMessage = balanceData.message || 'Энэ баримтанд байгаа хөрөнгийг зарлагадасан бага тул устгах боломжгүй Үлдэгдлээ шалгана уу?';
                if (typeof showMessageModal === 'function') {
                    showMessageModal(errorMessage, 'error', 'Анхааруулга');
                } else if (typeof Silicon4Message !== 'undefined' && Silicon4Message.error) {
                    Silicon4Message.error(errorMessage);
                } else {
                    alert(errorMessage);
                }
            }
        } else {
            // API error
            console.error('Disposal check API error:', balanceData.error);
            const errorMessage = balanceData.error || 'Зарлага шалгахад алдаа гарлаа';
            if (typeof showMessageModal === 'function') {
                showMessageModal(errorMessage, 'error', 'Алдаа');
            } else if (typeof Silicon4Message !== 'undefined' && Silicon4Message.error) {
                Silicon4Message.error(errorMessage);
            } else {
                alert(errorMessage);
            }
        }
    } catch (error) {
        console.error('Disposal check failed:', error);
        // On error, show error message but don't allow delete
        const errorMessage = 'Зарлага шалгахад алдаа гарлаа';
        if (typeof showMessageModal === 'function') {
            showMessageModal(errorMessage, 'error', 'Алдаа');
        } else if (typeof Silicon4Message !== 'undefined' && Silicon4Message.error) {
            Silicon4Message.error(errorMessage);
        } else {
            alert(errorMessage);
        }
    }
}

// Check period lock before allowing manage details
async function checkPeriodLockForManageDetails(documentId, documentDate) {
    console.log('checkPeriodLockForManageDetails called with:', documentId, documentDate);
    
    if (!documentDate) {
        // No date, proceed to manage details
        window.location.href = `/core/astdocuments/${documentId}/bulk-manage-details/`;
        return;
    }
    
    console.log('Checking period lock and depreciation for date:', documentDate);
    
    try {
        // First check period lock
        const lockResponse = await fetch(`/core/api/check-period-lock/?date=${documentDate}`);
        const lockData = await lockResponse.json();
        
        if (lockData.is_locked) {
            // Show modal for locked period
            if (typeof showMessageModal === 'function') {
                showMessageModal(lockData.message, 'error', 'Тухайн сар цоожлогдсон байна.');
            } else {
                alert(lockData.message);
            }
            return;
        }
        
        // Period not locked, check depreciation for document's period (current month)
        const depResponse = await fetch(`/core/api/check-document-period-depreciation/?document_id=${documentId}`);
        const depData = await depResponse.json();
        
        if (!depData.success) {
            console.error('Depreciation check API error:', depData.error);
            // On error, allow manage details (fail open)
            window.location.href = `/core/astdocuments/${documentId}/bulk-manage-details/`;
            return;
        }
        
        if (depData.has_depreciation_for_period) {
            // Show modal for depreciation in period
            const errorMessage = depData.message || 'Энэ сарын элэгдэл бодогдсон тул энэ баримтыг засах болон устгах боломжгүй. Элэгдлийн бичилтээ эхлээд устгана уу?';
            if (typeof showMessageModal === 'function') {
                showMessageModal(errorMessage, 'error', 'Анхааруулга');
            } else if (typeof Silicon4Message !== 'undefined' && Silicon4Message.error) {
                Silicon4Message.error(errorMessage);
            } else {
                alert(errorMessage);
            }
            return;
        }
        
        // Not locked and no depreciation, proceed to manage details
        window.location.href = `/core/astdocuments/${documentId}/bulk-manage-details/`;
    } catch (error) {
        console.error('Period lock or depreciation check failed:', error);
        // On error, allow manage details (fail open)
        window.location.href = `/core/astdocuments/${documentId}/bulk-manage-details/`;
    }
}

function initializeAll() {
    initializeEventHandlers();
    initializeDateInputs();
    initializeFilterListeners();
    initializePaginationListeners();
}

document.addEventListener('DOMContentLoaded', function(){ initializeAll(); });

// Asset Document Calculation Functions (moved here to ensure they're always available)
function calculateAssetItemTotals() {
    const itemsTbody = document.getElementById('items-tbody');
    if (!itemsTbody) {
        console.warn('Asset: No items tbody found');
        return;
    }
    
    const totalCostCells = itemsTbody.querySelectorAll('td.total-cost');
    const totalPriceCells = itemsTbody.querySelectorAll('td.total-price');
    
    let totalCost = 0;
    let totalPrice = 0;
    
    // Calculate total cost
    totalCostCells.forEach((cell) => {
        const value = parseFloat(cell.textContent.replace(/,/g, '')) || 0;
        totalCost += value;
    });
    
    // Calculate total price
    totalPriceCells.forEach((cell) => {
        const value = parseFloat(cell.textContent.replace(/,/g, '')) || 0;
        totalPrice += value;
    });
    
    // Update display elements
    const totalCostElement = document.getElementById('asset-total-cost');
    const totalPriceElement = document.getElementById('asset-total-price');
    
    if (totalCostElement) {
        const formattedCost = totalCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        totalCostElement.textContent = formattedCost;
    }
    
    if (totalPriceElement) {
        const formattedPrice = totalPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        totalPriceElement.textContent = formattedPrice;
    }
}

function calculateAssetAccountingTotals() {
    const tbody = document.getElementById('detail-tbody');
    if (!tbody) {
        console.warn('Asset: No detail tbody found');
        return;
    }
    
    const rows = tbody.querySelectorAll('tr');
    let totalDebit = 0;
    let totalCredit = 0;
    
    // Calculate totals
    rows.forEach((row) => {
        const debitCell = row.querySelector('td.debit-amount');
        const creditCell = row.querySelector('td.credit-amount');
        
        if (debitCell) {
            const value = parseFloat(debitCell.textContent.replace(/,/g, '')) || 0;
            totalDebit += value;
        }
        if (creditCell) {
            const value = parseFloat(creditCell.textContent.replace(/,/g, '')) || 0;
            totalCredit += value;
        }
    });
    
    // Update display elements
    const totalDebitElement = document.getElementById('display-total-debit');
    const totalCreditElement = document.getElementById('display-total-credit');
    
    if (totalDebitElement) {
        const formattedDebit = totalDebit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        totalDebitElement.textContent = formattedDebit;
    }
    
    if (totalCreditElement) {
        const formattedCredit = totalCredit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        totalCreditElement.textContent = formattedCredit;
    }
}

// Make functions globally available
window.calculateAssetItemTotals = calculateAssetItemTotals;
window.calculateAssetAccountingTotals = calculateAssetAccountingTotals;
console.log('✅ Asset calculation functions defined in master-detail template');

} // End of execution guard
</script>

<!-- Include Message Modal Component -->
{% include 'core/components/message_modal.html' %}

{% endblock %}
