{% extends 'base.html' %}
{% load static %}
{% load humanize %}
<!-- FORCE NO CACHE - New File -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="cache-bust" content="v1.0-2025-01-31">
<!-- Y Balance Financial Statement Report -->

{% block title %}САНХҮҮГИЙН ТАЙЛАН - Silicon4 Accounting{% endblock %}

{% block content %}
<div>
    <!-- Header -->
    <div class="flex justify-between items-center px-3 py-2 lg:px-6 bg-white border-b border-gray-200">
        <div>
            <h1 class="text-base lg:text-lg xl:text-xl font-medium text-gray-900">САНХҮҮГИЙН ТАЙЛАН</h1>
            
        </div>
    </div>

    <!-- Date Filter Form -->
    <div class="bg-white shadow rounded-lg border border-gray-200 p-4 mb-4">
        <form method="get" id="report-form" class="flex flex-col lg:flex-row gap-4 items-end">
            <input type="hidden" id="active_tab" name="active_tab" value="{{ active_tab|default:'balance' }}">
            <div class="flex-1">
                <label for="begin_date" class="block text-sm font-medium text-gray-700 mb-1">Эхний огноо</label>
                <input type="date" 
                       id="begin_date" 
                       name="begin_date" 
                       value="{{ begin_date }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       required>
            </div>
            <div class="flex-1">
                <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">Эцсийн огноо</label>
                <input type="date" 
                       id="end_date" 
                       name="end_date" 
                       value="{{ end_date }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       required>
            </div>
            <div>
                <input type="hidden" name="calculate" value="true">
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    ТООЦООЛОХ
                </button>
            </div>
        </form>
    </div>

    <!-- Error Message -->
    {% if error_message %}
    <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Алдаа</h3>
                <div class="mt-2 text-sm text-red-700">
                    {{ error_message }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tab Navigation -->
    <div class="bg-white shadow rounded-lg mb-4">
        <div class="border-b-2 border-gray-300">
            <nav class="flex space-x-2 px-6 p-3">
                <button id="tab-balance" onclick="switchToBalanceView()" class="{% if active_tab == 'balance' %}border border-blue-500 text-blue-600 bg-blue-50{% else %}border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50{% endif %} whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    САНХҮҮГИЙН БАЙДЛЫН ТАЙЛАН
                </button>
                <button id="tab-income" onclick="switchToIncomeView()" class="{% if active_tab == 'income' %}border border-blue-500 text-blue-600 bg-blue-50{% else %}border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50{% endif %} whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ОРЛОГО,ҮР ДҮНГИЙН ТАЙЛАН
                </button>
                <button id="tab-cashflow" onclick="switchToCashFlowView()" class="{% if active_tab == 'cashflow' %}border border-blue-500 text-blue-600 bg-blue-50{% else %}border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50{% endif %} whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    МӨНГӨН ГҮЙЛГЭЭНИЙ ТАЙЛАН
                </button>
                <button id="tab-equity" onclick="switchToEquityView()" class="{% if active_tab == 'equity' %}border border-blue-500 text-blue-600 bg-blue-50{% else %}border border-gray-300 text-gray-500 hover:text-gray-700 hover:border-gray-400 hover:bg-gray-50{% endif %} whitespace-nowrap py-2 px-3 font-medium text-sm rounded-md">
                    ӨМЧИЙН ӨӨРЧЛӨЛТИЙН ТАЙЛАН
                </button>
            </nav>
        </div>
    </div>

    <!-- Balance Table View -->
    <div id="balance-view" class="bg-white shadow rounded-lg border border-gray-200 overflow-hidden" {% if active_tab != 'balance' %}style="display: none;"{% endif %}>
        {% if st_balance_data %}
        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
            <h3 class="text-sm font-medium text-gray-900">
                Баланс: {{ begin_date }} - {{ end_date }}
            </h3>
        </div>
        
        <div class="overflow-x-auto">
            <table id="y-balance-table" class="min-w-full border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-24">Код</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300">Нэр</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300">Эхний үлдэгдэл</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300">Эцсийн үлдэгдэл</th>
                    </tr>
                    <tr class="bg-gray-100">
                        <th class="px-2 py-1 border border-gray-300 w-24">
                            <input type="text" id="filter-code" placeholder="Код..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </th>
                        <th class="px-2 py-1 border border-gray-300">
                            <input type="text" id="filter-name" placeholder="Нэр..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </th>
                        <th class="px-2 py-1 border border-gray-300">
                            <input type="text" id="filter-begin-balance" placeholder="Эхний..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </th>
                        <th class="px-2 py-1 border border-gray-300">
                            <input type="text" id="filter-end-balance" placeholder="Эцсийн..." 
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    {% for row in st_balance_data %}
                    <tr class="hover:bg-gray-50 border-b border-gray-300 cursor-pointer" 
                        data-stbalance-id="{{ row.StbalanceId }}"
                        data-stbalance-code="{{ row.StbalanceCode }}"
                        data-stbalance-name="{{ row.StbalanceName }}"
                        data-begin-balance="{{ row.BeginBalance }}"
                        data-end-balance="{{ row.EndBalance }}">
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 border border-gray-300 w-24">
                            {{ row.StbalanceCode }}
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-900 border border-gray-300">
                            {{ row.StbalanceName }}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right border border-gray-300">
                            {% if row.BeginBalance != 0 %}
                                {% if row.BeginBalance < 0 %}
                                    <span class="text-red-600 font-medium">{{ row.BeginBalance|floatformat:2|intcomma }}</span>
                                {% else %}
                                    <span class="text-gray-900">{{ row.BeginBalance|floatformat:2|intcomma }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right border border-gray-300">
                            {% if row.EndBalance != 0 %}
                                {% if row.EndBalance < 0 %}
                                    <span class="text-red-600 font-medium">{{ row.EndBalance|floatformat:2|intcomma }}</span>
                                {% else %}
                                    <span class="text-gray-900">{{ row.EndBalance|floatformat:2|intcomma }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr class="border-t border-gray-300">
                        <td colspan="2" class="px-3 py-2 text-sm text-gray-900 font-medium border border-gray-300">НИЙТ:</td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-right border border-gray-300" id="total-begin-balance">
                            <span>0.00</span>
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-right border border-gray-300" id="total-end-balance">
                            <span>0.00</span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        <div class="px-4 py-3 bg-gray-50 border-t border-gray-200">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-sm text-gray-700">
                    <span id="pagination-info">Хуудас 1, нийт 1 хуудас</span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="prev-page" 
                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        Өмнөх
                    </button>
                    <div id="page-numbers" class="flex gap-1">
                        <!-- Page numbers will be generated here -->
                    </div>
                    <button id="next-page" 
                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        Дараах
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <label for="rows-per-page" class="text-sm text-gray-700">Хуудас бүрт:</label>
                    <select id="rows-per-page" 
                            class="px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <button id="print-balance" 
                            class="border border-gray-300 text-gray-600 hover:text-gray-800 hover:border-gray-400 hover:bg-gray-100 whitespace-nowrap py-2 px-3 text-sm rounded-md">
                        ХЭВЛЭХ
                    </button>
                </div>
            </div>
        </div>
        {% elif begin_date and end_date %}
        <div class="p-16 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-4 text-sm font-medium text-gray-900">Мэдээлэл олдсонгүй</h3>
            <p class="mt-2 text-sm text-gray-500">Сонгосон хугацаанд мэдээлэл олдсонгүй.</p>
        </div>
        {% endif %}
    </div>


    <!-- Income Statement View -->
    <div id="income-view" class="bg-white shadow rounded-lg border border-gray-200 overflow-hidden" {% if active_tab != 'income' %}style="display: none;"{% endif %}>
        {% if st_income_data %}
        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
            <h3 class="text-sm font-medium text-gray-900">
                Орлого, үр дүнгийн тайлан: {{ begin_date }} - {{ end_date }}
            </h3>
        </div>
        
        <div class="overflow-x-auto">
            <table id="income-table" class="min-w-full border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-24">Код</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300">ҮЗҮҮЛЭЛТ</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300">ДҮН</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    {% for row in st_income_data %}
                    <tr class="hover:bg-gray-50 border-b border-gray-300">
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 border border-gray-300 w-24">
                            {{ row.StIncome }}
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-900 border border-gray-300">
                            {{ row.StIncomeName }}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right border border-gray-300">
                            {% if row.EndBalance != 0 %}
                                {% if row.EndBalance < 0 %}
                                    <span class="text-red-600 font-medium">{{ row.EndBalance|floatformat:2|intcomma }}</span>
                                {% else %}
                                    <span class="text-gray-900">{{ row.EndBalance|floatformat:2|intcomma }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% elif begin_date and end_date and active_tab == 'income' %}
        <div class="p-16 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-4 text-sm font-medium text-gray-900">Мэдээлэл олдсонгүй</h3>
            <p class="mt-2 text-sm text-gray-500">Сонгосон хугацаанд мэдээлэл олдсонгүй.</p>
        </div>
        {% endif %}
    </div>

    <!-- Cash Flow Statement View -->
    <div id="cashflow-view" class="bg-white shadow rounded-lg border border-gray-200 overflow-hidden" {% if active_tab != 'cashflow' %}style="display: none;"{% endif %}>
        {% if st_cashflow_data %}
        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
            <h3 class="text-sm font-medium text-gray-900">
                Мөнгөн гүйлгээний тайлан: {{ begin_date }} - {{ end_date }}
            </h3>
        </div>
        
        <div class="overflow-x-auto">
            <table id="cashflow-table" class="min-w-full border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-24">Код</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300">Нэр</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300">Эцсийн үлдэгдэл</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    {% for row in st_cashflow_data %}
                    <tr class="hover:bg-gray-50 border-b border-gray-300">
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 border border-gray-300 w-24">
                            {{ row.StCashFlowCode }}
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-900 border border-gray-300">
                            {{ row.StCashFlowName }}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right border border-gray-300">
                            {% if row.EndBalance != 0 %}
                                {% if row.EndBalance < 0 %}
                                    <span class="text-red-600 font-medium">{{ row.EndBalance|floatformat:2|intcomma }}</span>
                                {% else %}
                                    <span class="text-gray-900">{{ row.EndBalance|floatformat:2|intcomma }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr class="border-t border-gray-300">
                        <td colspan="2" class="px-3 py-2 text-sm text-gray-900 font-medium border border-gray-300">НИЙТ:</td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-right border border-gray-300" id="total-cashflow-balance">
                            <span>0.00</span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Print Button for Cash Flow Statement -->
        <div class="px-4 py-3 bg-gray-50 border-t border-gray-200">
            <div class="flex justify-end">
                <button id="print-cashflow" 
                        class="border border-gray-300 text-gray-600 hover:text-gray-800 hover:border-gray-400 hover:bg-gray-100 whitespace-nowrap py-2 px-3 text-sm rounded-md">
                    ХЭВЛЭХ
                </button>
            </div>
        </div>
        {% elif begin_date and end_date and active_tab == 'cashflow' %}
        <div class="p-16 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-4 text-sm font-medium text-gray-900">Мэдээлэл олдсонгүй</h3>
            <p class="mt-2 text-sm text-gray-500">Сонгосон хугацаанд мэдээлэл олдсонгүй.</p>
        </div>
        {% endif %}
    </div>

    <!-- Equity Changes Statement View -->
    <div id="equity-view" class="bg-white shadow rounded-lg border border-gray-200 overflow-hidden" {% if active_tab != 'equity' %}style="display: none;"{% endif %}>
        {% if st_equity_data %}
        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
            <h3 class="text-sm font-medium text-gray-900">
                Өмчийн өөрчлөлтийн тайлан: {{ begin_date }} - {{ end_date }}
            </h3>
        </div>
        
        <div class="overflow-x-auto">
            <table id="equity-table" class="min-w-full border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300 w-24">Код</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300">Нэр</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300">Эхний үлдэгдэл</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border border-gray-300">Эцсийн үлдэгдэл</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    {% for row in st_equity_data %}
                    <tr class="hover:bg-gray-50 border-b border-gray-300">
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 border border-gray-300 w-24">
                            {{ row.StEquityCode }}
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-900 border border-gray-300">
                            {{ row.StEquityName }}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right border border-gray-300">
                            {% if row.BeginBalance != 0 %}
                                {% if row.BeginBalance < 0 %}
                                    <span class="text-red-600 font-medium">{{ row.BeginBalance|floatformat:2|intcomma }}</span>
                                {% else %}
                                    <span class="text-gray-900">{{ row.BeginBalance|floatformat:2|intcomma }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right border border-gray-300">
                            {% if row.EndBalance != 0 %}
                                {% if row.EndBalance < 0 %}
                                    <span class="text-red-600 font-medium">{{ row.EndBalance|floatformat:2|intcomma }}</span>
                                {% else %}
                                    <span class="text-gray-900">{{ row.EndBalance|floatformat:2|intcomma }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr class="border-t border-gray-300">
                        <td colspan="2" class="px-3 py-2 text-sm text-gray-900 font-medium border border-gray-300">НИЙТ:</td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-right border border-gray-300" id="total-equity-begin-balance">
                            <span>0.00</span>
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-right border border-gray-300" id="total-equity-end-balance">
                            <span>0.00</span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Print Button for Equity Statement -->
        <div class="px-4 py-3 bg-gray-50 border-t border-gray-200">
            <div class="flex justify-end">
                <button id="print-equity" 
                        class="border border-gray-300 text-gray-600 hover:text-gray-800 hover:border-gray-400 hover:bg-gray-100 whitespace-nowrap py-2 px-3 text-sm rounded-md">
                    ХЭВЛЭХ
                </button>
            </div>
        </div>
        {% elif begin_date and end_date and active_tab == 'equity' %}
        <div class="p-16 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-4 text-sm font-medium text-gray-900">Мэдээлэл олдсонгүй</h3>
            <p class="mt-2 text-sm text-gray-500">Сонгосон хугацаанд мэдээлэл олдсонгүй.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Trial Balance Modal -->
<div id="trial-balance-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-6 border w-11/12 max-w-7xl shadow-xl rounded-lg bg-white">
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
            <div>
                <h3 id="trial-balance-modal-title" class="text-xl font-semibold text-gray-900">Туршилтын үлдэгдэл</h3>
                <p class="text-sm text-gray-500 mt-1">Дансны дэлгэрэнгүй мэдээлэл</p>
            </div>
            <button onclick="closeTrialBalanceModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div id="trial-balance-modal-body" class="max-h-[70vh] overflow-y-auto">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<!-- Include Account Statement Modal (for future use) -->
{% include 'core/components/print_account_statement_modal.html' %}

<!-- Include Print Script -->
<script src="{% static 'js/print-fin-statement.js' %}"></script>

<style>
@media print {
    .no-print {
        display: none !important;
    }
    body {
        margin: 0;
        padding: 10mm;
    }
    .print-table {
        page-break-inside: avoid;
    }
}
</style>

<script>
(function() {
// Add timestamp to form submission to prevent browser caching
document.addEventListener('DOMContentLoaded', function() {
    const reportForm = document.getElementById('report-form');
    if (reportForm) {
        reportForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default submission
            
            // Get form data
            const formData = new FormData(this);
            
            // Add timestamp parameter to prevent browser caching
            const timestamp = new Date().getTime();
            formData.append('_t', timestamp);
            
            // Build URL with all parameters including timestamp
            const params = new URLSearchParams(formData);
            const url = window.location.pathname + '?' + params.toString();
            
            // Navigate to the URL with timestamp
            window.location.href = url;
        });
    }
});

// Set default dates if not provided
function setDefaultDateValues() {
    // Check URL parameters first
    const urlParams = new URLSearchParams(window.location.search);
    const beginDateParam = urlParams.get('begin_date');
    const endDateParam = urlParams.get('end_date');
    
    const formatDateForInput = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    const beginDateInput = document.getElementById('begin_date');
    const endDateInput = document.getElementById('end_date');
    
    // Use URL parameters if available, otherwise use current month dates
    if (beginDateParam && beginDateInput) {
        beginDateInput.value = beginDateParam;
    } else if (beginDateInput && !beginDateInput.value) {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        beginDateInput.value = formatDateForInput(firstDay);
    }
    
    if (endDateParam && endDateInput) {
        endDateInput.value = endDateParam;
    } else if (endDateInput && !endDateInput.value) {
        const today = new Date();
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        endDateInput.value = formatDateForInput(lastDay);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setDefaultDateValues();
    
    // Initialize tab view based on active_tab from server
    const activeTabInput = document.getElementById('active_tab');
    const activeTab = activeTabInput ? activeTabInput.value : 'balance';
    
    if (activeTab === 'income') {
        // Just show the view without submitting (data already loaded from server)
        document.getElementById('balance-view').style.display = 'none';
        document.getElementById('income-view').style.display = 'block';
        document.getElementById('cashflow-view').style.display = 'none';
        document.getElementById('equity-view').style.display = 'none';
        
        // Update tab styling
        const balanceTab = document.getElementById('tab-balance');
        const incomeTab = document.getElementById('tab-income');
        const cashflowTab = document.getElementById('tab-cashflow');
        const equityTab = document.getElementById('tab-equity');
        
        if (incomeTab) {
            incomeTab.classList.remove('border-gray-300', 'text-gray-500');
            incomeTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
        }
        if (balanceTab) {
            balanceTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
            balanceTab.classList.add('border-gray-300', 'text-gray-500');
        }
        if (cashflowTab) {
            cashflowTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
            cashflowTab.classList.add('border-gray-300', 'text-gray-500');
        }
        if (equityTab) {
            equityTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
            equityTab.classList.add('border-gray-300', 'text-gray-500');
        }
    } else if (activeTab === 'cashflow') {
        switchToCashFlowView();
    } else if (activeTab === 'equity') {
        switchToEquityView();
    } else {
        switchToBalanceView();
    }
    
    // Initialize table features
    setTimeout(initializeTableFeatures, 100);
});

// Tab switching functions - define them first, then expose to window
function switchToBalanceView() {
    document.getElementById('balance-view').style.display = 'block';
    document.getElementById('income-view').style.display = 'none';
    document.getElementById('cashflow-view').style.display = 'none';
    document.getElementById('equity-view').style.display = 'none';
    
    // Update tab styling
    const balanceTab = document.getElementById('tab-balance');
    const incomeTab = document.getElementById('tab-income');
    const cashflowTab = document.getElementById('tab-cashflow');
    const equityTab = document.getElementById('tab-equity');
    
    balanceTab.classList.remove('border-gray-300', 'text-gray-500');
    balanceTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
    
    incomeTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    incomeTab.classList.add('border-gray-300', 'text-gray-500');
    
    cashflowTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    cashflowTab.classList.add('border-gray-300', 'text-gray-500');
    
    equityTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    equityTab.classList.add('border-gray-300', 'text-gray-500');
    
    // Update active tab in form
    const activeTabInput = document.getElementById('active_tab');
    if (activeTabInput) activeTabInput.value = 'balance';
}

function switchToIncomeView() {
    // Just switch view, don't submit form (calculations already done)
    document.getElementById('balance-view').style.display = 'none';
    document.getElementById('income-view').style.display = 'block';
    document.getElementById('cashflow-view').style.display = 'none';
    document.getElementById('equity-view').style.display = 'none';
    
    // Update tab styling
    const balanceTab = document.getElementById('tab-balance');
    const incomeTab = document.getElementById('tab-income');
    const cashflowTab = document.getElementById('tab-cashflow');
    const equityTab = document.getElementById('tab-equity');
    
    incomeTab.classList.remove('border-gray-300', 'text-gray-500');
    incomeTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
    
    balanceTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    balanceTab.classList.add('border-gray-300', 'text-gray-500');
    
    cashflowTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    cashflowTab.classList.add('border-gray-300', 'text-gray-500');
    
    equityTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    equityTab.classList.add('border-gray-300', 'text-gray-500');
    
    // Update active tab in form (for preserving state)
    const activeTabInput = document.getElementById('active_tab');
    if (activeTabInput) activeTabInput.value = 'income';
}

function switchToCashFlowView() {
    // Just switch view, don't submit form (calculations already done)
    document.getElementById('balance-view').style.display = 'none';
    document.getElementById('income-view').style.display = 'none';
    document.getElementById('cashflow-view').style.display = 'block';
    document.getElementById('equity-view').style.display = 'none';
    
    // Update tab styling
    const balanceTab = document.getElementById('tab-balance');
    const incomeTab = document.getElementById('tab-income');
    const cashflowTab = document.getElementById('tab-cashflow');
    const equityTab = document.getElementById('tab-equity');
    
    cashflowTab.classList.remove('border-gray-300', 'text-gray-500');
    cashflowTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
    
    balanceTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    balanceTab.classList.add('border-gray-300', 'text-gray-500');
    
    incomeTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    incomeTab.classList.add('border-gray-300', 'text-gray-500');
    
    equityTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    equityTab.classList.add('border-gray-300', 'text-gray-500');
    
    // Update active tab in form (for preserving state)
    const activeTabInput = document.getElementById('active_tab');
    if (activeTabInput) activeTabInput.value = 'cashflow';
    
    // Calculate totals for cash flow view
    calculateCashFlowTotals();
}

function switchToEquityView() {
    // Just switch view, don't submit form (calculations already done)
    document.getElementById('balance-view').style.display = 'none';
    document.getElementById('income-view').style.display = 'none';
    document.getElementById('cashflow-view').style.display = 'none';
    document.getElementById('equity-view').style.display = 'block';
    
    // Update tab styling
    const balanceTab = document.getElementById('tab-balance');
    const incomeTab = document.getElementById('tab-income');
    const cashflowTab = document.getElementById('tab-cashflow');
    const equityTab = document.getElementById('tab-equity');
    
    equityTab.classList.remove('border-gray-300', 'text-gray-500');
    equityTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
    
    balanceTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    balanceTab.classList.add('border-gray-300', 'text-gray-500');
    
    incomeTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    incomeTab.classList.add('border-gray-300', 'text-gray-500');
    
    cashflowTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
    cashflowTab.classList.add('border-gray-300', 'text-gray-500');
    
    // Update active tab in form (for preserving state)
    const activeTabInput = document.getElementById('active_tab');
    if (activeTabInput) activeTabInput.value = 'equity';
}

// Calculate totals for cash flow view
function calculateCashFlowTotals() {
    let total = 0;
    const cashflowRows = document.querySelectorAll('#cashflow-table tbody tr');
    cashflowRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 3) {
            const balanceText = cells[2].textContent.trim();
            const balance = parseFloat(balanceText.replace(/,/g, '').replace(/-/g, '')) || 0;
            // Check if it's negative (red text)
            if (cells[2].querySelector('.text-red-600')) {
                total -= balance;
            } else {
                total += balance;
            }
        }
    });
    
    updateTotalDisplay('total-cashflow-balance', total);
}

// Make functions globally accessible for onclick handlers
window.switchToBalanceView = switchToBalanceView;
window.switchToIncomeView = switchToIncomeView;
window.switchToCashFlowView = switchToCashFlowView;
window.switchToEquityView = switchToEquityView;
window.closeTrialBalanceModal = closeTrialBalanceModal;

// Client-side filtering and pagination
let allRows = [];
let filteredRows = [];
let currentPage = 1;
let rowsPerPage = 25;

// Initialize filtering and pagination
function initializeTableFeatures() {
    const tbody = document.querySelector('#y-balance-table tbody');
    if (tbody) {
        allRows = Array.from(tbody.querySelectorAll('tr'));
        filteredRows = [...allRows];
        setupPagination();
        setupInlineFilters();
        calculateTotals();
        
        // Add click handlers for rows (for future modal functionality)
        addClickHandlersToRows();
    }
}

// Add click handlers to rows
function addClickHandlersToRows() {
    const rows = document.querySelectorAll('#y-balance-table tbody tr');
    rows.forEach(row => {
        if (!row.dataset.hasClickHandler) {
            row.dataset.hasClickHandler = 'true';
            row.addEventListener('click', function() {
                const stbalanceId = this.dataset.stbalanceId;
                const stbalanceCode = this.dataset.stbalanceCode;
                const stbalanceName = this.dataset.stbalanceName;
                
                // Get dates from form
                const beginDate = document.getElementById('begin_date').value;
                const endDate = document.getElementById('end_date').value;
                
                if (!beginDate || !endDate) {
                    alert('Эхлэх болон төгсгөлийн огноо сонгоно уу');
                    return;
                }
                
                // Show loading modal
                showTrialBalanceModal(stbalanceId, stbalanceCode, stbalanceName, beginDate, endDate);
            });
        }
    });
}

// Show trial balance modal with data
function showTrialBalanceModal(stbalanceId, stbalanceCode, stbalanceName, beginDate, endDate) {
    // Show modal
    const modal = document.getElementById('trial-balance-modal');
    const modalTitle = document.getElementById('trial-balance-modal-title');
    const modalBody = document.getElementById('trial-balance-modal-body');
    
    if (!modal || !modalTitle || !modalBody) {
        console.error('Modal elements not found');
        return;
    }
    
    modalTitle.textContent = `${stbalanceCode} - ${stbalanceName}`;
    modalBody.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div><p class="mt-2 text-sm text-gray-600">Уншиж байна...</p></div>';
    modal.classList.remove('hidden');
    
    // Fetch trial balance data
    const url = `/core/api/trial-balance-by-stbalance/?stbalance_id=${stbalanceId}&begin_date=${beginDate}&end_date=${endDate}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderTrialBalanceTable(data.data, beginDate, endDate);
            } else {
                modalBody.innerHTML = `<div class="text-center py-8 text-red-600">Алдаа: ${data.error || 'Мэдээлэл авахад алдаа гарлаа'}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            modalBody.innerHTML = `<div class="text-center py-8 text-red-600">Алдаа: ${error.message}</div>`;
        });
}

// Render trial balance table
function renderTrialBalanceTable(data, beginDate, endDate) {
    const modalBody = document.getElementById('trial-balance-modal-body');
    
    if (!data || data.length === 0) {
        modalBody.innerHTML = '<div class="text-center py-8 text-gray-500">Мэдээлэл олдсонгүй</div>';
        return;
    }
    
    // Format number with thousand separators
    const formatNumber = (num) => {
        if (num === null || num === undefined) return '0.00';
        const n = parseFloat(num);
        if (isNaN(n)) return '0.00';
        return n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    };
    
    let html = `
        <div class="mb-4 text-sm text-gray-600">
            <p><strong>Хугацаа:</strong> ${beginDate} - ${endDate}</p>
            <p><strong>Нийт данс:</strong> ${data.length}</p>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border border-gray-300">Код</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border border-gray-300">Нэр</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase border border-gray-300">Төрөл</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase border border-gray-300">Эхний дебит</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase border border-gray-300">Эхний кредит</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase border border-gray-300">Дебит</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase border border-gray-300">Кредит</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase border border-gray-300">Эцсийн дебит</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase border border-gray-300">Эцсийн кредит</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
    `;
    
    let totalBeginDebit = 0, totalBeginCredit = 0;
    let totalDebit = 0, totalCredit = 0;
    let totalEndDebit = 0, totalEndCredit = 0;
    
    data.forEach(row => {
        const beginDebit = parseFloat(row.beginningbalancedebit || 0);
        const beginCredit = parseFloat(row.beginningbalancecredit || 0);
        const debit = parseFloat(row.debitamount || 0);
        const credit = parseFloat(row.creditamount || 0);
        const endDebit = parseFloat(row.endingbalancedebit || 0);
        const endCredit = parseFloat(row.endingbalancecredit || 0);
        
        totalBeginDebit += beginDebit;
        totalBeginCredit += beginCredit;
        totalDebit += debit;
        totalCredit += credit;
        totalEndDebit += endDebit;
        totalEndCredit += endCredit;
        
        html += `
            <tr class="hover:bg-gray-50 border-b border-gray-300">
                <td class="px-3 py-2 text-sm text-gray-900 border border-gray-300">${row.accountcode || ''}</td>
                <td class="px-3 py-2 text-sm text-gray-900 border border-gray-300">${row.accountname || ''}</td>
                <td class="px-3 py-2 text-sm text-gray-900 border border-gray-300">${row.accounttype || ''}</td>
                <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(beginDebit)}</td>
                <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(beginCredit)}</td>
                <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(debit)}</td>
                <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(credit)}</td>
                <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(endDebit)}</td>
                <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(endCredit)}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr class="font-medium">
                        <td colspan="3" class="px-3 py-2 text-sm text-gray-900 border border-gray-300">НИЙТ:</td>
                        <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(totalBeginDebit)}</td>
                        <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(totalBeginCredit)}</td>
                        <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(totalDebit)}</td>
                        <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(totalCredit)}</td>
                        <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(totalEndDebit)}</td>
                        <td class="px-3 py-2 text-sm text-right border border-gray-300">${formatNumber(totalEndCredit)}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
    
    modalBody.innerHTML = html;
}

// Close modal function
function closeTrialBalanceModal() {
    const modal = document.getElementById('trial-balance-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Calculate totals for all numeric columns
function calculateTotals() {
    let totals = {
        beginBalance: 0,
        endBalance: 0
    };
    
    allRows.forEach(row => {
        const beginBalance = parseFloat(row.dataset.beginBalance) || 0;
        const endBalance = parseFloat(row.dataset.endBalance) || 0;
        
        totals.beginBalance += beginBalance;
        totals.endBalance += endBalance;
    });
    
    updateTotalDisplay('total-begin-balance', totals.beginBalance);
    updateTotalDisplay('total-end-balance', totals.endBalance);
}


// Update individual total display
function updateTotalDisplay(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        const span = element.querySelector('span');
        if (span) {
            const formatted = value.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            if (value < 0) {
                span.className = 'text-red-600';
            } else if (value > 0) {
                span.className = 'text-gray-900';
            } else {
                span.className = 'text-gray-500';
            }
            
            span.textContent = formatted;
        }
    }
}

// Setup inline column filters
function setupInlineFilters() {
    const filterInputs = [
        'filter-code',
        'filter-name',
        'filter-begin-balance',
        'filter-end-balance'
    ];
    
    filterInputs.forEach(filterId => {
        const input = document.getElementById(filterId);
        if (input) {
            input.addEventListener('input', function() {
                applyAllFilters();
            });
        }
    });
}

// Apply all filters
function applyAllFilters() {
    filteredRows = allRows.filter(row => {
        const filters = {
            'filter-code': row.dataset.stbalanceCode?.toLowerCase() || '',
            'filter-name': row.dataset.stbalanceName?.toLowerCase() || '',
            'filter-begin-balance': parseFloat(row.dataset.beginBalance) || 0,
            'filter-end-balance': parseFloat(row.dataset.endBalance) || 0
        };
        
        for (const [filterId, value] of Object.entries(filters)) {
            const filterInput = document.getElementById(filterId);
            if (filterInput && filterInput.value.trim()) {
                const filterValue = filterInput.value.toLowerCase().trim();
                
                if (filterId.includes('code') || filterId.includes('name')) {
                    // Text filters
                    if (!value.includes(filterValue)) {
                        return false;
                    }
                } else {
                    // Numeric filters
                    if (filterValue.startsWith('>=')) {
                        const num = parseFloat(filterValue.substring(2));
                        if (isNaN(num) || value < num) return false;
                    } else if (filterValue.startsWith('<=')) {
                        const num = parseFloat(filterValue.substring(2));
                        if (isNaN(num) || value > num) return false;
                    } else if (filterValue.startsWith('>')) {
                        const num = parseFloat(filterValue.substring(1));
                        if (isNaN(num) || value <= num) return false;
                    } else if (filterValue.startsWith('<')) {
                        const num = parseFloat(filterValue.substring(1));
                        if (isNaN(num) || value >= num) return false;
                    } else if (filterValue.startsWith('=')) {
                        const num = parseFloat(filterValue.substring(1));
                        if (isNaN(num) || value !== num) return false;
                    } else {
                        const num = parseFloat(filterValue);
                        if (!isNaN(num)) {
                            if (value !== num) return false;
                        } else {
                            if (!value.toString().includes(filterValue)) return false;
                        }
                    }
                }
            }
        }
        
        return true;
    });
    
    currentPage = 1;
    displayRows();
    setupPagination();
}

// Display rows for current page
function displayRows() {
    const tbody = document.querySelector('#y-balance-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    const pageRows = filteredRows.slice(startIndex, endIndex);
    
    pageRows.forEach(row => {
        tbody.appendChild(row);
    });
    
    // Re-add click handlers
    addClickHandlersToRows();
}

// Setup pagination
function setupPagination() {
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    const paginationInfo = document.getElementById('pagination-info');
    const prevButton = document.getElementById('prev-page');
    const nextButton = document.getElementById('next-page');
    const pageNumbers = document.getElementById('page-numbers');
    
    if (paginationInfo) {
        paginationInfo.textContent = `Хуудас ${currentPage}, нийт ${totalPages} хуудас (${filteredRows.length} мөр)`;
    }
    
    if (prevButton) {
        prevButton.disabled = currentPage <= 1;
    }
    if (nextButton) {
        nextButton.disabled = currentPage >= totalPages;
    }
    
    if (pageNumbers) {
        pageNumbers.innerHTML = '';
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.className = `px-3 py-1 text-sm rounded ${
                i === currentPage 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            }`;
            pageButton.addEventListener('click', () => goToPage(i));
            pageNumbers.appendChild(pageButton);
        }
    }
}

// Go to specific page
function goToPage(page) {
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayRows();
        setupPagination();
    }
}

// Print handler functions
function handlePrintBalance() {
    const table = document.getElementById('y-balance-table');
    if (!table) {
        alert('Хэвлэх мэдээлэл алга байна.');
        return;
    }
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const headers = Array.from(table.querySelectorAll('thead tr:first-child th'))
        .map(th => th.textContent.trim());
    
    const data = rows.map(row => ({
        Code: row.dataset.stbalanceCode || '',
        Name: row.dataset.stbalanceName || '',
        BeginBalance: parseFloat(row.dataset.beginBalance) || 0,
        EndBalance: parseFloat(row.dataset.endBalance) || 0
    }));
    
    const beginDate = document.getElementById('begin_date').value;
    const endDate = document.getElementById('end_date').value;
    
    let totalBeginBalance = 0;
    let totalEndBalance = 0;
    data.forEach(row => {
        totalBeginBalance += row.BeginBalance;
        totalEndBalance += row.EndBalance;
    });
    
    if (typeof window.printFinancialStatement === 'function') {
        window.printFinancialStatement({
            title: 'САНХҮҮГИЙН БАЙДЛЫН ТАЙЛАН',
            startDate: beginDate,
            endDate: endDate,
            allData: data,
            columnHeaders: headers,
            totals: {
                beginBalance: totalBeginBalance,
                endBalance: totalEndBalance
            }
        });
    } else {
        alert('Хэвлэх систем ачаалагдаагүй байна. Хуудсыг дахин ачаална уу.');
    }
}

function handlePrintIncome() {
    const table = document.getElementById('income-table');
    if (!table) {
        alert('Хэвлэх мэдээлэл алга байна.');
        return;
    }
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const headers = Array.from(table.querySelectorAll('thead tr:first-child th'))
        .map(th => th.textContent.trim());
    
    const data = rows.map(row => {
        const cells = row.querySelectorAll('td');
        return {
            Code: cells[0]?.textContent.trim() || '',
            Name: cells[1]?.textContent.trim() || '',
            EndBalance: parseFloat(cells[2]?.textContent.replace(/,/g, '').replace(/-/g, '') || '0') || 0
        };
    });
    
    const beginDate = document.getElementById('begin_date').value;
    const endDate = document.getElementById('end_date').value;
    
    let totalEndBalance = 0;
    data.forEach(row => {
        totalEndBalance += row.EndBalance;
    });
    
    if (typeof window.printFinancialStatement === 'function') {
        window.printFinancialStatement({
            title: 'ОРЛОГО, ҮР ДҮНГИЙН ТАЙЛАН',
            startDate: beginDate,
            endDate: endDate,
            allData: data,
            columnHeaders: headers,
            totals: {
                endBalance: totalEndBalance
            }
        });
    } else {
        alert('Хэвлэх систем ачаалагдаагүй байна. Хуудсыг дахин ачаална уу.');
    }
}

function handlePrintCashFlow() {
    const table = document.getElementById('cashflow-table');
    if (!table) {
        alert('Хэвлэх мэдээлэл алга байна.');
        return;
    }
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const headers = Array.from(table.querySelectorAll('thead tr:first-child th'))
        .map(th => th.textContent.trim());
    
    const data = rows.map(row => {
        const cells = row.querySelectorAll('td');
        return {
            Code: cells[0]?.textContent.trim() || '',
            Name: cells[1]?.textContent.trim() || '',
            EndBalance: parseFloat(cells[2]?.textContent.replace(/,/g, '').replace(/-/g, '') || '0') || 0
        };
    });
    
    const beginDate = document.getElementById('begin_date').value;
    const endDate = document.getElementById('end_date').value;
    
    let totalEndBalance = 0;
    data.forEach(row => {
        totalEndBalance += row.EndBalance;
    });
    
    if (typeof window.printFinancialStatement === 'function') {
        window.printFinancialStatement({
            title: 'МӨНГӨН ГҮЙЛГЭЭНИЙ ТАЙЛАН',
            startDate: beginDate,
            endDate: endDate,
            allData: data,
            columnHeaders: headers,
            totals: {
                endBalance: totalEndBalance
            }
        });
    } else {
        alert('Хэвлэх систем ачаалагдаагүй байна. Хуудсыг дахин ачаална уу.');
    }
}

function handlePrintEquity() {
    const table = document.getElementById('equity-table');
    if (!table) {
        alert('Хэвлэх мэдээлэл алга байна.');
        return;
    }
    
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const headers = Array.from(table.querySelectorAll('thead tr:first-child th'))
        .map(th => th.textContent.trim());
    
    const data = rows.map(row => {
        const cells = row.querySelectorAll('td');
        return {
            Code: cells[0]?.textContent.trim() || '',
            Name: cells[1]?.textContent.trim() || '',
            BeginBalance: parseFloat(cells[2]?.textContent.replace(/,/g, '').replace(/-/g, '') || '0') || 0,
            EndBalance: parseFloat(cells[3]?.textContent.replace(/,/g, '').replace(/-/g, '') || '0') || 0
        };
    });
    
    const beginDate = document.getElementById('begin_date').value;
    const endDate = document.getElementById('end_date').value;
    
    let totalBeginBalance = 0;
    let totalEndBalance = 0;
    data.forEach(row => {
        totalBeginBalance += row.BeginBalance;
        totalEndBalance += row.EndBalance;
    });
    
    if (typeof window.printFinancialStatement === 'function') {
        window.printFinancialStatement({
            title: 'ӨМЧИЙН ӨӨРЧЛӨЛТИЙН ТАЙЛАН',
            startDate: beginDate,
            endDate: endDate,
            allData: data,
            columnHeaders: headers,
            totals: {
                beginBalance: totalBeginBalance,
                endBalance: totalEndBalance
            }
        });
    } else {
        alert('Хэвлэх систем ачаалагдаагүй байна. Хуудсыг дахин ачаална уу.');
    }
}

// Event listeners for pagination
document.addEventListener('DOMContentLoaded', function() {
    const prevButton = document.getElementById('prev-page');
    if (prevButton) {
        prevButton.addEventListener('click', () => goToPage(currentPage - 1));
    }
    
    const nextButton = document.getElementById('next-page');
    if (nextButton) {
        nextButton.addEventListener('click', () => goToPage(currentPage + 1));
    }
    
    const rowsPerPageSelect = document.getElementById('rows-per-page');
    if (rowsPerPageSelect) {
        rowsPerPageSelect.addEventListener('change', function() {
            rowsPerPage = parseInt(this.value);
            currentPage = 1;
            displayRows();
            setupPagination();
        });
    }
    
    // Print button event listeners
    const printBalanceBtn = document.getElementById('print-balance');
    if (printBalanceBtn) {
        printBalanceBtn.addEventListener('click', handlePrintBalance);
    }
    
    const printIncomeBtn = document.getElementById('print-income');
    if (printIncomeBtn) {
        printIncomeBtn.addEventListener('click', handlePrintIncome);
    }
    
    const printCashFlowBtn = document.getElementById('print-cashflow');
    if (printCashFlowBtn) {
        printCashFlowBtn.addEventListener('click', handlePrintCashFlow);
    }
    
    const printEquityBtn = document.getElementById('print-equity');
    if (printEquityBtn) {
        printEquityBtn.addEventListener('click', handlePrintEquity);
    }
});
})();
</script>
{% endblock %}

