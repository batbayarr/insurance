<!-- Account Statement Modal -->
<div id="print-account-statement-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-4 border-b border-gray-200">
            <div>
                <h3 class="text-lg font-medium text-gray-900" id="modal-account-title">ДАНСНЫ ТАЙЛАН</h3>
                <p class="text-sm text-gray-600" id="modal-date-range"></p>
            </div>
            <button onclick="closePrintAccountStatementModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="py-4">
            <!-- Account Info -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Код</label>
                        <p class="text-sm text-gray-900" id="modal-account-code"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Дансны Нэр</label>
                        <p class="text-sm text-gray-900" id="modal-account-name"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Төрөл</label>
                        <p class="text-sm text-gray-900" id="modal-account-type"></p>
                    </div>
                </div>
            </div>

            <!-- Balance Summary -->
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Эхний үлдэгдэл</label>
                        <p class="text-sm font-semibold text-gray-900" id="modal-beginning-balance"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Дебит гүйлгээ</label>
                        <p class="text-sm font-semibold text-gray-900" id="modal-total-debit"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Кредит гүйлгээ</label>
                        <p class="text-sm font-semibold text-gray-900" id="modal-total-credit"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Эцсийн үлдэгдэл</label>
                        <p class="text-sm font-semibold text-gray-900" id="modal-ending-balance"></p>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="modal-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-sm text-gray-600">уншиж байна...</p>
            </div>

            <!-- Error State -->
            <div id="modal-error" class="text-center py-8 hidden">
                <div class="text-red-600">
                    <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">сүлжээний алдаа гарлаа</h3>
                    <p class="mt-1 text-sm text-gray-500" id="modal-error-message"></p>
                </div>
            </div>

            <!-- Empty State -->
            <div id="modal-empty" class="text-center py-8 hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Гүйлгээ оруулаагүй байна.</h3>
                <p class="mt-1 text-sm text-gray-500">Гүйлгээ оруулаагүй байна.</p>
            </div>

            <!-- Documents Table -->
            <div id="modal-documents" class="hidden">
                <div class="space-y-2">
                    <div id="modal-documents-list">
                        <!-- Document groups will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex justify-end space-x-2 pt-4 border-t border-gray-200">
            <button onclick="closePrintAccountStatementModal()" 
                    class="px-4 py-2 bg-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                Close
            </button>
        </div>
    </div>
</div>

<script>
// Cache bust: Updated 2025-01-31 - Removed print functionality
function showPrintAccountStatementModal() {
    document.getElementById('print-account-statement-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closePrintAccountStatementModal() {
    document.getElementById('print-account-statement-modal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function formatNumber(num) {
    if (num === null || num === undefined || num === 0) return '-';
    return parseFloat(num).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function formatCurrency(num) {
    if (num === null || num === undefined || isNaN(num)) return '-';
    const formatted = parseFloat(num).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    return formatted === '0.00' ? '-' : formatted;
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US');
}

// Documents array
let allDocuments = [];

function populateAccountStatementModal(data, balanceData) {
    try {
        console.log('populateAccountStatementModal called with data:', data);
        console.log('Documents array:', data.documents);
        
        // Populate account info
        document.getElementById('modal-account-title').textContent = `${data.account.AccountCode} - ${data.account.AccountName}`;
        document.getElementById('modal-date-range').textContent = `${data.date_range.begin_date} to ${data.date_range.end_date}`;
        document.getElementById('modal-account-code').textContent = data.account.AccountCode;
        document.getElementById('modal-account-name').textContent = data.account.AccountName;
        document.getElementById('modal-account-type').textContent = data.account.AccountType;

    // Populate balance summary from trial balance data
    const beginningBalance = (balanceData.beginningBalanceDebit || 0) + (balanceData.beginningBalanceCredit || 0);
    const endingBalance = (balanceData.endingBalanceDebit || 0) + (balanceData.endingBalanceCredit || 0);
    
    document.getElementById('modal-beginning-balance').textContent = formatCurrency(beginningBalance);
    document.getElementById('modal-total-debit').textContent = formatCurrency(data.total_debit);
    document.getElementById('modal-total-credit').textContent = formatCurrency(data.total_credit);
    document.getElementById('modal-ending-balance').textContent = formatCurrency(endingBalance);

    // Store all documents
    allDocuments = data.documents || [];

        if (allDocuments.length > 0) {
            displayDocuments();
            document.getElementById('modal-documents').classList.remove('hidden');
            document.getElementById('modal-empty').classList.add('hidden');
        } else {
        document.getElementById('modal-documents').classList.add('hidden');
        document.getElementById('modal-empty').classList.remove('hidden');
    }

        // Hide loading and error states
        document.getElementById('modal-loading').classList.add('hidden');
        document.getElementById('modal-error').classList.add('hidden');
    } catch (error) {
        console.error('Error in populateAccountStatementModal:', error);
        showModalError('Error loading account statement: ' + error.message);
    }
}

function displayDocuments() {
    try {
        console.log('displayDocuments called with', allDocuments.length, 'documents');
        const container = document.getElementById('modal-documents-list');
        container.innerHTML = '';

        // Display all documents (no pagination)
        console.log('Processing', allDocuments.length, 'documents');
        allDocuments.forEach((doc, index) => {
            console.log('Processing document', index, ':', doc.DocumentId);
            const documentGroup = createDocumentGroup(doc);
            container.appendChild(documentGroup);
        });

        // All details are already collapsed from creation
    } catch (error) {
        console.error('Error in displayDocuments:', error);
        throw error;
    }
}

function createDocumentGroup(doc) {
    try {
        console.log('Creating document group for:', doc.DocumentId);
        const group = document.createElement('div');
        group.className = 'border border-gray-200 rounded-lg overflow-hidden';
    
    // Document header
    const header = document.createElement('div');
    header.className = 'bg-gray-50 px-4 py-3 cursor-pointer hover:bg-gray-100 transition-colors';
    header.onclick = () => toggleDetails(doc.DocumentId);
    
    header.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-4">
                    <span class="text-gray-900">Баримт:${doc.DocumentNo}</span>
                    <span class="text-sm text-gray-600">Огноо:${formatDate(doc.DocumentDate)}</span>
                    <span class="text-sm text-gray-600">Загвар:${doc.DocumentType}</span>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${doc.DocumentCategory}</span>
                </div>
                <div class="text-sm text-gray-600 mt-1">Гүйлгээний утга:${doc.DocumentDescription || 'No description'}</div>
            </div>
        </div>
    `;
    
    // Document details (expanded by default)
    const details = document.createElement('div');
    details.className = 'border-t border-gray-200 border-l-2 border-r-2 border-b-2 border-blue-200 bg-blue-50';
    details.id = `details-${doc.DocumentId}`;
    
    // Calculate totals for this document
    const docTotalDebit = doc.details.reduce((sum, detail) => sum + (detail.DebitAmount || 0), 0);
    const docTotalCredit = doc.details.reduce((sum, detail) => sum + (detail.CreditAmount || 0), 0);
    
    const table = document.createElement('div');
    table.className = 'overflow-x-auto';
    table.innerHTML = `
        <table class="min-w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дансны Код</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Харилцагч</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Валют нэр</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ханш</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Валют дүн</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Дебит</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Кредит</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                ${doc.details.map(detail => `
                    <tr class="${detail.IsMatchingAccount ? 'bg-yellow-50' : 'hover:bg-gray-50'}">
                        <td class="px-4 py-2 text-sm text-gray-900">
                            <span class="text-gray-900">${detail.AccountCode}</span>
                            <span class="text-gray-600">- ${detail.AccountName}</span>
                            ${detail.IsMatchingAccount ? '<span class="ml-2 text-xs bg-yellow-200 text-yellow-800 px-1 py-0.5 rounded">Target</span>' : ''}
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            ${detail.ClientCode ? `${detail.ClientCode} - ${detail.ClientName}` : '-'}
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-900">${detail.CurrencyName || '-'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 text-right">${detail.CurrencyExchange ? Number(detail.CurrencyExchange).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 6 }) : '-'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(detail.CurrencyAmount)}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(detail.DebitAmount)}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(detail.CreditAmount)}</td>
                    </tr>
                `).join('')}
            </tbody>
            <tfoot class="bg-gray-100 border-t-2 border-gray-300">
                <tr class="font-medium">
                    <td colspan="5" class="px-4 py-2 text-sm text-gray-900">НИЙТ:</td>
                    <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(docTotalDebit)}</td>
                    <td class="px-4 py-2 text-sm text-gray-900 text-right">${formatCurrency(docTotalCredit)}</td>
                </tr>
            </tfoot>
        </table>
    `;
    
    details.appendChild(table);
    
        group.appendChild(header);
        group.appendChild(details);
        
        return group;
    } catch (error) {
        console.error('Error in createDocumentGroup:', error);
        console.error('Document object:', doc);
        throw error;
    }
}

function toggleDetails(documentId) {
    const details = document.getElementById(`details-${documentId}`);
    const icon = document.getElementById(`icon-${documentId}`);
    
    if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
    } else {
        details.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
    }
}

function showModalLoading() {
    document.getElementById('modal-loading').classList.remove('hidden');
    document.getElementById('modal-documents').classList.add('hidden');
    document.getElementById('modal-empty').classList.add('hidden');
    document.getElementById('modal-error').classList.add('hidden');
}

function showModalError(message) {
    document.getElementById('modal-error-message').textContent = message;
    document.getElementById('modal-error').classList.remove('hidden');
    document.getElementById('modal-loading').classList.add('hidden');
    document.getElementById('modal-documents').classList.add('hidden');
    document.getElementById('modal-empty').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('print-account-statement-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePrintAccountStatementModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePrintAccountStatementModal();
    }
});

</script>
