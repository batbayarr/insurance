{% extends 'base.html' %}
{% load humanize %}
<!-- Receivable/Payable Balance Report -->

{% block title %}АВЛАГА, ӨГЛӨГ БАЛАНС - Silicon4 Accounting{% endblock %}

{% block content %}
<div>
    <!-- Header -->
    <div class="flex justify-between items-center px-3 py-2 lg:px-6 bg-white border-b border-gray-200">
        <div>
            <h1 class="text-base lg:text-lg xl:text-xl font-medium text-gray-900">АВЛАГА, ӨГЛӨГ БАЛАНС</h1>
            <p class="text-xs text-gray-600">Авлага болон өглөгийн нэгтгэл тайлан</p>
        </div>
    </div>

    <!-- Date Filter Form -->
    <div class="bg-white border-b border-gray-200 px-3 py-2 lg:px-6">
        <form method="get" class="flex flex-wrap items-center gap-3">
            <div class="flex items-center space-x-2">
                <label for="begin_date" class="text-sm font-medium text-gray-700">Эхлэх огноо:</label>
                <input type="date" 
                       id="begin_date" 
                       name="begin_date" 
                       value="{{ begin_date }}"
                       class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                       required>
            </div>
            <div class="flex items-center space-x-2">
                <label for="end_date" class="text-sm font-medium text-gray-700">Дуусах огноо:</label>
                <input type="date" 
                       id="end_date" 
                       name="end_date" 
                       value="{{ end_date }}"
                       class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                       required>
            </div>
            <button type="submit" 
                    class="border border-gray-300 text-gray-700 hover:bg-gray-50 whitespace-nowrap py-1 px-3 font-medium text-sm rounded-md">
                Тайлан үүсгэх
            </button>
        </form>
    </div>

    <!-- Error Message -->
    {% if error_message %}
    <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Алдаа</h3>
                <div class="mt-2 text-sm text-red-700">
                    {{ error_message }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Receivable/Payable Balance Table -->
    {% if recpay_balance_data %}
    <div class="bg-white shadow rounded-lg border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
            <h3 class="text-sm font-medium text-gray-900">
                Авлага, Өглөгийн баланс: {{ begin_date }} - {{ end_date }}
            </h3>
        </div>
        
        <div class="overflow-x-auto">
            <table id="recpay-balance-table" class="min-w-full border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дансны код</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дансны нэр</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагчийн код</th>
                        <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Харилцагчийн нэр</th>
                        <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Эхний үлдэгдэл (Дт)</th>
                        <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Эхний үлдэгдэл (Кт)</th>
                        <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Дт гүйлгээ</th>
                        <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Кт гүйлгээ</th>
                        <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Эцсийн үлдэгдэл (Дт)</th>
                        <th class="px-1 py-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">Эцсийн үлдэгдэл (Кт)</th>
                    </tr>
                    <tr class="bg-gray-100">
                        <th class="px-2 py-1 border-r border-gray-200">
                            <input type="text" id="filter-account-code" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-account-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-client-code" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-client-name" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-begin-debit" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-begin-credit" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-debit-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-credit-amount" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-end-debit" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="px-1 py-1 border-r border-gray-200">
                            <input type="text" id="filter-end-credit" placeholder="Filter..." 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for row in recpay_balance_data %}
                    <tr class="hover:bg-gray-50" 
                        data-account-id="{{ row.accountid }}"
                        data-account-code="{{ row.accountcode }}"
                        data-account-name="{{ row.accountname }}"
                        data-account-type="{{ row.accounttype }}"
                        data-client-id="{{ row.clientid }}"
                        data-client-code="{{ row.clientcode|default:'' }}"
                        data-client-name="{{ row.clientname|default:'' }}"
                        data-beginning-balance-debit="{{ row.beginningbalancedebit }}"
                        data-beginning-balance-credit="{{ row.beginningbalancecredit }}"
                        data-debit-amount="{{ row.debitamount }}"
                        data-credit-amount="{{ row.creditamount }}"
                        data-ending-balance-debit="{{ row.endingbalancedebit }}"
                        data-ending-balance-credit="{{ row.endingbalancecredit }}">
                        <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
                            {{ row.accountcode }}
                        </td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">
                            {{ row.accountname }}
                        </td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 border-r border-gray-200">
                            {{ row.clientcode|default:"-" }}
                        </td>
                        <td class="px-1 py-1 text-xs text-gray-900 border-r border-gray-200">
                            {{ row.clientname|default:"-" }}
                        </td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-right border-r border-gray-200">
                            {% if row.beginningbalancedebit != 0 %}
                                {% if row.beginningbalancedebit < 0 %}
                                    <span class="text-red-600 font-medium">{{ row.beginningbalancedebit|floatformat:2|intcomma }}</span>
                                {% else %}
                                    <span class="text-gray-900">{{ row.beginningbalancedebit|floatformat:2|intcomma }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-right border-r border-gray-200">
                            {% if row.beginningbalancecredit != 0 %}
                                {% if row.beginningbalancecredit < 0 %}
                                    <span class="text-red-600 font-medium">{{ row.beginningbalancecredit|floatformat:2|intcomma }}</span>
                                {% else %}
                                    <span class="text-gray-900">{{ row.beginningbalancecredit|floatformat:2|intcomma }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 text-right border-r border-gray-200">
                            {% if row.debitamount != 0 %}
                                {{ row.debitamount|floatformat:2|intcomma }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-gray-900 text-right border-r border-gray-200">
                            {% if row.creditamount != 0 %}
                                {{ row.creditamount|floatformat:2|intcomma }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-right border-r border-gray-200">
                            {% if row.endingbalancedebit != 0 %}
                                {% if row.endingbalancedebit < 0 %}
                                    <span class="text-red-600 font-medium">{{ row.endingbalancedebit|floatformat:2|intcomma }}</span>
                                {% else %}
                                    <span class="text-gray-900">{{ row.endingbalancedebit|floatformat:2|intcomma }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs text-right border-r border-gray-200">
                            {% if row.endingbalancecredit != 0 %}
                                {% if row.endingbalancecredit < 0 %}
                                    <span class="text-red-600 font-medium">{{ row.endingbalancecredit|floatformat:2|intcomma }}</span>
                                {% else %}
                                    <span class="text-gray-900">{{ row.endingbalancecredit|floatformat:2|intcomma }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr class="border-t border-gray-300">
                        <td colspan="4" class="px-2 py-1 text-xs text-gray-900 border-r border-gray-200">НИЙТ:</td>
                        <td class="px-1 py-1 text-xs text-gray-900 text-right border-r border-gray-200" id="total-begin-debit">
                            <span>0.00</span>
                        </td>
                        <td class="px-1 py-1 text-xs text-gray-900 text-right border-r border-gray-200" id="total-begin-credit">
                            <span>0.00</span>
                        </td>
                        <td class="px-1 py-1 text-xs text-gray-900 text-right border-r border-gray-200" id="total-debit-amount">
                            <span>0.00</span>
                        </td>
                        <td class="px-1 py-1 text-xs text-gray-900 text-right border-r border-gray-200" id="total-credit-amount">
                            <span>0.00</span>
                        </td>
                        <td class="px-1 py-1 text-xs text-gray-900 text-right border-r border-gray-200" id="total-end-debit">
                            <span>0.00</span>
                        </td>
                        <td class="px-1 py-1 text-xs text-gray-900 text-right border-r border-gray-200" id="total-end-credit">
                            <span>0.00</span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        <div class="px-4 py-3 bg-gray-50 border-t border-gray-200">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-sm text-gray-700">
                    <span id="pagination-info">Хуудас 1, нийт 1 хуудас</span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="prev-page" 
                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        Өмнөх
                    </button>
                    <div id="page-numbers" class="flex gap-1">
                        <!-- Page numbers will be generated here -->
                    </div>
                    <button id="next-page" 
                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        Дараах
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <label for="rows-per-page" class="text-sm text-gray-700">Хуудас бүрт:</label>
                    <select id="rows-per-page" 
                            class="px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    {% elif begin_date and end_date %}
    <div class="bg-white shadow rounded-lg border border-gray-200 p-16 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="mt-4 text-sm font-medium text-gray-900">Мэдээлэл олдсонгүй</h3>
        <p class="mt-2 text-sm text-gray-500">Сонгосон хугацаанд авлага, өглөгийн мэдээлэл олдсонгүй.</p>
    </div>
    {% endif %}
</div>

<!-- Include Subsidiary Ledger Modal -->
{% include 'core/components/print_subsidiary_ledger_modal.html' %}

<!-- Context Menu -->
<div id="context-menu" class="hidden fixed bg-white border border-gray-300 rounded-md shadow-lg z-50 py-1 min-w-[200px]">
    <button id="menu-subsidiary-ledger" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
        ТАЙЛАН ХЭВЛЭХ
        </button>
    <button id="menu-edit-subsidiary-ledger" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
        ТАЙЛАН ЗАСАХ
    </button>
    
</div>

<script>
(function() {
// Set default dates if not provided
document.addEventListener('DOMContentLoaded', function() {
    const beginDateInput = document.getElementById('begin_date');
    const endDateInput = document.getElementById('end_date');
    
    if (!beginDateInput.value) {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        beginDateInput.value = firstDay.toISOString().split('T')[0];
    }
    
    if (!endDateInput.value) {
        const today = new Date();
        endDateInput.value = today.toISOString().split('T')[0];
    }
});

// Client-side filtering and pagination
let allRows = [];
let filteredRows = [];
let currentPage = 1;
let rowsPerPage = 25;

// Initialize filtering and pagination
function initializeTableFeatures() {
    const tbody = document.querySelector('#recpay-balance-table tbody');
    if (tbody) {
        allRows = Array.from(tbody.querySelectorAll('tr'));
        filteredRows = [...allRows];
        console.log('Initialized with', allRows.length, 'rows');
        setupPagination();
        setupInlineFilters();
        calculateTotals();
        setupContextMenu();
    } else {
        console.log('Table body not found');
    }
}

// Calculate totals for all numeric columns
function calculateTotals() {
    let totals = {
        beginDebit: 0,
        beginCredit: 0,
        debitAmount: 0,
        creditAmount: 0,
        endDebit: 0,
        endCredit: 0
    };
    
    // Calculate totals from filtered rows
    filteredRows.forEach((row) => {
        const beginDebit = parseFloat(row.dataset.beginningBalanceDebit) || 0;
        const beginCredit = parseFloat(row.dataset.beginningBalanceCredit) || 0;
        const debitAmount = parseFloat(row.dataset.debitAmount) || 0;
        const creditAmount = parseFloat(row.dataset.creditAmount) || 0;
        const endDebit = parseFloat(row.dataset.endingBalanceDebit) || 0;
        const endCredit = parseFloat(row.dataset.endingBalanceCredit) || 0;
        
        totals.beginDebit += beginDebit;
        totals.beginCredit += beginCredit;
        totals.debitAmount += debitAmount;
        totals.creditAmount += creditAmount;
        totals.endDebit += endDebit;
        totals.endCredit += endCredit;
    });
    
    // Update total display elements
    updateTotalDisplay('total-begin-debit', totals.beginDebit);
    updateTotalDisplay('total-begin-credit', totals.beginCredit);
    updateTotalDisplay('total-debit-amount', totals.debitAmount);
    updateTotalDisplay('total-credit-amount', totals.creditAmount);
    updateTotalDisplay('total-end-debit', totals.endDebit);
    updateTotalDisplay('total-end-credit', totals.endCredit);
}

// Update individual total display
function updateTotalDisplay(elementId, value) {
    const element = document.getElementById(elementId);
    
    if (element) {
        const span = element.querySelector('span');
        if (span) {
            const formatted = value.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            if (value < 0) {
                span.className = 'text-red-600';
            } else if (value > 0) {
                span.className = 'text-gray-900';
            } else {
                span.className = 'text-gray-500';
            }
            
            span.textContent = formatted;
        }
    }
}

// Setup inline column filters
function setupInlineFilters() {
    const filterInputs = [
        'filter-account-code',
        'filter-account-name',
        'filter-client-code',
        'filter-client-name',
        'filter-begin-debit',
        'filter-begin-credit',
        'filter-debit-amount',
        'filter-credit-amount',
        'filter-end-debit',
        'filter-end-credit'
    ];
    
    filterInputs.forEach(filterId => {
        const input = document.getElementById(filterId);
        if (input) {
            input.addEventListener('input', function() {
                applyAllFilters();
            });
        }
    });
}

// Apply all filters
function applyAllFilters() {
    filteredRows = allRows.filter(row => {
        const filters = {
            'filter-account-code': row.dataset.accountCode?.toLowerCase() || '',
            'filter-account-name': row.dataset.accountName?.toLowerCase() || '',
            'filter-client-code': row.dataset.clientCode?.toLowerCase() || '',
            'filter-client-name': row.dataset.clientName?.toLowerCase() || '',
            'filter-begin-debit': parseFloat(row.dataset.beginningBalanceDebit) || 0,
            'filter-begin-credit': parseFloat(row.dataset.beginningBalanceCredit) || 0,
            'filter-debit-amount': parseFloat(row.dataset.debitAmount) || 0,
            'filter-credit-amount': parseFloat(row.dataset.creditAmount) || 0,
            'filter-end-debit': parseFloat(row.dataset.endingBalanceDebit) || 0,
            'filter-end-credit': parseFloat(row.dataset.endingBalanceCredit) || 0
        };
        
        for (const [filterId, value] of Object.entries(filters)) {
            const filterInput = document.getElementById(filterId);
            if (filterInput && filterInput.value.trim()) {
                const filterValue = filterInput.value.toLowerCase().trim();
                
                if (filterId.includes('account') || filterId.includes('client')) {
                    // Text filters
                    if (!value.includes(filterValue)) {
                        return false;
                    }
                } else {
                    // Numeric filters - support operators like >, <, =, >=, <=
                    if (filterValue.startsWith('>=')) {
                        const num = parseFloat(filterValue.substring(2));
                        if (isNaN(num) || value < num) return false;
                    } else if (filterValue.startsWith('<=')) {
                        const num = parseFloat(filterValue.substring(2));
                        if (isNaN(num) || value > num) return false;
                    } else if (filterValue.startsWith('>')) {
                        const num = parseFloat(filterValue.substring(1));
                        if (isNaN(num) || value <= num) return false;
                    } else if (filterValue.startsWith('<')) {
                        const num = parseFloat(filterValue.substring(1));
                        if (isNaN(num) || value >= num) return false;
                    } else if (filterValue.startsWith('=')) {
                        const num = parseFloat(filterValue.substring(1));
                        if (isNaN(num) || value !== num) return false;
                    } else {
                        const num = parseFloat(filterValue);
                        if (!isNaN(num)) {
                            if (value !== num) return false;
                        } else {
                            if (!value.toString().includes(filterValue)) return false;
                        }
                    }
                }
            }
        }
        
        return true;
    });
    
    currentPage = 1;
    displayRows();
    setupPagination();
    // Recalculate totals based on filtered rows
    calculateTotals();
}

// Display rows for current page
function displayRows() {
    const tbody = document.querySelector('#recpay-balance-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    const pageRows = filteredRows.slice(startIndex, endIndex);
    
    pageRows.forEach(row => {
        tbody.appendChild(row);
    });
    
    // Re-setup context menu for new rows
    setupContextMenu();
    // Re-add click handlers to new rows
    addClickHandlersToRecpayRows();
}

// Setup pagination
function setupPagination() {
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    const paginationInfo = document.getElementById('pagination-info');
    const prevButton = document.getElementById('prev-page');
    const nextButton = document.getElementById('next-page');
    const pageNumbers = document.getElementById('page-numbers');
    
    if (paginationInfo) {
        paginationInfo.textContent = `Хуудас ${currentPage}, нийт ${totalPages} хуудас (${filteredRows.length} мөр)`;
    }
    
    if (prevButton) {
        prevButton.disabled = currentPage <= 1;
    }
    if (nextButton) {
        nextButton.disabled = currentPage >= totalPages;
    }
    
    if (pageNumbers) {
        pageNumbers.innerHTML = '';
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.className = `px-3 py-1 text-sm rounded ${
                i === currentPage 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            }`;
            pageButton.addEventListener('click', () => goToPage(i));
            pageNumbers.appendChild(pageButton);
        }
    }
}

// Go to specific page
function goToPage(page) {
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayRows();
        setupPagination();
    }
}

// Subsidiary Ledger Modal Functions
function handleRecpayRowClick(row) {
    // Get the account data from the row
    const accountId = row.dataset.accountId;
    const clientId = row.dataset.clientId;
    const beginDate = document.getElementById('begin_date').value;
    const endDate = document.getElementById('end_date').value;
    const beginningBalanceDebit = parseFloat(row.dataset.beginningBalanceDebit) || 0;
    const beginningBalanceCredit = parseFloat(row.dataset.beginningBalanceCredit) || 0;
    const debitAmount = parseFloat(row.dataset.debitAmount) || 0;
    const creditAmount = parseFloat(row.dataset.creditAmount) || 0;
    const endingBalanceDebit = parseFloat(row.dataset.endingBalanceDebit) || 0;
    const endingBalanceCredit = parseFloat(row.dataset.endingBalanceCredit) || 0;
    
    if (!beginDate || !endDate) {
        alert('Please select a date range first');
        return;
    }
    
    // Show modal and loading state
    showPrintSubsidiaryLedgerModal();
    showModalLedgerLoading();
    
    // Prepare balance data from the row
    const balanceData = {
        beginningBalanceDebit: beginningBalanceDebit,
        beginningBalanceCredit: beginningBalanceCredit,
        debitAmount: debitAmount,
        creditAmount: creditAmount,
        endingBalanceDebit: endingBalanceDebit,
        endingBalanceCredit: endingBalanceCredit
    };
    
    // Make AJAX call to get subsidiary ledger details
    const url = `/core/api/subsidiary-ledger/?account_id=${accountId}&client_id=${clientId || ''}&begin_date=${beginDate}&end_date=${endDate}`;
    
    fetch(url, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                populateSubsidiaryLedgerModal(data, balanceData);
            } else {
                showModalLedgerError(data.error || 'Failed to load subsidiary ledger');
            }
        })
        .catch(error => {
            showModalLedgerError(`Network error: ${error.message}`);
        });
}

// Add click event listeners to recpay balance table rows
function addClickHandlersToRecpayRows() {
    const recpayBalanceRows = document.querySelectorAll('#recpay-balance-table tbody tr');
    recpayBalanceRows.forEach(row => {
        if (!row.dataset.hasClickHandler) {
            row.style.cursor = 'pointer';
            row.dataset.hasClickHandler = 'true';
            
            row.addEventListener('click', function() {
                handleRecpayRowClick(this);
            });
            
            // Add hover effect
            row.addEventListener('mouseenter', function() {
                this.classList.add('bg-blue-50');
            });
            
            row.addEventListener('mouseleave', function() {
                this.classList.remove('bg-blue-50');
            });
        }
    });
}

// Context menu functionality
let selectedRow = null;

function setupContextMenu() {
    const tbody = document.querySelector('#recpay-balance-table tbody');
    if (!tbody) return;
    
    // Use event delegation on tbody to handle all rows
    // Remove existing listener if any
    if (tbody.dataset.contextMenuSetup) return;
    tbody.dataset.contextMenuSetup = 'true';
    
    tbody.addEventListener('contextmenu', function(e) {
        const row = e.target.closest('tr');
        if (row && row.dataset.accountId) {
            e.preventDefault();
            selectedRow = row;
            showContextMenu(e.clientX, e.clientY);
        }
    });
}

function showContextMenu(x, y) {
    const menu = document.getElementById('context-menu');
    if (!menu) return;
    
    // Show menu first to get its dimensions
    menu.classList.remove('hidden');
    
    // Get menu dimensions
    const menuRect = menu.getBoundingClientRect();
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    // Adjust position if menu goes off-screen
    let left = x;
    let top = y;
    
    if (x + menuRect.width > windowWidth) {
        left = windowWidth - menuRect.width - 10;
    }
    if (y + menuRect.height > windowHeight) {
        top = windowHeight - menuRect.height - 10;
    }
    
    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
    
    // Hide menu when clicking outside
    setTimeout(() => {
        document.addEventListener('click', hideContextMenu, { once: true });
    }, 0);
}

function hideContextMenu() {
    const menu = document.getElementById('context-menu');
    if (menu) {
        menu.classList.add('hidden');
    }
}

function handleSubsidiaryLedger() {
    if (!selectedRow) return;
    
    const accountId = selectedRow.dataset.accountId;
    const clientId = selectedRow.dataset.clientId;
    const beginDate = document.getElementById('begin_date').value;
    const endDate = document.getElementById('end_date').value;
    const beginBalanceDebit = parseFloat(selectedRow.dataset.beginningBalanceDebit) || 0;
    const beginBalanceCredit = parseFloat(selectedRow.dataset.beginningBalanceCredit) || 0;
    const debitTotal = parseFloat(selectedRow.dataset.debitAmount) || 0;
    const creditTotal = parseFloat(selectedRow.dataset.creditAmount) || 0;
    const endBalanceDebit = parseFloat(selectedRow.dataset.endingBalanceDebit) || 0;
    const endBalanceCredit = parseFloat(selectedRow.dataset.endingBalanceCredit) || 0;
    
    if (!accountId || !beginDate || !endDate) {
        alert('Мэдээлэл дутуу байна');
        return;
    }
    
    // Show modal and loading state
    showPrintSubsidiaryLedgerModal();
    showModalLedgerLoading();
    
    // Prepare balance data from the row
    const balanceData = {
        beginningBalanceDebit: beginBalanceDebit,
        beginningBalanceCredit: beginBalanceCredit,
        debitAmount: debitTotal,
        creditAmount: creditTotal,
        endingBalanceDebit: endBalanceDebit,
        endingBalanceCredit: endBalanceCredit
    };
    
    // Make AJAX call to get subsidiary ledger details
    const url = `/core/api/subsidiary-ledger/?account_id=${accountId}&client_id=${clientId || ''}&begin_date=${beginDate}&end_date=${endDate}`;
    
    fetch(url, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                populateSubsidiaryLedgerModal(data, balanceData);
            } else {
                showModalLedgerError(data.error || 'Failed to load subsidiary ledger');
            }
        })
        .catch(error => {
            showModalLedgerError(`Network error: ${error.message}`);
        });
    
    hideContextMenu();
}

function handleEditSubsidiaryLedger() {
    if (!selectedRow) return;
    
    const accountId = selectedRow.dataset.accountId;
    const clientId = selectedRow.dataset.clientId;
    const beginDate = document.getElementById('begin_date').value;
    const endDate = document.getElementById('end_date').value;
    const beginBalanceDebit = parseFloat(selectedRow.dataset.beginningBalanceDebit) || 0;
    const beginBalanceCredit = parseFloat(selectedRow.dataset.beginningBalanceCredit) || 0;
    const debitTotal = parseFloat(selectedRow.dataset.debitAmount) || 0;
    const creditTotal = parseFloat(selectedRow.dataset.creditAmount) || 0;
    const endBalanceDebit = parseFloat(selectedRow.dataset.endingBalanceDebit) || 0;
    const endBalanceCredit = parseFloat(selectedRow.dataset.endingBalanceCredit) || 0;
    
    if (!accountId || !beginDate || !endDate) {
        alert('Мэдээлэл дутуу байна');
        return;
    }
    
    // Navigate to subsidiary ledger view with all summary values
    const url = `/core/reports/subsidiary-ledger/?account_id=${accountId}&client_id=${clientId || ''}&begin_date=${beginDate}&end_date=${endDate}&begin_balance_debit=${beginBalanceDebit}&begin_balance_credit=${beginBalanceCredit}&debit_total=${debitTotal}&credit_total=${creditTotal}&end_balance_debit=${endBalanceDebit}&end_balance_credit=${endBalanceCredit}`;
    window.location.href = url;
    hideContextMenu();
}

// Event listeners for pagination
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeTableFeatures, 100);
    // Add click handlers to existing rows
    setTimeout(addClickHandlersToRecpayRows, 150);
    
    const prevButton = document.getElementById('prev-page');
    if (prevButton) {
        prevButton.addEventListener('click', () => goToPage(currentPage - 1));
    }
    
    const nextButton = document.getElementById('next-page');
    if (nextButton) {
        nextButton.addEventListener('click', () => goToPage(currentPage + 1));
    }
    
    const rowsPerPageSelect = document.getElementById('rows-per-page');
    if (rowsPerPageSelect) {
        rowsPerPageSelect.addEventListener('change', function() {
            rowsPerPage = parseInt(this.value);
            currentPage = 1;
            displayRows();
            setupPagination();
        });
    }
    
    // Context menu item click handlers
    const menuSubsidiaryLedger = document.getElementById('menu-subsidiary-ledger');
    if (menuSubsidiaryLedger) {
        menuSubsidiaryLedger.addEventListener('click', handleSubsidiaryLedger);
    }
    
    const menuEditSubsidiaryLedger = document.getElementById('menu-edit-subsidiary-ledger');
    if (menuEditSubsidiaryLedger) {
        menuEditSubsidiaryLedger.addEventListener('click', handleEditSubsidiaryLedger);
    }
});
})();
</script>
{% endblock %}

